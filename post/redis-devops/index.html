<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon.png">
  <link rel="mask-icon" href="/images/icon.png" color="#222">
  <meta name="google-site-verification" content="HffpR8NKoAvdPtHw1WLz8yun_UKXOBTbuFVpUH6i77Q">







<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"flat"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: true,
    lazyload: false,
    pangu: true,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="article">
<meta property="og:title" content="ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹">
<meta property="og:url" content="https://blog.palemoky.com/post/redis-devops/index.html">
<meta property="og:site_name" content="Xinyu's Space">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tva1.sinaimg.cn/middle/006y8mN6ly1g8ronsawmbj30ku0aft9d.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g8rmou0bzdj30hx0kb0xe.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g8tfeooj3zj30k60hptbk.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/middle/006y8mN6ly1g8u1rzsipij30n811un3c.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/middle/006y8mN6ly1g8u27kw8tmj30u00ws7ff.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91c1tnqngj30ky0m3djy.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91co0mb8fj30g40hz770.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91e0yu7flj30if0o442t.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91vyy7e25j30h909875n.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91xk5bba1j30jh0hejtq.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91xn7bm5rj30j30lqgp7.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91xwacukej30hu0d8gnx.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g91z58ncm8j30iv0frgpv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g94c4oj8s0j30y20mmtfb.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g94i0a1qirj30u00wg49h.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g94ig5abpxj30zi0u0tkp.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g97yccw87dj30kt0dq0w8.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g982kp4di3j30lh0fadim.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g994eh8oswj30lt0fr41y.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9bsaxy49ij30kq0eetcb.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/middle/006y8mN6ly1g9chovnyqwj30lm0ls77d.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/middle/006y8mN6ly1g9chuf4cjdj30ld0hogp4.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/middle/006y8mN6ly1g9chunrge9j30mh0hbtbn.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9cieyqdx2j30je0riwj1.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9e35sce95j30m505ywfm.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9i5gd6qalj30n80nowkd.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9ic768uakj30ho0m8jve.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9icdly6hpj30j30ebq5o.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9icgp2fv1j30ju0gwtcv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9jh857qqpj30ji0ehq6u.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9jhell5zkj30gy0hc417.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9jhkc00w3j30he0b3q5k.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9jhv81y3pj30j00jrwhp.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9qoovqnpwj30u00vlk0z.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9qop67mnjj311m0ti0z1.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9qp56c761j30u010847e.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enly0i2dj30g10i1ac8.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enotipdrj30in0hvq5t.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9ens6v1czj30md068q4q.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enykatrkj30lu0m9tf4.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enz0x9eaj30mh0jsgr7.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eoakg0wrj30md0g0jty.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eo4ku5pyj30mg095acq.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eobx2323j30m20ed0vb.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eomw75jpj30lp0lt43y.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eol3rlkmj30mz07fq4l.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9qrmwcp5ij30il0black.jpg">
<meta property="article:published_time" content="2019-11-09T02:31:49.000Z">
<meta property="article:modified_time" content="2020-07-16T02:37:19.724Z">
<meta property="article:author" content="Palemoky">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/middle/006y8mN6ly1g8ronsawmbj30ku0aft9d.jpg">

<link rel="canonical" href="https://blog.palemoky.com/post/redis-devops/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>
<meta name="google-site-verification" content="HffpR8NKoAvdPtHw1WLz8yun_UKXOBTbuFVpUH6i77Q">
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js"></script>
  <title>ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹ | Xinyu's Space</title>
  
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-88938102-1"></script>
    <script pjax="">
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-88938102-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <script type="text/javascript">
    var host = "blog.palemoky.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
</script>
<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');loadCss('//fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext');loadCss('//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css');loadCss('https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css');</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"></noscript></head>

<body itemscope="" itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xinyu's Space</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">ä¸ƒçªé€šäº†å…­çª</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-ascii">

    <a href="/ASCII/" rel="section"><i class="fa fa-fw fa-globe"></i>ASCII</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Searching..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/palemoky" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.palemoky.com/post/redis-devops/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9hf0u8313j305o05p3ye.jpg">
      <meta itemprop="name" content="Palemoky">
      <meta itemprop="description" content="Learn by doing !">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xinyu's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-09 10:31:49" itemprop="dateCreated datePublished" datetime="2019-11-09T10:31:49+08:00">2019-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-16 10:37:19" itemprop="dateModified" datetime="2020-07-16T10:37:19+08:00">2020-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">å­¦ä¹ ç¬”è®°</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/post/redis-devops/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/redis-devops/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://tva1.sinaimg.cn/middle/006y8mN6ly1g8ronsawmbj30ku0aft9d.jpg"></p>
<span id="more"></span>

<h1 id="ç¬¬-1-ç« -åˆè¯†-Redis"><a href="#ç¬¬-1-ç« -åˆè¯†-Redis" class="headerlink" title="ç¬¬ 1 ç«  åˆè¯† Redis"></a>ç¬¬ 1 ç«  åˆè¯† Redis</h1><p>å¯¹äºå¤§éƒ¨åˆ†æ•°æ®åº“æ¥è¯´ï¼Œæ’å…¥è¡Œæ“ä½œçš„æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼ˆæ’å…¥è¡Œåªä¼šåœ¨ç¡¬ç›˜æ–‡ä»¶æœ«å°¾è¿›è¡Œå†™å…¥ï¼‰ã€‚ä¸è¿‡ï¼Œå¯¹è¡¨é‡Œé¢çš„è¡Œè¿›è¡Œæ›´æ–°å´æ˜¯ä¸€ä¸ªé€Ÿåº¦ç›¸å½“æ…¢çš„æ“ä½œï¼Œå› ä¸ºè¿™ç§æ›´æ–°é™¤äº†ä¼šå¼•èµ·ä¸€æ¬¡éšæœºè¯»ä¹‹å¤–ï¼Œè¿˜å¯èƒ½ä¼šå¼•èµ·ä¸€æ¬¡éšæœºå†™ã€‚</p>
<h2 id="Redis-æ•°æ®ç±»å‹"><a href="#Redis-æ•°æ®ç±»å‹" class="headerlink" title="Redis æ•°æ®ç±»å‹"></a>Redis æ•°æ®ç±»å‹</h2><ul>
<li>string(Bitmaps &amp; HyperLogLog)</li>
<li>hash</li>
<li>list</li>
<li>set</li>
<li>zset</li>
</ul>
<h2 id="Redis-æä¾›çš„åŠŸèƒ½"><a href="#Redis-æä¾›çš„åŠŸèƒ½" class="headerlink" title="Redis æä¾›çš„åŠŸèƒ½"></a>Redis æä¾›çš„åŠŸèƒ½</h2><ul>
<li>é”®è¿‡æœŸ</li>
<li>å‘å¸ƒè®¢é˜…ï¼ˆæ¶ˆæ¯ç³»ç»Ÿï¼‰</li>
<li>äº‹åŠ¡</li>
<li>æµæ°´çº¿ï¼ˆä¸€æ‰¹å‘½ä»¤ä¸€æ¬¡å‘é€åˆ° Redisï¼Œé¿å…ç½‘ç»œå¼€é”€ï¼‰</li>
<li>Lua è„šæœ¬</li>
</ul>
<h2 id="Redis-ä½¿ç”¨åœºæ™¯"><a href="#Redis-ä½¿ç”¨åœºæ™¯" class="headerlink" title="Redis ä½¿ç”¨åœºæ™¯"></a>Redis ä½¿ç”¨åœºæ™¯</h2><ul>
<li>ç¼“å­˜</li>
<li>æ’è¡Œæ¦œ</li>
<li>è®¡æ•°å™¨ï¼ˆè§†é¢‘æ’­æ”¾æ•°ï¼Œå•†å“æµè§ˆé‡ï¼‰</li>
<li>ç¤¾äº¤ï¼ˆå…±åŒå¥½å‹ã€ç²‰ä¸ã€ç‚¹èµï¼‰</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>å…±äº« Session</li>
<li>é™é€Ÿï¼ˆå¦‚ï¼Œ60s è·å–ä¸€æ¬¡æ‰‹æœºéªŒè¯ç ï¼š<code>redis.set(phoneNum, 1, "EX 60", "NX")</code>ï¼‰</li>
<li>ä½¿ç”¨å“ˆå¸Œç±»å‹æ¨¡æ‹Ÿå…³ç³»å‹æ•°æ®åº“ï¼ˆä¼˜ç‚¹ï¼šç”¨æˆ·ä¿¡æ¯å†…èšæ€§è¾ƒå¼ºï¼Œå ç”¨çš„é”®è¾ƒå°‘ï¼›ç¼ºç‚¹ï¼šå“ˆå¸Œç±»å‹æ˜¯ç¨€ç–çš„ï¼Œéš¾ä»¥åšå¤æ‚çš„å…³ç³»æŸ¥è¯¢ã€‚æ³¨æ„ï¼šè¦æ§åˆ¶å“ˆå¸Œåœ¨ ziplist å’Œ hashtable ä¸¤ç§å†…éƒ¨ç¼–ç çš„è½¬æ¢ï¼Œhashtable ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ï¼‰</li>
</ul>
<h2 id="ä¸ºä»€ä¹ˆ-Redis-å¾ˆå¿«ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-Redis-å¾ˆå¿«ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ Redis å¾ˆå¿«ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ Redis å¾ˆå¿«ï¼Ÿ</h2><ul>
<li>å†…å­˜è®¿é—®</li>
<li>C è¯­è¨€å®ç°</li>
<li>å•çº¿ç¨‹æ¶æ„ï¼Œé¿å…çº¿ç¨‹åˆ‡æ¢ä¸ç«æ€äº§ç”Ÿçš„æ¶ˆè€—</li>
<li>I/O å¤šè·¯å¤ç”¨æ¨¡å‹ï¼ˆepollï¼‰</li>
</ul>
<p>å®‰è£…è½¯ä»¶æ—¶ï¼Œä¸ºè½¯ä»¶å»ºç«‹è½¯è¿æ¥æ˜¯ä¸€ç§å¥½ä¹ æƒ¯ï¼Œé¿å…å°†è½¯ä»¶å›ºå®šåœ¨æŒ‡å®šç‰ˆæœ¬ä¸Šï¼Œæœ‰åˆ©äºæœªæ¥è½¯ä»¶çš„ç‰ˆæœ¬å‡çº§ã€‚</p>
<p>Redis å€Ÿé‰´äº† Linux å¯¹äºç‰ˆæœ¬å·çš„å‘½åè§„åˆ™ï¼šç‰ˆæœ¬å·ç¬¬äºŒä½å¦‚æœæ˜¯å¥‡æ•°ï¼Œåˆ™ä¸ºéç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚ 2.7ã€2.9ã€3.1ï¼‰ï¼Œå¦åˆ™ä¸ºç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚ 2.6ã€2.8ã€3.0ï¼‰</p>
<h2 id="Redis-å¯æ‰§è¡Œæ–‡ä»¶è¯´æ˜"><a href="#Redis-å¯æ‰§è¡Œæ–‡ä»¶è¯´æ˜" class="headerlink" title="Redis å¯æ‰§è¡Œæ–‡ä»¶è¯´æ˜"></a>Redis å¯æ‰§è¡Œæ–‡ä»¶è¯´æ˜</h2><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>redis-server</code></td>
<td>å¯åŠ¨ Redis</td>
</tr>
<tr>
<td><code>redis-cli</code></td>
<td>Redis å‘½ä»¤è¡Œå®¢æˆ·ç«¯</td>
</tr>
<tr>
<td><code>redis-cli shutdown</code></td>
<td>å…³é—­ Redis</td>
</tr>
<tr>
<td><code>redis-benchmark</code></td>
<td>Redis åŸºå‡†æµ‹è¯•å·¥å…·</td>
</tr>
<tr>
<td><code>redis-check-of</code></td>
<td>Redis AOF æŒä¹…åŒ–æ–‡ä»¶æ£€æµ‹ä¸ä¿®å¤å·¥å…·</td>
</tr>
<tr>
<td><code>redis-check-dump</code></td>
<td>Redis RDB æŒä¹…åŒ–æ–‡ä»¶æ£€æµ‹ä¸ä¿®å¤å·¥å…·</td>
</tr>
<tr>
<td><code>redis-sentinel</code></td>
<td>å¯åŠ¨ Redis Sentinel</td>
</tr>
</tbody></table>
<h2 id="å¯åŠ¨-Redis-çš„3ç§æ–¹å¼"><a href="#å¯åŠ¨-Redis-çš„3ç§æ–¹å¼" class="headerlink" title="å¯åŠ¨ Redis çš„3ç§æ–¹å¼"></a>å¯åŠ¨ Redis çš„3ç§æ–¹å¼</h2><ol>
<li>é»˜è®¤é…ç½®(<code>redis-server</code>)</li>
<li>è¿è¡Œé…ç½®(<code>redis-server --port 6380</code>)</li>
<li>é…ç½®æ–‡ä»¶(<code>redis-server /opt/redis/redis.conf</code>)</li>
</ol>
<p>python çš„ redis é«˜æ€§èƒ½æ‰©å±•æ˜¯ hiredisï¼ŒPHP åˆ™æ˜¯ phpredisã€‚</p>
<h1 id="ç¬¬-2-ç« -API-çš„ç†è§£å’Œä½¿ç”¨"><a href="#ç¬¬-2-ç« -API-çš„ç†è§£å’Œä½¿ç”¨" class="headerlink" title="ç¬¬ 2 ç«  API çš„ç†è§£å’Œä½¿ç”¨"></a>ç¬¬ 2 ç«  API çš„ç†è§£å’Œä½¿ç”¨</h1><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>é€‰é¡¹</th>
<th>è¿”å›å€¼</th>
<th>å«ä¹‰</th>
<th>å¤æ‚åº¦</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>keys pattern</code></td>
<td>pattern ä½¿ç”¨çš„æ˜¯ glob é£æ ¼çš„é€šé…ç¬¦</td>
<td></td>
<td>æŸ¥çœ‹æ‰€æœ‰é”®</td>
<td>$O(n)$</td>
<td>å¤§é‡é”®æ—¶ç¦æ­¢ä½¿ç”¨</td>
</tr>
<tr>
<td><code>dbsize</code></td>
<td></td>
<td>intï¼ˆ&gt;=0ï¼‰</td>
<td>é”®æ€»æ•°</td>
<td>$O(1)$</td>
<td>ä¸éå†é”®ï¼Œç›´æ¥è¯»å–å†…ç½®é”®æ€»æ•°</td>
</tr>
<tr>
<td><code>exists key</code></td>
<td></td>
<td>intboolï¼ˆå­˜åœ¨ä¸º 1ï¼Œå¦åˆ™ä¸º 0ï¼‰</td>
<td>æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>del key [key ...]</code></td>
<td></td>
<td>intï¼ˆæˆåŠŸåˆ é™¤çš„ä¸ªæ•°ï¼Œè‹¥åˆ é™¤ä¸å­˜åœ¨çš„é”®ï¼Œè¿”å› 0ï¼‰</td>
<td>åˆ é™¤é”®</td>
<td>$O(k)$ï¼Œğ‘˜ä¸ºé”®çš„ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>expire key seconds</code><br><br><code>expireat key timestamp</code><br><br><code>pexpire key milliseconds</code><br><br><code>pexpireat key milliseconds-timestamp</code></td>
<td></td>
<td>boolintï¼ˆæˆåŠŸä¸º 1ï¼Œkey ä¸å­˜åœ¨æˆ–æ— æ³•è®¾ç½®ä¸º 0ï¼‰</td>
<td>é”®è¿‡æœŸ</td>
<td></td>
<td>1. æ— è®ºä½¿ç”¨å“ªç§å½¢å¼ï¼Œåœ¨ Redis å†…éƒ¨æœ€ç»ˆä½¿ç”¨çš„éƒ½æ˜¯<code>pexpireat</code>ï¼›<br>2. å¦‚æœ<code>expire key</code>çš„é”®ä¸å­˜åœ¨ï¼Œè¿”å› 0;<br>3. å¦‚æœè¿‡æœŸæ—¶é—´ä¸ºè´Ÿå€¼ï¼Œé”®ä¼šè¢«ç«‹å³åˆ é™¤ï¼ŒçŠ¹å¦‚ä½¿ç”¨äº†<code>del</code>;<br>4. <code>persist key</code>å¯ä»¥å°†é”®çš„è¿‡æœŸæ—¶é—´æ¸…é™¤ï¼›<br>5. <strong>å¯¹äºå­—ç¬¦ä¸²ç±»å‹é”®ï¼Œæ‰§è¡Œ<code>set</code>å‘½ä»¤ä¼šå»æ‰è¿‡æœŸæ—¶é—´</strong>;<br>6. Redis ä¸æ”¯æŒäºŒçº§æ•°æ®ç»“æ„ï¼ˆå“ˆå¸Œã€åˆ—è¡¨ï¼‰å†…éƒ¨å…ƒç´ çš„è¿‡æœŸåŠŸèƒ½ï¼Œå¦‚ä¸èƒ½å¯¹åˆ—è¡¨ç±»å‹çš„ä¸€ä¸ªå…ƒç´ åšè¿‡æœŸæ—¶é—´è®¾ç½®ï¼›<br>7. <code>setex</code>ä½œä¸º<code>set</code>+<code>expire</code>çš„ç»„åˆï¼Œä¸ä½†æ˜¯åŸå­æ‰§è¡Œï¼ŒåŒæ—¶å‡å°‘äº†ä¸€æ¬¡ç½‘ç»œé€šè®¯çš„æ—¶é—´</td>
</tr>
<tr>
<td><code>ttl key</code><br><code>pttl key</code></td>
<td></td>
<td>intï¼ˆ&gt;=0ï¼šé”®å‰©ä½™è¿‡æœŸæ—¶é—´ï¼›-1ï¼šé”®æœªè®¾ç½®è¿‡æœŸæ—¶é—´ï¼›-2ï¼šé”®ä¸å­˜åœ¨ï¼‰</td>
<td>æŸ¥çœ‹é”®å‰©ä½™å­˜æ´»æ—¶é—´ï¼ˆç§’/æ¯«ç§’ï¼‰</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>type key</code></td>
<td></td>
<td>é”®å­˜åœ¨è¿”å›æ•°æ®ç±»å‹ï¼Œä¸å­˜åœ¨è¿”å› none</td>
<td>æŸ¥çœ‹é”®çš„æ•°æ®ç±»å‹</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>rename key newkey</code><br><code>renamenx key newkey</code></td>
<td></td>
<td>æˆåŠŸè¿”å›<code>OK</code>,å¤±è´¥ä¸º 0</td>
<td>é”®é‡å‘½å</td>
<td></td>
<td>1. å¦‚æœåœ¨é‡å‘½åä¹‹å‰ï¼Œé”®å€¼å·²ç»å­˜åœ¨ï¼Œåˆ™å€¼ä¼šè¢«è¦†ç›–ï¼›<br>2. ç”±äºé‡å‘½åé”®æœŸé—´ä¼šæ‰§è¡Œ<code>del</code>åˆ é™¤æ—§é”®ï¼Œå¦‚æœé”®å¯¹åº”çš„å€¼è¾ƒå¤§ï¼Œå¯èƒ½ä¼šè¢«é˜»å¡</td>
</tr>
<tr>
<td><code>randomkey</code></td>
<td></td>
<td></td>
<td>éšæœºè¿”å›ä¸€ä¸ªé”®</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>move key db</code><br><br><code>dump key</code> + <code>restore key ttl value</code><br><br><code>migrate host port key|"" destination-db timeout [copy] [replace] [keys key [key ...]]</code></td>
<td><code>ttl</code>ä¸º 0 æ—¶è¡¨ç¤ºæ— è¿‡æœŸæ—¶é—´<br><code>host</code>:ç›®æ ‡ä¸»æœº<br><code>port</code>:ç›®æ ‡ç«¯å£<br><code>key|""</code>:è¿ç§»å•ä¸ªé”®æŒ‡å®šé”®åï¼Œå¤šä¸ªé”®åˆ™ä¸ºç©ºå­—ç¬¦ä¸²<br><code>destination-db</code>:ç›®æ ‡ db ç´¢å¼•<br><code>timeout</code>:è¿ç§»çš„è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰<br><code>copy</code>:ä¸åˆ é™¤æºé”®<br><code>replace</code>:å¯¹ç›®æ ‡ Redis è¦†å†™æ“ä½œã€‚è‹¥æœªæŒ‡å®šï¼Œæº Redis å’Œç›®æ ‡ Redis å­˜åœ¨åŒåé”®ä¼šæŠ¥é”™<br><code>keys key [key ...]</code>:è¿ç§»çš„é”®å</td>
<td></td>
<td>è¿ç§»é”®</td>
<td></td>
<td>æ–¹å¼äºŒä¸­ï¼Œ<code>dump</code>ä¼šå°†é”®å€¼åºåˆ—åŒ–ï¼Œæ ¼å¼é‡‡ç”¨ RDB æ ¼å¼ï¼Œåœ¨ç›®æ ‡ Redis ä¸Šï¼Œ<code>restore</code>å†å°†åºåˆ—åŒ–çš„å€¼å¤åŸ<br><br><code>migrate</code>å®è´¨ä¸Šæ˜¯<code>dump</code>ã€<code>restore</code>ã€<code>del</code>ä¸‰ä¸ªå‘½ä»¤çš„ç»„åˆã€‚<code>migrate</code>å…·æœ‰åŸå­æ€§ï¼Œåªéœ€åœ¨æº Redis ä¸Šæ‰§è¡Œå³å¯ï¼Œç›®æ ‡ Redis å®Œæˆ<code>restore</code>åè¿”å› OKï¼Œæº Redis å†æ ¹æ®<code>migrate</code>çš„å¯¹åº”é€‰é¡¹å†³å®šæ˜¯å¦åœ¨æº Redis ä¸Šåˆ é™¤å¯¹åº”çš„é”®</td>
</tr>
<tr>
<td><code>scan cursor [match pattern] [count number]</code></td>
<td><code>cursor</code>ï¼šæ¸¸æ ‡ï¼Œç¬¬ä¸€æ¬¡éå†ä»0å¼€å§‹ï¼Œæ¯æ¬¡<code>scan</code>éå†å®Œéƒ½ä¼šè¿”å›å½“å‰æ¸¸æ ‡çš„å€¼ï¼Œç›´åˆ°æ¸¸æ ‡å€¼ä¸º0ï¼Œè¡¨ç¤ºéå†ç»“æŸ<br><code>Â·match pattern</code>ï¼šæ¨¡å¼åŒ¹é…<br><code>count number</code>ï¼šæ˜æ¯æ¬¡è¦éå†çš„é”®ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯10ï¼Œæ­¤å‚æ•°å¯ä»¥é€‚å½“å¢å¤§</td>
<td></td>
<td>æ¸è¿›å¼éå†</td>
<td></td>
<td>å¦‚æœåœ¨éå†è¿‡ç¨‹ä¸­é”®å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™ç»“æœå¯èƒ½æ˜¯ä¸å‡†ç¡®çš„ï¼›<br><code>hscan</code> è§£å†³ <code>hgetall</code> çš„é˜»å¡<br><code>sscan</code>è§£å†³<code>smembers</code> çš„é˜»å¡<br><code>zscan</code>è§£å†³<code>zrange</code> çš„é˜»å¡</td>
</tr>
<tr>
<td><code>select dbIndex</code></td>
<td></td>
<td></td>
<td>åˆ‡æ¢æ•°æ®åº“</td>
<td></td>
<td>é»˜è®¤ 16 ä¸ªæ•°æ®åº“(0~15)ï¼ŒæœªæŒ‡å®šæ•°æ®åº“æ—¶ï¼Œé»˜è®¤ä¸º 0 æ•°æ®åº“;<br>å»ºè®®åªä½¿ç”¨ 0 å·æ•°æ®åº“ï¼Œé¿å…å¤šæ•°æ®åº“çš„åˆ‡æ¢é”™è¯¯ï¼Œä»¥åŠæ•…éšœæ’æŸ¥å›°éš¾ã€‚å¦‚æœéœ€è¦ä½¿ç”¨å¤šæ•°æ®åº“ï¼Œå¯ä»¥åœ¨å•æœºéƒ¨ç½²å¤šä¸ª Redis å®ä¾‹ï¼Œé€šè¿‡ç«¯å£åŒºåˆ†ä¸åŒæ•°æ®åº“</td>
</tr>
<tr>
<td><code>flushdb</code><br><code>flushall</code></td>
<td></td>
<td></td>
<td>æ¸…ç©ºå½“å‰/æ‰€æœ‰æ•°æ®åº“</td>
<td></td>
<td>è‹¥æ•°æ®åº“é”®å€¼è¾ƒå¤šï¼Œå¯èƒ½å¼•å‘é˜»å¡</td>
</tr>
<tr>
<td><strong>å­—ç¬¦ä¸² String</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>set key value [ex seconds] [px milliseconds] [nx|xx]</code></td>
<td>exï¼šè®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´<br>pxï¼šè®¾ç½®æ¯«ç§’çº§è¿‡æœŸæ—¶é—´<br>nxï¼šé”®ä¸å­˜åœ¨æ‰èƒ½è®¾ç½®æˆåŠŸï¼Œç”¨äºæ·»åŠ <br>xxï¼šé”®å­˜åœ¨æ‰èƒ½è®¾ç½®æˆåŠŸï¼Œç”¨äºæ›´æ–°</td>
<td>æˆåŠŸè¿”å› OKï¼Œå¤±è´¥è¿”å› 0</td>
<td>è®¾ç½®å€¼</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>setex key seconds value</code></td>
<td></td>
<td>æˆåŠŸè¿”å› OKï¼Œå¤±è´¥è¿”å› 0</td>
<td>è®¾å®šçš„å€¼å­˜åœ¨æ‰ä¼šæˆåŠŸ</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>setnx key value</code></td>
<td></td>
<td>æˆåŠŸè¿”å› OKï¼Œå¤±è´¥è¿”å› 0</td>
<td>è®¾å®šçš„å€¼ä¸å­˜åœ¨æ‰ä¼šæˆåŠŸ</td>
<td></td>
<td>å¸¸ç”¨äºåˆ†å¸ƒå¼é”</td>
</tr>
<tr>
<td><code>get key</code></td>
<td></td>
<td>é”®å­˜åœ¨æ—¶è¿”å›å€¼ï¼Œä¸å­˜åœ¨è¿”å› nil</td>
<td>è·å–å€¼</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>mset key value [key value ...]</code></td>
<td></td>
<td>æˆåŠŸè¿”å› OKï¼Œå¤±è´¥è¿”å› 0</td>
<td>æ‰¹é‡è®¾ç½®å€¼</td>
<td>$O(k)$ï¼Œğ‘˜ä¸ºé”®çš„ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>mget key [key ...]</code></td>
<td></td>
<td>é”®å­˜åœ¨æ—¶è¿”å›å€¼ï¼Œä¸å­˜åœ¨è¿”å› nilã€‚ç»“æœæŒ‰ç…§ä¼ å…¥é”®çš„é¡ºåºè¿”å›</td>
<td>æ‰¹é‡è·å–å€¼</td>
<td>$O(k)$ï¼Œğ‘˜ä¸ºé”®çš„ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>incr key</code></td>
<td></td>
<td>å€¼ä¸æ˜¯æ•´æ•°ï¼Œè¿”å›é”™è¯¯<br>å€¼æ˜¯æ•´æ•°ï¼Œè¿”å›è‡ªå¢åç»“æœ<br>é”®ä¸å­˜åœ¨ï¼ŒæŒ‰ç…§å€¼ä¸º 0 è‡ªå¢ï¼Œè¿”å›ç»“æœä¸º 1</td>
<td>å€¼è‡ªå¢</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>decr key</code></td>
<td></td>
<td>int</td>
<td>å€¼è‡ªå‡</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>incrby key increment</code></td>
<td></td>
<td>int</td>
<td>è‡ªå¢æŒ‡å®šæ•°å­—</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>decrby key decrement</code></td>
<td></td>
<td>int</td>
<td>è‡ªå‡æŒ‡å®šæ•°å­—</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>incrbyfloat key increment</code></td>
<td></td>
<td>float</td>
<td>è‡ªå¢æµ®ç‚¹æ•°</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>append key value</code></td>
<td></td>
<td>intï¼ˆè¿”å›è¿½åŠ åçš„å­—ç¬¦é•¿åº¦ï¼‰</td>
<td>å‘å­—ç¬¦ä¸²å°¾éƒ¨è¿½åŠ å€¼</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>strlen key</code></td>
<td></td>
<td>intï¼ˆæ ¹æ®ä¸åŒç¼–ç è¿”å›å­—ç¬¦é•¿åº¦ï¼Œå¦‚ UTF8 çš„â€œä¸­å›½â€è¿”å›å€¼ä¸º 6ï¼‰</td>
<td>å­—ç¬¦ä¸²é•¿åº¦</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>getset key value</code></td>
<td></td>
<td></td>
<td>è®¾ç½®å¹¶è¿”å›å€¼</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>setrange key offeset value</code></td>
<td></td>
<td>intï¼ˆè¿”å›å­—ç¬¦é•¿åº¦ï¼‰</td>
<td>è®¾ç½®æŒ‡å®šä½ç½®çš„å­—ç¬¦</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>getrange key start end</code></td>
<td></td>
<td>è¿”å›æˆªå–çš„å­—ç¬¦å†…å®¹</td>
<td>è·å–éƒ¨åˆ†å­—ç¬¦ä¸²</td>
<td>$O(n)$ï¼Œğ‘› ä¸ºå­—ç¬¦ä¸²é•¿åº¦ï¼Œç”±äºè·å–å­—ç¬¦ä¸²éå¸¸å¿«ï¼Œè‹¥å­—ç¬¦ä¸²ä¸æ˜¯å¾ˆé•¿ï¼Œå¯ä»¥è§†ä¸º$O(1)$</td>
<td></td>
</tr>
<tr>
<td><strong>å“ˆå¸Œ Hash</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>hset key field value</code><br><code>hget key field</code></td>
<td></td>
<td></td>
<td>è®¾ç½®å€¼<br>è·å–å€¼</td>
<td>$O(1)$<br>$O(1)$</td>
<td>åœ¨ Redis ä¸­ï¼Œå“ˆå¸Œç±»å‹æ˜¯æŒ‡é”®å€¼æœ¬èº«åˆæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ç»“æ„ï¼ˆå½¢å¦‚ JSONï¼‰ã€‚å“ˆå¸Œç±»å‹ä¸­çš„æ˜ å°„å…³ç³»å«ä½œfield-valueï¼Œæ³¨æ„è¿™é‡Œçš„valueæ˜¯æŒ‡fieldå¯¹åº”çš„å€¼ï¼Œä¸æ˜¯é”®å¯¹åº”çš„å€¼ï¼Œè¯·æ³¨æ„valueåœ¨ä¸åŒä¸Šä¸‹æ–‡çš„ä½œç”¨ã€‚</td>
</tr>
<tr>
<td><code>hdel key field [field ...]</code></td>
<td></td>
<td>int ï¼ˆæˆåŠŸä¸ºåˆ é™¤çš„ä¸ªæ•°ï¼‰</td>
<td>åˆ é™¤ field</td>
<td>$O(k)$ ï¼Œğ‘˜æ˜¯fieldä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>hlen key</code></td>
<td></td>
<td>int</td>
<td>è®¡ç®— field ä¸ªæ•°</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>hmset key field value [field value ...]</code><br><code>hmget key field [field ...]</code></td>
<td></td>
<td></td>
<td>æ‰¹é‡è®¾ç½®æˆ–è·å–field-value</td>
<td>$O(k)$ ï¼Œğ‘˜æ˜¯fieldä¸ªæ•°<br>$O(k)$ ï¼Œğ‘˜æ˜¯fieldä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>hexists key field</code></td>
<td></td>
<td>å­˜åœ¨ä¸º 1ï¼Œå¦åˆ™ä¸º 0</td>
<td>åˆ¤æ–­fieldæ˜¯å¦å­˜åœ¨</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>hsetnx key field value</code></td>
<td></td>
<td></td>
<td></td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>hkeys key</code></td>
<td></td>
<td></td>
<td>è·å–æ‰€æœ‰field</td>
<td>$O(n)$ ï¼Œğ‘› æ˜¯fieldä¸ªæ•°</td>
<td><code>hkeys</code> å« <code>hfields</code>æ›´æ°å½“</td>
</tr>
<tr>
<td><code>hvals key</code></td>
<td></td>
<td></td>
<td>è·å–æ‰€æœ‰value</td>
<td>$O(n)$ ï¼Œğ‘› æ˜¯fieldä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>hgetall key</code></td>
<td></td>
<td></td>
<td>è·å–æ‰€æœ‰çš„field-value</td>
<td>$O(n)$ ï¼Œğ‘› æ˜¯fieldä¸ªæ•°</td>
<td>åœ¨ä½¿ç”¨<code>hgetall</code>æ—¶ï¼Œå¦‚æœå“ˆå¸Œå…ƒç´ ä¸ªæ•°æ¯”è¾ƒå¤šï¼Œå¯èƒ½ä¼šé˜»å¡Redisã€‚å¦‚æœå¼€å‘äººå‘˜åªéœ€è¦è·å–éƒ¨åˆ†fieldï¼Œå¯ä»¥ä½¿ç”¨<code>hmget</code>ï¼Œå¦‚æœä¸€å®šè¦è·å–å…¨éƒ¨field-valueï¼Œå¯ä»¥ä½¿ç”¨<code>hscan</code>å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä¼šæ¸è¿›å¼éå†å“ˆå¸Œç±»å‹ã€‚</td>
</tr>
<tr>
<td><code>hincrby key field</code><br><code>hincrbyfloat key field</code></td>
<td></td>
<td></td>
<td>æŒ‰æŒ‡å®šå€¼é€’å¢</td>
<td>$O(1)$<br>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>hstrlen key field</code></td>
<td></td>
<td></td>
<td>è®¡ç®—valueçš„å­—ç¬¦ä¸²é•¿åº¦</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td>åˆ—è¡¨ List</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>lpush key value [value ...]</code><br><code>rpush key value [value ...]</code></td>
<td></td>
<td>intï¼ˆæˆåŠŸæ’å…¥å…ƒç´ ä¸ªæ•°ï¼‰</td>
<td>ä»å·¦/å³ä¾§æ’å…¥å…ƒç´ </td>
<td>$O(k)$ï¼Œğ‘˜ ä¸ºå…ƒç´ ä¸ªæ•°</td>
<td>åˆ—è¡¨ç±»å‹çš„ä¸¤ä¸ªç‰¹ç‚¹ï¼šç¬¬ä¸€ï¼Œåˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯æœ‰åºçš„ï¼ˆå³ï¼Œå¯ä»¥é€šè¿‡ç´¢å¼•ä¸‹æ ‡è·å–å…ƒç´ ï¼‰ï¼›ç¬¬äºŒï¼Œåˆ—è¡¨ä¸­çš„å…ƒç´ å¯ä»¥æ˜¯é‡å¤çš„</td>
</tr>
<tr>
<td><code>lpop key</code><br><code>rpop key</code></td>
<td></td>
<td></td>
<td>ä»åˆ—è¡¨å·¦/å³ä¾§å¼¹å‡ºå…ƒç´ </td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>linsert key before|after pivot value</code></td>
<td></td>
<td>intï¼ˆè¿”å›å½“å‰åˆ—è¡¨é•¿åº¦ï¼‰</td>
<td>å‘æŸä¸ªå…ƒç´ å‰æˆ–è€…åæ’å…¥å…ƒç´ </td>
<td>$O(n)$ï¼Œğ‘› æ˜¯ pivot è·ç¦»åˆ—è¡¨å¤´æˆ–å°¾çš„è·ç¦»</td>
<td></td>
</tr>
<tr>
<td><code>lrange key start end</code></td>
<td></td>
<td></td>
<td>è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ åˆ—è¡¨</td>
<td>$O(s+n)$ï¼Œğ‘  æ˜¯ start åç§»é‡ï¼Œğ‘› æ˜¯start åˆ° end çš„èŒƒå›´</td>
<td>1. <code>lrange 0 -1</code> å¯è·å–åˆ—è¡¨æ‰€æœ‰å…ƒç´ <br>2. end åŒ…å«äº†è‡ªèº«</td>
</tr>
<tr>
<td><code>lindex key index</code></td>
<td></td>
<td></td>
<td>è·å–åˆ—è¡¨æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ </td>
<td>$O(n)$ï¼Œğ‘› æ˜¯ç´¢å¼•çš„åç§»é‡</td>
<td></td>
</tr>
<tr>
<td><code>llen key</code></td>
<td></td>
<td>int</td>
<td>è·å–åˆ—è¡¨é•¿åº¦</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>lrem key count value</code></td>
<td></td>
<td>count &gt; 0ï¼Œä»å·¦åˆ°å³ï¼Œåˆ é™¤æœ€å¤š count ä¸ªå…ƒç´ <br>count &lt; 0ï¼Œä»å³åˆ°å·¦ï¼Œåˆ é™¤æœ€å¤š count ç»å¯¹å€¼ä¸ªå…ƒç´ <br>count = 0ï¼Œåˆ é™¤æ‰€æœ‰</td>
<td>åˆ é™¤æŒ‡å®šå…ƒç´ </td>
<td>$O(n)$ï¼Œğ‘› æ˜¯åˆ—è¡¨é•¿åº¦</td>
<td></td>
</tr>
<tr>
<td><code>ltrim key start end</code></td>
<td></td>
<td></td>
<td>æŒ‰ç…§ç´¢å¼•èŒƒå›´ä¿®å‰ªåˆ—è¡¨</td>
<td>$O(n)$ï¼Œğ‘› æ˜¯è¦è£å‰ªçš„å…ƒç´ æ€»æ•°</td>
<td></td>
</tr>
<tr>
<td><code>lset key index newValue</code></td>
<td></td>
<td></td>
<td>ä¿®æ”¹æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ </td>
<td>$O(n)$ï¼Œğ‘› æ˜¯ç´¢å¼•çš„åç§»é‡</td>
<td></td>
</tr>
<tr>
<td><code>blpop key [key ...] timeout</code><br><code>brpop key [key ...] timeout</code></td>
<td><code>timeout</code> ä¸ºé˜»å¡æ—¶é—´</td>
<td></td>
<td>é˜»å¡å¼å¼¹å‡º</td>
<td>$O(1)$</td>
<td>å¦‚æœæœ‰å¤šä¸ªé”®ï¼Œé‚£ä¹ˆ<code>brpop</code>ä¼šä»å·¦è‡³å³éå†é”®ï¼Œä¸€æ—¦æœ‰ä¸€ä¸ªé”®èƒ½å¼¹å‡ºå…ƒç´ ï¼Œå®¢æˆ·ç«¯ç«‹å³è¿”å›</td>
</tr>
<tr>
<td><strong>é›†åˆ(Set)</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>sadd key element [element ...]</code></td>
<td></td>
<td>intï¼ˆè¿”å›æ·»åŠ æˆåŠŸå…ƒç´ çš„ä¸ªæ•°ï¼‰</td>
<td>æ·»åŠ å…ƒç´ </td>
<td>$O(k)$ï¼Œğ‘˜æ˜¯å…ƒç´ ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>srem key element [element ...]</code></td>
<td></td>
<td>intï¼ˆè¿”å›åˆ é™¤æˆåŠŸå…ƒç´ çš„ä¸ªæ•°ï¼‰</td>
<td>åˆ é™¤å…ƒç´ </td>
<td>$O(k)$ï¼Œğ‘˜æ˜¯å…ƒç´ ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>scard key</code></td>
<td></td>
<td></td>
<td>è®¡ç®—å…ƒç´ ä¸ªæ•°</td>
<td>$O(1)$</td>
<td>åŒ<code>dbsize</code>ç±»ä¼¼ï¼Œç›´æ¥è¯»å–å†…ç½®å˜é‡</td>
</tr>
<tr>
<td><code>sismember key element</code></td>
<td></td>
<td>intï¼ˆå­˜åœ¨è¿”å› 1ï¼Œå¦åˆ™ä¸º 0ï¼‰</td>
<td>åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>srandmember key [count]</code></td>
<td></td>
<td></td>
<td>éšæœºä»é›†åˆè¿”å›æŒ‡å®šä¸ªæ•°å…ƒç´ </td>
<td>$O(count)$</td>
<td></td>
</tr>
<tr>
<td><code>spop key</code></td>
<td></td>
<td></td>
<td>ä»é›†åˆéšæœºå¼¹å‡ºå…ƒç´ </td>
<td>$O(1)$</td>
<td><code>srandmember</code>å’Œ<code>spop</code>éƒ½æ˜¯éšæœºä»é›†åˆé€‰å‡ºå…ƒç´ ï¼Œä¸¤è€…ä¸åŒçš„æ˜¯<code>spop</code>å‘½ä»¤æ‰§è¡Œåï¼Œå…ƒç´ ä¼šä»é›†åˆä¸­åˆ é™¤ï¼Œè€Œ<code>srandmember</code>ä¸ä¼šã€‚</td>
</tr>
<tr>
<td><code>smembers key</code></td>
<td></td>
<td></td>
<td>è·å–æ‰€æœ‰å…ƒç´ ï¼Œç»“æœæ˜¯æ— åºçš„</td>
<td>$O(n)$ï¼Œğ‘›æ˜¯å…ƒç´ æ€»æ•°</td>
<td><code>smembers</code>å’Œ<code>lrange</code>ã€<code>hgetall</code>éƒ½å±äºæ¯”è¾ƒé‡çš„å‘½ä»¤ï¼Œå¦‚æœå…ƒç´ è¿‡å¤šå­˜åœ¨é˜»å¡Redisçš„å¯èƒ½æ€§ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨<code>sscan</code>æ¥å®Œæˆ</td>
</tr>
<tr>
<td><code>sinter key [key ...]</code></td>
<td></td>
<td></td>
<td>å–äº¤é›†</td>
<td>$O(m*k)$ï¼Œğ‘˜æ˜¯å¤šä¸ªé›†åˆå…ƒç´ æœ€å°‘çš„ä¸ªæ•°ï¼Œğ‘šæ˜¯é”®ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>suinon key [key ...]</code></td>
<td></td>
<td></td>
<td>å–å¹¶é›†</td>
<td>$O(k)$ï¼Œğ‘˜æ˜¯å¤šä¸ªé›†åˆå…ƒç´ ä¸ªæ•°å’Œ</td>
<td></td>
</tr>
<tr>
<td><code>sdiff key [key ...]</code></td>
<td></td>
<td></td>
<td>å–å·®é›†</td>
<td>$O(k)$ï¼Œğ‘˜æ˜¯å¤šä¸ªé›†åˆå…ƒç´ ä¸ªæ•°å’Œ</td>
<td></td>
</tr>
<tr>
<td><code>sinterstore destination key [key ...]</code><br><code>suionstore destination key [key ...]</code><br><code>sdiffstore destination key [key ...]</code></td>
<td></td>
<td></td>
<td>ï¼‰å°†äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„ç»“æœä¿å­˜</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>æœ‰åºé›†åˆï¼ˆZsetï¼‰</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>zadd key score member [score member ...]</code></td>
<td></td>
<td></td>
<td>æ·»åŠ æˆå‘˜</td>
<td>$O(k*log(n))$ï¼Œğ‘˜æ˜¯æ·»åŠ æˆå‘˜çš„ä¸ªæ•°ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zcard key</code></td>
<td></td>
<td>int</td>
<td>è®¡ç®—æˆå‘˜ä¸ªæ•°</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>zscore key member</code></td>
<td></td>
<td>intï¼ˆæˆå‘˜ä¸å­˜åœ¨è¿”å› nilï¼‰</td>
<td>è®¡ç®—æŸä¸ªæˆå‘˜çš„åˆ†æ•°</td>
<td>$O(1)$</td>
<td></td>
</tr>
<tr>
<td><code>zrank key member</code><br><code>zrevrank key member</code></td>
<td></td>
<td>è¿”å›åˆ†æ•°ä»ä½åˆ°é«˜/ä»é«˜åˆ°ä½çš„æ’å</td>
<td>è®¡ç®—æˆå‘˜çš„æ’å</td>
<td>$O(log(n))$ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zrem key member [member ...]</code></td>
<td></td>
<td>è¿”å›åˆ é™¤æˆå‘˜çš„ä¸ªæ•°</td>
<td>åˆ é™¤æˆå‘˜</td>
<td>$O(k*log(n))$ï¼Œğ‘˜æ˜¯åˆ é™¤æˆå‘˜çš„ä¸ªæ•°ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zincrby key increment member</code></td>
<td></td>
<td></td>
<td>å¢åŠ æˆå‘˜çš„åˆ†æ•°</td>
<td>$O(log(n))$ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zrange key start end [withscores]</code><br><code>zrevrange key start end [withscores]</code></td>
<td><code>withscores</code>ä¼šåŒæ—¶è¿”å›æˆå‘˜åˆ†æ•°</td>
<td>è¿”å›åˆ†æ•°ä»ä½åˆ°é«˜/ä»é«˜åˆ°ä½çš„æ’å</td>
<td>è¿”å›æŒ‡å®šæ’åèŒƒå›´çš„æˆå‘˜</td>
<td>$O(log(n)+k)$ï¼Œğ‘˜æ˜¯è¦è·å–çš„æˆå‘˜ä¸ªæ•°ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zrangebyscore key min max [withscores] [limit offset count]</code><br><code>zrevrangebyscore key max min [withscores] [limit offset count]</code></td>
<td><code>min</code>å’Œ<code>max</code>è¿˜æ”¯æŒå¼€åŒºé—´ï¼ˆå°æ‹¬å·ï¼‰å’Œé—­åŒºé—´ï¼ˆä¸­æ‹¬å·ï¼‰ï¼Œ<code>-inf</code>å’Œ<code>+inf</code>åˆ†åˆ«ä»£è¡¨æ— é™å°å’Œæ— é™å¤§</td>
<td></td>
<td>è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜</td>
<td>$O(log(n)+k)$ï¼Œğ‘˜æ˜¯è¦è·å–çš„æˆå‘˜ä¸ªæ•°ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zcount key min max</code></td>
<td></td>
<td></td>
<td>è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´æˆå‘˜ä¸ªæ•°</td>
<td>$O(log(n))$ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zremrangebyrank key start end</code></td>
<td></td>
<td></td>
<td>åˆ é™¤æŒ‡å®šæ’åå†…çš„å‡åºå…ƒç´ </td>
<td>$O(log(n)+k)$ï¼Œğ‘˜æ˜¯è¦åˆ é™¤çš„æˆå‘˜ä¸ªæ•°ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zremrangebyscore key min max</code></td>
<td></td>
<td></td>
<td>åˆ é™¤æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜</td>
<td>$O(log(n)+k)$ï¼Œğ‘˜æ˜¯è¦åˆ é™¤çš„æˆå‘˜ä¸ªæ•°ï¼Œğ‘›æ˜¯å½“å‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zinterstore destination numkeys key [key ...] [weights weight [weight ...]] [aggregate sum|min|max]</code></td>
<td><code>destination</code>ï¼šäº¤é›†è®¡ç®—ç»“æœä¿å­˜åˆ°è¿™ä¸ªé”®ï¼›<br><code>numkeys</code>ï¼šéœ€è¦åšäº¤é›†è®¡ç®—é”®çš„ä¸ªæ•°ï¼›<br><code>key [key...]</code>ï¼šéœ€è¦åšäº¤é›†è®¡ç®—çš„é”®ï¼›<br><code>weights weight[weight...]</code>ï¼šæ¯ä¸ªé”®çš„æƒé‡ï¼Œåœ¨åšäº¤é›†è®¡ç®—æ—¶ï¼Œæ¯ä¸ªé”®ä¸­çš„æ¯ä¸ª member ä¼šå°†è‡ªå·±åˆ†æ•°ä¹˜ä»¥è¿™ä¸ªæƒé‡ï¼Œæ¯ä¸ªé”®çš„æƒé‡é»˜è®¤æ˜¯1ï¼›<br><code>aggregate sum|min|max</code>ï¼šè®¡ç®—æˆå‘˜äº¤é›†åï¼Œåˆ†å€¼å¯ä»¥æŒ‰ç…§sumï¼ˆå’Œï¼‰ã€minï¼ˆæœ€å°å€¼ï¼‰ã€maxï¼ˆæœ€å¤§å€¼ï¼‰åšæ±‡æ€»ï¼Œé»˜è®¤å€¼æ˜¯sum</td>
<td></td>
<td>å–äº¤é›†</td>
<td>$O(n * k)+O(m*log(m))$ï¼Œğ‘›æ˜¯æˆå‘˜æ•°æœ€å°çš„æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°ï¼Œğ‘˜æ˜¯æœ‰åºé›†åˆçš„ä¸ªæ•°ï¼Œğ‘šæ˜¯ç»“æœé›†ä¸­æˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>zunionstore destination numkeys key [key ...] [weights weight [weight ...]] [aggregate sum|min|max]</code></td>
<td></td>
<td></td>
<td>å–å¹¶é›†</td>
<td>$O(n)+O(m*log(m))$ï¼Œğ‘›æ˜¯æ‰€æœ‰æœ‰åºé›†åˆæˆå‘˜ä¸ªæ•°å’Œï¼Œğ‘šæ˜¯ç»“æœé›†ä¸­æˆå‘˜ä¸ªæ•°</td>
<td></td>
</tr>
</tbody></table>
<h2 id="åˆ¤æ–­é”®ä¸å­˜åœ¨çš„æ–¹æ³•"><a href="#åˆ¤æ–­é”®ä¸å­˜åœ¨çš„æ–¹æ³•" class="headerlink" title="åˆ¤æ–­é”®ä¸å­˜åœ¨çš„æ–¹æ³•"></a>åˆ¤æ–­é”®ä¸å­˜åœ¨çš„æ–¹æ³•</h2><ol>
<li><code>exists</code> è¿”å› 0</li>
<li><code>del</code> è¿”å› 0</li>
<li><code>ttl</code> è¿”å› -2</li>
<li><code>type</code> è¿”å› <code>none</code></li>
<li><code>get</code> è¿”å› <code>nil</code></li>
</ol>
<p>è®¾è®¡åˆç†çš„é”®åï¼Œæœ‰åŠ©äºé˜²æ­¢é”®å†²çªå’Œé¡¹ç›®çš„å¯ç»´æŠ¤æ€§ï¼Œæ¯”è¾ƒæ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨â€œä¸šåŠ¡å:å¯¹è±¡å:id:[å±æ€§]â€ä½œä¸ºé”®åã€‚å¦‚æœé”®åè¾ƒé•¿ï¼Œå¯ä»¥åœ¨èƒ½æè¿°é”®å«ä¹‰çš„å‰æä¸‹é€‚å½“å‡å°‘é”®çš„é•¿åº¦ï¼Œä»è€Œå‡å°‘ç”±äºé”®åè¿‡é•¿è€Œå¯¼è‡´çš„å†…å­˜æµªè´¹ã€‚</p>
<h2 id="åˆ—è¡¨çš„å››ç§æ“ä½œç±»å‹"><a href="#åˆ—è¡¨çš„å››ç§æ“ä½œç±»å‹" class="headerlink" title="åˆ—è¡¨çš„å››ç§æ“ä½œç±»å‹"></a>åˆ—è¡¨çš„å››ç§æ“ä½œç±»å‹</h2><table>
<thead>
<tr>
<th>æ“ä½œç±»å‹</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody><tr>
<td>æ·»åŠ </td>
<td><code>rpush</code> <code>lpush</code> <code>linsert</code></td>
</tr>
<tr>
<td>æŸ¥</td>
<td><code>lrange</code> <code>lindex</code> <code>llen</code></td>
</tr>
<tr>
<td>åˆ é™¤</td>
<td><code>lpop</code> <code>rpop</code> <code>lrem</code> <code>ltrim</code></td>
</tr>
<tr>
<td>ä¿®æ”¹</td>
<td><code>lset</code></td>
</tr>
<tr>
<td>é˜»å¡æ“ä½œ</td>
<td><code>blpop</code> <code>brpop</code></td>
</tr>
</tbody></table>
<h2 id="åˆ—è¡¨çš„ä½¿ç”¨åœºæ™¯"><a href="#åˆ—è¡¨çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="åˆ—è¡¨çš„ä½¿ç”¨åœºæ™¯"></a>åˆ—è¡¨çš„ä½¿ç”¨åœºæ™¯</h2><ul>
<li><code>lpush</code> + <code>lpop</code> = Stackï¼ˆæ ˆï¼‰</li>
<li><code>lpush</code> + <code>rpop</code> = Queueï¼ˆé˜Ÿåˆ—ï¼‰</li>
<li><code>lpush</code> + <code>ltrim</code> = Capped Collectionï¼ˆæœ‰é™é›†åˆï¼‰</li>
<li><code>lpush</code> + <code>brpop</code> = Message Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰</li>
</ul>
<h2 id="é›†åˆçš„ä½¿ç”¨åœºæ™¯"><a href="#é›†åˆçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="é›†åˆçš„ä½¿ç”¨åœºæ™¯"></a>é›†åˆçš„ä½¿ç”¨åœºæ™¯</h2><ul>
<li><code>sadd</code> = Taggingï¼ˆæ ‡ç­¾ï¼‰</li>
<li><code>spop/srandmember</code> = Random itemï¼ˆç”Ÿæˆéšæœºæ•°ï¼Œæ¯”å¦‚æŠ½å¥–ï¼‰</li>
<li><code>sadd</code> + <code>sinter</code>= Social Graphï¼ˆç¤¾äº¤éœ€æ±‚ï¼‰</li>
</ul>
<h2 id="åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆçš„å¼‚åŒç‚¹"><a href="#åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆçš„å¼‚åŒç‚¹" class="headerlink" title="åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆçš„å¼‚åŒç‚¹"></a>åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆçš„å¼‚åŒç‚¹</h2><table>
<thead>
<tr>
<th>æ•°æ®ç»“æ„</th>
<th align="center">æ˜¯å¦å…è®¸é‡å¤å…ƒç´ </th>
<th align="center">æ˜¯å¦æœ‰åº</th>
<th>æœ‰åºå®ç°æ–¹å¼</th>
<th>åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>åˆ—è¡¨</td>
<td align="center">æ˜¯</td>
<td align="center">æ˜¯</td>
<td>ç´¢å¼•ä¸‹æ ‡</td>
<td>æ—¶é—´è½´ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰</td>
</tr>
<tr>
<td>é›†åˆ</td>
<td align="center">å¦</td>
<td align="center">å¦</td>
<td>æ— </td>
<td>æ ‡ç­¾ã€ç¤¾äº¤ç­‰</td>
</tr>
<tr>
<td>æœ‰åºé›†åˆ</td>
<td align="center">å¦</td>
<td align="center">æ˜¯</td>
<td>åˆ†å€¼</td>
<td>æ’è¡Œæ¦œã€ç¤¾äº¤ç­‰</td>
</tr>
</tbody></table>
<h2 id="Redis-æ•°æ®ç»“æ„ä¸å†…éƒ¨ç¼–ç "><a href="#Redis-æ•°æ®ç»“æ„ä¸å†…éƒ¨ç¼–ç " class="headerlink" title="Redis æ•°æ®ç»“æ„ä¸å†…éƒ¨ç¼–ç "></a>Redis æ•°æ®ç»“æ„ä¸å†…éƒ¨ç¼–ç </h2><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8rmou0bzdj30hx0kb0xe.jpg" alt="Redisæ•°æ®ç»“æ„ä¸å†…éƒ¨ç¼–ç "></p>
<ul>
<li>å­—ç¬¦ä¸²<ul>
<li>int: 8ä¸ªå­—èŠ‚çš„é•¿æ•´å‹</li>
<li>embstr: &lt;=39 Byte çš„å­—ç¬¦ä¸²</li>
<li>raw: &gt;39 Byte çš„å­—ç¬¦ä¸²</li>
</ul>
</li>
<li>å“ˆå¸Œ<ul>
<li>ziplist: å½“å“ˆå¸Œç±»å‹å…ƒç´ ä¸ªæ•°å°äº <code>hash-max-ziplist-entries</code> é…ç½®ï¼ˆé»˜è®¤512ä¸ªï¼‰ã€åŒæ—¶æ‰€æœ‰å€¼éƒ½å°äº <code>hash-max-ziplist-value</code> é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ ziplist ä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œziplist ä½¿ç”¨æ›´åŠ ç´§å‡‘çš„ç»“æ„å®ç°å¤šä¸ªå…ƒç´ çš„è¿ç»­å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨<strong>èŠ‚çœå†…å­˜æ–¹é¢æ¯” hashtable æ›´åŠ ä¼˜ç§€</strong>ã€‚</li>
<li>hashtable: å½“å“ˆå¸Œç±»å‹æ— æ³•æ»¡è¶³ ziplist çš„æ¡ä»¶æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ hashtable ä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ ziplist çš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œè€Œ hashtable çš„è¯»å†™æ—¶é—´å¤æ‚åº¦ä¸º$O(1)$</li>
</ul>
</li>
<li>åˆ—è¡¨<ul>
<li>ziplist: å½“åˆ—è¡¨å…ƒç´ ä¸ªæ•°å°äº <code>list-max-ziplist-entries</code> é…ç½®ï¼ˆé»˜è®¤512ä¸ªï¼‰ã€åŒæ—¶æ¯ä¸ªå…ƒç´ å€¼éƒ½å°äº <code>list-max-ziplist-value</code> é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ ziplist æ¥ä½œä¸ºåˆ—è¡¨çš„å†…éƒ¨å®ç°æ¥å‡å°‘å†…å­˜</li>
<li>linkedlist: å½“æ— æ³•æ»¡è¶³ziplistæ¡ä»¶æ—¶</li>
</ul>
</li>
<li>é›†åˆ<ul>
<li>intset: å½“é›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äº<code>set-maxintset-entries</code>é…ç½®ï¼ˆé»˜è®¤512ä¸ªï¼‰æ—¶ï¼ŒRedisä¼šé€‰ç”¨intsetæ¥ä½œä¸ºé›†åˆçš„å†…éƒ¨å®ç°ï¼Œä»è€Œå‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚</li>
<li>hashtable: æ— æ³•æ»¡è¶³intsetæ—¶</li>
</ul>
</li>
<li>æœ‰åºé›†åˆ<ul>
<li>ziplist: å½“æœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äº<code>zset-max-ziplistentries</code>é…ç½®ï¼ˆé»˜è®¤128ä¸ªï¼‰ï¼ŒåŒæ—¶æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äº<code>zset-max-ziplist-value</code>é…ç½®ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰æ—¶ï¼ŒRedisä¼šç”¨ziplistæ¥ä½œä¸ºæœ‰åºé›†åˆçš„å†…éƒ¨å®ç°æ¥å‡å°‘å†…å­˜</li>
<li>skiplist: å½“æ— æ³•æ»¡è¶³ziplistæ¡ä»¶æ—¶</li>
</ul>
</li>
</ul>
<p>Redis è®¾è®¡å†…éƒ¨ç¼–ç ä¸å¤–éƒ¨ç»“æ„æœ‰ä¸¤ä¸ªå¥½å¤„</p>
<ol>
<li>æ”¹è¿›å†…éƒ¨ç¼–ç è€Œå¯¹å¤–éƒ¨æ•°æ®ç»“æ„å’Œå‘½ä»¤æ²¡æœ‰å½±å“</li>
<li>å¤šç§å†…éƒ¨ç¼–ç å®ç°å¯ä»¥åœ¨ä¸åŒåœºæ™¯ä¸‹å‘æŒ¥å„è‡ªçš„ä¼˜åŠ¿ï¼Œå¦‚ ziplist æ¯”è¾ƒèŠ‚çœå†…å­˜ï¼Œä½†åœ¨åˆ—è¡¨å…ƒç´ è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½ä¼šæœ‰æ‰€ä¸‹é™ï¼Œæ­¤æ—¶ Redis ä¼šæ ¹æ®é…ç½®é€‰é¡¹å°†åˆ—è¡¨ç±»å‹çš„å†…éƒ¨å®ç°è½¬æ¢ä¸º linkedlistã€‚</li>
</ol>
<p>å¯ä»¥é€šè¿‡<code>object encoding key</code>å‘½ä»¤æŸ¥è¯¢å†…éƒ¨ç¼–ç ã€‚</p>
<h1 id="ç¬¬-3-ç« -å°åŠŸèƒ½å¤§ç”¨å¤„"><a href="#ç¬¬-3-ç« -å°åŠŸèƒ½å¤§ç”¨å¤„" class="headerlink" title="ç¬¬ 3 ç«  å°åŠŸèƒ½å¤§ç”¨å¤„"></a>ç¬¬ 3 ç«  å°åŠŸèƒ½å¤§ç”¨å¤„</h1><h2 id="æ…¢æŸ¥è¯¢"><a href="#æ…¢æŸ¥è¯¢" class="headerlink" title="æ…¢æŸ¥è¯¢"></a>æ…¢æŸ¥è¯¢</h2><h3 id="æ…¢æŸ¥è¯¢é…ç½®"><a href="#æ…¢æŸ¥è¯¢é…ç½®" class="headerlink" title="æ…¢æŸ¥è¯¢é…ç½®"></a>æ…¢æŸ¥è¯¢é…ç½®</h3><ul>
<li><code>slowlog-log-slower-than</code> æ‰§è¡Œæ—¶é—´é˜ˆå€¼<ul>
<li>å•ä½ä¸ºå¾®ç§’ï¼Œé»˜è®¤ 10,000ï¼Œä¸º 0 è¡¨ç¤ºè®°å½•æ‰€æœ‰å‘½ä»¤ï¼Œ&lt;0 ä¸è®°å½•ä»»ä½•å‘½ä»¤</li>
<li>åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œéœ€è¦å°†è¯¥å€¼å‘ä¸‹è°ƒæ•´</li>
</ul>
</li>
<li><code>slowlog-max-len</code><ul>
<li>Redis ä½¿ç”¨åˆ—è¡¨ç»“æ„å­˜å‚¨æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œè¯¥å‚æ•°ä¸ºåˆ—è¡¨æœ€å¤§é•¿åº¦</li>
<li>å½“åˆ—è¡¨è¾¾æœ€å¤§é•¿åº¦æ—¶ï¼Œæœ€æ—©æ’å…¥çš„å‘½ä»¤ä¼šè¢«ä»åˆ—è¡¨ä¸­ç§»å‡º</li>
<li>å¯å®šæ—¶å°†æ…¢æŸ¥è¯¢æ—¥å¿—æŒä¹…åŒ–å¤„ç†ï¼Œä¾¿äºæ’æŸ¥æ•…éšœ</li>
</ul>
</li>
</ul>
<h3 id="æ…¢æŸ¥è¯¢å‘½ä»¤"><a href="#æ…¢æŸ¥è¯¢å‘½ä»¤" class="headerlink" title="æ…¢æŸ¥è¯¢å‘½ä»¤"></a>æ…¢æŸ¥è¯¢å‘½ä»¤</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>é€‰é¡¹</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>slowlog get [n]</code></td>
<td><code>n</code>: æŒ‡å®šæ¡æ•°</td>
<td></td>
</tr>
<tr>
<td><code>slowlog len</code></td>
<td></td>
<td>è·å–å½“å‰æ…¢æŸ¥è¯¢åˆ—è¡¨é•¿åº¦</td>
</tr>
<tr>
<td><code>slowlog reset</code></td>
<td></td>
<td>é‡ç½®æ—¥å¿—ï¼Œå³æ¸…ç†æ…¢æŸ¥è¯¢åˆ—è¡¨</td>
</tr>
</tbody></table>
<h3 id="æ…¢æŸ¥è¯¢æ—¥å¿—ç»“æ„"><a href="#æ…¢æŸ¥è¯¢æ—¥å¿—ç»“æ„" class="headerlink" title="æ…¢æŸ¥è¯¢æ—¥å¿—ç»“æ„"></a>æ…¢æŸ¥è¯¢æ—¥å¿—ç»“æ„</h3><p>ç”± 4 ä¸ªå±æ€§ç»„æˆ</p>
<ol>
<li>æ—¥å¿—æ ‡è¯† ID</li>
<li>æ—¶é—´æˆ³</li>
<li>å‘½ä»¤è€—æ—¶</li>
<li>æ‰§è¡Œå‘½ä»¤å’Œå‚æ•°<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; slowlog get</span><br><span class="line">1) 1) (integer) 666</span><br><span class="line">   2) (integer) 1456786500</span><br><span class="line">   3) (integer) 11615</span><br><span class="line">   4) 1) "BGREWRITEAOF"</span><br><span class="line">2) 1) (integer) 665</span><br><span class="line">   2) (integer) 1456718400</span><br><span class="line">   3) (integer) 12006</span><br><span class="line">   4) 1) "SETEX"</span><br><span class="line">      2) "video_info_200"</span><br><span class="line">      3) "300"</span><br><span class="line">      4) "2"</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h2 id="Redis-Shell"><a href="#Redis-Shell" class="headerlink" title="Redis Shell"></a>Redis Shell</h2><h3 id="redis-cli"><a href="#redis-cli" class="headerlink" title="redis-cli"></a><code>redis-cli</code></h3><table>
<thead>
<tr>
<th>ç¤ºä¾‹</th>
<th>é€‰é¡¹</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>redis-cli -r 3 ping</code></td>
<td><code>-r</code>(repeat)ï¼šæŒ‡å®šå‘½ä»¤æ‰§è¡Œæ¬¡æ•°</td>
<td></td>
</tr>
<tr>
<td><code>redis-cli -r 5 -i 1 ping</code></td>
<td><code>-i</code>(interval)ï¼šæ‰§è¡Œå‘½ä»¤é—´éš”æ—¶é—´ï¼Œå•ä½ç§’</td>
<td><code>-i</code>å¿…é¡»ä¸<code>-r</code>ä¸€åŒä½¿ç”¨<br>è¯¥é€‰é¡¹ä¸æ”¯æŒæ¯«ç§’ä¸ºå•ä½ï¼Œè‹¥æƒ³ä»¥ 10ms ä¸ºé—´éš”ï¼Œå¯ä»¥ä½¿ç”¨<code>-i 0.01</code></td>
</tr>
<tr>
<td><code>echo "world" | redis-cli -x set hello</code></td>
<td><code>-x</code>: ä» stdin è¯»å–æ•°æ®ä½œä¸º <code>redis-cli</code>çš„æœ€åä¸€ä¸ªå‚æ•°</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>-c</code>(cluster): è¿æ¥ Redis cluster æ—¶ä½¿ç”¨ï¼Œå¯ä»¥é˜²æ­¢ <code>moved</code> å’Œ <code>ask</code> å¼‚å¸¸</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>-a</code>(auth): å¯†ç è®¤è¯</td>
<td></td>
</tr>
<tr>
<td><code>redis-cli --scan --pattern "app*"</code></td>
<td><code>--scan</code> &amp; <code>--pattern</code>: äºæ‰«ææŒ‡å®šæ¨¡å¼çš„é”®</td>
<td></td>
</tr>
<tr>
<td><code>redis-cli --slave</code></td>
<td><code>--slave</code>é€‰é¡¹æ˜¯æŠŠå½“å‰å®¢æˆ·ç«¯æ¨¡æ‹Ÿæˆå½“å‰ Redis èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨æ¥è·å–å½“å‰ Redis èŠ‚ç‚¹çš„æ›´æ–°æ“ä½œ</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>--rdb</code>: å°† Redis å®ä¾‹æŒä¹…åŒ–</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>--pipe</code>: å°†å‘½ä»¤å°è£…æˆRedisé€šä¿¡åè®®å®šä¹‰çš„æ•°æ®æ ¼å¼ï¼Œæ‰¹é‡å‘é€ç»™Redisæ‰§è¡Œ</td>
<td></td>
</tr>
<tr>
<td><code>redis-cli --bigkeys</code></td>
<td><code>--bigkeys</code>: ä½¿ç”¨scanå‘½ä»¤å¯¹Redisçš„é”®è¿›è¡Œé‡‡æ ·ï¼Œä»ä¸­æ‰¾åˆ°å†…å­˜å ç”¨æ¯”è¾ƒå¤§çš„é”®å€¼ï¼Œè¿™äº›é”®å¯èƒ½æ˜¯ç³»ç»Ÿçš„ç“¶é¢ˆ</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>--eval</code>: æŒ‡å®š Lua è„šæœ¬</td>
<td></td>
</tr>
<tr>
<td><code>redis-cli -h {machineB} --latency</code><br><code>redis-cli -h {machineB} --latency-history</code><br><code>redis-cli -h {machineB} --latency-dist</code></td>
<td><code>--latency</code>: æµ‹è¯•ç›®æ ‡ Redis ç½‘ç»œå»¶æ—¶ã€‚ä»…è¿”å›ä¸€æ¡ç»“æœ<br><code>--latency-history</code>: æ¯é—´éš”ä¸€å®šæ—¶é—´ï¼ˆå¯é€šè¿‡<code>-i</code>è®¾å®šï¼‰è¿”å›ç»“æœ<br><code>--latency-dist</code>: ä»¥ç»Ÿè®¡å›¾è¡¨çš„æ–¹å¼è¾“å‡ºç»Ÿè®¡ä¿¡æ¯</td>
<td></td>
</tr>
<tr>
<td><code>redis-cli --stat</code></td>
<td><code>--stat</code>: å®æ—¶è·å– Redis ç»Ÿè®¡ä¿¡æ¯</td>
<td><code>redis-cli info</code>ä¹Ÿèƒ½æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯</td>
</tr>
<tr>
<td><code>redis-cli --no-raw get apple</code></td>
<td><code>--raw</code> &amp; <code>--no-raw</code>: æ˜¯å¦æ ¼å¼åŒ–è¾“å‡º</td>
<td></td>
</tr>
</tbody></table>
<h3 id="redis-server"><a href="#redis-server" class="headerlink" title="redis-server"></a><code>redis-server</code></h3><p><code>redis-server --test-memory 1024</code> å¯ç”¨äºæ£€æµ‹å½“å‰ OS æ˜¯å¦èƒ½ç¨³å®šåˆ†é…æŒ‡å®šå®¹é‡å†…å­˜ç»™ Redisï¼Œè¯¥å‘½ä»¤é€šå¸¸ç”¨äºå‹æµ‹ã€‚</p>
<h3 id="redis-benchmark"><a href="#redis-benchmark" class="headerlink" title="redis-benchmark"></a><code>redis-benchmark</code></h3><p>è¯¥å‘½ä»¤ä¼šå¯¹å„ç±»æ•°æ®ç»“æ„çš„å‘½ä»¤è¿›è¡Œæµ‹è¯•ï¼Œå¹¶ç»™å‡ºæ€§èƒ½æŒ‡æ ‡ã€‚</p>
<ul>
<li><code>-c</code>(client) å¯æŒ‡å®šå®¢æˆ·ç«¯å¹¶å‘æ•°ï¼ˆé»˜è®¤ 50ï¼‰</li>
<li><code>-n</code> æŒ‡å®šå®¢æˆ·ç«¯è¯·æ±‚æ€»é‡ï¼ˆé»˜è®¤ 100,000ï¼‰</li>
<li><code>-q</code> ä»…æ˜¾ç¤ºæ¯ç§’æ¥æ”¶è¯·æ±‚æ•°</li>
<li><code>-r</code>(random) éšæœºæ’å…¥é”®ï¼Œä»¥è¿›è¡ŒåŸºå‡†æµ‹è¯•</li>
<li><code>-P</code> æ¯ä¸ªè¯·æ±‚ pipeline çš„æ•°æ®é‡ï¼ˆé»˜è®¤ä¸º 1ï¼‰</li>
<li><code>-k</code> å®¢æˆ·ç«¯æ˜¯å¦ä½¿ç”¨<code>keepalive</code>ï¼Œ1 ä¸ºä½¿ç”¨ï¼Œ0 ä¸ºä¸ä½¿ç”¨ï¼Œé»˜è®¤ä¸º 1</li>
<li><code>-t</code> å¯¹æŒ‡å®šå‘½ä»¤è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå¦‚<code>redis-benchmark -t get,set -q</code></li>
<li><code>--csv</code> å°†ç»“æœæŒ‰ç…§ csv æ ¼å¼è¾“å‡º</li>
</ul>
<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><p>ç”±äº Redis æ˜¯å•çº¿ç¨‹æœºåˆ¶ï¼Œå½“éœ€è¦æ‰§è¡Œå¤šæ¡å‘½ä»¤æ—¶ï¼Œç½‘ç»œ I/O æˆä¸ºäº†ç“¶é¢ˆï¼Œå› æ­¤ pipeline å¯å°†å¾…æ‰§è¡Œå‘½ä»¤â€œæ‰“åŒ…â€ï¼Œé€šè¿‡ä¸€æ¬¡å¾€è¿”å³å¯å®Œæˆã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœ pipeline æ•°æ®é‡è¿‡å¤§ï¼Œå°†ä¼šå¯¼è‡´ç½‘ç»œé˜»å¡ã€‚</p>
<h2 id="äº‹åŠ¡ä¸-Lua"><a href="#äº‹åŠ¡ä¸-Lua" class="headerlink" title="äº‹åŠ¡ä¸ Lua"></a>äº‹åŠ¡ä¸ Lua</h2><p>Redis ä¸­ï¼Œå°†ä¸€ç»„éœ€è¦ä¸€èµ·æ‰§è¡Œçš„äº‹åŠ¡å‘½ä»¤æ”¾åˆ°<code>multi</code>(å¼€å§‹)å’Œ<code>exec</code>(ç»“æŸ)ä¹‹é—´å³å¯ï¼Œå¦‚æœè¦åœæ­¢äº‹åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨<code>discard</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRedis ä¸æ”¯æŒäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œä½†å¯ä»¥é€šè¿‡ Lua æ¥å®ç°å›æ»šã€‚</p>
<p>æœ‰äº›åº”ç”¨åœºæ™¯éœ€è¦åœ¨äº‹åŠ¡ä¹‹å‰ï¼Œç¡®ä¿äº‹åŠ¡ä¸­çš„<code>key</code>æ²¡æœ‰è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹è¿‡ï¼Œæ‰æ‰§è¡Œäº‹åŠ¡ï¼Œå¦åˆ™ä¸æ‰§è¡Œï¼ˆç±»ä¼¼ä¹è§‚é”ï¼‰ã€‚Redisæä¾›äº†<code>watch</code>å‘½ä»¤æ¥è§£å†³è¿™ç±»é—®é¢˜ã€‚</p>
<p>Lua çš„æ•°æ®ç±»å‹ï¼š</p>
<ol>
<li>booleans(å¸ƒå°”)</li>
<li>numbers(æ•°å€¼)</li>
<li>strings(å­—ç¬¦ä¸²)</li>
<li>tables(è¡¨æ ¼)</li>
</ol>
<h3 id="åœ¨-Redis-ä¸­æ‰§è¡Œ-Lua-çš„æ–¹æ³•"><a href="#åœ¨-Redis-ä¸­æ‰§è¡Œ-Lua-çš„æ–¹æ³•" class="headerlink" title="åœ¨ Redis ä¸­æ‰§è¡Œ Lua çš„æ–¹æ³•"></a>åœ¨ Redis ä¸­æ‰§è¡Œ Lua çš„æ–¹æ³•</h3><p>æ–¹å¼ä¸€<br><code>eval è„šæœ¬å†…å®¹ keyä¸ªæ•° keyåˆ—è¡¨ å‚æ•°åˆ—è¡¨</code></p>
<p>æ–¹å¼äºŒ<br>å…ˆå°† Lua è„šæœ¬åŠ è½½å…¥ Redisï¼Œå¾—åˆ°è¯¥è„šæœ¬çš„ SHA1ï¼Œ<code>evalsha</code>ä½¿ç”¨<code>SHA1</code>æ‰§è¡Œå¯¹åº”çš„è„šæœ¬ã€‚è¿™æ ·å¯ä»¥é‡å¤æ‰¹å¤„ç†ã€‚</p>
<ul>
<li>åŠ è½½è„šæœ¬ï¼š<code>redis-cli script load "$(cat lua_get.lua)"</code></li>
<li>æ‰§è¡Œè„šæœ¬ï¼š<code>evalsha è„šæœ¬SHA1å€¼ keyä¸ªæ•° keyåˆ—è¡¨ å‚æ•°åˆ—è¡¨</code></li>
<li>åˆ¤æ–­è„šæœ¬æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼š<code>scripts exists sha1 [sha1 â€¦]</code>ï¼Œè¿”å›å­˜åœ¨çš„è„šæœ¬ä¸ªæ•°</li>
<li>æ¸…é™¤æ‰€æœ‰è„šæœ¬ï¼š<code>script flush</code></li>
<li>å¼ºåˆ¶ç»ˆæ­¢è„šæœ¬ï¼š<code>script kill</code>ã€‚å¦‚æœå½“å‰è„šæœ¬æ­£åœ¨å†™å…¥ï¼Œåˆ™è¯¥å‘½ä»¤ä¸ä¼šç”Ÿæ•ˆï¼Œæ­¤æ—¶è¦ä¹ˆç­‰å¾…è„šæœ¬æ‰§è¡Œç»“æŸï¼Œè¦ä¹ˆä½¿ç”¨<code>shutdown save</code>åœæ­¢ Redis æœåŠ¡</li>
</ul>
<blockquote>
<p>Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šæ’å…¥å…¶å®ƒå‘½ä»¤ã€‚</p>
</blockquote>
<h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h2><p>Bitmapsæœ¬èº«ä¸æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®é™…ä¸Šå®ƒå°±æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å®ƒå¯ä»¥å¯¹å­—ç¬¦ä¸²çš„ä½è¿›è¡Œæ“ä½œã€‚</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>setbit key offset value</code></td>
<td>è®¾ç½®å€¼</td>
<td>å¾ˆå¤šåº”ç”¨çš„ç”¨æˆ·idä»¥ä¸€ä¸ªæŒ‡å®šæ•°å­—ï¼ˆä¾‹å¦‚10000ï¼‰å¼€å¤´ï¼Œç›´æ¥å°†ç”¨æˆ·idå’ŒBitmapsçš„åç§»é‡å¯¹åº”åŠ¿å¿…ä¼šé€ æˆä¸€å®šçš„æµªè´¹ï¼Œé€šå¸¸çš„åšæ³•æ˜¯æ¯æ¬¡åš <code>setbit</code> æ“ä½œæ—¶å°†ç”¨æˆ·idå‡å»è¿™ä¸ªæŒ‡å®šæ•°å­—ã€‚åœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ– Bitmaps æ—¶ï¼Œå‡å¦‚åç§»é‡éå¸¸å¤§ï¼Œé‚£ä¹ˆæ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹æ‰§è¡Œä¼šæ¯”è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šé€ æˆRedisçš„é˜»å¡</td>
</tr>
<tr>
<td><code>gitbit key offset</code></td>
<td>è·å–å€¼</td>
<td></td>
</tr>
<tr>
<td><code>bitcount key [start][end]</code></td>
<td>è·å–BitmapsæŒ‡å®šèŒƒå›´å€¼ä¸º1çš„ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>bitop operator destkey key[key....]</code></td>
<td>Bitmapsé—´çš„è¿ç®—</td>
<td><code>bitop</code>æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼Œå®ƒå¯ä»¥åšå¤šä¸ªBitmapsçš„<code>and</code>ã€<code>or</code>ã€<code>not</code>ã€<code>xor</code>æ“ä½œå¹¶å°†ç»“æœä¿å­˜åœ¨<code>destkey</code>ä¸­</td>
</tr>
<tr>
<td><code>bitpos key targetBit [start] [end]</code></td>
<td>è®¡ç®—Bitmapsä¸­ç¬¬ä¸€ä¸ªå€¼ä¸ºtargetBitçš„åç§»é‡</td>
<td></td>
</tr>
</tbody></table>
<p>å½“ç”¨æˆ·é‡å¾ˆå¤§æ—¶ï¼Œä½¿ç”¨ bitmaps å­˜å‚¨ç”¨æˆ·çš„æ´»è·ƒæƒ…å†µæ˜¯éå¸¸å¥½çš„ä¸€ç§æ–¹æ¡ˆï¼Œä½†æ´»è·ƒç”¨æˆ·é‡è¾ƒå°‘æ—¶åˆ™ä¸åˆç†ï¼Œå¤§å¤šæ•°ä½éƒ½æ˜¯ 0ã€‚</p>
<h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h2><p>HyperLogLogå¹¶ä¸æ˜¯ä¸€ç§æ–°çš„æ•°æ®ç»“æ„ï¼ˆå®é™…ç±»å‹ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼‰ï¼Œé€šè¿‡HyperLogLogå¯ä»¥åˆ©ç”¨æå°çš„å†…å­˜ç©ºé—´å®Œæˆç‹¬ç«‹æ€»æ•°çš„ç»Ÿè®¡ï¼Œæ•°æ®é›†å¯ä»¥æ˜¯IPã€Emailã€IDç­‰ã€‚</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>pfadd key element [element â€¦]</code></td>
<td>æ·»åŠ ï¼ŒæˆåŠŸè¿”å› 1</td>
<td></td>
</tr>
<tr>
<td><code>pfcount key [key â€¦]</code></td>
<td>è®¡ç®—ç‹¬ç«‹ç”¨æˆ·</td>
<td></td>
</tr>
<tr>
<td><code>pfmerge destkey sourcekey [sourcekey ...]</code></td>
<td>åˆå¹¶</td>
<td></td>
</tr>
</tbody></table>
<p>ç›¸æ¯”äºé›†åˆç±»å‹ï¼ŒHyperLogLog å†…å­˜å ç”¨é‡éå¸¸å°ï¼Œä½†æ˜¯å­˜åœ¨é”™è¯¯ç‡ï¼Œå› æ­¤ï¼Œåœ¨æ•°æ®ç»“æ„é€‰å‹æ—¶ï¼Œéœ€è¦å¹³è¡¡è¯¯å·®ä¸ç©ºé—´å ç”¨ç‡ã€‚</p>
<h2 id="å‘å¸ƒè®¢é˜…"><a href="#å‘å¸ƒè®¢é˜…" class="headerlink" title="å‘å¸ƒè®¢é˜…"></a>å‘å¸ƒè®¢é˜…</h2><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>publish channel message</code></td>
<td>å‘å¸ƒæ¶ˆæ¯ï¼Œè¿”å›è®¢é˜…è€…ä¸ªæ•°</td>
<td></td>
</tr>
<tr>
<td><code>subscribe channel [channel ...]</code></td>
<td>è®¢é˜…æ¶ˆæ¯</td>
<td>å®¢æˆ·ç«¯åœ¨æ‰§è¡Œè®¢é˜…å‘½ä»¤ä¹‹åè¿›å…¥äº†è®¢é˜…çŠ¶æ€ï¼Œåªèƒ½æ¥æ”¶<code>subscribe</code>ã€<code>psubscribe</code>ã€<code>unsubscribe</code>ã€<code>punsubscribe</code>çš„å››ä¸ªå‘½ä»¤<br>æ–°å¼€å¯çš„è®¢é˜…å®¢æˆ·ç«¯ï¼Œæ— æ³•æ”¶åˆ°è¯¥é¢‘é“ä¹‹å‰çš„æ¶ˆæ¯ï¼Œå› ä¸ºRedisä¸ä¼šå¯¹å‘å¸ƒçš„æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–</td>
</tr>
<tr>
<td><code>unsubscribe [channel [channel ...]]</code></td>
<td>å–æ¶ˆè®¢é˜…</td>
<td></td>
</tr>
<tr>
<td><code>psubscribe pattern [pattern...]</code><br><code>punsubscribe [pattern [pattern ...]]</code></td>
<td>æŒ‰ç…§æ¨¡å¼è®¢é˜…å’Œå–æ¶ˆè®¢é˜…</td>
<td></td>
</tr>
<tr>
<td><code>pubsub channels [pattern]</code></td>
<td>æŸ¥çœ‹æ´»è·ƒçš„é¢‘é“</td>
<td></td>
</tr>
<tr>
<td><code>pubsub numsub [channel ...]</code></td>
<td>æŸ¥çœ‹é¢‘é“è®¢é˜…æ•°</td>
<td></td>
</tr>
<tr>
<td><code>pubsub numpat</code></td>
<td>æŸ¥çœ‹æ¨¡å¼è®¢é˜…æ•°</td>
<td></td>
</tr>
</tbody></table>
<h2 id="GEO"><a href="#GEO" class="headerlink" title="GEO"></a>GEO</h2><p>GEOåº•å±‚ç”± zset å®ç°ã€‚</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>geoadd key longitude latitude member [longitude latitude member ...]</code></td>
<td>å¢åŠ åœ°ç†ä½ç½®ä¿¡æ¯ã€‚è¿”å›æˆåŠŸæ·»åŠ çš„ä¸ªæ•°</td>
<td>æ›´æ–°åœ°ç†ä½ç½®ä¿¡æ¯ä»ç„¶å¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤ï¼Œä½†è¿”å›ä¸º 0ã€‚è¯¥å‘½ä»¤åŒæ—¶æ”¯æŒå¤šä¸ªåœ°ç†ä½ç½®æ·»åŠ </td>
</tr>
<tr>
<td><code>geopos key member [member ...]</code></td>
<td>è·å–åœ°ç†ä½ç½®ä¿¡æ¯</td>
<td></td>
</tr>
<tr>
<td><code>geodist key member1 member2 [unit]</code></td>
<td>è·å–ä¸¤ä¸ªåœ°ç†ä½ç½®çš„è·ç¦»</td>
<td><code>unit</code>ä¸ºå•ä½ï¼Œåˆ†åˆ«ä¸º<code>m</code>(ç±³)ï¼Œ<code>km</code>(å…¬é‡Œ)ï¼Œ<code>mi</code>(è‹±é‡Œ)ï¼Œ<code>ft</code>(å°º)</td>
</tr>
<tr>
<td><code>georadius key longitude latitude radiusm|km|ft|mi [withcoord] [withdist] [withhash] [COUNT count] [asc|desc] [store key] [storedist key]</code><br><br><code>georadiusbymember key member radiusm|km|ft|mi [withcoord] [withdist] [withhash] [COUNT count] [asc|desc] [store key] [storedist key]</code></td>
<td>è·å–æŒ‡å®šä½ç½®èŒƒå›´å†…çš„åœ°ç†ä¿¡æ¯ä½ç½®é›†åˆ</td>
<td><code>georadius</code>å’Œ<code>georadiusbymember</code>ä¸¤ä¸ªå‘½ä»¤çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä»¥ä¸€ä¸ªåœ°ç†ä½ç½®ä¸ºä¸­å¿ƒç®—å‡ºæŒ‡å®šåŠå¾„å†…çš„å…¶ä»–åœ°ç†ä¿¡æ¯ä½ç½®ï¼Œä¸åŒçš„æ˜¯<code>georadius</code>å‘½ä»¤çš„ä¸­å¿ƒä½ç½®ç»™å‡ºäº†å…·ä½“çš„ç»çº¬åº¦ï¼Œ<code>georadiusbymember</code>åªéœ€ç»™å‡ºæˆå‘˜å³å¯ã€‚å…¶ä¸­<code>radiusm|km|ft|mi</code>æ˜¯å¿…éœ€å‚æ•°ï¼ŒæŒ‡å®šäº†åŠå¾„<br><code>withcoord</code>:è¿”å›ç»çº¬åº¦ï¼›<br><code>withdist</code>:è¿”å›ç¦»ä¸­å¿ƒèŠ‚ç‚¹ä½ç½®çš„è·ç¦»ï¼›<br><code>withhash</code>:è¿”å›<code>geohash</code>ï¼›<br><code>COUNT count</code>:è¿”å›æŒ‡å®šç»“æœæ•°é‡ï¼›<br><code>asc|desc</code>:æŒ‰è·ä¸­å¿ƒèŠ‚ç‚¹è·ç¦»å‡åºæˆ–é™åºï¼›<br><code>store key</code>:å°†ç»“æœä¿å­˜åˆ°æŒ‡å®šé”®ï¼›<br><code>storedist key</code>:å°†è·ä¸­å¿ƒèŠ‚ç‚¹è·ç¦»ä¿å­˜åˆ°æŒ‡å®šé”®</td>
</tr>
<tr>
<td><code>geohash key member [member ...]</code></td>
<td>è·å–geohash</td>
<td>Rediså°†æ‰€æœ‰åœ°ç†ä½ç½®ä¿¡æ¯çš„<code>geohash</code>å­˜æ”¾åœ¨<code>zset</code>ä¸­ï¼Œå­—ç¬¦ä¸²è¶Šé•¿ï¼Œè¡¨ç¤ºçš„ä½ç½®æ›´ç²¾ç¡®</td>
</tr>
<tr>
<td><code>zrem key member</code></td>
<td>åˆ é™¤åœ°ç†ä½ç½®ä¿¡æ¯</td>
<td></td>
</tr>
</tbody></table>
<h1 id="ç¬¬-4-ç« -å®¢æˆ·ç«¯"><a href="#ç¬¬-4-ç« -å®¢æˆ·ç«¯" class="headerlink" title="ç¬¬ 4 ç«  å®¢æˆ·ç«¯"></a>ç¬¬ 4 ç«  å®¢æˆ·ç«¯</h1><h2 id="å®¢æˆ·ç«¯å¸¸è§å¼‚å¸¸"><a href="#å®¢æˆ·ç«¯å¸¸è§å¼‚å¸¸" class="headerlink" title="å®¢æˆ·ç«¯å¸¸è§å¼‚å¸¸"></a>å®¢æˆ·ç«¯å¸¸è§å¼‚å¸¸</h2><ol>
<li>æ— æ³•ä»è¿æ¥æ± è·å–åˆ°è¿æ¥<ol>
<li>è¿æ¥æ± è®¾ç½®è¿‡å°ï¼Œé»˜è®¤ä¸º 8</li>
<li>å®¢æˆ·ç«¯æœªæ­£ç¡®ä½¿ç”¨è¿æ¥æ± ï¼Œå¦‚æ²¡æœ‰è¿›è¡Œé‡Šæ”¾</li>
<li>å­˜åœ¨æ…¢æŸ¥è¯¢æ“ä½œ</li>
<li>Redis æœåŠ¡é€ æˆå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹é˜»å¡</li>
</ol>
</li>
<li>å®¢æˆ·ç«¯è¯»å†™è¶…æ—¶<ol>
<li>è¯»å†™æ—¶é—´è®¾ç½®è¿‡çŸ­</li>
<li>å‘½ä»¤æ‰§è¡Œæ—¶é—´è¾ƒé•¿</li>
<li>ç½‘è·¯å¼‚å¸¸</li>
<li>Redis è‡ªèº«å‘ç”Ÿé˜»å¡</li>
</ol>
</li>
<li>å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶<ol>
<li>è¶…æ—¶æ—¶é—´è¿‡çŸ­</li>
<li>Redis å‘ç”Ÿé˜»å¡ï¼Œ<code>tcp-backlog</code>å·²æ»¡ï¼Œé€ æˆæ–°çš„è¿æ¥å¤±è´¥</li>
<li>ç½‘ç»œå¼‚å¸¸</li>
</ol>
</li>
<li>å®¢æˆ·ç«¯ç¼“å†²åŒºå¼‚å¸¸<ol>
<li>è¾“å‡ºç¼“å†²åŒºæ»¡</li>
<li>é•¿æ—¶é—´é—²ç½®è¿æ¥è¢«æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€</li>
<li>ä¸æ­£å¸¸å¹¶å‘è¯»å†™</li>
</ol>
</li>
<li>Lua è„šæœ¬æ­£åœ¨æ‰§è¡Œ<ol>
<li>è„šæœ¬æ­£åœ¨æ‰§è¡Œï¼Œä¸”æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†<code>lua-time-limit</code>ï¼Œéœ€ç­‰å¾…è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œæˆ–è€…ä½¿ç”¨<code>shutdown save</code>å…³é—­ Redis æœåŠ¡</li>
</ol>
</li>
<li>Redis æ­£åœ¨åŠ è½½æŒä¹…åŒ–æ–‡ä»¶</li>
<li>Redis ä½¿ç”¨çš„å†…å­˜è¶…è¿‡<code>maxmemory</code>é…ç½®</li>
<li>å®¢æˆ·ç«¯è¿æ¥æ•°è¿‡å¤§<ol>
<li>å®¢æˆ·ç«¯ï¼šå¦‚æœ<code>maxclients</code>å‚æ•°ä¸æ˜¯å¾ˆå°çš„è¯ï¼Œåº”ç”¨æ–¹çš„å®¢æˆ·ç«¯è¿æ¥æ•°åŸºæœ¬ä¸ä¼šè¶…è¿‡<code>maxclients</code>ï¼Œé€šå¸¸æ¥çœ‹æ˜¯ç”±äºåº”ç”¨æ–¹å¯¹äºRediså®¢æˆ·ç«¯ä½¿ç”¨ä¸å½“é€ æˆçš„ã€‚æ­¤æ—¶å¦‚æœåº”ç”¨æ–¹æ˜¯åˆ†å¸ƒå¼ç»“æ„çš„è¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹çº¿éƒ¨åˆ†åº”ç”¨èŠ‚ç‚¹ï¼ˆä¾‹å¦‚å ç”¨è¿æ¥è¾ƒå¤šçš„èŠ‚ç‚¹ï¼‰ï¼Œä½¿å¾—Redisçš„è¿æ¥æ•°å…ˆé™ä¸‹æ¥ã€‚ä»è€Œè®©ç»å¤§éƒ¨åˆ†èŠ‚ç‚¹å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œæ­¤æ—¶å†é€šè¿‡æŸ¥æ‰¾ç¨‹åºbugæˆ–è€…è°ƒæ•´<code>maxclients</code>è¿›è¡Œé—®é¢˜çš„ä¿®å¤ã€‚</li>
<li>æœåŠ¡ç«¯ï¼šå¦‚æœæ­¤æ—¶å®¢æˆ·ç«¯æ— æ³•å¤„ç†ï¼Œè€Œå½“å‰Redisä¸ºé«˜å¯ç”¨æ¨¡å¼ï¼ˆä¾‹å¦‚Redis Sentinelå’ŒRedis Clusterï¼‰ï¼Œå¯ä»¥è€ƒè™‘å°†å½“å‰Redisåšæ•…éšœè½¬ç§»ã€‚</li>
</ol>
</li>
</ol>
<h2 id="å®¢æˆ·ç«¯æ¡ˆä¾‹åˆ†æ"><a href="#å®¢æˆ·ç«¯æ¡ˆä¾‹åˆ†æ" class="headerlink" title="å®¢æˆ·ç«¯æ¡ˆä¾‹åˆ†æ"></a>å®¢æˆ·ç«¯æ¡ˆä¾‹åˆ†æ</h2><h3 id="Rediså†…å­˜é™¡å¢"><a href="#Rediså†…å­˜é™¡å¢" class="headerlink" title="Rediså†…å­˜é™¡å¢"></a>Rediså†…å­˜é™¡å¢</h3><h4 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h4><p>æœåŠ¡ç«¯ç°è±¡ï¼šRedisä¸»èŠ‚ç‚¹å†…å­˜é™¡å¢ï¼Œå‡ ä¹ç”¨æ»¡<code>maxmemory</code>ï¼Œè€Œä»èŠ‚ç‚¹å†…å­˜å¹¶æ²¡æœ‰å˜åŒ–<br>å®¢æˆ·ç«¯ç°è±¡ï¼šå®¢æˆ·ç«¯äº§ç”Ÿäº†OOMå¼‚å¸¸ï¼Œæ— æ³•å†™å…¥æ–°çš„æ•°æ®</p>
<h4 id="åˆ†æåŸå› "><a href="#åˆ†æåŸå› " class="headerlink" title="åˆ†æåŸå› "></a>åˆ†æåŸå› </h4><p>ä»ç°è±¡çœ‹ï¼Œå¯èƒ½çš„åŸå› æœ‰ä¸¤ä¸ª</p>
<ol>
<li>ç¡®å®æœ‰å¤§é‡å†™å…¥ï¼Œä½†æ˜¯ä¸»ä»å¤åˆ¶å‡ºç°é—®é¢˜ï¼šç”¨<code>dbsize</code>æŸ¥è¯¢Rediså¤åˆ¶çš„ç›¸å…³ä¿¡æ¯ï¼Œå¤åˆ¶æ˜¯æ­£å¸¸çš„ï¼Œä¸»ä»æ•°æ®åŸºæœ¬ä¸€è‡´ã€‚</li>
<li>å…¶ä»–åŸå› é€ æˆä¸»èŠ‚ç‚¹å†…å­˜ä½¿ç”¨è¿‡å¤§ï¼šæ’æŸ¥æ˜¯å¦ç”±å®¢æˆ·ç«¯ç¼“å†²åŒºé€ æˆä¸»èŠ‚ç‚¹å†…å­˜é™¡å¢ï¼Œä½¿ç”¨<code>info clients</code>å‘½ä»¤æŸ¥è¯¢ï¼Œå‘ç°è¾“å‡ºç¼“å†²åŒºä¸å¤ªæ­£å¸¸ï¼Œè¿›ä¸€æ­¥é€šè¿‡<code>client list</code>å‘½ä»¤æ‰¾åˆ°<code>omem</code>ä¸æ­£å¸¸çš„è¿æ¥ï¼Œä¸€èˆ¬æ¥è¯´å¤§éƒ¨åˆ†å®¢æˆ·ç«¯çš„<code>omem</code>ä¸º0ï¼ˆå› ä¸ºå¤„ç†é€Ÿåº¦ä¼šè¶³å¤Ÿå¿«ï¼‰ï¼Œäºæ˜¯é€šè¿‡<code>redis-cli client list | grep -v "omem=0"</code>æ‰¾åˆ°<code>omem</code>éé›¶çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
</ol>
<h3 id="å®¢æˆ·ç«¯å‘¨æœŸæ€§çš„è¶…æ—¶"><a href="#å®¢æˆ·ç«¯å‘¨æœŸæ€§çš„è¶…æ—¶" class="headerlink" title="å®¢æˆ·ç«¯å‘¨æœŸæ€§çš„è¶…æ—¶"></a>å®¢æˆ·ç«¯å‘¨æœŸæ€§çš„è¶…æ—¶</h3><h4 id="ç°è±¡-1"><a href="#ç°è±¡-1" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h4><p>å®¢æˆ·ç«¯ç°è±¡ï¼šå®¢æˆ·ç«¯å‡ºç°å¤§é‡å‘¨æœŸæ€§è¶…æ—¶<br>æœåŠ¡ç«¯ç°è±¡ï¼šæœåŠ¡ç«¯å¹¶æ²¡æœ‰æ˜æ˜¾çš„å¼‚å¸¸ï¼Œåªæ˜¯æœ‰ä¸€äº›æ…¢æŸ¥è¯¢æ“ä½œ</p>
<h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><ul>
<li>ç½‘ç»œï¼šæŸ¥çœ‹ç½‘ç»œè¿æ¥æ­£å¸¸</li>
<li>Redisï¼šæŸ¥çœ‹ Redis æ—¥å¿—ç»Ÿè®¡ï¼Œæœªå‘ç°å¼‚å¸¸</li>
<li>å®¢æˆ·ç«¯ï¼šæ…¢æŸ¥è¯¢ä¸è¶…æ—¶å‘ç”Ÿæ—¶é—´ç‚¹å»åˆï¼Œæ¨æ–­ç”±æ…¢æŸ¥è¯¢å¼•èµ·</li>
</ul>
<h1 id="ç¬¬-5-ç« -æŒä¹…åŒ–"><a href="#ç¬¬-5-ç« -æŒä¹…åŒ–" class="headerlink" title="ç¬¬ 5 ç«  æŒä¹…åŒ–"></a>ç¬¬ 5 ç«  æŒä¹…åŒ–</h1><h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><ul>
<li><code>save</code>å‘½ä»¤ï¼šé˜»å¡å½“å‰RedisæœåŠ¡å™¨ï¼Œç›´åˆ°RDBè¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œå¯¹äºå†…å­˜æ¯”è¾ƒå¤§çš„å®ä¾‹ä¼šé€ æˆé•¿æ—¶é—´é˜»å¡ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨ã€‚</li>
<li><code>bgsave</code>å‘½ä»¤ï¼šRedisè¿›ç¨‹æ‰§è¡Œforkæ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼ŒRDBæŒä¹…åŒ–è¿‡ç¨‹ç”±å­è¿›ç¨‹è´Ÿè´£ï¼Œå®Œæˆåè‡ªåŠ¨ç»“æŸã€‚é˜»å¡åªå‘ç”Ÿåœ¨forké˜¶æ®µï¼Œä¸€èˆ¬æ—¶é—´å¾ˆçŸ­ã€‚</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8tfeooj3zj30k60hptbk.jpg" alt="bgsave workflow"></p>
<p>è‡ªåŠ¨è§¦å‘åœºæ™¯ï¼š</p>
<ol>
<li>ä½¿ç”¨saveç›¸å…³é…ç½®ï¼Œå¦‚<code>save m n</code>ã€‚è¡¨ç¤º m ç§’å†…æ•°æ®é›†å­˜åœ¨ n æ¬¡ä¿®æ”¹æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ bgsave</li>
<li>å¦‚æœä»èŠ‚ç‚¹æ‰§è¡Œå…¨é‡å¤åˆ¶æ“ä½œï¼Œä¸»èŠ‚ç‚¹è‡ªåŠ¨æ‰§è¡Œ bgsave ç”ŸæˆRDBæ–‡ä»¶å¹¶å‘é€ç»™ä»èŠ‚ç‚¹</li>
<li>æ‰§è¡Œ<code>debug reload</code>å‘½ä»¤é‡æ–°åŠ è½½Redisæ—¶ï¼Œä¹Ÿä¼šè‡ªåŠ¨è§¦å‘ save æ“ä½œ</li>
<li>é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œ<code>shutdown</code>å‘½ä»¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ AOF æŒä¹…åŒ–åŠŸèƒ½åˆ™è‡ªåŠ¨æ‰§è¡Œ bgsave</li>
</ol>
<p>å¦‚æœRedisåŠ è½½æŸåçš„RDBæ–‡ä»¶æ—¶æ‹’ç»å¯åŠ¨ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨Redisæä¾›çš„<code>redis-check-dump</code>å·¥å…·æ£€æµ‹ RDB æ–‡ä»¶å¹¶è·å–å¯¹åº”çš„é”™è¯¯æŠ¥å‘Šã€‚</p>
<h3 id="RDB-çš„ä¼˜ç¼ºç‚¹"><a href="#RDB-çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="RDB çš„ä¼˜ç¼ºç‚¹"></a>RDB çš„ä¼˜ç¼ºç‚¹</h3><p>RDBçš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>RDBæ˜¯ä¸€ä¸ªç´§å‡‘å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»£è¡¨Redisåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„æ•°æ®å¿«ç…§ã€‚<strong>éå¸¸é€‚ç”¨äºå¤‡ä»½ï¼Œå…¨é‡å¤åˆ¶ç­‰åœºæ™¯</strong>ã€‚æ¯”å¦‚æ¯6å°æ—¶æ‰§è¡Œbgsaveå¤‡ä»½ï¼Œå¹¶æŠŠRDBæ–‡ä»¶æ‹·è´åˆ°è¿œç¨‹æœºå™¨æˆ–è€…æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ˆå¦‚hdfsï¼‰ï¼Œç”¨äºç¾éš¾æ¢å¤ã€‚</li>
<li>RedisåŠ è½½RDBæ¢å¤æ•°æ®è¿œè¿œå¿«äºAOFçš„æ–¹å¼ã€‚</li>
</ul>
<p>RDBçš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>RDBæ–¹å¼æ•°æ®<strong>æ— æ³•åšåˆ°å®æ—¶æŒä¹…åŒ–/ç§’çº§æŒä¹…åŒ–</strong>ã€‚å› ä¸ºbgsaveæ¯æ¬¡è¿è¡Œéƒ½è¦æ‰§è¡Œforkæ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼Œå±äºé‡é‡çº§æ“ä½œï¼Œé¢‘ç¹æ‰§è¡Œæˆæœ¬è¿‡é«˜ã€‚</li>
<li>RDBæ–‡ä»¶ä½¿ç”¨ç‰¹å®šäºŒè¿›åˆ¶æ ¼å¼ä¿å­˜ï¼ŒRedisç‰ˆæœ¬æ¼”è¿›è¿‡ç¨‹ä¸­æœ‰å¤šä¸ªæ ¼å¼çš„RDBç‰ˆæœ¬ï¼Œå­˜åœ¨è€ç‰ˆæœ¬RedisæœåŠ¡æ— æ³•å…¼å®¹æ–°ç‰ˆRDBæ ¼å¼çš„é—®é¢˜ã€‚</li>
</ul>
<h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p>AOFï¼ˆappend only fileï¼‰æŒä¹…åŒ–ï¼šä»¥ç‹¬ç«‹æ—¥å¿—çš„æ–¹å¼è®°å½•æ¯æ¬¡å†™å‘½ä»¤(ç±»ä¼¼äº MySQL çš„ Binlog)ï¼Œé‡å¯æ—¶å†é‡æ–°æ‰§è¡ŒAOFæ–‡ä»¶ä¸­çš„å‘½ä»¤è¾¾åˆ°æ¢å¤æ•°æ®çš„ç›®çš„ã€‚ç›®å‰å·²ç»æ˜¯RedisæŒä¹…åŒ–çš„ä¸»æµæ–¹å¼ã€‚</p>
<p>å¼€å¯AOFåŠŸèƒ½éœ€è¦è®¾ç½®é…ç½®ï¼š<code>appendonly yes</code>ï¼Œé»˜è®¤ä¸å¼€å¯ã€‚AOFæ–‡ä»¶åé€šè¿‡<code>appendfilename</code>é…ç½®è®¾ç½®ï¼Œé»˜è®¤æ–‡ä»¶åæ˜¯<code>appendonly.aof</code>ã€‚ä¿å­˜è·¯å¾„åŒ RDB æŒä¹…åŒ–æ–¹å¼ä¸€è‡´ï¼Œé€šè¿‡<code>dir</code>é…ç½®æŒ‡å®šã€‚<br><img src="https://tva1.sinaimg.cn/middle/006y8mN6ly1g8u1rzsipij30n811un3c.jpg" alt="AOF workflow"></p>
<p>AOFç¼“å†²åŒºåŒæ­¥æ–‡ä»¶ç­–ç•¥(å‚æ•°<code>appendfsync</code>)</p>
<table>
<thead>
<tr>
<th>å¯é…ç½®å€¼</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>always</code></td>
<td>å‘½ä»¤å†™å…¥<code>aof_buf</code>åè°ƒç”¨ç³»ç»Ÿ<code>fsync</code>æ“ä½œåŒæ­¥åˆ° AOF æ–‡ä»¶ï¼Œ<code>fsync</code> å®Œæˆåçº¿ç¨‹è¿”å›</td>
<td>ä¸å»ºè®®</td>
</tr>
<tr>
<td><code>everysec</code></td>
<td>å‘½ä»¤å†™å…¥<code>aof_buf</code>åè°ƒç”¨ç³»ç»Ÿ<code>write</code>æ“ä½œï¼Œ<code>write</code>å®Œæˆåçº¿ç¨‹è¿”å›ã€‚<code>fsync</code>åŒæ­¥æ–‡ä»¶æ“ä½œç”±ä¸“é—¨çº¿ç¨‹æ¯ç§’è°ƒç”¨ä¸€æ¬¡ã€‚</td>
<td>å»ºè®®ï¼Œä¸ºé»˜è®¤é€‰é¡¹</td>
</tr>
<tr>
<td><code>no</code></td>
<td>å‘½ä»¤å†™å…¥<code>aof_buf</code>åè°ƒç”¨ç³»ç»Ÿ<code>write</code>æ“ä½œï¼Œä¸å¯¹ AOF æ–‡ä»¶åš<code>fsync</code>åŒæ­¥ï¼ŒåŒæ­¥ç¡¬ç›˜æ“ä½œç”± OS è´Ÿè´£ï¼Œé€šå¸¸åŒæ­¥å‘¨æœŸæœ€é•¿ 30s</td>
<td>æ•°æ®å®‰å…¨æ— æ³•å¾—åˆ°ä¿è¯</td>
</tr>
</tbody></table>
<p>aof é‡å†™è¿‡ç¨‹å¯é€šè¿‡æ‰‹åŠ¨ä¸è‡ªåŠ¨æ–¹å¼è§¦å‘ã€‚æ‰‹åŠ¨é€šè¿‡ç›´æ¥è°ƒç”¨<code>bgrewriteaof</code>å‘½ä»¤ï¼Œè‡ªåŠ¨æ–¹å¼åˆ™æ ¹æ®<code>auto-aof-rewrite-min-size</code>å’Œ<code>auto-aof-rewrite-percentage</code>çš„å‚æ•°ç¡®å®šè§¦å‘æ—¶æœºã€‚<br><img src="https://tva1.sinaimg.cn/middle/006y8mN6ly1g8u27kw8tmj30u00ws7ff.jpg" alt="AOF rewrite workflow"></p>
<h2 id="é‡å¯åŠ è½½"><a href="#é‡å¯åŠ è½½" class="headerlink" title="é‡å¯åŠ è½½"></a>é‡å¯åŠ è½½</h2><p>Redis å¯åŠ¨æ—¶ä¼šä¼˜å…ˆåŠ è½½ AOF æ–‡ä»¶ï¼Œå¦‚æœ AOF ä¸å¯åŠ è½½ï¼Œç„¶åå†åŠ è½½ RDB æ–‡ä»¶ã€‚å…¶æ–‡ä»¶åŠ è½½æµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91c1tnqngj30ky0m3djy.jpg"></p>
<p>å¦‚æœåœ¨åŠ è½½ AOF æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå¯ä»¥å…ˆè¿›è¡Œå¤‡ä»½ï¼Œç„¶åé‡‡ç”¨<code>redis-check-aof --fix</code>å‘½ä»¤è¿›è¡Œä¿®å¤ï¼Œä¿®å¤åä½¿ç”¨<code>diff -u</code>å¯¹æ¯”æ•°æ®çš„å·®å¼‚ï¼Œæ‰¾å‡ºä¸¢å¤±çš„æ•°æ®ï¼Œæœ‰äº›å¯ä»¥äººå·¥ä¿®æ”¹è¡¥å…¨ã€‚</p>
<p>AOFæ–‡ä»¶å¯èƒ½å­˜åœ¨ç»“å°¾ä¸å®Œæ•´çš„æƒ…å†µï¼Œæ¯”å¦‚æœºå™¨çªç„¶æ‰ç”µå¯¼è‡´AOFå°¾éƒ¨æ–‡ä»¶å‘½ä»¤å†™å…¥ä¸å…¨ã€‚Redisä¸ºæˆ‘ä»¬æä¾›äº†<code>aof-load-truncated</code>é…ç½®æ¥å…¼å®¹è¿™ç§æƒ…å†µï¼Œé»˜è®¤å¼€å¯ã€‚åŠ è½½AOFæ—¶ï¼Œå½“é‡åˆ°æ­¤é—®é¢˜æ—¶ä¼šå¿½ç•¥å¹¶ç»§ç»­å¯åŠ¨ï¼ŒåŒæ—¶æ‰“å°å¦‚ä¸‹è­¦å‘Šæ—¥å¿—ï¼š</p>
<figure class="highlight erlang-repl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># !!! Warning: short read while loading the AOF file !!!</span><br><span class="line"># !!! Truncating the AOF at offset <span class="number">397856725</span> !!!</span><br><span class="line"># AOF loaded anyway because aof-load-truncated is enabled</span><br></pre></td></tr></tbody></table></figure>

<h2 id="é—®é¢˜å®šä½ä¸ä¼˜åŒ–"><a href="#é—®é¢˜å®šä½ä¸ä¼˜åŒ–" class="headerlink" title="é—®é¢˜å®šä½ä¸ä¼˜åŒ–"></a>é—®é¢˜å®šä½ä¸ä¼˜åŒ–</h2><h3 id="fork-æ“ä½œ"><a href="#fork-æ“ä½œ" class="headerlink" title="fork æ“ä½œ"></a>fork æ“ä½œ</h3><p>å½“ Redis åš RDB æˆ– AOF é‡å†™æ—¶ï¼Œå¯¹äºå¤§å¤šæ•°æ“ä½œç³»ç»Ÿæ¥è¯´ fork æ˜¯ä¸ªé‡é‡çº§é”™è¯¯ã€‚forkæ“ä½œè€—æ—¶è·Ÿè¿›ç¨‹æ€»å†…å­˜é‡æ¯æ¯ç›¸å…³ï¼Œå¦‚æœä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯ Xen è™šæ‹Ÿæœºï¼Œfork æ“ä½œä¼šæ›´è€—æ—¶ã€‚</p>
<p>å¯¹äºé«˜å¹¶å‘ Redis å®ä¾‹ï¼Œå¦‚æœforkæ“ä½œè€—æ—¶åœ¨ç§’çº§åˆ«å°†æ‹–æ…¢ Redis å‡ ä¸‡æ¡å‘½ä»¤æ‰§è¡Œï¼Œå¯¹çº¿ä¸Šåº”ç”¨å»¶è¿Ÿå½±å“éå¸¸æ˜æ˜¾ã€‚æ­£å¸¸æƒ…å†µä¸‹ fork è€—æ—¶åº”è¯¥æ˜¯æ¯ GB æ¶ˆè€—20æ¯«ç§’å·¦å³ã€‚å¯ä»¥åœ¨<code>info stats</code>ç»Ÿè®¡ä¸­æŸ¥<code>latest_fork_usec</code>æŒ‡æ ‡è·å–æœ€è¿‘ä¸€æ¬¡ fork æ“ä½œè€—æ—¶ï¼Œå•ä½å¾®ç§’ã€‚</p>
<p>æ”¹å–„forkæ“ä½œçš„è€—æ—¶ï¼š</p>
<ol>
<li>ä¼˜å…ˆä½¿ç”¨ç‰©ç†æœºæˆ–è€…é«˜æ•ˆæ”¯æŒforkæ“ä½œçš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œé¿å…ä½¿ç”¨Xenã€‚</li>
<li>æ§åˆ¶ Redis å®ä¾‹æœ€å¤§å¯ç”¨å†…å­˜ï¼Œfork è€—æ—¶è·Ÿå†…å­˜é‡æˆæ­£æ¯”ï¼Œçº¿ä¸Šå»ºè®®æ¯ä¸ª Redis å®ä¾‹å†…å­˜æ§åˆ¶åœ¨ 10GB ä»¥å†…ã€‚</li>
<li>åˆç†é…ç½® Linux å†…å­˜åˆ†é…ç­–ç•¥ï¼Œé¿å…ç‰©ç†å†…å­˜ä¸è¶³å¯¼è‡´ fork å¤±è´¥ã€‚</li>
<li>é™ä½ fork æ“ä½œçš„é¢‘ç‡ï¼Œå¦‚é€‚åº¦æ”¾å®½ AOF è‡ªåŠ¨è§¦å‘æ—¶æœºï¼Œé¿å…ä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ç­‰ã€‚</li>
</ol>
<h3 id="å­è¿›ç¨‹å¼€é”€ç›‘æ§å’Œä¼˜åŒ–"><a href="#å­è¿›ç¨‹å¼€é”€ç›‘æ§å’Œä¼˜åŒ–" class="headerlink" title="å­è¿›ç¨‹å¼€é”€ç›‘æ§å’Œä¼˜åŒ–"></a>å­è¿›ç¨‹å¼€é”€ç›‘æ§å’Œä¼˜åŒ–</h3><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><ul>
<li>CPUå¼€é”€åˆ†æã€‚å­è¿›ç¨‹è´Ÿè´£æŠŠè¿›ç¨‹å†…çš„æ•°æ®åˆ†æ‰¹å†™å…¥æ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å±äºCPUå¯†é›†æ“ä½œï¼Œé€šå¸¸å­è¿›ç¨‹å¯¹å•æ ¸CPUåˆ©ç”¨ç‡æ¥è¿‘90%.</li>
<li>CPUæ¶ˆè€—ä¼˜åŒ–ã€‚Redisæ˜¯CPUå¯†é›†å‹æœåŠ¡ï¼Œä¸è¦åšç»‘å®šå•æ ¸CPUæ“ä½œã€‚ç”±äºå­è¿›ç¨‹éå¸¸æ¶ˆè€—CPUï¼Œä¼šå’Œçˆ¶è¿›ç¨‹äº§ç”Ÿå•æ ¸èµ„æºç«äº‰ã€‚</li>
<li>ä¸è¦å’Œå…¶ä»–CPUå¯†é›†å‹æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œé€ æˆCPUè¿‡åº¦ç«äº‰ã€‚</li>
<li>å¦‚æœéƒ¨ç½²å¤šä¸ªRediså®ä¾‹ï¼Œå°½é‡ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œé‡å†™å·¥ä½œã€‚</li>
</ul>
<h4 id="ç¡¬ç›˜å¼€é”€"><a href="#ç¡¬ç›˜å¼€é”€" class="headerlink" title="ç¡¬ç›˜å¼€é”€"></a>ç¡¬ç›˜å¼€é”€</h4><ul>
<li>ä¸è¦å’Œå…¶ä»–é«˜ç¡¬ç›˜è´Ÿè½½çš„æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ã€‚å¦‚ï¼šå­˜å‚¨æœåŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ç­‰ã€‚</li>
<li>AOFé‡å†™æ—¶ä¼šæ¶ˆè€—å¤§é‡ç¡¬ç›˜IOï¼Œå¯ä»¥å¼€å¯é…ç½®<code>no-appendfsync-on-rewrite</code>ï¼Œé»˜è®¤å…³é—­ã€‚è¡¨ç¤ºåœ¨AOFé‡å†™æœŸé—´ä¸åš<code>fsync</code>æ“ä½œã€‚</li>
<li>å½“å¼€å¯ AOF åŠŸèƒ½çš„ Redis ç”¨äºé«˜æµé‡å†™å…¥åœºæ™¯æ—¶ï¼Œå¦‚æœä½¿ç”¨æ™®é€šæœºæ¢°ç£ç›˜ï¼Œå†™å…¥ååä¸€èˆ¬åœ¨100MB/så·¦å³ï¼Œè¿™æ—¶ Redis å®ä¾‹çš„ç“¶é¢ˆä¸»è¦åœ¨ AOF åŒæ­¥ç¡¬ç›˜ä¸Šã€‚</li>
<li>å¯¹äºå•æœºé…ç½®å¤šä¸ª Redis å®ä¾‹çš„æƒ…å†µï¼Œå¯ä»¥é…ç½®ä¸åŒå®ä¾‹åˆ†ç›˜å­˜å‚¨ AOF æ–‡ä»¶ï¼Œåˆ†æ‘Šç¡¬ç›˜å†™å…¥å‹åŠ›ã€‚</li>
</ul>
<blockquote>
<p>âš ï¸ é…ç½®<code>no-appendfsync-on-rewrite=yes</code>æ—¶ï¼Œåœ¨æç«¯æƒ…å†µä¸‹å¯èƒ½ä¸¢å¤±æ•´ä¸ªAOFé‡å†™æœŸé—´çš„æ•°æ®ï¼Œéœ€è¦æ ¹æ®æ•°æ®å®‰å…¨æ€§å†³å®šæ˜¯å¦é…ç½®ã€‚</p>
</blockquote>
<h3 id="AOF-è¿½åŠ é˜»å¡"><a href="#AOF-è¿½åŠ é˜»å¡" class="headerlink" title="AOF è¿½åŠ é˜»å¡"></a>AOF è¿½åŠ é˜»å¡</h3><p>å½“ Redis æ‰§è¡Œ <code>fsync</code> åŒæ­¥æ—¶ï¼Œå¦‚æœç³»ç»Ÿç¡¬ç›˜ç¹å¿™ï¼Œä¼šé€ æˆ Redis ä¸»çº¿ç¨‹çš„é˜»å¡ã€‚<br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91co0mb8fj30g40hz770.jpg"></p>
<p>æ¯å½“å‘ç”Ÿ AOF è¿½åŠ é˜»å¡äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåœ¨<code>info Persistence</code>ç»Ÿè®¡ä¸­ï¼Œ<code>aof_delayed_fsync</code>æŒ‡æ ‡ä¼šç´¯åŠ ï¼ŒæŸ¥çœ‹è¿™ä¸ªæŒ‡æ ‡æ–¹ä¾¿å®šä½ AOF é˜»å¡é—®é¢˜ã€‚AOFåŒæ­¥æœ€å¤šå…è®¸2ç§’çš„å»¶è¿Ÿï¼Œå½“å»¶è¿Ÿå‘ç”Ÿæ—¶è¯´æ˜ç¡¬ç›˜å­˜åœ¨é«˜è´Ÿè½½é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ç›‘æ§å·¥å…·å¦‚<code>iotop</code>ï¼Œå®šä½æ¶ˆè€—ç¡¬ç›˜IOèµ„æºçš„è¿›ç¨‹ã€‚</p>
<h2 id="æœ¬ç« æ€»ç»“"><a href="#æœ¬ç« æ€»ç»“" class="headerlink" title="æœ¬ç« æ€»ç»“"></a>æœ¬ç« æ€»ç»“</h2><ul>
<li>RDBä½¿ç”¨ä¸€æ¬¡æ€§ç”Ÿæˆå†…å­˜å¿«ç…§çš„æ–¹å¼ï¼Œäº§ç”Ÿçš„æ–‡ä»¶ç´§å‡‘å‹ç¼©æ¯”æ›´é«˜ï¼Œå› æ­¤è¯»å–RDBæ¢å¤é€Ÿåº¦æ›´å¿«ã€‚ç”±äºæ¯æ¬¡ç”ŸæˆRDBå¼€é”€è¾ƒå¤§ï¼Œ<strong>æ— æ³•åšåˆ°å®æ—¶æŒä¹…åŒ–ï¼Œä¸€èˆ¬ç”¨äºæ•°æ®å†·å¤‡å’Œå¤åˆ¶ä¼ è¾“</strong>ã€‚</li>
<li>AOFé€šè¿‡è¿½åŠ å†™å‘½ä»¤åˆ°æ–‡ä»¶å®ç°æŒä¹…åŒ–ï¼Œé€šè¿‡<code>appendfsync</code>å‚æ•°å¯ä»¥æ§åˆ¶å®æ—¶/ç§’çº§æŒä¹…åŒ–ã€‚å› ä¸ºéœ€è¦ä¸æ–­è¿½åŠ å†™å‘½ä»¤ï¼Œæ‰€ä»¥AOFæ–‡ä»¶ä½“ç§¯é€æ¸å˜å¤§ï¼Œéœ€è¦å®šæœŸæ‰§è¡Œé‡å†™æ“ä½œæ¥é™ä½æ–‡ä»¶ä½“ç§¯ã€‚</li>
<li>AOFé‡å†™å¯ä»¥é€šè¿‡<code>auto-aof-rewrite-min-size</code> å’Œ <code>auto-aof-rewritepercentage</code>å‚æ•°æ§åˆ¶è‡ªåŠ¨è§¦å‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>bgrewriteaof</code>å‘½ä»¤æ‰‹åŠ¨è§¦å‘ã€‚</li>
<li>å­è¿›ç¨‹æ‰§è¡ŒæœŸé—´ä½¿ç”¨<code>copy-on-write</code>æœºåˆ¶ä¸çˆ¶è¿›ç¨‹å…±äº«å†…å­˜ï¼Œé¿å…å†…å­˜æ¶ˆè€—ç¿»å€ã€‚AOFé‡å†™æœŸé—´è¿˜éœ€è¦ç»´æŠ¤é‡å†™ç¼“å†²åŒºï¼Œä¿å­˜æ–°çš„å†™å…¥å‘½ä»¤é¿å…æ•°æ®ä¸¢å¤±ã€‚</li>
</ul>
<h1 id="ç¬¬-6-ç« -å¤åˆ¶"><a href="#ç¬¬-6-ç« -å¤åˆ¶" class="headerlink" title="ç¬¬ 6 ç«  å¤åˆ¶"></a>ç¬¬ 6 ç«  å¤åˆ¶</h1><h2 id="å»ºç«‹å¤åˆ¶"><a href="#å»ºç«‹å¤åˆ¶" class="headerlink" title="å»ºç«‹å¤åˆ¶"></a>å»ºç«‹å¤åˆ¶</h2><p>é…ç½®å¤åˆ¶çš„ä¸‰ç§æ–¹å¼</p>
<ol>
<li>åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥<code>slaveof {masterHost} {masterPort}</code> éšRediså¯åŠ¨ç”Ÿæ•ˆã€‚</li>
<li>åœ¨<code>redis-server</code>å¯åŠ¨å‘½ä»¤ååŠ å…¥<code>--slaveof {masterHost} {masterPort}</code> ç”Ÿæ•ˆã€‚</li>
<li>ç›´æ¥ä½¿ç”¨å‘½ä»¤<code>slaveof {masterHost} {masterPort}</code>ç”Ÿæ•ˆã€‚</li>
</ol>
<p>ä¸»ä»èŠ‚ç‚¹å¤åˆ¶æˆåŠŸå»ºç«‹åï¼Œå¯ä»¥ä½¿ç”¨<code>info replication</code>å‘½ä»¤æŸ¥çœ‹å¤åˆ¶ç›¸å…³çŠ¶æ€ã€‚</p>
<h2 id="æ–­å¼€å¤åˆ¶"><a href="#æ–­å¼€å¤åˆ¶" class="headerlink" title="æ–­å¼€å¤åˆ¶"></a>æ–­å¼€å¤åˆ¶</h2><p><code>slaveof</code>å‘½ä»¤ä¸ä½†å¯ä»¥å»ºç«‹å¤åˆ¶ï¼Œè¿˜å¯ä»¥åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œ<code>slaveof no one</code>æ¥æ–­å¼€ä¸ä¸»èŠ‚ç‚¹å¤åˆ¶å…³ç³»ã€‚åŒæ—¶ï¼Œ<code>slaveof {newMasterIp} {newMasterPort}</code>è¿˜å¯ä»¥å®ç°åˆ‡ä¸»æ“ä½œï¼Œæ›´æ¢ä¸»èŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>âš ï¸ åˆ‡ä¸»åä»èŠ‚ç‚¹ä¼šæ¸…ç©ºä¹‹å‰æ‰€æœ‰çš„æ•°æ®ï¼Œçº¿ä¸Šäººå·¥æ“ä½œæ—¶å°å¿ƒ<code>slaveof</code>åœ¨é”™è¯¯çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œæˆ–è€…æŒ‡å‘é”™è¯¯çš„ä¸»èŠ‚ç‚¹ã€‚</p>
</blockquote>
<p>å¯¹äºæ•°æ®æ¯”è¾ƒé‡è¦çš„èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹ä¼šé€šè¿‡è®¾ç½®<code>requirepass</code>å‚æ•°è¿›è¡Œå¯†ç éªŒè¯ï¼Œè¿™æ—¶æ‰€æœ‰çš„å®¢æˆ·ç«¯è®¿é—®å¿…é¡»ä½¿ç”¨<code>auth</code>å‘½ä»¤å®è¡Œæ ¡éªŒã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹ä½¿ç”¨<code>slave-read-only=yes</code>é…ç½®ä¸ºåªè¯»æ¨¡å¼ã€‚ç”±äºå¤åˆ¶åªèƒ½ä»ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹ï¼Œå¯¹äºä»èŠ‚ç‚¹çš„ä»»ä½•ä¿®æ”¹ä¸»èŠ‚ç‚¹éƒ½æ— æ³•æ„ŸçŸ¥ï¼Œä¿®æ”¹ä»èŠ‚ç‚¹ä¼šé€ æˆä¸»ä»æ•°æ®ä¸ä¸€è‡´ã€‚å› æ­¤å»ºè®®çº¿ä¸Šä¸è¦ä¿®æ”¹ä»èŠ‚ç‚¹çš„åªè¯»æ¨¡å¼ã€‚</p>
<p>Redisä¸ºæˆ‘ä»¬æä¾›äº†<code>repl-disable-tcp-nodelay</code>å‚æ•°ç”¨äºæ§åˆ¶æ˜¯å¦å…³é—­<code>TCP_NODELAY</code>ï¼Œé»˜è®¤å…³é—­ï¼Œè¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>å½“å…³é—­æ—¶ï¼Œä¸»èŠ‚ç‚¹äº§ç”Ÿçš„å‘½ä»¤æ•°æ®æ— è®ºå¤§å°éƒ½ä¼šåŠæ—¶åœ°å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè¿™æ ·ä¸»ä»ä¹‹é—´å»¶è¿Ÿä¼šå˜å°ï¼Œä½†å¢åŠ äº†ç½‘ç»œå¸¦å®½çš„æ¶ˆè€—ã€‚é€‚ç”¨äºä¸»ä»ä¹‹é—´çš„ç½‘ç»œç¯å¢ƒè‰¯å¥½çš„åœºæ™¯ï¼Œå¦‚åŒæœºæ¶æˆ–åŒæœºæˆ¿éƒ¨ç½²ã€‚</li>
<li>å½“å¼€å¯æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šåˆå¹¶è¾ƒå°çš„TCPæ•°æ®åŒ…ä»è€ŒèŠ‚çœå¸¦å®½ã€‚é»˜è®¤å‘é€æ—¶é—´é—´éš”å–å†³äºLinuxçš„å†…æ ¸ï¼Œä¸€èˆ¬é»˜è®¤ä¸º40æ¯«ç§’ã€‚è¿™ç§é…ç½®èŠ‚çœäº†å¸¦å®½ä½†å¢å¤§ä¸»ä»ä¹‹é—´çš„å»¶è¿Ÿã€‚é€‚ç”¨äºä¸»ä»ç½‘ç»œç¯å¢ƒå¤æ‚æˆ–å¸¦å®½ç´§å¼ çš„åœºæ™¯ï¼Œå¦‚è·¨æœºæˆ¿éƒ¨ç½²ã€‚</li>
</ul>
<h2 id="æ‹“æ‰‘"><a href="#æ‹“æ‰‘" class="headerlink" title="æ‹“æ‰‘"></a>æ‹“æ‰‘</h2><p>æ ¹æ®æ‹“æ‰‘çš„å¤æ‚æ€§ï¼Œå¯åˆ†ä¸ºä¸‰ç§ï¼šä¸€ä¸»ä¸€ä»ã€ä¸€ä¸»å¤šä»ã€æ ‘çŠ¶ä¸»ä»ç»“æ„ã€‚</p>
<h3 id="ä¸€ä¸»ä¸€ä»"><a href="#ä¸€ä¸»ä¸€ä»" class="headerlink" title="ä¸€ä¸»ä¸€ä»"></a>ä¸€ä¸»ä¸€ä»</h3><p>å½“åº”ç”¨å†™å‘½ä»¤å¹¶å‘é‡è¾ƒé«˜ä¸”éœ€è¦æŒä¹…åŒ–æ—¶ï¼Œå¯ä»¥åªåœ¨ä»èŠ‚ç‚¹ä¸Šå¼€å¯AOFï¼Œè¿™æ ·æ—¢ä¿è¯æ•°æ®å®‰å…¨æ€§åŒæ—¶ä¹Ÿé¿å…äº†æŒä¹…åŒ–å¯¹ä¸»èŠ‚ç‚¹çš„æ€§èƒ½å¹²æ‰°ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä¸»èŠ‚ç‚¹å…³é—­æŒä¹…åŒ–åŠŸèƒ½æ—¶ï¼Œå¦‚æœä¸»èŠ‚ç‚¹è„±æœºè¦é¿å…è‡ªåŠ¨é‡å¯æ“ä½œã€‚å› ä¸ºä¸»èŠ‚ç‚¹ä¹‹å‰æ²¡æœ‰å¼€å¯æŒä¹…åŒ–åŠŸèƒ½è‡ªåŠ¨é‡å¯åæ•°æ®é›†ä¸ºç©ºï¼Œè¿™æ—¶ä»èŠ‚ç‚¹å¦‚æœç»§ç»­å¤åˆ¶ä¸»èŠ‚ç‚¹ä¼šå¯¼è‡´ä»èŠ‚ç‚¹æ•°æ®ä¹Ÿè¢«æ¸…ç©ºçš„æƒ…å†µï¼Œä¸§å¤±äº†æŒä¹…åŒ–çš„æ„ä¹‰ã€‚å®‰å…¨çš„åšæ³•æ˜¯åœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œ<code>slaveof no one</code>æ–­å¼€ä¸ä¸»èŠ‚ç‚¹çš„å¤åˆ¶å…³ç³»ï¼Œå†é‡å¯ä¸»èŠ‚ç‚¹ä»è€Œé¿å…è¿™ä¸€é—®é¢˜ã€‚</p>
<h3 id="ä¸€ä¸»å¤šä»"><a href="#ä¸€ä¸»å¤šä»" class="headerlink" title="ä¸€ä¸»å¤šä»"></a>ä¸€ä¸»å¤šä»</h3><p>å¯¹äºå†™å¹¶å‘é‡è¾ƒé«˜çš„åœºæ™¯ï¼Œå¤šä¸ªä»èŠ‚ç‚¹ä¼šå¯¼è‡´ä¸»èŠ‚ç‚¹å†™å‘½ä»¤çš„å¤šæ¬¡å‘é€ä»è€Œè¿‡åº¦æ¶ˆè€—ç½‘ç»œå¸¦å®½ï¼ŒåŒæ—¶ä¹ŸåŠ é‡äº†ä¸»èŠ‚ç‚¹çš„è´Ÿè½½å½±å“æœåŠ¡ç¨³å®šæ€§ã€‚</p>
<h3 id="æ ‘çŠ¶ä¸»ä»ç»“æ„"><a href="#æ ‘çŠ¶ä¸»ä»ç»“æ„" class="headerlink" title="æ ‘çŠ¶ä¸»ä»ç»“æ„"></a>æ ‘çŠ¶ä¸»ä»ç»“æ„</h3><p>å½“ä¸»èŠ‚ç‚¹éœ€è¦æŒ‚è½½å¤šä¸ªä»èŠ‚ç‚¹æ—¶ä¸ºäº†é¿å…å¯¹ä¸»èŠ‚ç‚¹çš„æ€§èƒ½å¹²æ‰°ï¼Œå¯ä»¥é‡‡ç”¨æ ‘çŠ¶ä¸»ä»ç»“æ„é™ä½ä¸»èŠ‚ç‚¹å‹åŠ›ã€‚</p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91e0yu7flj30if0o442t.jpg"></p>
<h3 id="æ•°æ®åŒæ­¥"><a href="#æ•°æ®åŒæ­¥" class="headerlink" title="æ•°æ®åŒæ­¥"></a>æ•°æ®åŒæ­¥</h3><p>Redis åœ¨åˆæ¬¡å¤åˆ¶æ—¶ï¼Œä¼šè¿›è¡Œå…¨é‡å¤åˆ¶ï¼Œä¹‹åä¾¿ä¼šæ ¹æ®ä¸»ä»èŠ‚ç‚¹çš„å¤åˆ¶åç§»é‡è¿›è¡Œ<code>psync</code>å¢é‡å¤åˆ¶ã€‚</p>
<p><code>psync</code>å‘½ä»¤è¿è¡Œéœ€è¦ä»¥ä¸‹ç»„ä»¶æ”¯æŒï¼š</p>
<ul>
<li>ä¸»ä»èŠ‚ç‚¹å„è‡ªå¤åˆ¶åç§»é‡ã€‚</li>
<li>ä¸»èŠ‚ç‚¹å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚</li>
<li>ä¸»èŠ‚ç‚¹è¿è¡Œidã€‚</li>
</ul>
<h4 id="å¤åˆ¶åç§»é‡"><a href="#å¤åˆ¶åç§»é‡" class="headerlink" title="å¤åˆ¶åç§»é‡"></a>å¤åˆ¶åç§»é‡</h4><p>å‚ä¸å¤åˆ¶çš„ä¸»ä»èŠ‚ç‚¹éƒ½ä¼šç»´æŠ¤è‡ªèº«å¤åˆ¶åç§»é‡ã€‚ä¸»èŠ‚ç‚¹åœ¨ç†å®Œå†™å…¥å‘½ä»¤åï¼Œä¼šæŠŠå‘½ä»¤çš„å­—èŠ‚é•¿åº¦åšç´¯åŠ è®°å½•ï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨<code>info relication</code>ä¸­çš„<code>master_repl_offset</code>æŒ‡æ ‡ä¸­ï¼Œä»èŠ‚ç‚¹ä¼šæ¯ç§’é’Ÿä¸ŠæŠ¥è‡ªèº«çš„å¤åˆ¶åç§»é‡ç»™ä¸»èŠ‚ç‚¹ï¼Œå› æ­¤ä¸»èŠ‚ç‚¹ä¹Ÿä¼šä¿å­˜ä»èŠ‚ç‚¹çš„å¤åˆ¶åç§»é‡ã€‚ä»èŠ‚ç‚¹åœ¨æ¥æ”¶åˆ°ä¸»èŠ‚ç‚¹å‘é€çš„å‘½ä»¤åï¼Œä¹Ÿä¼šç´¯åŠ è®°å½•è‡ªèº«çš„åç§»é‡ã€‚ç»Ÿè®¡ä¿¡æ¯åœ¨<code>info relication</code>ä¸­çš„<code>slave_repl_offset</code>æŒ‡æ ‡ä¸­ã€‚</p>
<p>å¯ä»¥é€šè¿‡ä¸»èŠ‚ç‚¹çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œè®¡ç®—å‡º<code>master_repl_offset_slave_offset</code>å­—èŠ‚é‡ï¼Œåˆ¤æ–­ä¸»ä»èŠ‚ç‚¹å¤åˆ¶ç›¸å·®çš„æ•°æ®é‡ï¼Œæ ¹æ®è¿™ä¸ªå·®å€¼åˆ¤å®šå½“å‰å¤åˆ¶çš„å¥åº·åº¦ã€‚å¦‚æœä¸»ä»ä¹‹é—´å¤åˆ¶åç§»é‡ç›¸å·®è¾ƒå¤§ï¼Œåˆ™å¯èƒ½æ˜¯ç½‘ç»œå»¶è¿Ÿæˆ–å‘½ä»¤é˜»å¡ç­‰åŸå› å¼•èµ·ã€‚</p>
<h4 id="å¤åˆ¶ç§¯å‹ç¼“å†²åŒº"><a href="#å¤åˆ¶ç§¯å‹ç¼“å†²åŒº" class="headerlink" title="å¤åˆ¶ç§¯å‹ç¼“å†²åŒº"></a>å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</h4><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91vyy7e25j30h909875n.jpg"></p>
<p>ä¸»èŠ‚ç‚¹å“åº”ä»èŠ‚ç‚¹çš„åŒæ­¥æ—¶ï¼Œä¸ä½†ä¼šæŠŠå‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè¿˜ä¼šå†™å…¥å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚ç”±äºç¼“å†²åŒºæœ¬è´¨ä¸Šæ˜¯å…ˆè¿›å…ˆå‡ºçš„å®šé•¿é˜Ÿåˆ—ï¼Œæ‰€ä»¥èƒ½å®ç°ä¿å­˜æœ€è¿‘å·²å¤åˆ¶æ•°æ®çš„åŠŸèƒ½ï¼Œç”¨äºéƒ¨åˆ†å¤åˆ¶å’Œå¤åˆ¶å‘½ä»¤ä¸¢å¤±çš„æ•°æ®è¡¥æ•‘ã€‚å¤åˆ¶ç¼“å†²åŒºç›¸å…³ç»Ÿè®¡ä¿¡æ¯ä¿å­˜åœ¨ä¸»èŠ‚ç‚¹çš„<code>info replication</code>ä¸­ã€‚</p>
<h4 id="ä¸»èŠ‚ç‚¹è¿è¡ŒID"><a href="#ä¸»èŠ‚ç‚¹è¿è¡ŒID" class="headerlink" title="ä¸»èŠ‚ç‚¹è¿è¡ŒID"></a>ä¸»èŠ‚ç‚¹è¿è¡ŒID</h4><p>æ¯ä¸ªRedisèŠ‚ç‚¹å¯åŠ¨åéƒ½ä¼šåŠ¨æ€åˆ†é…ä¸€ä¸ª40ä½çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ä½œä¸ºè¿è¡ŒIDã€‚è¿è¡ŒIDçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å”¯ä¸€è¯†åˆ«RedisèŠ‚ç‚¹ï¼Œæ¯”å¦‚ä»èŠ‚ç‚¹ä¿å­˜ä¸»èŠ‚ç‚¹çš„è¿è¡ŒIDè¯†åˆ«è‡ªå·±æ­£åœ¨å¤åˆ¶çš„æ˜¯å“ªä¸ªä¸»èŠ‚ç‚¹ã€‚å¦‚æœåªä½¿ç”¨ip+portçš„æ–¹å¼è¯†åˆ«ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹é‡å¯å˜æ›´äº†æ•´ä½“æ•°æ®é›†ï¼ˆå¦‚æ›¿æ¢RDB/AOFæ–‡ä»¶ï¼‰ï¼Œä»èŠ‚ç‚¹å†åŸºäºåç§»é‡å¤åˆ¶æ•°æ®å°†æ˜¯ä¸å®‰å…¨çš„ï¼Œå› æ­¤å½“è¿è¡ŒIDå˜åŒ–åä»èŠ‚ç‚¹å°†åšå…¨é‡å¤åˆ¶ã€‚å¯ä»¥è¿è¡Œ<code>info server</code>å‘½ä»¤æŸ¥çœ‹å½“å‰èŠ‚ç‚¹çš„è¿è¡ŒIDã€‚</p>
<p>å½“éœ€è¦è°ƒä¼˜ä¸€äº›å†…å­˜ç›¸å…³é…ç½®ï¼Œä¾‹å¦‚ï¼š<code>hash-max-ziplist-value</code>ç­‰ï¼Œè¿™äº›é…ç½®éœ€è¦Redisé‡æ–°åŠ è½½æ‰èƒ½ä¼˜åŒ–å·²å­˜åœ¨çš„æ•°æ®ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨<code>debug reload</code>å‘½ä»¤é‡æ–°åŠ è½½ RDB å¹¶ä¿æŒè¿è¡Œ ID ä¸å˜ï¼Œä»è€Œæœ‰æ•ˆé¿å…ä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ã€‚</p>
<blockquote>
<p><code>debug reload</code>å‘½ä»¤ä¼šé˜»å¡å½“å‰RedisèŠ‚ç‚¹ä¸»çº¿ç¨‹ï¼Œé˜»å¡æœŸé—´ä¼šç”Ÿæˆæœ¬åœ°RDBå¿«ç…§å¹¶æ¸…ç©ºæ•°æ®ä¹‹åå†åŠ è½½RDBæ–‡ä»¶ã€‚å› æ­¤å¯¹äºå¤§æ•°æ®é‡çš„ä¸»èŠ‚ç‚¹å’Œæ— æ³•å®¹å¿é˜»å¡çš„åº”ç”¨åœºæ™¯ï¼Œè°¨æ…ä½¿ç”¨ã€‚</p>
</blockquote>
<h4 id="psync-å‘½ä»¤"><a href="#psync-å‘½ä»¤" class="headerlink" title="psync å‘½ä»¤"></a>psync å‘½ä»¤</h4><p>ä»èŠ‚ç‚¹ä½¿ç”¨<code>psync</code>å‘½ä»¤å®Œæˆéƒ¨åˆ†å¤åˆ¶å’Œå…¨é‡å¤åˆ¶åŠŸèƒ½ï¼Œå‘½ä»¤æ ¼å¼ï¼š<code>psync {runId} {offset}</code></p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91xk5bba1j30jh0hejtq.jpg"></p>
<p>ä¸»èŠ‚ç‚¹å›å¤<code>+FULLRESYNC {runId} {offset}</code>ä¼šè§¦å‘å…¨é‡å¤åˆ¶ï¼Œ<code>+CONTINUE</code>åˆ™è§¦å‘å¢é‡å¤åˆ¶ã€‚</p>
<h4 id="å…¨é‡åŒæ­¥"><a href="#å…¨é‡åŒæ­¥" class="headerlink" title="å…¨é‡åŒæ­¥"></a>å…¨é‡åŒæ­¥</h4><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91xn7bm5rj30j30lqgp7.jpg"></p>
<p>å¯¹äºä»èŠ‚ç‚¹å¼€å§‹æ¥æ”¶RDBå¿«ç…§åˆ°æ¥æ”¶å®ŒæˆæœŸé—´ï¼Œä¸»èŠ‚ç‚¹ä»ç„¶å“åº”è¯»å†™å‘½ä»¤ï¼Œå› æ­¤ä¸»èŠ‚ç‚¹ä¼šæŠŠè¿™æœŸé—´å†™å‘½ä»¤æ•°æ®ä¿å­˜åœ¨å¤åˆ¶å®¢æˆ·ç«¯ç¼“å†²åŒºå†…ï¼Œå½“ä»èŠ‚ç‚¹åŠ è½½å®ŒRDBæ–‡ä»¶åï¼Œä¸»èŠ‚ç‚¹å†æŠŠç¼“å†²åŒºå†…çš„æ•°æ®å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä¿è¯ä¸»ä»ä¹‹é—´æ•°æ®ä¸€è‡´æ€§ã€‚å¦‚æœ RDB æ–‡ä»¶è¿‡å¤§ï¼Œè¶…è¿‡é¢„è®¾çš„ timeoutï¼Œåˆ™ä¼šç»ˆæ­¢å…¨é‡åŒæ­¥ï¼Œå¹¶æ¸…é™¤å·²ä¸‹è½½ä¸´æ—¶æ–‡ä»¶ã€‚å¦‚æœåœ¨é«˜å¹¶å‘å†™çš„åœºæ™¯ï¼Œä¸»èŠ‚ç‚¹çš„ç¼“å†²åŒºè¢«å†™æ»¡ï¼ŒåŒæ ·ä¼šå¯¼è‡´åŒæ­¥çš„å¤±è´¥ã€‚</p>
<p>å…¨é‡å¤åˆ¶çš„ä¸»è¦æ—¶é—´å¼€é”€åœ¨ï¼š</p>
<ul>
<li>ä¸»èŠ‚ç‚¹ <code>bgsave</code> æ—¶é—´</li>
<li>RDB æ–‡ä»¶ç½‘ç»œä¼ è¾“æ—¶é—´</li>
<li>ä»èŠ‚ç‚¹æ¸…ç©ºæ•°æ®æ—¶é—´</li>
<li>ä»èŠ‚ç‚¹åŠ è½½ RDB æ—¶é—´</li>
<li>å¯èƒ½çš„ AOF é‡å†™æ—¶é—´</li>
</ul>
<h4 id="å¢é‡åŒæ­¥"><a href="#å¢é‡åŒæ­¥" class="headerlink" title="å¢é‡åŒæ­¥"></a>å¢é‡åŒæ­¥</h4><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91xwacukej30hu0d8gnx.jpg"></p>
<h4 id="å¿ƒè·³"><a href="#å¿ƒè·³" class="headerlink" title="å¿ƒè·³"></a>å¿ƒè·³</h4><p>ä¸»ä»å¿ƒè·³åˆ¤æ–­æœºåˆ¶ï¼š</p>
<ul>
<li>é€šè¿‡<code>client list</code>å‘½ä»¤æŸ¥çœ‹å¤åˆ¶ç›¸å…³å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä¸»èŠ‚ç‚¹çš„è¿æ¥çŠ¶æ€ä¸º<code>flags=M</code>ï¼Œä»èŠ‚ç‚¹è¿æ¥çŠ¶æ€ä¸º<code>flags=S</code>ã€‚</li>
<li>ä¸»èŠ‚ç‚¹é»˜è®¤æ¯éš”10ç§’å¯¹ä»èŠ‚ç‚¹å‘é€<code>ping</code>å‘½ä»¤ï¼Œåˆ¤æ–­ä»èŠ‚ç‚¹çš„å­˜æ´»æ€§å’Œè¿æ¥çŠ¶æ€ã€‚å¯é€šè¿‡å‚æ•°<code>repl-ping-slave-period</code>æ§åˆ¶å‘é€é¢‘ç‡ã€‚</li>
<li>ä»èŠ‚ç‚¹åœ¨ä¸»çº¿ç¨‹ä¸­æ¯éš”1ç§’å‘é€<code>replconf ack{offset}</code>å‘½ä»¤ï¼Œç»™ä¸»èŠ‚ç‚¹ä¸ŠæŠ¥è‡ªèº«å½“å‰çš„å¤åˆ¶åç§»é‡ã€‚<code>replconf</code>å‘½ä»¤ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š<ul>
<li>å®æ—¶ç›‘æµ‹ä¸»ä»èŠ‚ç‚¹ç½‘ç»œçŠ¶æ€</li>
<li>ä¸ŠæŠ¥è‡ªèº«å¤åˆ¶åç§»é‡ï¼Œæ£€æŸ¥å¤åˆ¶æ•°æ®æ˜¯å¦ä¸¢å¤±ï¼Œå¦‚æœä»èŠ‚ç‚¹æ•°æ®ä¸¢å¤±ï¼Œå†ä»ä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºä¸­æ‹‰å–ä¸¢å¤±æ•°æ®</li>
<li>å®ç°ä¿è¯ä»èŠ‚ç‚¹çš„æ•°é‡å’Œå»¶è¿Ÿæ€§åŠŸèƒ½ï¼Œé€šè¿‡min-slaves-to-writeã€minslaves-max-lagå‚æ•°é…ç½®å®šä¹‰</li>
</ul>
</li>
</ul>
<blockquote>
<p>æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°æ•°æ®åŒæ­¥çš„é—®é¢˜ï¼Œä½†å¦‚ä½•åœ¨æ¶ˆè€—æœ€å°‘çš„èµ„æºä¸‹ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§æ˜¯æˆ‘ä»¬ä¸€ç›´ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œå¥½åœ¨ï¼Œå¾ˆå¤šæˆç†Ÿçš„ è½¯ä»¶å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†å€Ÿé‰´çš„æ–¹æ¡ˆï¼Œå¦‚ Git çš„ hash chainï¼ŒRedis çš„ <code>psync</code> åç§»é‡å¢é‡å¤åˆ¶ä¸ç¼“å†²åŒºï¼Œä»¥åŠ MySQL çš„<code>binlog</code>ã€‚æ²¡æœ‰æœ€å¥½çš„æ–¹æ¡ˆï¼Œåªæœ‰æœ€åˆé€‚çš„æ–¹æ¡ˆï¼Œæˆ–è®¸æˆ‘ä»¬èƒ½ä»ä¸­å¾—åˆ°å¯å‘ï¼Œæ‰¾åˆ°æœ€é€‚åˆè‡ªå·±çš„å¢é‡åŒæ­¥æ–¹å¼ã€‚</p>
</blockquote>
<h2 id="å¼€å‘ä¸è¿ç»´ä¸­çš„é—®é¢˜"><a href="#å¼€å‘ä¸è¿ç»´ä¸­çš„é—®é¢˜" class="headerlink" title="å¼€å‘ä¸è¿ç»´ä¸­çš„é—®é¢˜"></a>å¼€å‘ä¸è¿ç»´ä¸­çš„é—®é¢˜</h2><h3 id="æ•°æ®å»¶æ—¶"><a href="#æ•°æ®å»¶æ—¶" class="headerlink" title="æ•°æ®å»¶æ—¶"></a>æ•°æ®å»¶æ—¶</h3><p>Rediså¤åˆ¶æ•°æ®çš„å»¶è¿Ÿç”±äºå¼‚æ­¥å¤åˆ¶ç‰¹æ€§æ˜¯æ— æ³•é¿å…çš„ï¼Œå»¶è¿Ÿå–å†³äºç½‘ç»œå¸¦å®½å’Œå‘½ä»¤é˜»å¡æƒ…å†µã€‚éœ€è¦ä¸šåŠ¡åœºæ™¯å…è®¸çŸ­æ—¶é—´å†…çš„æ•°æ®å»¶è¿Ÿã€‚å¯¹äºæ— æ³•å®¹å¿å¤§é‡å»¶è¿Ÿåœºæ™¯ï¼Œå¯ä»¥ç¼–å†™å¤–éƒ¨ç›‘æ§ç¨‹åºç›‘å¬ä¸»ä»èŠ‚ç‚¹çš„å¤åˆ¶åç§»é‡ï¼Œå½“å»¶è¿Ÿè¾ƒå¤§æ—¶è§¦å‘æŠ¥è­¦æˆ–è€…é€šçŸ¥å®¢æˆ·ç«¯é¿å…è¯»å–å»¶è¿Ÿè¿‡é«˜çš„ä»èŠ‚ç‚¹ã€‚</p>
<h3 id="è¯»åˆ°è¿‡æœŸæ•°æ®"><a href="#è¯»åˆ°è¿‡æœŸæ•°æ®" class="headerlink" title="è¯»åˆ°è¿‡æœŸæ•°æ®"></a>è¯»åˆ°è¿‡æœŸæ•°æ®</h3><p>æƒ°æ€§åˆ é™¤ï¼šä¸»èŠ‚ç‚¹å°†è¿‡æœŸçš„é”®åŒæ­¥ç»™ä»èŠ‚ç‚¹<br>å®šæ—¶åˆ é™¤ï¼šä¸»èŠ‚ç‚¹è½®è¯¢é‡‡æ ·ä¸€å®šæ•°é‡çš„é”®ï¼Œå½“é‡‡æ ·çš„é”®è¿‡æœŸåï¼ŒåŒæ­¥ç»™ä»èŠ‚ç‚¹ã€‚<br>Redis 3.2+ åœ¨ä»èŠ‚ç‚¹è¯»å–é”®æ—¶ä¼šæ ¡éªŒæ˜¯å¦è¿‡æœŸä»¥åˆ¤æ–­æ˜¯å¦è¿”å›æ•°æ®ã€‚</p>
<h3 id="ä»èŠ‚ç‚¹æ•…éšœ"><a href="#ä»èŠ‚ç‚¹æ•…éšœ" class="headerlink" title="ä»èŠ‚ç‚¹æ•…éšœ"></a>ä»èŠ‚ç‚¹æ•…éšœ</h3><p>ä¸‹çº¿æ•…éšœèŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>å½“ä¸»èŠ‚ç‚¹ä¼˜åŒ–ç©ºé—´ä¸å¤§æ—¶å†è€ƒè™‘æ‰©å±•ã€‚ç¬”è€…å»ºè®®å¤§å®¶åœ¨åšè¯»å†™åˆ†ç¦»ä¹‹å‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨Redis Clusterç­‰åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆï¼Œè¿™æ ·ä¸æ­¢æ‰©å±•äº†è¯»æ€§èƒ½è¿˜å¯ä»¥æ‰©å±•å†™æ€§èƒ½å’Œå¯æ”¯æ’‘æ•°æ®è§„æ¨¡ï¼Œå¹¶ä¸”ä¸€è‡´æ€§å’Œæ•…éšœè½¬ç§»ä¹Ÿå¯ä»¥å¾—åˆ°ä¿è¯ï¼Œå¯¹äºå®¢æˆ·ç«¯çš„ç»´æŠ¤é€»è¾‘ä¹Ÿç›¸å¯¹å®¹æ˜“ã€‚</p>
</blockquote>
<h3 id="è§„é¿å…¨é‡å¤åˆ¶"><a href="#è§„é¿å…¨é‡å¤åˆ¶" class="headerlink" title="è§„é¿å…¨é‡å¤åˆ¶"></a>è§„é¿å…¨é‡å¤åˆ¶</h3><ul>
<li>ç¬¬ä¸€æ¬¡å»ºç«‹å¤åˆ¶ï¼šç”±äºæ˜¯ç¬¬ä¸€æ¬¡å»ºç«‹å¤åˆ¶ï¼Œä»èŠ‚ç‚¹ä¸åŒ…å«ä»»ä½•ä¸»èŠ‚ç‚¹æ•°æ®ï¼Œå› æ­¤å¿…é¡»è¿›è¡Œå…¨é‡å¤åˆ¶æ‰èƒ½å®Œæˆæ•°æ®åŒæ­¥ã€‚å¯¹äºè¿™ç§æƒ…å†µå…¨é‡å¤åˆ¶æ— æ³•é¿å…ã€‚å½“å¯¹æ•°æ®é‡è¾ƒå¤§ä¸”æµé‡è¾ƒé«˜çš„ä¸»èŠ‚ç‚¹æ·»åŠ ä»èŠ‚ç‚¹æ—¶ï¼Œå»ºè®®åœ¨ä½å³°æ—¶è¿›è¡Œæ“ä½œï¼Œæˆ–è€…å°½é‡è§„é¿ä½¿ç”¨å¤§æ•°æ®é‡çš„RedisèŠ‚ç‚¹ã€‚</li>
<li>èŠ‚ç‚¹è¿è¡ŒIDä¸åŒ¹é…ï¼šå½“ä¸»ä»å¤åˆ¶å…³ç³»å»ºç«‹åï¼Œä»èŠ‚ç‚¹ä¼šä¿å­˜ä¸»èŠ‚ç‚¹çš„è¿è¡ŒIDï¼Œå¦‚æœæ­¤æ—¶ä¸»èŠ‚ç‚¹å› æ•…éšœé‡å¯ï¼Œé‚£ä¹ˆå®ƒçš„è¿è¡ŒIDä¼šæ”¹å˜ï¼Œä»èŠ‚ç‚¹å‘ç°ä¸»èŠ‚ç‚¹è¿è¡ŒIDä¸åŒ¹é…æ—¶ï¼Œä¼šè®¤ä¸ºè‡ªå·±å¤åˆ¶çš„æ˜¯ä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ä»è€Œè¿›è¡Œå…¨é‡å¤åˆ¶ã€‚å¯¹äºè¿™ç§æƒ…å†µåº”è¯¥ä»æ¶æ„ä¸Šè§„é¿ï¼Œæ¯”å¦‚æä¾›æ•…éšœè½¬ç§»åŠŸèƒ½ã€‚å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœåï¼Œæ‰‹åŠ¨æå‡ä»èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹æˆ–è€…é‡‡ç”¨æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»çš„å“¨å…µæˆ–é›†ç¾¤æ–¹æ¡ˆã€‚</li>
<li>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸è¶³ï¼šå½“ä¸»ä»èŠ‚ç‚¹ç½‘ç»œä¸­æ–­åï¼Œä»èŠ‚ç‚¹å†æ¬¡è¿ä¸Šä¸»èŠ‚ç‚¹æ—¶ä¼šå‘é€<code>psync {offset} {runId}</code>å‘½ä»¤è¯·æ±‚éƒ¨åˆ†å¤åˆ¶ï¼Œ<strong>å¦‚æœè¯·æ±‚çš„åç§»é‡ä¸åœ¨ä¸»èŠ‚ç‚¹çš„ç§¯å‹ç¼“å†²åŒºå†…ï¼Œåˆ™æ— æ³•æä¾›ç»™ä»èŠ‚ç‚¹æ•°æ®ï¼Œå› æ­¤éƒ¨åˆ†å¤åˆ¶ä¼šé€€åŒ–ä¸ºå…¨é‡å¤åˆ¶</strong>ã€‚æ­¤æ—¶éœ€è¦ä¿è¯<code>repl_backlog_size &gt; net_break_time*write_size_per_minute</code>ä»¥é¿å…ç¼“å†²åŒºä¸è¶³å¼•å‘çš„å…¨é‡å¤åˆ¶ã€‚</li>
</ul>
<h3 id="è§„é¿å¤åˆ¶é£æš´"><a href="#è§„é¿å¤åˆ¶é£æš´" class="headerlink" title="è§„é¿å¤åˆ¶é£æš´"></a>è§„é¿å¤åˆ¶é£æš´</h3><h4 id="å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´"><a href="#å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´" class="headerlink" title="å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´"></a>å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´</h4><p>ä¸€èˆ¬å‘ç”Ÿåœ¨ä¸»èŠ‚ç‚¹æŒ‚è½½å¤šä¸ªä»èŠ‚ç‚¹çš„åœºæ™¯ã€‚å½“ä¸»èŠ‚ç‚¹é‡å¯æ¢å¤åï¼Œä»èŠ‚ç‚¹ä¼šå‘èµ·å…¨é‡å¤åˆ¶æµç¨‹ï¼Œè¿™æ—¶ä¸»èŠ‚ç‚¹å°±ä¼šä¸ºä»èŠ‚ç‚¹åˆ›å»ºRDBå¿«ç…§ï¼Œå¦‚æœåœ¨å¿«ç…§åˆ›å»ºå®Œæ¯•ä¹‹å‰ï¼Œæœ‰å¤šä¸ªä»èŠ‚ç‚¹éƒ½å°è¯•ä¸ä¸»èŠ‚ç‚¹è¿›è¡Œå…¨é‡åŒæ­¥ï¼Œé‚£ä¹ˆå…¶ä»–ä»èŠ‚ç‚¹å°†å…±äº«è¿™ä»½RDBå¿«ç…§ï¼ŒåŒæ—¶å‘å¤šä¸ªä»èŠ‚ç‚¹å‘é€RDBå¿«ç…§ï¼Œå¯èƒ½ä½¿ä¸»èŠ‚ç‚¹çš„ç½‘ç»œå¸¦å®½æ¶ˆè€—ä¸¥é‡ï¼Œé€ æˆä¸»èŠ‚ç‚¹çš„å»¶è¿Ÿå˜å¤§ï¼Œæç«¯æƒ…å†µä¼šå‘ç”Ÿä¸»ä»èŠ‚ç‚¹è¿æ¥æ–­å¼€ï¼Œå¯¼è‡´å¤åˆ¶å¤±è´¥ã€‚<br>è§£å†³æ–¹æ¡ˆå¯ä»¥å‡å°‘ä¸»èŠ‚ç‚¹æŒ‚è½½çš„ä»èŠ‚ç‚¹æ•°é‡ï¼Œæˆ–è€…é‡‡ç”¨æ ‘å½¢å¤åˆ¶ç»“æ„(è¿™ç§æ ‘çŠ¶ç»“æ„ä¹Ÿå¸¦æ¥äº†è¿ç»´çš„å¤æ‚æ€§ï¼Œå¢åŠ äº†æ‰‹åŠ¨å’Œè‡ªåŠ¨å¤„ç†æ•…éšœè½¬ç§»çš„éš¾åº¦)ã€‚</p>
<h4 id="å•æœºå™¨å¤åˆ¶é£æš´"><a href="#å•æœºå™¨å¤åˆ¶é£æš´" class="headerlink" title="å•æœºå™¨å¤åˆ¶é£æš´"></a>å•æœºå™¨å¤åˆ¶é£æš´</h4><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g91z58ncm8j30iv0frgpv.jpg"></p>
<ul>
<li>åº”è¯¥æŠŠä¸»èŠ‚ç‚¹å°½é‡åˆ†æ•£åœ¨å¤šå°æœºå™¨ä¸Šï¼Œé¿å…åœ¨å•å°æœºå™¨ä¸Šéƒ¨ç½²è¿‡å¤šçš„ä¸»èŠ‚ç‚¹ã€‚</li>
<li>å½“ä¸»èŠ‚ç‚¹æ‰€åœ¨æœºå™¨æ•…éšœåæä¾›æ•…éšœè½¬ç§»æœºåˆ¶ï¼Œé¿å…æœºå™¨æ¢å¤åè¿›è¡Œå¯†é›†çš„å…¨é‡å¤åˆ¶ã€‚</li>
</ul>
<h1 id="ç¬¬-7-ç« -é˜»å¡"><a href="#ç¬¬-7-ç« -é˜»å¡" class="headerlink" title="ç¬¬ 7 ç«  é˜»å¡"></a>ç¬¬ 7 ç«  é˜»å¡</h1><p>å‘ç”Ÿé˜»å¡ä¼šæœ‰å†…åœ¨ä¸å¤–åœ¨åŸå› <br>å†…åœ¨åŸå› ï¼šä¸åˆç†åœ°ä½¿ç”¨APIæˆ–æ•°æ®ç»“æ„ã€CPUé¥±å’Œã€æŒä¹…åŒ–é˜»å¡ç­‰<br>å¤–åœ¨åŸå› ï¼šCPUç«äº‰ã€å†…å­˜äº¤æ¢ã€ç½‘ç»œé—®é¢˜ç­‰</p>
<h2 id="å†…å› "><a href="#å†…å› " class="headerlink" title="å†…å› "></a>å†…å› </h2><h3 id="å¦‚ä½•å‘ç°æ…¢æŸ¥è¯¢"><a href="#å¦‚ä½•å‘ç°æ…¢æŸ¥è¯¢" class="headerlink" title="å¦‚ä½•å‘ç°æ…¢æŸ¥è¯¢"></a>å¦‚ä½•å‘ç°æ…¢æŸ¥è¯¢</h3><p>æ‰§è¡Œ<code>slowlog get {n}</code>è·å–æœ€è¿‘çš„ n æ¡æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Œçº¿ä¸Šå®ä¾‹å»ºè®®è®¾ç½®ä¸º1æ¯«ç§’ä¾¿äºåŠæ—¶å‘ç°æ¯«ç§’çº§ä»¥ä¸Šçš„å‘½ä»¤ã€‚å¦‚æœå‘½ä»¤æ‰§è¡Œæ—¶é—´åœ¨æ¯«ç§’çº§ï¼Œåˆ™å®ä¾‹å®é™…OPSåªæœ‰1000å·¦å³ã€‚æ…¢æŸ¥è¯¢é˜Ÿåˆ—é•¿åº¦é»˜è®¤128ï¼Œå¯é€‚å½“è°ƒå¤§ã€‚æ…¢æŸ¥è¯¢æœ¬èº«åªè®°å½•äº†å‘½ä»¤æ‰§è¡Œæ—¶é—´ï¼Œä¸åŒ…æ‹¬æ•°æ®ç½‘ç»œä¼ è¾“æ—¶é—´å’Œå‘½ä»¤æ’é˜Ÿæ—¶é—´ï¼Œå› æ­¤å®¢æˆ·ç«¯å‘ç”Ÿé˜»å¡å¼‚å¸¸åï¼Œå¯èƒ½ä¸æ˜¯å½“å‰å‘½ä»¤ç¼“æ…¢ï¼Œè€Œæ˜¯åœ¨ç­‰å¾…å…¶ä»–å‘½ä»¤æ‰§è¡Œã€‚éœ€è¦é‡ç‚¹æ¯”å¯¹å¼‚å¸¸å’Œæ…¢æŸ¥è¯¢å‘ç”Ÿçš„æ—¶é—´ç‚¹ï¼Œç¡®è®¤æ˜¯å¦æœ‰æ…¢æŸ¥è¯¢é€ æˆçš„å‘½ä»¤é˜»å¡æ’é˜Ÿã€‚</p>
<p>è§£å†³æ…¢æŸ¥è¯¢</p>
<ul>
<li>ä¿®æ”¹ä¸ºä½ç®—æ³•åº¦çš„å‘½ä»¤ï¼Œå¦‚<code>hgetall</code>æ”¹ä¸º<code>hmget</code>ç­‰ï¼Œç¦ç”¨<code>keys</code>ã€<code>sort</code>ç­‰å‘½ä»¤ã€‚</li>
<li>è°ƒæ•´å¤§å¯¹è±¡ï¼šç¼©å‡å¤§å¯¹è±¡æ•°æ®æˆ–æŠŠå¤§å¯¹è±¡æ‹†åˆ†ä¸ºå¤šä¸ªå°å¯¹è±¡ï¼Œé˜²æ­¢ä¸€æ¬¡å‘½ä»¤æ“ä½œè¿‡å¤šçš„æ•°æ®ã€‚å¤§å¯¹è±¡æ‹†åˆ†è¿‡ç¨‹éœ€è¦å…·ä½“çš„ä¸šåŠ¡å†³å®šï¼Œå¦‚ç”¨æˆ·å¥½å‹é›†åˆå­˜å‚¨åœ¨Redisä¸­ï¼Œæœ‰äº›çƒ­ç‚¹ç”¨æˆ·ä¼šå…³æ³¨å¤§é‡å¥½å‹ï¼Œè¿™æ—¶å¯ä»¥æŒ‰æ—¶é—´æˆ–å…¶ä»–ç»´åº¦æ‹†åˆ†åˆ°å¤šä¸ªé›†åˆä¸­ã€‚</li>
</ul>
<h3 id="å¦‚ä½•å‘ç°å¤§å¯¹è±¡"><a href="#å¦‚ä½•å‘ç°å¤§å¯¹è±¡" class="headerlink" title="å¦‚ä½•å‘ç°å¤§å¯¹è±¡"></a>å¦‚ä½•å‘ç°å¤§å¯¹è±¡</h3><p>Redisæœ¬èº«æä¾›å‘ç°å¤§å¯¹è±¡çš„å·¥å…·<code>redis-cli -h{ip} -p{port} bigkeys</code>ã€‚å†…éƒ¨åŸç†é‡‡ç”¨åˆ†æ®µè¿›è¡Œ<code>scan</code>æ“ä½œï¼ŒæŠŠå†å²æ‰«æè¿‡çš„æœ€å¤§å¯¹è±¡ç»Ÿè®¡å‡ºæ¥ä¾¿äºåˆ†æä¼˜åŒ–ï¼Œ</p>
<h3 id="CPUé¥±å’Œ"><a href="#CPUé¥±å’Œ" class="headerlink" title="CPUé¥±å’Œ"></a>CPUé¥±å’Œ</h3><p>ä½¿ç”¨<code>top</code>å‘½ä»¤å¾ˆå®¹æ˜“è¯†åˆ«å‡ºå¯¹åº”Redisè¿›ç¨‹çš„CPUä½¿ç”¨ç‡ã€‚CPUé¥±å’Œæ˜¯éå¸¸å±é™©çš„ï¼Œå°†å¯¼è‡´Redisæ— æ³•å¤„ç†æ›´å¤šçš„å‘½ä»¤ï¼Œä¸¥é‡å½±å“ååé‡å’Œåº”ç”¨æ–¹çš„ç¨³å®šæ€§ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰Redisçš„å¹¶å‘é‡æ˜¯å¦è¾¾åˆ°æé™ï¼Œå»ºè®®ä½¿ç”¨ç»Ÿè®¡å‘½ä»¤<code>redis-cli -h{ip} -p{port} --stat</code>è·å–å½“å‰Redisä½¿ç”¨æƒ…å†µï¼Œè¯¥å‘½ä»¤æ¯ç§’è¾“å‡ºä¸€è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<h3 id="æŒä¹…åŒ–é˜»å¡"><a href="#æŒä¹…åŒ–é˜»å¡" class="headerlink" title="æŒä¹…åŒ–é˜»å¡"></a>æŒä¹…åŒ–é˜»å¡</h3><p>æŒä¹…åŒ–å¼•èµ·ä¸»çº¿ç¨‹é˜»å¡çš„æ“ä½œä¸»è¦æœ‰ï¼šforké˜»å¡ã€AOFåˆ·ç›˜é˜»å¡ã€HugePageå†™æ“ä½œé˜»å¡ã€‚</p>
<p>fork é˜»å¡å¯ä»¥æ‰§è¡Œ<code>info stats</code>å‘½ä»¤è·å–åˆ°<code>latest_fork_usec</code>æŒ‡æ ‡ï¼Œè¡¨ç¤ºRedisæœ€è¿‘ä¸€æ¬¡forkæ“ä½œè€—æ—¶ï¼Œå¦‚æœè€—æ—¶å¾ˆå¤§ï¼Œæ¯”å¦‚è¶…è¿‡1ç§’ï¼Œåˆ™éœ€è¦åšå‡ºä¼˜åŒ–è°ƒæ•´ï¼Œå¦‚é¿å…ä½¿ç”¨è¿‡å¤§çš„å†…å­˜å®ä¾‹å’Œè§„é¿forkç¼“æ…¢çš„æ“ä½œç³»ç»Ÿç­‰ã€‚</p>
<p>AOFåˆ·ç›˜é˜»å¡ä¸»è¦æ˜¯ç¡¬ç›˜å‹åŠ›å¼•èµ·ï¼Œå¯ä»¥æŸ¥çœ‹Redisæ—¥å¿—è¯†åˆ«å‡ºè¿™ç§æƒ…å†µã€‚ç¡¬ç›˜å‹åŠ›å¯èƒ½æ˜¯Redisè¿›ç¨‹å¼•èµ·çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–è¿›ç¨‹å¼•èµ·çš„ï¼Œå¯ä»¥ä½¿ç”¨iotopæŸ¥çœ‹å…·ä½“æ˜¯å“ªä¸ªè¿›ç¨‹æ¶ˆè€—è¿‡å¤šçš„ç¡¬ç›˜èµ„æºã€‚</p>
<p>HugePageå†™æ“ä½œé˜»å¡ã€‚å­è¿›ç¨‹åœ¨æ‰§è¡Œé‡å†™æœŸé—´åˆ©ç”¨Linuxå†™æ—¶å¤åˆ¶æŠ€æœ¯é™ä½å†…å­˜å¼€é”€ï¼Œå› æ­¤åªæœ‰å†™æ“ä½œæ—¶Redisæ‰å¤åˆ¶è¦ä¿®æ”¹çš„å†…å­˜é¡µã€‚å¯¹äºå¼€å¯Transparent HugePagesçš„æ“ä½œç³»ç»Ÿï¼Œæ¯æ¬¡å†™å‘½ä»¤å¼•èµ·çš„å¤åˆ¶å†…å­˜é¡µå•ä½ç”±4Kå˜ä¸º2MBï¼Œæ”¾å¤§äº†512å€ï¼Œä¼šæ‹–æ…¢å†™æ“ä½œçš„æ‰§è¡Œæ—¶é—´ï¼Œå¯¼è‡´å¤§é‡å†™æ“ä½œæ…¢æŸ¥è¯¢ã€‚ä¾‹å¦‚ç®€å•çš„incrå‘½ä»¤ä¹Ÿä¼šå‡ºç°åœ¨æ…¢æŸ¥è¯¢ä¸­ã€‚å…³äºTransparent HugePagesçš„ç»†èŠ‚è§ç¬¬12ç« çš„12.1èŠ‚â€œLinuxé…ç½®ä¼˜åŒ–â€ã€‚</p>
<blockquote>
<p>Redis å¯¹é˜»å¡é—®é¢˜çš„è¯´æ˜ï¼š<a target="_blank" rel="noopener" href="https://redis.io/topics/latency">https://redis.io/topics/latency</a></p>
</blockquote>
<h2 id="å¤–å› "><a href="#å¤–å› " class="headerlink" title="å¤–å› "></a>å¤–å› </h2><h3 id="CPU-ç«äº‰"><a href="#CPU-ç«äº‰" class="headerlink" title="CPU ç«äº‰"></a>CPU ç«äº‰</h3><p>è¿›ç¨‹ç«äº‰ï¼šRedisæ˜¯å…¸å‹çš„CPUå¯†é›†å‹åº”ç”¨ï¼Œä¸å»ºè®®å’Œå…¶ä»–å¤šæ ¸CPUå¯†é›†å‹æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ã€‚å½“å…¶ä»–è¿›ç¨‹è¿‡åº¦æ¶ˆè€—CPUæ—¶ï¼Œå°†ä¸¥é‡å½±å“Redisååé‡ã€‚å¯ä»¥é€šè¿‡<code>top</code>ã€<code>sar</code>ç­‰å‘½ä»¤å®šä½åˆ°CPUæ¶ˆè€—çš„æ—¶é—´ç‚¹å’Œå…·ä½“è¿›ç¨‹ï¼Œè¿™ä¸ªé—®é¢˜æ¯”è¾ƒå®¹æ˜“å‘ç°ï¼Œéœ€è¦è°ƒæ•´æœåŠ¡ä¹‹é—´éƒ¨ç½²ç»“æ„ã€‚<br>ç»‘å®šCPUï¼šéƒ¨ç½²Redisæ—¶ä¸ºäº†å……åˆ†åˆ©ç”¨å¤šæ ¸CPUï¼Œé€šå¸¸ä¸€å°æœºå™¨éƒ¨ç½²å¤šä¸ªå®ä¾‹ã€‚å¸¸è§çš„ä¸€ç§ä¼˜åŒ–æ˜¯æŠŠRedisè¿›ç¨‹ç»‘å®šåˆ°CPUä¸Šï¼Œç”¨äºé™ä½CPUé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚ä½†å½“Redisçˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹è¿›è¡ŒRDB/AOFé‡å†™æ—¶ï¼Œå¦‚æœåšäº†CPUç»‘å®šï¼Œä¼šä¸çˆ¶è¿›ç¨‹å…±äº«ä½¿ç”¨ä¸€ä¸ªCPUã€‚å­è¿›ç¨‹é‡å†™æ—¶å¯¹å•æ ¸CPUä½¿ç”¨ç‡é€šå¸¸åœ¨90%ä»¥ä¸Šï¼Œçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å°†äº§ç”Ÿæ¿€çƒˆCPUç«äº‰ï¼Œæå¤§å½±å“Redisç¨³å®šæ€§ã€‚å› æ­¤å¯¹äºå¼€å¯äº†æŒä¹…åŒ–æˆ–å‚ä¸å¤åˆ¶çš„ä¸»èŠ‚ç‚¹ä¸å»ºè®®ç»‘å®šCPUã€‚</p>
<h3 id="å†…å­˜äº¤æ¢"><a href="#å†…å­˜äº¤æ¢" class="headerlink" title="å†…å­˜äº¤æ¢"></a>å†…å­˜äº¤æ¢</h3><p>å†…å­˜äº¤æ¢ï¼ˆswapï¼‰å¯¹äºRedisæ¥è¯´æ˜¯éå¸¸è‡´å‘½çš„ï¼ŒRedisä¿è¯é«˜æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å‰ææ˜¯æ‰€æœ‰çš„æ•°æ®åœ¨å†…å­˜ä¸­ã€‚å¦‚æœæ“ä½œç³»ç»ŸæŠŠRedisä½¿ç”¨çš„éƒ¨åˆ†å†…å­˜æ¢å‡ºåˆ°ç¡¬ç›˜ï¼Œç”±äºå†…å­˜ä¸ç¡¬ç›˜è¯»å†™é€Ÿåº¦å·®å‡ ä¸ªæ•°é‡çº§ï¼Œä¼šå¯¼è‡´å‘ç”Ÿäº¤æ¢åçš„Redisæ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚</p>
<p>åˆ¤æ–­ Redis æ˜¯å¦å†…å­˜äº¤æ¢çš„æ–¹æ³•ï¼š</p>
<ol>
<li>æŸ¥è¯¢ Redis çš„è¿›ç¨‹å·ï¼š<code># redis-cli -p 6379 info server | grep process_id</code> // process_id:4476</li>
<li>æ ¹æ®è¿›ç¨‹å·æŸ¥è¯¢å†…å­˜äº¤æ¢ä¿¡æ¯ï¼š<code># cat /proc/4476/smaps | grep Swap</code><br>å¦‚æœäº¤æ¢é‡éƒ½æ˜¯0KBæˆ–è€…ä¸ªåˆ«çš„æ˜¯4KBï¼Œåˆ™æ˜¯æ­£å¸¸ç°è±¡ï¼Œè¯´æ˜Redisè¿›ç¨‹å†…å­˜æ²¡æœ‰è¢«äº¤æ¢ã€‚</li>
</ol>
<p>é¢„é˜² Redis çš„å†…å­˜äº¤æ¢</p>
<ul>
<li>ä¿è¯æœºå™¨å¯ç”¨å†…å­˜å……è¶³</li>
<li>ç¡®ä¿æ‰€æœ‰ Redis å®ä¾‹è®¾ç½®æœ€å¤§å¯ç”¨å†…å­˜(maxmemory)</li>
<li>é™ä½ç³»ç»Ÿä½¿ç”¨swapä¼˜å…ˆçº§ï¼Œå¦‚<code>echo10&gt;/proc/sys/vm/swappiness</code></li>
</ul>
<h3 id="ç½‘ç»œé—®é¢˜"><a href="#ç½‘ç»œé—®é¢˜" class="headerlink" title="ç½‘ç»œé—®é¢˜"></a>ç½‘ç»œé—®é¢˜</h3><p>Redisè¿æ¥æ‹’ç»ï¼šRedisé€šè¿‡maxclientså‚æ•°æ§åˆ¶å®¢æˆ·ç«¯æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤10000ã€‚å½“Redisè¿æ¥æ•°å¤§äº<code>maxclients</code>æ—¶ä¼šæ‹’ç»æ–°çš„è¿æ¥è¿›å…¥ï¼Œ<code>info stats</code>çš„<code>rejected_connections</code>ç»Ÿè®¡æŒ‡æ ‡è®°å½•æ‰€æœ‰è¢«æ‹’ç»è¿æ¥çš„æ•°é‡ã€‚å®¢æˆ·ç«¯è®¿é—®Redisæ—¶å°½é‡é‡‡ç”¨NIOé•¿è¿æ¥æˆ–è€…è¿æ¥æ± çš„æ–¹å¼ã€‚Redis é»˜è®¤ä¸ä¼šä¸»åŠ¨å…³é—­é•¿æ—¶é—´é—²ç½®è¿æ¥æˆ–æ£€æŸ¥å…³é—­æ— æ•ˆçš„TCPè¿æ¥ï¼Œå› æ­¤ä¼šå¯¼è‡´Redisè¿æ¥æ•°å¿«é€Ÿæ¶ˆè€—ä¸”æ— æ³•é‡Šæ”¾çš„é—®é¢˜ï¼Œæ­¤æ—¶å¯è®¾ç½®<code>tcp-keepalive</code>å’Œ<code>timeout</code>å‚æ•°è®©Redisä¸»åŠ¨æ£€æŸ¥å’Œå…³é—­æ— æ•ˆè¿æ¥ã€‚</p>
<p>è¿æ¥æº¢å‡ºï¼šOS ä¸€èˆ¬ä¼šå¯¹è¿›ç¨‹ä½¿ç”¨çš„èµ„æºåšé™åˆ¶ï¼Œå…¶ä¸­ä¸€é¡¹æ˜¯å¯¹è¿›ç¨‹å¯æ‰“å¼€æœ€å¤§æ–‡ä»¶æ•°æ§åˆ¶ï¼Œé»˜è®¤ 1024ï¼Œå¯¹éœ€è¦æ”¯æ’‘é«˜å¹¶å‘çš„ Redis éœ€è¦è°ƒå¤§è¯¥é™åˆ¶ã€‚</p>
<p>å¸¸è§çš„ç‰©ç†æ‹“æ‰‘æŒ‰ç½‘ç»œå»¶è¿Ÿç”±å¿«åˆ°æ…¢å¯åˆ†ä¸ºï¼šåŒç‰©ç†æœº&gt;åŒæœºæ¶&gt;è·¨æœºæ¶&gt;åŒæœºæˆ¿&gt;åŒåŸæœºæˆ¿&gt;å¼‚åœ°æœºæˆ¿ã€‚ä½†å®ƒä»¬å®¹ç¾æ€§æ­£å¥½ç›¸åã€‚</p>
<h1 id="ç¬¬-8-ç« -ç†è§£å†…å­˜"><a href="#ç¬¬-8-ç« -ç†è§£å†…å­˜" class="headerlink" title="ç¬¬ 8 ç«  ç†è§£å†…å­˜"></a>ç¬¬ 8 ç«  ç†è§£å†…å­˜</h1><p>å†…å­˜æ¶ˆè€—å¯ä»¥åˆ†ä¸ºè¿›ç¨‹è‡ªèº«æ¶ˆè€—å’Œå­è¿›ç¨‹æ¶ˆè€—ã€‚</p>
<h2 id="å†…å­˜æ¶ˆè€—"><a href="#å†…å­˜æ¶ˆè€—" class="headerlink" title="å†…å­˜æ¶ˆè€—"></a>å†…å­˜æ¶ˆè€—</h2><h3 id="å†…å­˜æ¶ˆè€—ç»Ÿè®¡"><a href="#å†…å­˜æ¶ˆè€—ç»Ÿè®¡" class="headerlink" title="å†…å­˜æ¶ˆè€—ç»Ÿè®¡"></a>å†…å­˜æ¶ˆè€—ç»Ÿè®¡</h3><p>é€šè¿‡<code>info memory</code>å‘½ä»¤è·å–å†…å­˜ç›¸å…³æŒ‡æ ‡ï¼ŒæŒ‡æ ‡è¯´æ˜å¦‚ä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>å±æ€§å</th>
<th>å±æ€§è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>used_memory</code></td>
<td>Redisåˆ†é…å™¨åˆ†é…çš„å†…å­˜æ€»é‡ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨å­˜å‚¨çš„æ‰€æœ‰æ•°æ®å†…å­˜å ç”¨é‡</td>
</tr>
<tr>
<td><code>used_memory_human</code></td>
<td>ä»¥å¯è¯»çš„æ ¼å¼è¿”å›<code>used memory</code></td>
</tr>
<tr>
<td><code>used_memory_rss</code></td>
<td>ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦æ˜¾ç¤ºRedisè¿›ç¨‹å ç”¨çš„ç‰©ç†å†…å­˜æ€»é‡</td>
</tr>
<tr>
<td><code>used_memory_peak</code></td>
<td>å†…å­˜ä½¿ç”¨çš„æœ€å¤§å€¼ï¼Œè¡¨ç¤º<code>used memory</code>çš„å³°å€¼</td>
</tr>
<tr>
<td><code>used_memory_peak_human</code></td>
<td>ä»¥å¯è¯»çš„æ ¼å¼è¿”å›<code>used_memory_peak</code></td>
</tr>
<tr>
<td><code>used_memory_lua</code></td>
<td>Lua å¼•æ“æ‰€æ¶ˆè€—çš„å†…å­˜å¤§å°</td>
</tr>
<tr>
<td><code>mem_fragmentation_ratio</code></td>
<td><code>used_memory_rss/used_memory</code>æ¯”å€¼ï¼Œè¡¨ç¤ºå†…å­˜ç¢ç‰‡ç‡</td>
</tr>
<tr>
<td><code>mem_allocator</code></td>
<td>Redis æ‰€ä½¿ç”¨çš„å†…å­˜åˆ†é…å™¨ï¼Œé»˜è®¤ä¸º jemalloc</td>
</tr>
</tbody></table>
<p>å½“<code>mem_fragmentation_ratio &gt; 1</code>æ—¶ï¼Œè¯´æ˜<code>used_memory_rss-used_memory</code>å¤šå‡ºçš„éƒ¨åˆ†å†…å­˜å¹¶æ²¡æœ‰ç”¨äºæ•°æ®å­˜å‚¨ï¼Œè€Œæ˜¯è¢«å†…å­˜ç¢ç‰‡æ‰€æ¶ˆè€—ï¼Œå¦‚æœä¸¤è€…ç›¸å·®å¾ˆå¤§ï¼Œè¯´æ˜ç¢ç‰‡ç‡ä¸¥é‡ã€‚<br>å½“<code>mem_fragmentation_ratio &lt; 1</code>æ—¶ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬å‡ºç°åœ¨æ“ä½œç³»ç»ŸæŠŠRediså†…å­˜äº¤æ¢ï¼ˆSwapï¼‰åˆ°ç¡¬ç›˜å¯¼è‡´ï¼Œå‡ºç°è¿™ç§æƒ…å†µæ—¶è¦æ ¼å¤–å…³æ³¨ï¼Œç”±äºç¡¬ç›˜é€Ÿåº¦è¿œè¿œæ…¢äºå†…å­˜ï¼ŒRedisæ€§èƒ½ä¼šå˜å¾—å¾ˆå·®ï¼Œç”šè‡³åƒµæ­»ã€‚</p>
<h3 id="å†…å­˜æ¶ˆè€—åˆ’åˆ†"><a href="#å†…å­˜æ¶ˆè€—åˆ’åˆ†" class="headerlink" title="å†…å­˜æ¶ˆè€—åˆ’åˆ†"></a>å†…å­˜æ¶ˆè€—åˆ’åˆ†</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g94c4oj8s0j30y20mmtfb.jpg"></p>
<p>å†…å­˜ç¢ç‰‡é—®é¢˜è™½ç„¶æ˜¯æ‰€æœ‰å†…å­˜æœåŠ¡çš„é€šç—…ï¼Œä½†æ˜¯jemallocé’ˆå¯¹ç¢ç‰‡åŒ–é—®é¢˜ä¸“é—¨åšäº†ä¼˜åŒ–ï¼Œä¸€èˆ¬ä¸ä¼šå­˜åœ¨è¿‡åº¦ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼Œæ­£å¸¸çš„ç¢ç‰‡ç‡ï¼ˆ<code>mem_fragmentation_ratio</code>ï¼‰åœ¨1.03å·¦å³ã€‚ä½†æ˜¯å½“å­˜å‚¨çš„æ•°æ®é•¿çŸ­å·®å¼‚è¾ƒå¤§æ—¶ï¼Œä»¥ä¸‹åœºæ™¯å®¹æ˜“å‡ºç°é«˜å†…å­˜ç¢ç‰‡é—®é¢˜ï¼š</p>
<ul>
<li>é¢‘ç¹åšæ›´æ–°æ“ä½œï¼Œä¾‹å¦‚é¢‘ç¹å¯¹å·²å­˜åœ¨çš„é”®æ‰§è¡Œ<code>append</code>ã€<code>setrange</code>ç­‰æ›´æ–°æ“ä½œã€‚</li>
<li>å¤§é‡è¿‡æœŸé”®åˆ é™¤ï¼Œé”®å¯¹è±¡è¿‡æœŸåˆ é™¤åï¼Œé‡Šæ”¾çš„ç©ºé—´æ— æ³•å¾—åˆ°å……åˆ†åˆ©ç”¨ï¼Œå¯¼è‡´ç¢ç‰‡ç‡ä¸Šå‡ã€‚</li>
</ul>
<p>å‡ºç°é«˜å†…å­˜ç¢ç‰‡é—®é¢˜æ—¶å¸¸è§çš„è§£å†³æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®å¯¹é½ï¼šåœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹å°½é‡åšæ•°æ®å¯¹é½ï¼Œæ¯”å¦‚æ•°æ®å°½é‡é‡‡ç”¨æ•°å­—ç±»å‹æˆ–è€…å›ºå®šé•¿åº¦å­—ç¬¦ä¸²ç­‰ï¼Œä½†æ˜¯è¿™è¦è§†å…·ä½“çš„ä¸šåŠ¡è€Œå®šï¼Œæœ‰äº›åœºæ™¯æ— æ³•åšåˆ°ã€‚</li>
<li>å®‰å…¨é‡å¯ï¼šé‡å¯èŠ‚ç‚¹å¯ä»¥åšåˆ°å†…å­˜ç¢ç‰‡é‡æ–°æ•´ç†ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨é«˜å¯ç”¨æ¶æ„ï¼Œå¦‚Sentinelæˆ–Clusterï¼Œå°†ç¢ç‰‡ç‡è¿‡é«˜çš„ä¸»èŠ‚ç‚¹è½¬æ¢ä¸ºä»èŠ‚ç‚¹ï¼Œè¿›è¡Œå®‰å…¨é‡å¯ã€‚</li>
</ul>
<h3 id="å­è¿›ç¨‹å†…å­˜æ¶ˆè€—"><a href="#å­è¿›ç¨‹å†…å­˜æ¶ˆè€—" class="headerlink" title="å­è¿›ç¨‹å†…å­˜æ¶ˆè€—"></a>å­è¿›ç¨‹å†…å­˜æ¶ˆè€—</h3><ul>
<li>Redisäº§ç”Ÿçš„å­è¿›ç¨‹å¹¶ä¸éœ€è¦æ¶ˆè€—1å€çš„çˆ¶è¿›ç¨‹å†…å­˜ï¼Œå®é™…æ¶ˆè€—æ ¹æ®æœŸé—´å†™å…¥å‘½ä»¤é‡å†³å®šï¼Œä½†æ˜¯ä¾ç„¶è¦é¢„ç•™å‡ºä¸€äº›å†…å­˜é˜²æ­¢æº¢å‡ºã€‚</li>
<li>éœ€è¦è®¾ç½®<code>sysctl vm.overcommit_memory = 1</code>å…è®¸å†…æ ¸å¯ä»¥åˆ†é…æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼Œé˜²æ­¢Redisè¿›ç¨‹æ‰§è¡Œforkæ—¶å› ç³»ç»Ÿå‰©ä½™å†…å­˜ä¸è¶³è€Œå¤±è´¥ã€‚</li>
<li>æ’æŸ¥å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒå¹¶å¼€å¯THPï¼Œå¦‚æœå¼€å¯ï¼Œå»ºè®®å…³é—­ï¼Œé˜²æ­¢<code>copy-onwrite</code>æœŸé—´å†…å­˜è¿‡åº¦æ¶ˆè€—ã€‚å¦‚æœåœ¨é«˜å¹¶å‘å†™çš„åœºæ™¯ä¸‹å¼€å¯THPï¼Œå­è¿›ç¨‹å†…å­˜æ¶ˆè€—å¯èƒ½æ˜¯çˆ¶è¿›ç¨‹çš„æ•°å€ï¼Œææ˜“é€ æˆæœºå™¨ç‰©ç†å†…å­˜æº¢å‡ºï¼Œä»è€Œè§¦å‘SWAPæˆ–OOM killerã€‚</li>
</ul>
<h2 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h2><p>Redisä¸»è¦é€šè¿‡æ§åˆ¶å†…å­˜ä¸Šé™å’Œå›æ”¶ç­–ç•¥å®ç°å†…å­˜ç®¡ç†ã€‚</p>
<h3 id="è®¾ç½®å†…å­˜ä¸Šé™"><a href="#è®¾ç½®å†…å­˜ä¸Šé™" class="headerlink" title="è®¾ç½®å†…å­˜ä¸Šé™"></a>è®¾ç½®å†…å­˜ä¸Šé™</h3><p>Redisä½¿ç”¨<code>maxmemory</code>å‚æ•°é™åˆ¶æœ€å¤§å¯ç”¨å†…å­˜ã€‚éœ€è¦æ³¨æ„ï¼Œ<code>maxmemory</code>é™åˆ¶çš„æ˜¯Rediså®é™…ä½¿ç”¨çš„å†…å­˜é‡ï¼Œä¹Ÿå°±æ˜¯<code>used_memory</code>ç»Ÿè®¡é¡¹å¯¹åº”çš„å†…å­˜ã€‚ç”±äºå†…å­˜ç¢ç‰‡ç‡çš„å­˜åœ¨ï¼Œå®é™…æ¶ˆè€—çš„å†…å­˜å¯èƒ½ä¼šæ¯”<code>maxmemory</code>è®¾ç½®çš„æ›´å¤§ï¼Œå®é™…ä½¿ç”¨æ—¶è¦å°å¿ƒè¿™éƒ¨åˆ†å†…å­˜æº¢å‡ºã€‚é€šè¿‡è®¾ç½®å†…å­˜ä¸Šé™å¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®ç°ä¸€å°æœåŠ¡å™¨éƒ¨ç½²å¤šä¸ªRedisè¿›ç¨‹çš„å†…å­˜æ§åˆ¶ã€‚æ¯”å¦‚ä¸€å°24GBå†…å­˜çš„æœåŠ¡å™¨ï¼Œä¸ºç³»ç»Ÿé¢„ç•™4GBå†…å­˜ï¼Œé¢„ç•™4GBç©ºé—²å†…å­˜ç»™å…¶ä»–è¿›ç¨‹æˆ–Redis forkè¿›ç¨‹ï¼Œç•™ç»™Redis16GBå†…å­˜ï¼Œè¿™æ ·å¯ä»¥éƒ¨ç½²4ä¸ª<code>maxmemory=4GB</code>çš„Redisè¿›ç¨‹ã€‚å¾—ç›ŠäºRediså•çº¿ç¨‹æ¶æ„å’Œå†…å­˜é™åˆ¶æœºåˆ¶ï¼Œå³ä½¿æ²¡æœ‰é‡‡ç”¨è™šæ‹ŸåŒ–ï¼Œä¸åŒçš„Redisè¿›ç¨‹ä¹‹é—´ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°å®ç°CPUå’Œå†…å­˜çš„éš”ç¦»æ€§ï¼Œ</p>
<h3 id="åŠ¨æ€è°ƒæ•´å†…å­˜ä¸Šé™"><a href="#åŠ¨æ€è°ƒæ•´å†…å­˜ä¸Šé™" class="headerlink" title="åŠ¨æ€è°ƒæ•´å†…å­˜ä¸Šé™"></a>åŠ¨æ€è°ƒæ•´å†…å­˜ä¸Šé™</h3><p>Redisçš„å†…å­˜ä¸Šé™å¯ä»¥é€šè¿‡<code>config set maxmemory</code>è¿›è¡ŒåŠ¨æ€ä¿®æ”¹ã€‚è¯¥æ–¹å¼è¿‡äºç®€å•ï¼Œæ¨èä½¿ç”¨å“¨å…µæˆ–è€…é›†ç¾¤æ¥å¤„ç†ã€‚</p>
<p>Redisé»˜è®¤æ— é™ä½¿ç”¨æœåŠ¡å™¨å†…å­˜ï¼Œä¸ºé˜²æ­¢æç«¯æƒ…å†µä¸‹å¯¼è‡´ç³»ç»Ÿå†…å­˜è€—å°½ï¼Œå»ºè®®æ‰€æœ‰çš„Redisè¿›ç¨‹éƒ½è¦é…ç½®<code>maxmemory</code>ã€‚</p>
<h3 id="å†…å­˜å›æ”¶ç­–ç•¥"><a href="#å†…å­˜å›æ”¶ç­–ç•¥" class="headerlink" title="å†…å­˜å›æ”¶ç­–ç•¥"></a>å†…å­˜å›æ”¶ç­–ç•¥</h3><p>Redisçš„å†…å­˜å›æ”¶æœºåˆ¶åˆ†ä¸ºåˆ é™¤è¿‡æœŸçš„é”®å¯¹è±¡ï¼Œä¸å†…å­˜ä½¿ç”¨è¾¾åˆ°maxmemoryä¸Šé™æ—¶è§¦å‘å†…å­˜æº¢å‡ºæ§åˆ¶ç­–ç•¥ã€‚</p>
<p>Redisæ‰€æœ‰çš„é”®éƒ½å¯ä»¥è®¾ç½®è¿‡æœŸå±æ€§ï¼Œå†…éƒ¨ä¿å­˜åœ¨è¿‡æœŸå­—å…¸ä¸­ã€‚ç”±äºè¿›ç¨‹å†…ä¿å­˜å¤§é‡çš„é”®ï¼Œç»´æŠ¤æ¯ä¸ªé”®ç²¾å‡†çš„è¿‡æœŸåˆ é™¤æœºåˆ¶ä¼šå¯¼è‡´æ¶ˆè€—å¤§é‡çš„CPUï¼Œå¯¹äºå•çº¿ç¨‹çš„Redisæ¥è¯´æˆæœ¬è¿‡é«˜ï¼Œå› æ­¤Redisé‡‡ç”¨æƒ°æ€§åˆ é™¤å’Œå®šæ—¶ä»»åŠ¡åˆ é™¤æœºåˆ¶å®ç°è¿‡æœŸé”®çš„å†…å­˜å›æ”¶ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g94i0a1qirj30u00wg49h.jpg"></p>
<p>Redis çš„å†…å­˜æº¢å‡ºæœ‰ 6 ç§æ§åˆ¶ç­–ç•¥ï¼Œå¯é€šè¿‡<code>config set maxmemory-policy {policy}</code>é…ç½®</p>
<ol>
<li>noevictionï¼šé»˜è®¤ç­–ç•¥ï¼Œä¸ä¼šåˆ é™¤ä»»ä½•æ•°æ®ï¼Œæ‹’ç»æ‰€æœ‰å†™å…¥æ“ä½œå¹¶è¿”å›å®¢æˆ·ç«¯é”™è¯¯ä¿¡æ¯ï¼ˆerrorï¼‰OOM command not allowed when used memoryï¼Œæ­¤æ—¶Redisåªå“åº”è¯»æ“ä½œã€‚</li>
<li>volatile-lruï¼šæ ¹æ®LRUç®—æ³•åˆ é™¤è®¾ç½®äº†è¶…æ—¶å±æ€§ï¼ˆexpireï¼‰çš„é”®ï¼Œç›´åˆ°è…¾å‡ºè¶³å¤Ÿç©ºé—´ä¸ºæ­¢ã€‚å¦‚æœæ²¡æœ‰å¯åˆ é™¤çš„é”®å¯¹è±¡ï¼Œå›é€€åˆ°noevictionç­–ç•¥ã€‚</li>
<li>allkeys-lruï¼šæ ¹æ®LRUç®—æ³•åˆ é™¤é”®ï¼Œä¸ç®¡æ•°æ®æœ‰æ²¡æœ‰è®¾ç½®è¶…æ—¶å±æ€§ï¼Œç›´åˆ°è…¾å‡ºè¶³å¤Ÿç©ºé—´ä¸ºæ­¢ã€‚</li>
<li>allkeys-randomï¼šéšæœºåˆ é™¤æ‰€æœ‰é”®ï¼Œç›´åˆ°è…¾å‡ºè¶³å¤Ÿç©ºé—´ä¸ºæ­¢ã€‚</li>
<li>volatile-randomï¼šéšæœºåˆ é™¤è¿‡æœŸé”®ï¼Œç›´åˆ°è…¾å‡ºè¶³å¤Ÿç©ºé—´ä¸ºæ­¢ã€‚</li>
<li>volatile-ttlï¼šæ ¹æ®é”®å€¼å¯¹è±¡çš„ttlå±æ€§ï¼Œåˆ é™¤æœ€è¿‘å°†è¦è¿‡æœŸæ•°æ®ã€‚å¦‚æœæ²¡æœ‰ï¼Œå›é€€åˆ°noevictionç­–ç•¥ã€‚</li>
</ol>
<p>é¢‘ç¹æ‰§è¡Œå›æ”¶å†…å­˜æˆæœ¬å¾ˆé«˜ï¼Œä¼šå¯¼è‡´ Redis çš„æ€§èƒ½ä¸‹é™ï¼Œå¦‚æœå½“å‰Redisæœ‰ä»èŠ‚ç‚¹ï¼Œå›æ”¶å†…å­˜æ“ä½œå¯¹åº”çš„åˆ é™¤å‘½ä»¤ä¼šåŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œå¯¼è‡´å†™æ”¾å¤§çš„é—®é¢˜ã€‚</p>
<h2 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h2><h3 id="redisObjectå¯¹è±¡"><a href="#redisObjectå¯¹è±¡" class="headerlink" title="redisObjectå¯¹è±¡"></a>redisObjectå¯¹è±¡</h3><p>Rediså­˜å‚¨çš„æ‰€æœ‰å€¼å¯¹è±¡åœ¨å†…éƒ¨å®šä¹‰ä¸ºredisObjectç»“æ„ä½“ï¼Œå†…éƒ¨ç»“æ„å¦‚å›¾<br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g94ig5abpxj30zi0u0tkp.jpg"></p>
<p>typeå­—æ®µï¼šè¡¨ç¤ºå½“å‰å¯¹è±¡ä½¿ç”¨çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨<code>type {key}</code>å‘½ä»¤æŸ¥çœ‹å¯¹è±¡æ‰€å±ç±»å‹<br>encoding å­—æ®µï¼šRediså†…éƒ¨ç¼–ç ç±»å‹<br>lru å­—æ®µï¼šè®°å½•å¯¹è±¡æœ€åä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´ï¼Œå½“é…ç½®äº†<code>maxmemory</code>å’Œ<code>maxmemory-policy=volatile-lru</code>æˆ–è€…<code>allkeys-lru</code>æ—¶ï¼Œç”¨äºè¾…åŠ©LRUç®—æ³•åˆ é™¤é”®æ•°æ®ã€‚å¯ä»¥ä½¿ç”¨<code>object idletime {key}</code>å‘½ä»¤åœ¨ä¸æ›´æ–°lruå­—æ®µæƒ…å†µä¸‹æŸ¥çœ‹å½“å‰é”®çš„ç©ºé—²æ—¶é—´ã€‚<br>refcountå­—æ®µï¼šè®°å½•å½“å‰å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼Œç”¨äºé€šè¿‡å¼•ç”¨æ¬¡æ•°å›æ”¶å†…å­˜ï¼Œå½“<code>refcount=0</code>æ—¶ï¼Œå¯ä»¥å®‰å…¨å›æ”¶å½“å‰å¯¹è±¡ç©ºé—´ã€‚<br><code>*ptr</code>å­—æ®µï¼šä¸å¯¹è±¡çš„æ•°æ®å†…å®¹ç›¸å…³ï¼Œå¦‚æœæ˜¯æ•´æ•°ï¼Œç›´æ¥å­˜å‚¨æ•°æ®ï¼›å¦åˆ™è¡¨ç¤ºæŒ‡å‘æ•°æ®çš„æŒ‡é’ˆã€‚Redisåœ¨3.0ä¹‹åå¯¹å€¼å¯¹è±¡æ˜¯å­—ç¬¦ä¸²ä¸”é•¿åº¦&lt;=39å­—èŠ‚çš„æ•°æ®ï¼Œå†…éƒ¨ç¼–ç ä¸º<code>embstr</code>ç±»å‹ï¼Œå­—ç¬¦ä¸²<code>sds</code>å’Œ<code>redisObject</code>ä¸€èµ·åˆ†é…ï¼Œä»è€Œ<strong>åªè¦ä¸€æ¬¡å†…å­˜æ“ä½œå³å¯</strong>ã€‚</p>
<h3 id="ç¼©å‡é”®å€¼å¯¹è±¡"><a href="#ç¼©å‡é”®å€¼å¯¹è±¡" class="headerlink" title="ç¼©å‡é”®å€¼å¯¹è±¡"></a>ç¼©å‡é”®å€¼å¯¹è±¡</h3><p>é™ä½Rediså†…å­˜ä½¿ç”¨æœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯ç¼©å‡é”®ï¼ˆkeyï¼‰å’Œå€¼ï¼ˆvalueï¼‰çš„é•¿åº¦ã€‚</p>
<ul>
<li>keyé•¿åº¦ï¼šå¦‚åœ¨è®¾è®¡é”®æ—¶ï¼Œåœ¨å®Œæ•´æè¿°ä¸šåŠ¡æƒ…å†µä¸‹ï¼Œé”®å€¼è¶ŠçŸ­è¶Šå¥½ã€‚å¦‚<code>userï¼š{uid}ï¼šfriendsï¼šnotifyï¼š{fid}</code>å¯ä»¥ç®€åŒ–ä¸º<code>uï¼š{uid}ï¼šfsï¼šntï¼š{fid}</code></li>
<li>valueé•¿åº¦ï¼šå€¼å¯¹è±¡ç¼©å‡æ¯”è¾ƒå¤æ‚ï¼Œå¸¸è§éœ€æ±‚æ˜¯æŠŠä¸šåŠ¡å¯¹è±¡åºåˆ—åŒ–æˆäºŒè¿›åˆ¶æ•°ç»„æ”¾å…¥Redisã€‚é¦–å…ˆåº”è¯¥<strong>åœ¨ä¸šåŠ¡ä¸Šç²¾ç®€ä¸šåŠ¡å¯¹è±¡ï¼Œå»æ‰ä¸å¿…è¦çš„å±æ€§é¿å…å­˜å‚¨æ— æ•ˆæ•°æ®</strong>ã€‚å…¶æ¬¡åœ¨åºåˆ—åŒ–å·¥å…·é€‰æ‹©ä¸Šï¼Œåº”è¯¥<strong>é€‰æ‹©æ›´é«˜æ•ˆçš„åºåˆ—åŒ–å·¥å…·æ¥é™ä½å­—èŠ‚æ•°ç»„å¤§å°</strong>ã€‚å€¼å¯¹è±¡é™¤äº†å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ä¹‹å¤–ï¼Œé€šå¸¸è¿˜ä¼šä½¿ç”¨é€šç”¨æ ¼å¼å­˜å‚¨æ•°æ®æ¯”å¦‚ï¼šjsonã€xmlç­‰ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨åœ¨Redisä¸­ã€‚è¿™ç§æ–¹å¼ä¼˜ç‚¹æ˜¯æ–¹ä¾¿è°ƒè¯•å’Œè·¨è¯­è¨€ï¼Œä½†æ˜¯åŒæ ·çš„æ•°æ®ç›¸æ¯”å­—èŠ‚æ•°ç»„æ‰€éœ€çš„ç©ºé—´æ›´å¤§ï¼Œåœ¨å†…å­˜ç´§å¼ çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨é€šç”¨å‹ç¼©ç®—æ³•å‹ç¼©jsonã€xmlåå†å­˜å…¥Redisï¼Œä»è€Œé™ä½å†…å­˜å ç”¨ï¼Œä¾‹å¦‚ä½¿ç”¨GZIPå‹ç¼©åçš„jsonå¯é™ä½çº¦60%çš„ç©ºé—´ã€‚ï¼ˆå½“é¢‘ç¹å‹ç¼©è§£å‹jsonç­‰æ–‡æœ¬æ•°æ®æ—¶ï¼Œå¼€å‘äººå‘˜éœ€è¦è€ƒè™‘å‹ç¼©é€Ÿåº¦å’Œè®¡ç®—å¼€é”€æˆæœ¬ï¼Œè¿™é‡Œæ¨èä½¿ç”¨Googleçš„Snappyå‹ç¼©å·¥å…·ï¼Œåœ¨ç‰¹å®šçš„å‹ç¼©ç‡æƒ…å†µä¸‹æ•ˆç‡è¿œè¿œé«˜äºGZIPç­‰ä¼ ç»Ÿå‹ç¼©å·¥å…·ï¼Œä¸”æ”¯æŒæ‰€æœ‰ä¸»æµè¯­è¨€ç¯å¢ƒã€‚ï¼‰</li>
</ul>
<h3 id="å­—ç¬¦ä¸²ä¼˜åŒ–"><a href="#å­—ç¬¦ä¸²ä¼˜åŒ–" class="headerlink" title="å­—ç¬¦ä¸²ä¼˜åŒ–"></a>å­—ç¬¦ä¸²ä¼˜åŒ–</h3><p>Redisæ²¡æœ‰é‡‡ç”¨åŸç”ŸCè¯­è¨€çš„å­—ç¬¦ä¸²ç±»å‹è€Œæ˜¯è‡ªå·±å®ç°äº†å­—ç¬¦ä¸²ç»“æ„ï¼Œå†…éƒ¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsimple dynamic stringï¼ŒSDSï¼‰ã€‚<br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g97yccw87dj30kt0dq0w8.jpg"></p>
<p>Redisè‡ªèº«å®ç°çš„å­—ç¬¦ä¸²ç»“æ„æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>$O(1)$æ—¶é—´å¤æ‚åº¦è·å–ï¼šå­—ç¬¦ä¸²é•¿åº¦ã€å·²ç”¨é•¿åº¦ã€æœªç”¨é•¿åº¦ã€‚</li>
<li>å¯ç”¨äºä¿å­˜å­—èŠ‚æ•°ç»„ï¼Œæ”¯æŒå®‰å…¨çš„äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨ã€‚</li>
<li>å†…éƒ¨å®ç°ç©ºé—´é¢„åˆ†é…æœºåˆ¶ï¼Œé™ä½å†…å­˜å†åˆ†é…æ¬¡æ•°ã€‚</li>
<li>æƒ°æ€§åˆ é™¤æœºåˆ¶ï¼Œå­—ç¬¦ä¸²ç¼©å‡åçš„ç©ºé—´ä¸é‡Šæ”¾ï¼Œä½œä¸ºé¢„åˆ†é…ç©ºé—´ä¿ç•™ã€‚</li>
</ul>
<p>å­—ç¬¦ä¸²ä¹‹æ‰€ä»¥é‡‡ç”¨é¢„åˆ†é…çš„æ–¹å¼æ˜¯é˜²æ­¢ä¿®æ”¹æ“ä½œéœ€è¦ä¸æ–­é‡åˆ†é…å†…å­˜å’Œå­—èŠ‚æ•°æ®æ‹·è´ã€‚ä½†åŒæ ·ä¹Ÿä¼šé€ æˆå†…å­˜çš„æµªè´¹ã€‚æˆ‘ä»¬éœ€è¦å°½é‡å‡å°‘å­—ç¬¦ä¸²é¢‘ç¹ä¿®æ”¹æ“ä½œå¦‚<code>append</code>ã€<code>setrange</code>å¯èƒ½å¯¼è‡´çš„é¢„åˆ†é…å®¹é‡ç¿»å€ï¼ˆå†…å­˜ç¢ç‰‡ç‡ä¸Šå‡ï¼‰çš„é—®é¢˜ã€‚</p>
<p>å­—ç¬¦ä¸²é‡æ„ï¼šæŒ‡<strong>ä¸ä¸€å®šæŠŠæ¯ä»½æ•°æ®ä½œä¸ºå­—ç¬¦ä¸²æ•´ä½“å­˜å‚¨ï¼Œåƒjsonè¿™æ ·çš„æ•°æ®å¯ä»¥ä½¿ç”¨hashç»“æ„ï¼Œä½¿ç”¨äºŒçº§ç»“æ„å­˜å‚¨ä¹Ÿèƒ½å¸®æˆ‘ä»¬èŠ‚çœå†…å­˜</strong>ã€‚åŒæ—¶å¯ä»¥ä½¿ç”¨<code>hmget</code>ã€<code>hmset</code>å‘½ä»¤æ”¯æŒå­—æ®µçš„éƒ¨åˆ†è¯»å–ä¿®æ”¹ï¼Œè€Œä¸ç”¨æ¯æ¬¡æ•´ä½“å­˜å–ã€‚å¦‚ä¸‹é¢çš„jsonæ•°æ®ï¼š</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"vid"</span>: <span class="string">"413368768"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"æœç‹å±Œä¸ç”·å£«"</span>,</span><br><span class="line">    <span class="attr">"videoAlbumPic"</span>:<span class="string">"http://photocdn.sohu.com/60160518/vrsa_ver8400079_ae433_pic26.jpg"</span>,</span><br><span class="line">    <span class="attr">"pid"</span>: <span class="string">"6494271"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"1024"</span>,</span><br><span class="line">    <span class="attr">"playlist"</span>: <span class="string">"6494271"</span>,</span><br><span class="line">    <span class="attr">"playTime"</span>: <span class="string">"468"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<center>æµ‹è¯•å†…å­˜è¡¨ç°</center>

<table>
<thead>
<tr>
<th align="center">æ•°æ®é‡</th>
<th align="center">key</th>
<th align="left">å­˜å‚¨ç±»å‹</th>
<th align="center">value</th>
<th align="center">é…ç½®</th>
<th align="center">used_mem</th>
</tr>
</thead>
<tbody><tr>
<td align="center">200w</td>
<td align="center">20å­—èŠ‚</td>
<td align="left">string</td>
<td align="center">json å­—ç¬¦ä¸²</td>
<td align="center">é»˜è®¤</td>
<td align="center">612.2M</td>
</tr>
<tr>
<td align="center">200w</td>
<td align="center">20å­—èŠ‚</td>
<td align="left">hash</td>
<td align="center">key-value å¯¹</td>
<td align="center">é»˜è®¤</td>
<td align="center">1.88G</td>
</tr>
<tr>
<td align="center">200w</td>
<td align="center">20å­—èŠ‚</td>
<td align="left">hash</td>
<td align="center">key-value å¯¹</td>
<td align="center">hash-max-ziplist-value:66</td>
<td align="center">535.60M</td>
</tr>
</tbody></table>
<p>æ ¹æ®æµ‹è¯•ç»“æ„ï¼Œç¬¬ä¸€æ¬¡é»˜è®¤é…ç½®ä¸‹ä½¿ç”¨hashç±»å‹ï¼Œå†…å­˜æ¶ˆè€—ä¸ä½†æ²¡æœ‰é™ä½åè€Œæ¯”å­—ç¬¦ä¸²å­˜å‚¨å¤šå‡º2å€ï¼Œè€Œè°ƒæ•´<code>hash-max-ziplist-value=66</code>ä¹‹åå†…å­˜é™ä½ä¸º535.60Mã€‚å› ä¸ºjsonçš„<code>videoAlbumPic</code>å±æ€§é•¿åº¦æ˜¯65ï¼Œè€Œ<code>hash-max-ziplist-value</code>é»˜è®¤å€¼æ˜¯64ï¼ŒRedisé‡‡ç”¨<code>hashtable</code>ç¼–ç æ–¹å¼ï¼Œåè€Œæ¶ˆè€—äº†å¤§é‡å†…å­˜ã€‚è°ƒæ•´é…ç½®åhashç±»å‹å†…éƒ¨ç¼–ç æ–¹å¼å˜ä¸º<code>ziplist</code>ï¼Œç›¸æ¯”å­—ç¬¦ä¸²æ›´çœå†…å­˜ä¸”æ”¯æŒå±æ€§çš„éƒ¨åˆ†æ“ä½œã€‚</p>
<h3 id="ç¼–ç ä¼˜åŒ–"><a href="#ç¼–ç ä¼˜åŒ–" class="headerlink" title="ç¼–ç ä¼˜åŒ–"></a>ç¼–ç ä¼˜åŒ–</h3><table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç¼–ç æ–¹å¼</th>
<th>æ•°æ®ç»“æ„</th>
</tr>
</thead>
<tbody><tr>
<td>string</td>
<td>raw</td>
<td>åŠ¨æ€å­—ç¬¦ä¸²ç¼–ç </td>
</tr>
<tr>
<td></td>
<td>embstr</td>
<td>ä¼˜åŒ–å†…å­˜åˆ†é…çš„å­—ç¬¦ä¸²ç¼–ç </td>
</tr>
<tr>
<td></td>
<td>int</td>
<td>æ•´æ•°ç¼–ç </td>
</tr>
<tr>
<td>hash</td>
<td>hashtable</td>
<td>æ•£åˆ—è¡¨ç¼–ç </td>
</tr>
<tr>
<td></td>
<td>ziplist</td>
<td>å‹ç¼©åˆ—è¡¨ç¼–ç </td>
</tr>
<tr>
<td>list</td>
<td>linkedlist</td>
<td>åŒå‘é“¾è¡¨ç¼–ç </td>
</tr>
<tr>
<td></td>
<td>ziplist</td>
<td>å‹ç¼©åˆ—è¡¨ç¼–ç </td>
</tr>
<tr>
<td></td>
<td>quicklist</td>
<td></td>
</tr>
<tr>
<td>set</td>
<td>hashtable</td>
<td>æ•£åˆ—è¡¨ç¼–ç </td>
</tr>
<tr>
<td></td>
<td>intset</td>
<td>æ•´æ•°é›†åˆç¼–ç </td>
</tr>
<tr>
<td>zset</td>
<td>skiplist</td>
<td>è·³è·ƒè¡¨ç¼–ç </td>
</tr>
<tr>
<td></td>
<td>ziplist</td>
<td>å‹ç¼©åˆ—è¡¨ç¼–ç </td>
</tr>
</tbody></table>
<p>Redis å¯¹ä¸€ç§æ•°æ®ç»“æ„å®ç°å¤šç§ç¼–ç æ–¹å¼ä¸»è¦åŸå› æ˜¯Redisä½œè€…æƒ³é€šè¿‡ä¸åŒç¼–ç å®ç°æ•ˆç‡å’Œç©ºé—´çš„å¹³è¡¡ã€‚æ¯”å¦‚å½“æˆ‘ä»¬çš„å­˜å‚¨åªæœ‰10ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œå½“ä½¿ç”¨åŒå‘é“¾è¡¨æ•°æ®ç»“æ„æ—¶ï¼Œå¿…ç„¶éœ€è¦ç»´æŠ¤å¤§é‡çš„å†…éƒ¨å­—æ®µå¦‚æ¯ä¸ªå…ƒç´ éœ€è¦ï¼šå‰ç½®æŒ‡é’ˆï¼Œåç½®æŒ‡é’ˆï¼Œæ•°æ®æŒ‡é’ˆç­‰ï¼Œé€ æˆç©ºé—´æµªè´¹ï¼Œå¦‚æœé‡‡ç”¨è¿ç»­å†…å­˜ç»“æ„çš„å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ï¼Œå°†ä¼šèŠ‚çœå¤§é‡å†…å­˜ï¼Œè€Œç”±äºæ•°æ®é•¿åº¦è¾ƒå°ï¼Œå­˜å–æ“ä½œæ—¶é—´å¤æ‚åº¦å³ä½¿ä¸º$O(n^2)$æ€§èƒ½ä¹Ÿå¯æ»¡è¶³éœ€æ±‚ã€‚</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç¼–ç </th>
<th>å†³å®šæ¡ä»¶</th>
</tr>
</thead>
<tbody><tr>
<td>hash</td>
<td>ziplist</td>
<td>æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼š<br>value æœ€å¤§ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰&lt;= hash-max-ziplist-value<br>field ä¸ªæ•° &lt;= hash-max-ziplist-entries</td>
</tr>
<tr>
<td></td>
<td>hashtable</td>
<td>æ»¡è¶³ä»»æ„æ¡ä»¶ï¼š<br>value æœ€å¤§ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰&gt; hash-max-ziplist-value<br>field ä¸ªæ•° &gt; hash-max-ziplist-entries</td>
</tr>
<tr>
<td>list</td>
<td>ziplist</td>
<td>æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼š<br>value æœ€å¤§ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰&lt;= list-max-ziplist-value<br>é“¾è¡¨é•¿åº¦ &lt;= list-max-ziplist-entries</td>
</tr>
<tr>
<td></td>
<td>linkedlist</td>
<td>æ»¡è¶³ä»»æ„æ¡ä»¶ï¼š<br>value æœ€å¤§ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰&gt; list-max-ziplist-value<br>é“¾è¡¨é•¿åº¦ &gt; list-max-ziplist-entries</td>
</tr>
<tr>
<td></td>
<td>quicklist</td>
<td>list-max-ziplist-sizeï¼šè¡¨ç¤ºæœ€å¤§å‹ç¼©ç©ºé—´æˆ–é•¿åº¦<br>æœ€å¤§ç©ºé—´ä½¿ç”¨[-5-1]èŒƒå›´é…ç½®ï¼Œé»˜è®¤-2 è¡¨ç¤º 8KB<br>æ­£æ•´æ•°è¡¨ç¤ºæœ€å¤§å‹ç¼©é•¿åº¦<br>list-compress-depthï¼šè¡¨ç¤ºæœ€å¤§å‹ç¼©æ·±åº¦ï¼Œé»˜è®¤ä¸º 0 è¡¨ç¤ºä¸å‹ç¼©</td>
</tr>
<tr>
<td>set</td>
<td>intset</td>
<td>æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼š<br>å…ƒç´ å¿…é¡»ä¸ºæ•´æ•°<br>é›†åˆé•¿åº¦ &lt;= set-max-intset-entries</td>
</tr>
<tr>
<td></td>
<td>hashtable</td>
<td>æ»¡è¶³ä»»æ„æ¡ä»¶ï¼š<br>å…ƒç´ éæ•´æ•°ç±»å‹<br>é›†åˆé•¿åº¦ &gt; set-max-ziplist-entries</td>
</tr>
<tr>
<td>zset</td>
<td>ziplist</td>
<td>æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼š<br>value æœ€å¤§ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰&lt;= zset-max-ziplist-value<br>æœ‰åºé›†åˆé•¿åº¦ &lt;= zset-max-ziplist-entries</td>
</tr>
<tr>
<td></td>
<td>skiplist</td>
<td>æ»¡è¶³ä»»æ„æ¡ä»¶ï¼š<br>value æœ€å¤§ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰&gt; zset-max-ziplist-value<br>æœ‰åºé›†åˆé•¿åº¦ &gt; zset-max-ziplist-entries</td>
</tr>
</tbody></table>
<p>ziplistç¼–ç ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œå› æ­¤æ‰€æœ‰æ•°æ®éƒ½æ˜¯é‡‡ç”¨çº¿æ€§è¿ç»­çš„å†…å­˜ç»“æ„ã€‚ziplistç¼–ç æ˜¯åº”ç”¨èŒƒå›´æœ€å¹¿çš„ä¸€ç§ï¼Œå¯ä»¥åˆ†åˆ«ä½œä¸ºhashã€listã€zsetç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„å®ç°ã€‚å…¶å†…éƒ¨ç»“æ„å¦‚å›¾ï¼š<br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g982kp4di3j30lh0fadim.jpg"></p>
<p>ziplistç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å†…éƒ¨è¡¨ç°ä¸ºæ•°æ®ç´§å‡‘æ’åˆ—çš„ä¸€å—è¿ç»­å†…å­˜æ•°ç»„ã€‚</li>
<li>å¯ä»¥æ¨¡æ‹ŸåŒå‘é“¾è¡¨ç»“æ„ï¼Œä»¥$O(1)$æ—¶é—´å¤æ‚åº¦å…¥é˜Ÿå’Œå‡ºé˜Ÿã€‚</li>
<li>æ–°å¢åˆ é™¤æ“ä½œæ¶‰åŠå†…å­˜é‡æ–°åˆ†é…æˆ–é‡Šæ”¾ï¼ŒåŠ å¤§äº†æ“ä½œçš„å¤æ‚æ€§ã€‚(<strong>ziplistå‹ç¼©ç¼–ç çš„åŸåˆ™ï¼šè¿½æ±‚ç©ºé—´å’Œæ—¶é—´çš„å¹³è¡¡</strong>)</li>
<li>è¯»å†™æ“ä½œæ¶‰åŠå¤æ‚çš„æŒ‡é’ˆç§»åŠ¨ï¼Œæœ€åæ—¶é—´å¤æ‚åº¦ä¸º$O(n^2)$ã€‚</li>
<li><strong>é€‚åˆå­˜å‚¨å°å¯¹è±¡å’Œé•¿åº¦æœ‰é™çš„æ•°æ®</strong>ã€‚</li>
</ul>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒRedis é€šè¿‡å¤šç§æ‰‹æ®µæ¥ä¿éšœæ€§èƒ½ï¼Œå¦‚å•çº¿ç¨‹ã€epollã€åŸºäºå†…å­˜æ“ä½œã€å†…å­˜é¢„åˆ†é…ã€è‡ªåŠ¨åˆ‡æ¢åˆç†çš„æ•°æ®ç»“æ„ç­‰ï¼Œä½œè€…åœ¨è¿™æ–¹ä¾¿åšäº†å¾ˆå¤šçš„åŠªåŠ›ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰å¾ˆå¤š$O(1)$å¤æ‚åº¦æ–¹æ³•ï¼Œæ—¥åæ‰èƒ½å¤§è¡Œå…¶é“ï¼Œè¿™å…¶ä¸­æˆ‘ä»¬å¯ä»¥å€Ÿé‰´çš„ç»éªŒä¿¯æ‹¾çš†æ˜¯ï¼Œè¶³è§ä½œè€…æ˜¯ä¸€ä¸ªæœ‰è¿½æ±‚çš„ coderï¼Œç›¸ä¿¡ Redis çš„æºç ä¼šç»™ä¸æˆ‘ä»¬æ›´å¤šçš„å¯å‘ã€‚</p>
</blockquote>
<h3 id="æ§åˆ¶é”®çš„æ•°é‡"><a href="#æ§åˆ¶é”®çš„æ•°é‡" class="headerlink" title="æ§åˆ¶é”®çš„æ•°é‡"></a>æ§åˆ¶é”®çš„æ•°é‡</h3><p>å¯¹äºå­˜å‚¨ç›¸åŒçš„æ•°æ®å†…å®¹åˆ©ç”¨Redisçš„æ•°æ®ç»“æ„(å¦‚hash)é™ä½å¤–å±‚é”®çš„æ•°é‡ï¼Œä¹Ÿå¯ä»¥èŠ‚çœå¤§é‡å†…å­˜ã€‚</p>
<p>å»ºè®®ä½¿ç”¨Rediså­˜å‚¨å¤§é‡æ•°æ®æ—¶ï¼ŒæŠŠå†…å­˜ä¼˜åŒ–ç¯èŠ‚åŠ å…¥åˆ°å‰æœŸè®¾è®¡é˜¶æ®µï¼Œå¦åˆ™æ•°æ®å¤§å¹…å¢é•¿åï¼Œå¼€å‘äººå‘˜éœ€è¦é¢å¯¹é‡æ–°ä¼˜åŒ–å†…å­˜æ‰€å¸¦æ¥å¼€å‘å’Œæ•°æ®è¿ç§»çš„åŒé‡æˆæœ¬ã€‚<strong>å½“Rediså†…å­˜ä¸è¶³æ—¶ï¼Œé¦–å…ˆè€ƒè™‘çš„é—®é¢˜ä¸æ˜¯åŠ æœºå™¨åšæ°´å¹³æ‰©å±•ï¼Œåº”è¯¥å…ˆå°è¯•åšå†…å­˜ä¼˜åŒ–ï¼Œå½“é‡åˆ°ç“¶é¢ˆæ—¶ï¼Œå†å»è€ƒè™‘æ°´å¹³æ‰©å±•</strong>ã€‚å³ä½¿å¯¹äºé›†ç¾¤åŒ–æ–¹æ¡ˆï¼Œå‚ç›´å±‚é¢ä¼˜åŒ–ä¹ŸåŒæ ·é‡è¦ï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæµªè´¹å’Œé›†ç¾¤åŒ–åçš„ç®¡ç†æˆæœ¬ã€‚</p>
<h2 id="ä¼˜åŒ–æ€»ç»“"><a href="#ä¼˜åŒ–æ€»ç»“" class="headerlink" title="ä¼˜åŒ–æ€»ç»“"></a>ä¼˜åŒ–æ€»ç»“</h2><p>å†…å­˜æ˜¯ç›¸å¯¹å®è´µçš„èµ„æºï¼Œé€šè¿‡åˆç†çš„ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆåœ°é™ä½å†…å­˜çš„ä½¿ç”¨é‡ï¼Œå†…å­˜ä¼˜åŒ–çš„æ€è·¯åŒ…æ‹¬</p>
<ul>
<li>ç²¾ç®€é”®å€¼å¯¹å¤§å°ï¼Œä½¿ç”¨é«˜æ•ˆäºŒè¿›åˆ¶åºåˆ—åŒ–å·¥å…·ã€‚</li>
<li>ä½¿ç”¨å¯¹è±¡å…±äº«æ± ä¼˜åŒ–å°æ•´æ•°å¯¹è±¡ã€‚</li>
<li>æ•°æ®ä¼˜å…ˆä½¿ç”¨æ•´æ•°ï¼Œæ¯”å­—ç¬¦ä¸²ç±»å‹æ›´èŠ‚çœç©ºé—´ã€‚</li>
<li>ä¼˜åŒ–å­—ç¬¦ä¸²ä½¿ç”¨ï¼Œé¿å…é¢„åˆ†é…é€ æˆçš„å†…å­˜æµªè´¹ã€‚</li>
<li>ä½¿ç”¨<code>ziplist</code>å‹ç¼©ç¼–ç ä¼˜åŒ–<code>hash</code>ã€<code>list</code>ç­‰ç»“æ„ï¼Œæ³¨é‡æ•ˆç‡å’Œç©ºé—´çš„å¹³è¡¡ã€‚</li>
<li>ä½¿ç”¨<code>intset</code>ç¼–ç ä¼˜åŒ–æ•´æ•°é›†åˆã€‚</li>
<li>ä½¿ç”¨<code>ziplist</code>ç¼–ç çš„<code>hash</code>ç»“æ„é™ä½å°å¯¹è±¡é“¾è§„æ¨¡ã€‚</li>
</ul>
<h1 id="ç¬¬-9-ç« -å“¨å…µ"><a href="#ç¬¬-9-ç« -å“¨å…µ" class="headerlink" title="ç¬¬ 9 ç«  å“¨å…µ"></a>ç¬¬ 9 ç«  å“¨å…µ</h1><h2 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h2><p>ä¸»ä»æ¨¡å¼ä¸‹å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ol>
<li>ä¸»èŠ‚ç‚¹å®•æœºçš„æ•…éšœè½¬ç§»éœ€è¦äººå·¥ä»‹å…¥æ¢å¤ï¼ˆğŸ‘‰ å“¨å…µï¼‰</li>
<li>ä¸»èŠ‚ç‚¹çš„å†™èƒ½åŠ›ä¸å­˜å‚¨èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ï¼ˆğŸ‘‰ é›†ç¾¤ï¼‰</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g994eh8oswj30lt0fr41y.jpg"></p>
<p>Redis Sentinel å…·æœ‰ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>ç›‘æ§ï¼šSentinelèŠ‚ç‚¹ä¼šå®šæœŸæ£€æµ‹Redisæ•°æ®èŠ‚ç‚¹ã€å…¶ä½™SentinelèŠ‚ç‚¹æ˜¯å¦å¯è¾¾ã€‚</li>
<li>é€šçŸ¥ï¼šSentinelèŠ‚ç‚¹ä¼šå°†æ•…éšœè½¬ç§»çš„ç»“æœé€šçŸ¥ç»™åº”ç”¨æ–¹ã€‚</li>
<li>ä¸»èŠ‚ç‚¹æ•…éšœè½¬ç§»ï¼šå®ç°ä»èŠ‚ç‚¹æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹å¹¶ç»´æŠ¤åç»­æ­£ç¡®çš„ä¸»ä»å…³ç³»ã€‚</li>
<li>é…ç½®æä¾›è€…ï¼šåœ¨Redis Sentinelç»“æ„ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¿æ¥çš„æ˜¯SentinelèŠ‚ç‚¹é›†åˆï¼Œä»ä¸­è·å–ä¸»èŠ‚ç‚¹ä¿¡æ¯ã€‚</li>
</ul>
<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>ä»èŠ‚ç‚¹çš„éƒ¨ç½²ä¸ä¸»èŠ‚ç‚¹çš„åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯æ·»åŠ äº†<code>slaveof</code>é…ç½®ã€‚<br>å¯é€šè¿‡<code>info replication</code>å‘½ä»¤æŸ¥çœ‹ä»èŠ‚ç‚¹æˆ–æ‰€å±ä¸»èŠ‚ç‚¹ã€‚</p>
<p>å“¨å…µèŠ‚ç‚¹é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel-<span class="number">26379</span>.conf</span><br><span class="line">port <span class="number">26379</span>                                                      <span class="regexp">//</span> å“¨å…µé»˜è®¤ç«¯å£</span><br><span class="line">daemonize yes</span><br><span class="line">logfile <span class="string">"26379.log"</span>                                             <span class="regexp">//</span> æ—¥å¿—æ–‡ä»¶</span><br><span class="line">dir <span class="regexp">/opt/</span>soft<span class="regexp">/redis/</span>data</span><br><span class="line">sentinel monitor mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span> <span class="number">2</span>                      <span class="regexp">//</span> è¯¥å“¨å…µç›‘æ§ mymaster <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">6379</span> çš„ä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶éœ€è¦ <span class="number">2</span> ä¸ªå“¨å…µåˆ¤æ–­æ•…éšœæ‰ä¼šè¿›è¡Œæ•…éšœè½¬ç§»ã€‚æ•…éšœåˆ¤å®šå‚æ•° quorum å»ºè®®è®¾ç½®ä¸º**å“¨å…µèŠ‚ç‚¹æ•°é‡çš„ä¸€èˆ¬åŠ  <span class="number">1</span>**ï¼ŒåŒæ—¶è¯¥å‚æ•°è¿˜ä¸å“¨å…µèŠ‚ç‚¹çš„é¢†å¯¼è€…é€‰ä¸¾æœ‰å…³ï¼Œè‡³å°‘éœ€è¦æœ‰ `max(quorum, num(sentinels)/<span class="number">2</span> + <span class="number">1</span>)`ä¸ªèŠ‚ç‚¹å‚ä¸é€‰ä¸¾ï¼Œæ‰èƒ½é€‰å‡ºå“¨å…µé¢†å¯¼è€…</span><br><span class="line">sentinel down-after-milliseconds mymaster <span class="number">30000</span>                 <span class="regexp">//</span> ç›‘æ§èŠ‚ç‚¹çš„è¶…æ—¶æ—¶é—´</span><br><span class="line">sentinel parallel-syncs mymaster <span class="number">1</span>                              <span class="regexp">//</span> ç”¨äºé™åˆ¶ä¸€æ¬¡æ•…éšœè½¬ç§»åï¼Œæ¯æ¬¡å‘æ–°çš„ä¸»èŠ‚ç‚¹å‘èµ·å¤åˆ¶æ“ä½œçš„ä»èŠ‚ç‚¹ä¸ªæ•°ã€‚åŒæ—¶å‘ä¸»èŠ‚ç‚¹å‘èµ·å¤åˆ¶ï¼Œå¿…ç„¶ä¼šå¯¹ä¸»æœºè¯¶å•æ‰€åœ¨æœºå™¨é€ æˆç½‘ç»œä¸ç£ç›˜å¼€é”€</span><br><span class="line">sentinel failover-timeout mymaster <span class="number">180000</span>                       <span class="regexp">//</span> æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´</span><br><span class="line"><span class="comment"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;                   </span></span><br><span class="line"><span class="comment"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;      // åœ¨æ•…éšœ**è½¬ç§»æœŸé—´**çš„å‘Šè­¦äº‹ä»¶è„šæœ¬</span></span><br><span class="line"><span class="comment"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;   // åœ¨æ•…éšœ**è½¬ç§»ç»“æŸå**çš„äº‹ä»¶è„šæœ¬</span></span><br></pre></td></tr></tbody></table></figure>

<p>å¯åŠ¨SentinelèŠ‚ç‚¹çš„å‘½ä»¤ï¼š<code>redis-sentinel</code>æˆ–<code>redis-server redis-sentinel-26379.conf --sentinel</code>ã€‚<br>å¯é€šè¿‡<code>info sentinel</code>å‘½ä»¤æŸ¥çœ‹å“¨å…µèŠ‚ç‚¹ä¿¡æ¯<br>å“¨å…µèŠ‚ç‚¹ä¼šé€šè¿‡ä¸»èŠ‚ç‚¹å‘ç°ä»èŠ‚ç‚¹ä»¥åŠå…¶å®ƒå“¨å…µèŠ‚ç‚¹ï¼Œä»è€Œå®ç°å¯¹æ‰€æœ‰èŠ‚ç‚¹çš„ç›‘æ§ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9bsaxy49ij30kq0eetcb.jpg"></p>
<p>éƒ¨ç½²æŠ€å·§</p>
<ul>
<li>å“¨å…µèŠ‚ç‚¹ä¸åº”è¯¥éƒ¨ç½²åœ¨åŒä¸€å°ç‰©ç†æœºä¸Š</li>
<li>éƒ¨ç½²è‡³å°‘ä¸‰ä¸ªä¸”å¥‡æ•°ä¸ªå“¨å…µèŠ‚ç‚¹</li>
<li>å¦‚æœå“¨å…µèŠ‚ç‚¹é›†åˆç›‘æ§çš„æ˜¯åŒä¸€ä¸ªä¸šåŠ¡çš„å¤šä¸ªä¸»èŠ‚ç‚¹é›†åˆï¼Œé‚£ä¹ˆé‡‡ç”¨ä¸€å¥—å“¨å…µèŠ‚ç‚¹ç›‘æ§å¤šä¸ªä¸»ä»èŠ‚ç‚¹ï¼Œå¦åˆ™é‡‡ç”¨å¤šä¸ªå“¨å…µèŠ‚ç‚¹ç›‘æ§å¤šä¸ªä¸»ä»èŠ‚ç‚¹çš„æ–¹æ¡ˆã€‚</li>
</ul>
<h2 id="å“¨å…µèŠ‚ç‚¹çš„-API"><a href="#å“¨å…µèŠ‚ç‚¹çš„-API" class="headerlink" title="å“¨å…µèŠ‚ç‚¹çš„ API"></a>å“¨å…µèŠ‚ç‚¹çš„ API</h2><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>sentinel masters</code></td>
<td>å±•ç¤ºæ‰€æœ‰è¢«ç›‘æ§çš„ä¸»èŠ‚ç‚¹çŠ¶æ€ä»¥åŠç›¸å…³ç»Ÿè®¡ä¿¡æ¯</td>
</tr>
<tr>
<td><code>sentinel master &lt;master name&gt;</code></td>
<td>å±•ç¤ºæŒ‡å®š<code>&lt;master name&gt;</code>çš„ä¸»èŠ‚ç‚¹çŠ¶æ€ä»¥åŠç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯</td>
</tr>
<tr>
<td><code>sentinel slaves &lt;master name&gt;</code></td>
<td>å±•ç¤ºæŒ‡å®š<code>&lt;master name&gt;</code>çš„ä»èŠ‚ç‚¹çŠ¶æ€ä»¥åŠç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯</td>
</tr>
<tr>
<td><code>sentinel sentinels &lt;master name&gt;</code></td>
<td>å±•ç¤ºæŒ‡å®š<code>&lt;master name&gt;</code>çš„SentinelèŠ‚ç‚¹é›†åˆï¼ˆä¸åŒ…å«å½“å‰SentinelèŠ‚ç‚¹ï¼‰</td>
</tr>
<tr>
<td><code>sentinel get-master-addr-by-name &lt;master name&gt;</code></td>
<td>è¿”å›æŒ‡å®š<code>&lt;master name&gt;</code>ä¸»èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£</td>
</tr>
<tr>
<td><code>sentinel reset &lt;pattern&gt;</code></td>
<td>å½“å‰SentinelèŠ‚ç‚¹å¯¹ç¬¦åˆ<code>&lt;pattern&gt;</code>ï¼ˆé€šé…ç¬¦é£æ ¼ï¼‰ä¸»èŠ‚ç‚¹çš„é…ç½®è¿›è¡Œé‡ç½®ï¼ŒåŒ…å«æ¸…é™¤ä¸»èŠ‚ç‚¹çš„ç›¸å…³çŠ¶æ€ï¼ˆä¾‹å¦‚æ•…éšœè½¬ç§»ï¼‰ï¼Œé‡æ–°å‘ç°ä»èŠ‚ç‚¹å’ŒSentinelèŠ‚ç‚¹ã€‚</td>
</tr>
<tr>
<td><code>sentinel failover &lt;master name&gt;</code></td>
<td>å¯¹æŒ‡å®š<code>&lt;master name&gt;</code>ä¸»èŠ‚ç‚¹è¿›è¡Œå¼ºåˆ¶æ•…éšœè½¬ç§»ï¼ˆæ²¡æœ‰å’Œå…¶ä»–SentinelèŠ‚ç‚¹â€œåå•†â€ï¼‰ï¼Œå½“æ•…éšœè½¬ç§»å®Œæˆåï¼Œå…¶ä»–SentinelèŠ‚ç‚¹æŒ‰ç…§æ•…éšœè½¬ç§»çš„ç»“æœæ›´æ–°è‡ªèº«é…ç½®ï¼Œè¿™ä¸ªå‘½ä»¤åœ¨Redis Sentinelçš„æ—¥å¸¸è¿ç»´ä¸­éå¸¸æœ‰ç”¨ã€‚</td>
</tr>
<tr>
<td><code>sentinel ckquorum &lt;master name&gt;</code></td>
<td>æ£€æµ‹å½“å‰å¯è¾¾çš„SentinelèŠ‚ç‚¹æ€»æ•°æ˜¯å¦è¾¾åˆ°<code>&lt;quorum&gt;</code>çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><code>sentinel flushconfig</code></td>
<td>å°†SentinelèŠ‚ç‚¹çš„é…ç½®å¼ºåˆ¶åˆ·åˆ°ç£ç›˜ä¸Šï¼Œè¿™ä¸ªå‘½ä»¤SentinelèŠ‚ç‚¹è‡ªèº«ç”¨å¾—æ¯”è¾ƒå¤šï¼Œå¯¹äºå¼€å‘å’Œè¿ç»´äººå‘˜åªæœ‰å½“å¤–éƒ¨åŸå› ï¼ˆä¾‹å¦‚ç£ç›˜æŸåï¼‰é€ æˆé…ç½®æ–‡ä»¶æŸåæˆ–è€…ä¸¢å¤±æ—¶ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</td>
</tr>
<tr>
<td><code>sentinel remove &lt;master name&gt;</code></td>
<td>å–æ¶ˆå½“å‰SentinelèŠ‚ç‚¹å¯¹äºæŒ‡å®š<code>&lt;master name&gt;</code>ä¸»èŠ‚ç‚¹çš„ç›‘æ§ã€‚</td>
</tr>
<tr>
<td><code>sentinel monitor &lt;master name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</code></td>
<td>ä¸é…ç½®æ–‡ä»¶ä¸­çš„å«ä¹‰æ˜¯å®Œå…¨ä¸€æ ·</td>
</tr>
<tr>
<td><code>sentinel set &lt;master name&gt;</code></td>
<td>åŠ¨æ€ä¿®æ”¹SentinelèŠ‚ç‚¹é…ç½®é€‰é¡¹ã€‚æ³¨æ„ï¼šè¯¥å‘½ä»¤åªä¼šå¯¹å½“å‰èŠ‚ç‚¹æœ‰æ•ˆï¼Œä¸”ä¿®æ”¹æˆåŠŸåä¼šç«‹å³ç”Ÿæ•ˆ</td>
</tr>
<tr>
<td><code>sentinel is-master-down-by-addr</code></td>
<td>SentinelèŠ‚ç‚¹ä¹‹é—´ç”¨æ¥äº¤æ¢å¯¹ä¸»èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿çš„åˆ¤æ–­ï¼Œæ ¹æ®å‚æ•°çš„ä¸åŒï¼Œè¿˜å¯ä»¥ä½œä¸ºSentinelé¢†å¯¼è€…é€‰ä¸¾çš„é€šä¿¡æ–¹å¼</td>
</tr>
</tbody></table>
<p>Redis Sentinel å®¢æˆ·ç«¯åŸºæœ¬å®ç°åŸç†</p>
<ol>
<li>éå†SentinelèŠ‚ç‚¹é›†åˆè·å–ä¸€ä¸ªå¯ç”¨çš„SentinelèŠ‚ç‚¹(SentinelèŠ‚ç‚¹ä¹‹é—´å¯ä»¥å…±äº«æ•°æ®)ï¼Œæ‰€ä»¥å¯ä»¥ä»ä»»æ„ä¸€ä¸ªSentinelèŠ‚ç‚¹è·å–ä¸»èŠ‚ç‚¹ä¿¡æ¯</li>
<li>é€šè¿‡<code>sentinel get-master-addr-by-name master-name</code>è¿™ä¸ªAPIæ¥è·å–å¯¹åº”ä¸»èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯</li>
<li>éªŒè¯å½“å‰è·å–çš„â€œä¸»èŠ‚ç‚¹â€æ˜¯çœŸæ­£çš„ä¸»èŠ‚ç‚¹(é€šè¿‡ <code>role</code> æˆ–è€… <code>info replication</code> åˆ¤å®š)ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢æ•…éšœè½¬ç§»æœŸé—´ä¸»èŠ‚ç‚¹çš„å˜åŒ–</li>
<li>ä¿æŒå’ŒSentinelèŠ‚ç‚¹é›†åˆçš„â€œè”ç³»â€ï¼Œæ—¶åˆ»è·å–å…³äºä¸»èŠ‚ç‚¹çš„ç›¸å…³â€œä¿¡æ¯â€</li>
</ol>
<h2 id="Redis-Sentinel-çš„å®ç°åŸç†"><a href="#Redis-Sentinel-çš„å®ç°åŸç†" class="headerlink" title="Redis Sentinel çš„å®ç°åŸç†"></a>Redis Sentinel çš„å®ç°åŸç†</h2><h3 id="ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡"><a href="#ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡" class="headerlink" title="ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡"></a>ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡</h3><ol>
<li>æ¯éš”10ç§’ï¼Œæ¯ä¸ªSentinelèŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å‘é€<code>info</code>å‘½ä»¤è·å–æœ€æ–°çš„æ‹“æ‰‘ç»“æ„ã€‚è¯¥ä»»åŠ¡çš„ä½œç”¨è¡¨ç°åœ¨ï¼š<ol>
<li>é€šè¿‡å‘ä¸»èŠ‚ç‚¹æ‰§è¡Œ<code>info</code>å‘½ä»¤ï¼Œè·å–ä»èŠ‚ç‚¹çš„ä¿¡æ¯</li>
<li>å½“æœ‰æ–°çš„ä»èŠ‚ç‚¹åŠ å…¥æ—¶éƒ½å¯ä»¥ç«‹åˆ»æ„ŸçŸ¥å‡ºæ¥</li>
<li>èŠ‚ç‚¹ä¸å¯è¾¾æˆ–è€…æ•…éšœè½¬ç§»åï¼Œå¯ä»¥é€šè¿‡<code>info</code>å‘½ä»¤å®æ—¶æ›´æ–°èŠ‚ç‚¹æ‹“æ‰‘ä¿¡æ¯ã€‚</li>
</ol>
</li>
<li>æ¯éš”2ç§’ï¼Œæ¯ä¸ªSentinelèŠ‚ç‚¹ä¼šå‘Redisæ•°æ®èŠ‚ç‚¹çš„<code>__sentinel__ï¼šhello</code>é¢‘é“ä¸Šå‘é€è¯¥SentinelèŠ‚ç‚¹å¯¹äºä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ä»¥åŠå½“å‰SentinelèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒåŒæ—¶æ¯ä¸ªSentinelèŠ‚ç‚¹ä¹Ÿä¼šè®¢é˜…è¯¥é¢‘é“ï¼Œæ¥äº†è§£å…¶ä»–SentinelèŠ‚ç‚¹ä»¥åŠå®ƒä»¬å¯¹ä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œæ‰€ä»¥è¿™ä¸ªå®šæ—¶ä»»åŠ¡å¯ä»¥å®Œæˆä»¥ä¸‹ä¸¤ä¸ªå·¥ä½œï¼š<ol>
<li>å‘ç°æ–°çš„SentinelèŠ‚ç‚¹ï¼šé€šè¿‡è®¢é˜…ä¸»èŠ‚ç‚¹çš„<code>__sentinel__ï¼šhello</code>äº†è§£å…¶ä»–çš„SentinelèŠ‚ç‚¹ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ–°åŠ å…¥çš„SentinelèŠ‚ç‚¹ï¼Œå°†è¯¥SentinelèŠ‚ç‚¹ä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸è¯¥SentinelèŠ‚ç‚¹åˆ›å»ºè¿æ¥ã€‚</li>
<li>SentinelèŠ‚ç‚¹ä¹‹é—´äº¤æ¢ä¸»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä½œä¸ºåé¢å®¢è§‚ä¸‹çº¿ä»¥åŠé¢†å¯¼è€…é€‰ä¸¾çš„ä¾æ®ã€‚SentinelèŠ‚ç‚¹publishçš„æ¶ˆæ¯æ ¼å¼ï¼š<code>&lt;SentinelèŠ‚ç‚¹IP&gt; &lt;SentinelèŠ‚ç‚¹ç«¯å£&gt; &lt;SentinelèŠ‚ç‚¹runId&gt; &lt;SentinelèŠ‚ç‚¹é…ç½®ç‰ˆæœ¬&gt; &lt;ä¸»èŠ‚ç‚¹åå­—&gt; &lt;ä¸»èŠ‚ç‚¹Ip&gt; &lt;ä¸»èŠ‚ç‚¹ç«¯å£&gt; &lt;ä¸»èŠ‚ç‚¹é…ç½®ç‰ˆæœ¬&gt;</code></li>
</ol>
</li>
<li>æ¯éš”1ç§’ï¼Œæ¯ä¸ªSentinelèŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹ã€å…¶ä½™SentinelèŠ‚ç‚¹å‘é€ä¸€æ¡pingå‘½ä»¤åšä¸€æ¬¡å¿ƒè·³æ£€æµ‹ï¼Œæ¥ç¡®è®¤è¿™äº›èŠ‚ç‚¹å½“å‰æ˜¯å¦å¯è¾¾ã€‚è¿™ä¸ªå®šæ—¶ä»»åŠ¡æ˜¯èŠ‚ç‚¹å¤±è´¥åˆ¤å®šçš„é‡è¦ä¾æ®ã€‚</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/middle/006y8mN6ly1g9chovnyqwj30lm0ls77d.jpg"><br><img src="https://tva1.sinaimg.cn/middle/006y8mN6ly1g9chuf4cjdj30ld0hogp4.jpg"><br><img src="https://tva1.sinaimg.cn/middle/006y8mN6ly1g9chunrge9j30mh0hbtbn.jpg"></p>
<h3 id="ä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿"><a href="#ä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿" class="headerlink" title="ä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿"></a>ä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿</h3><p>ä¸»è§‚ä¸‹çº¿ï¼šå•ä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­ä¸»èŠ‚ç‚¹è¶…è¿‡<code>down-after-milliseconds</code>æ—¶ï¼Œè¯¥å“¨å…µèŠ‚ç‚¹å³è®¤ä¸ºè¯¥ä¸»èŠ‚ç‚¹å·²ä¸‹çº¿<br>å®¢è§‚ä¸‹çº¿ï¼šä¸ºäº†é˜²æ­¢ä¸»è§‚ä¸‹çº¿çš„è¯¯åˆ¤ï¼Œå› æ­¤è¿˜éœ€è¦å‘é€<code>è¿‡sentinel ismaster-down-by-addr</code>å‘½ä»¤å‘å…¶ä»–SentinelèŠ‚ç‚¹è¯¢é—®å¯¹ä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå½“è¶…è¿‡<code>&lt;quorum&gt;</code>ä¸ªæ•°ï¼Œå³åˆ¤å®šè¯¥ä¸»èŠ‚ç‚¹ç¡®å®å·²ä¸‹çº¿</p>
<h3 id="é¢†å¯¼è€…-Sentinel-èŠ‚ç‚¹é€‰ä¸¾"><a href="#é¢†å¯¼è€…-Sentinel-èŠ‚ç‚¹é€‰ä¸¾" class="headerlink" title="é¢†å¯¼è€… Sentinel èŠ‚ç‚¹é€‰ä¸¾"></a>é¢†å¯¼è€… Sentinel èŠ‚ç‚¹é€‰ä¸¾</h3><p><strong>Redis ä½¿ç”¨äº† <a target="_blank" rel="noopener" href="https://raft.github.io/">Raft ç®—æ³•</a> å®ç°é¢†å¯¼è€…é€‰ä¸¾</strong>ã€‚è¯¥ç®—æ³•çš„æ€è·¯ä¸ºï¼šæ¯ä¸ªèŠ‚ç‚¹å‡æœ‰é€‰ä¸¾ä¸è¢«é€‰ä¸¾èµ„æ ¼ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸”åªæœ‰ 1 ç¥¨ã€‚å½“å“¨å…µèŠ‚ç‚¹å®Œæˆä¸»è§‚ä¸‹çº¿åï¼Œå‘å…¶å®ƒå“¨å…µèŠ‚ç‚¹è¯¢é—®å®¢è§‚ä¸‹çº¿æ—¶ï¼Œä¼šæè®®è‡ªèº«ä½œä¸ºå“¨å…µé¢†å¯¼è€…ï¼Œè‹¥è¢«è¯¢é—®è€…å°šæœªæŠ•ç¥¨ï¼Œåˆ™å–å¾—è¯¥è¢«è¯¢é—®è€…çš„ç¥¨æ•°ï¼Œå¦‚æœè¯¢é—®è€…çš„ç¥¨æ•°å¤§äºç­‰äº<code>max(quorum, num(sentinels)/2 + 1)</code>ï¼Œåˆ™è¯¥è¯¢é—®è€…æˆä¸ºé¢†å¯¼ï¼Œé€‰ä¸¾ç»“æŸï¼ŒåŒæ—¶ç»ˆæ­¢å…¶å®ƒèŠ‚ç‚¹çš„è¯¢é—®ã€‚</p>
<p>Raft ä½œä¸ºä¸€è‡´æ€§åè®®ï¼Œæä¾›äº†ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„åŠŸèƒ½ï¼š</p>
<ol>
<li>Leader é€‰ä¸¾</li>
<li>æˆå‘˜å˜æ›´</li>
<li>æ—¥å¿—å¤åˆ¶</li>
</ol>
<h3 id="æ•…éšœè½¬ç§»"><a href="#æ•…éšœè½¬ç§»" class="headerlink" title="æ•…éšœè½¬ç§»"></a>æ•…éšœè½¬ç§»</h3><p>æ•…éšœè½¬ç§»çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åœ¨ä»èŠ‚ç‚¹åˆ—è¡¨ä¸­é€‰å‡ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œé€‰æ‹©æ–¹æ³•å¦‚ä¸‹<ol>
<li>è¿‡æ»¤ï¼šâ€œä¸å¥åº·â€ï¼ˆä¸»è§‚ä¸‹çº¿ã€æ–­çº¿ï¼‰ã€5ç§’å†…æ²¡æœ‰å›å¤è¿‡SentinelèŠ‚ç‚¹pingå“åº”ã€ä¸ä¸»èŠ‚ç‚¹å¤±è”è¶…è¿‡<code>down-after-milliseconds * 10</code>ç§’ã€‚</li>
<li>é€‰æ‹©<code>slave-priority</code>ï¼ˆä»èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼‰æœ€é«˜çš„ä»èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›ï¼Œä¸å­˜åœ¨åˆ™ç»§ç»­ã€‚</li>
<li>é€‰æ‹©å¤åˆ¶åç§»é‡æœ€å¤§çš„ä»èŠ‚ç‚¹ï¼ˆå¤åˆ¶çš„æœ€å®Œæ•´ï¼‰ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›ï¼Œä¸å­˜åœ¨åˆ™ç»§ç»­ã€‚</li>
<li>é€‰æ‹©runidæœ€å°çš„ä»èŠ‚ç‚¹ã€‚</li>
</ol>
</li>
<li>Sentinelé¢†å¯¼è€…èŠ‚ç‚¹ä¼šå¯¹ç¬¬ä¸€æ­¥é€‰å‡ºæ¥çš„ä»èŠ‚ç‚¹æ‰§è¡Œ<code>slaveof no oneå‘½</code>ä»¤è®©å…¶æˆä¸ºä¸»èŠ‚ç‚¹</li>
<li>Sentinelé¢†å¯¼è€…èŠ‚ç‚¹ä¼šå‘å‰©ä½™çš„ä»èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œè®©å®ƒä»¬æˆä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå¤åˆ¶è§„åˆ™å’Œ<code>parallel-syncs</code>å‚æ•°æœ‰å…³</li>
<li>SentinelèŠ‚ç‚¹é›†åˆä¼šå°†åŸæ¥çš„ä¸»èŠ‚ç‚¹æ›´æ–°ä¸ºä»èŠ‚ç‚¹ï¼Œå¹¶ä¿æŒç€å¯¹å…¶å…³æ³¨ï¼Œå½“å…¶æ¢å¤åå‘½ä»¤å®ƒå»å¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9cieyqdx2j30je0riwj1.jpg"></p>
<h2 id="å¼€å‘ä¸è¿ç»´é—®é¢˜"><a href="#å¼€å‘ä¸è¿ç»´é—®é¢˜" class="headerlink" title="å¼€å‘ä¸è¿ç»´é—®é¢˜"></a>å¼€å‘ä¸è¿ç»´é—®é¢˜</h2><p>æ¨¡æ‹Ÿæ•…éšœçš„æ–¹å¼ï¼š</p>
<ul>
<li>æ–¹æ³•ä¸€ï¼Œå¼ºåˆ¶æ€æ‰å¯¹åº”èŠ‚ç‚¹çš„è¿›ç¨‹å·ï¼Œè¿™æ ·å¯ä»¥æ¨¡æ‹Ÿå‡ºå®•æœºçš„æ•ˆæœã€‚</li>
<li>æ–¹æ³•äºŒï¼Œä½¿ç”¨Redisçš„<code>debug sleep</code>å‘½ä»¤ï¼Œè®©èŠ‚ç‚¹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¿™æ ·å¯ä»¥æ¨¡æ‹Ÿé˜»å¡çš„æ•ˆæœã€‚</li>
<li>æ–¹æ³•ä¸‰ï¼Œä½¿ç”¨Redisçš„<code>shutdown</code>å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ­£å¸¸çš„åœæ‰Redisã€‚</li>
</ul>
<p>SentinelèŠ‚ç‚¹åªæ”¯æŒå¦‚ä¸‹å‘½ä»¤ï¼š<code>ping</code>ã€<code>sentinel</code>ã€<code>subscribe</code>ã€<code>unsubscribe</code>ã€<code>psubscribe</code>ã€<code>punsubscribe</code>ã€<code>publish</code>ã€<code>info</code>ã€<code>role</code>ã€<code>client</code>ã€<code>shutdown</code>ã€‚</p>
<h1 id="ç¬¬-10-ç« -é›†ç¾¤"><a href="#ç¬¬-10-ç« -é›†ç¾¤" class="headerlink" title="ç¬¬ 10 ç«  é›†ç¾¤"></a>ç¬¬ 10 ç«  é›†ç¾¤</h1><h2 id="æ•°æ®åˆ†å¸ƒ"><a href="#æ•°æ®åˆ†å¸ƒ" class="headerlink" title="æ•°æ®åˆ†å¸ƒ"></a>æ•°æ®åˆ†å¸ƒ</h2><p>å¸¸è§çš„åˆ†åŒºè§„åˆ™æœ‰å“ˆå¸Œåˆ†åŒºä¸é¡ºåºåˆ†åŒºä¸¤ç§ã€‚Redis é›†ç¾¤é‡‡ç”¨äº†å“ˆå¸Œåˆ†åŒºã€‚<br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9e35sce95j30m505ywfm.jpg"></p>
<h3 id="å¸¸è§çš„å“ˆå¸Œåˆ†åŒºè§„åˆ™"><a href="#å¸¸è§çš„å“ˆå¸Œåˆ†åŒºè§„åˆ™" class="headerlink" title="å¸¸è§çš„å“ˆå¸Œåˆ†åŒºè§„åˆ™"></a>å¸¸è§çš„å“ˆå¸Œåˆ†åŒºè§„åˆ™</h3><ul>
<li>èŠ‚ç‚¹å–ä½™<ul>
<li>ä½¿ç”¨ç‰¹å®šçš„æ•°æ®ï¼Œå¦‚Redisçš„é”®æˆ–ç”¨æˆ·IDï¼Œå†æ ¹æ®èŠ‚ç‚¹æ•°é‡Nä½¿ç”¨å…¬å¼ï¼š<code>hash(key)%N</code>è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œç”¨æ¥å†³å®šæ•°æ®æ˜ å°„åˆ°å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå½“èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ï¼Œå¦‚æ‰©å®¹æˆ–æ”¶ç¼©èŠ‚ç‚¹ï¼Œæ•°æ®èŠ‚ç‚¹æ˜ å°„å…³ç³»éœ€è¦é‡æ–°è®¡ç®—ï¼Œä¼šå¯¼è‡´æ•°æ®çš„é‡æ–°è¿ç§»ã€‚å¸¸ç”¨äºæ•°æ®åº“çš„åˆ†åº“åˆ†è¡¨è§„åˆ™ï¼Œä¸€èˆ¬é‡‡ç”¨é¢„åˆ†åŒºçš„æ–¹å¼ï¼Œæå‰æ ¹æ®æ•°æ®é‡è§„åˆ’å¥½åˆ†åŒºæ•°ã€‚</li>
</ul>
</li>
<li>ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº<ul>
<li>ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºï¼ˆDistributed Hash Tableï¼‰å®ç°æ€è·¯æ˜¯ä¸ºç³»ç»Ÿä¸­æ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªtokenï¼ŒèŒƒå›´ä¸€èˆ¬åœ¨0~$2^{32}$ï¼Œè¿™äº›tokenæ„æˆä¸€ä¸ªå“ˆå¸Œç¯ã€‚æ•°æ®è¯»å†™æ‰§è¡ŒèŠ‚ç‚¹æŸ¥æ‰¾æ“ä½œæ—¶ï¼Œå…ˆæ ¹æ®keyè®¡ç®—hashå€¼ï¼Œç„¶åé¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºè¯¥å“ˆå¸Œå€¼çš„tokenèŠ‚ç‚¹</li>
<li>ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼šâ‘ åŠ å‡èŠ‚ç‚¹ä¼šé€ æˆå“ˆå¸Œç¯ä¸­éƒ¨åˆ†æ•°æ®æ— æ³•å‘½ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æˆ–è€…å¿½ç•¥è¿™éƒ¨åˆ†æ•°æ®ï¼Œå› æ­¤<strong>ä¸€è‡´æ€§å“ˆå¸Œå¸¸ç”¨äºç¼“å­˜åœºæ™¯</strong>â‘¡å½“ä½¿ç”¨å°‘é‡èŠ‚ç‚¹æ—¶ï¼ŒèŠ‚ç‚¹å˜åŒ–å°†å¤§èŒƒå›´å½±å“å“ˆå¸Œç¯ä¸­æ•°æ®æ˜ å°„ï¼Œå› æ­¤è¿™ç§æ–¹å¼<strong>ä¸é€‚åˆå°‘é‡æ•°æ®èŠ‚ç‚¹çš„åˆ†å¸ƒå¼æ–¹æ¡ˆ</strong>â‘¢æ™®é€šçš„ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºåœ¨å¢å‡èŠ‚ç‚¹æ—¶éœ€è¦å¢åŠ ä¸€å€æˆ–å‡å»ä¸€åŠèŠ‚ç‚¹æ‰èƒ½ä¿è¯æ•°æ®å’Œè´Ÿè½½çš„å‡è¡¡ã€‚</li>
</ul>
</li>
<li>è™šæ‹Ÿåˆ†åŒºæ§½<ul>
<li>è™šæ‹Ÿæ§½åˆ†åŒºå·§å¦™åœ°ä½¿ç”¨äº†å“ˆå¸Œç©ºé—´ï¼Œä½¿ç”¨åˆ†æ•£åº¦è‰¯å¥½çš„å“ˆå¸Œå‡½æ•°æŠŠæ‰€æœ‰æ•°æ®æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šèŒƒå›´çš„æ•´æ•°é›†åˆä¸­ï¼Œæ•´æ•°å®šä¹‰ä¸ºæ§½ï¼ˆslotï¼‰ï¼Œè®¡ç®—å…¬å¼ä¸º<code>slot=CRC16(key)&amp;16383</code>ã€‚å¦‚Redis Clusteræ§½èŒƒå›´æ˜¯0~16383ã€‚<strong>æ§½æ˜¯é›†ç¾¤å†…æ•°æ®ç®¡ç†å’Œè¿ç§»çš„åŸºæœ¬å•ä½</strong>ã€‚é‡‡ç”¨å¤§èŒƒå›´æ§½çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿æ•°æ®æ‹†åˆ†å’Œé›†ç¾¤æ‰©å±•ã€‚æ¯ä¸ªèŠ‚ç‚¹ä¼šè´Ÿè´£ä¸€å®šæ•°é‡çš„æ§½</li>
</ul>
</li>
</ul>
<p>Redis è™šæ‹Ÿæ§½åˆ†åŒºçš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>è§£è€¦æ•°æ®å’ŒèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œç®€åŒ–äº†èŠ‚ç‚¹æ‰©å®¹å’Œæ”¶ç¼©éš¾åº¦ã€‚</li>
<li>èŠ‚ç‚¹è‡ªèº«ç»´æŠ¤æ§½çš„æ˜ å°„å…³ç³»ï¼Œä¸éœ€è¦å®¢æˆ·ç«¯æˆ–è€…ä»£ç†æœåŠ¡ç»´æŠ¤æ§½åˆ†åŒºå…ƒæ•°æ®ã€‚</li>
<li>æ”¯æŒèŠ‚ç‚¹ã€æ§½ã€é”®ä¹‹é—´çš„æ˜ å°„æŸ¥è¯¢ï¼Œç”¨äºæ•°æ®è·¯ç”±ã€åœ¨çº¿ä¼¸ç¼©ç­‰åœºæ™¯ã€‚</li>
</ul>
<h3 id="é›†ç¾¤åŠŸèƒ½é™åˆ¶"><a href="#é›†ç¾¤åŠŸèƒ½é™åˆ¶" class="headerlink" title="é›†ç¾¤åŠŸèƒ½é™åˆ¶"></a>é›†ç¾¤åŠŸèƒ½é™åˆ¶</h3><ol>
<li>keyæ‰¹é‡æ“ä½œæ”¯æŒæœ‰é™ã€‚å¦‚msetã€mgetï¼Œç›®å‰åªæ”¯æŒå…·æœ‰ç›¸åŒslotå€¼çš„keyæ‰§è¡Œæ‰¹é‡æ“ä½œã€‚å¯¹äºæ˜ å°„ä¸ºä¸åŒslotå€¼çš„keyç”±äºæ‰§è¡Œmgetã€mgetç­‰æ“ä½œå¯èƒ½å­˜åœ¨äºå¤šä¸ªèŠ‚ç‚¹ä¸Šå› æ­¤ä¸è¢«æ”¯æŒã€‚</li>
<li>keyäº‹åŠ¡æ“ä½œæ”¯æŒæœ‰é™ã€‚åŒç†åªæ”¯æŒå¤škeyåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šçš„äº‹åŠ¡æ“ä½œï¼Œå½“å¤šä¸ªkeyåˆ†å¸ƒåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šæ—¶æ— æ³•ä½¿ç”¨äº‹åŠ¡åŠŸèƒ½ã€‚</li>
<li>keyä½œä¸ºæ•°æ®åˆ†åŒºçš„æœ€å°ç²’åº¦ï¼Œå› æ­¤ä¸èƒ½å°†ä¸€ä¸ªå¤§çš„é”®å€¼å¯¹è±¡å¦‚hashã€listç­‰æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚</li>
<li>ä¸æ”¯æŒå¤šæ•°æ®åº“ç©ºé—´ã€‚å•æœºä¸‹çš„Rediså¯ä»¥æ”¯æŒ16ä¸ªæ•°æ®åº“ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹åªèƒ½ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“ç©ºé—´ï¼Œå³db0ã€‚</li>
<li>å¤åˆ¶ç»“æ„åªæ”¯æŒä¸€å±‚ï¼Œä»èŠ‚ç‚¹åªèƒ½å¤åˆ¶ä¸»èŠ‚ç‚¹ï¼Œä¸æ”¯æŒåµŒå¥—æ ‘çŠ¶å¤åˆ¶ç»“æ„ã€‚</li>
</ol>
<h2 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h2><p>æ­å»ºé›†ç¾¤éœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å‡†å¤‡èŠ‚ç‚¹<ul>
<li>Redisé›†ç¾¤ä¸€èˆ¬ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œ<strong>èŠ‚ç‚¹æ•°é‡è‡³å°‘ä¸º6ä¸ªæ‰èƒ½ä¿è¯ç»„æˆå®Œæ•´é«˜å¯ç”¨çš„é›†ç¾¤</strong>ã€‚æ¯ä¸ªèŠ‚ç‚¹éœ€è¦å¼€å¯é…ç½®cluster-enabled yesï¼Œè®©Redisè¿è¡Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ã€‚å»ºè®®ä¸ºé›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹ç»Ÿä¸€ç›®å½•ï¼Œä¸€èˆ¬åˆ’åˆ†ä¸‰ä¸ªç›®å½•ï¼šconfã€dataã€logï¼Œåˆ†åˆ«å­˜æ”¾é…ç½®ã€æ•°æ®å’Œæ—¥å¿—ç›¸å…³æ–‡ä»¶ã€‚</li>
<li>èŠ‚ç‚¹ ID ç”¨äºå”¯ä¸€æ ‡è¯†é›†ç¾¤å†…ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹‹åå¾ˆå¤šé›†ç¾¤æ“ä½œéƒ½è¦å€ŸåŠ©äºèŠ‚ç‚¹IDæ¥å®Œæˆã€‚éœ€è¦æ³¨æ„æ˜¯ï¼ŒèŠ‚ç‚¹IDä¸åŒäºè¿è¡ŒIDã€‚èŠ‚ç‚¹IDåœ¨é›†ç¾¤åˆå§‹åŒ–æ—¶åªåˆ›å»ºä¸€æ¬¡ï¼ŒèŠ‚ç‚¹é‡å¯æ—¶ä¼šåŠ è½½é›†ç¾¤é…ç½®æ–‡ä»¶è¿›è¡Œé‡ç”¨ï¼Œè€ŒRedisçš„è¿è¡ŒIDæ¯æ¬¡é‡å¯éƒ½ä¼šå˜åŒ–ã€‚åœ¨èŠ‚ç‚¹6380æ‰§è¡Œ<code>cluster nodes</code>å‘½ä»¤è·å–é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€ã€‚</li>
<li>Redis è‡ªåŠ¨ç»´æŠ¤é›†ç¾¤é…ç½®æ–‡ä»¶ï¼Œä¸è¦æ‰‹åŠ¨ä¿®æ”¹ï¼Œé˜²æ­¢èŠ‚ç‚¹é‡å¯æ—¶äº§ç”Ÿé›†ç¾¤ä¿¡æ¯é”™è¯¯ã€‚</li>
</ul>
</li>
<li>èŠ‚ç‚¹æ¡æ‰‹<ul>
<li>ç”±å®¢æœç«¯å‘èµ·å‘½ä»¤<code>cluster meet {ip} {port}</code>å»ºç«‹è¿æ¥ï¼Œè¯¥å‘½ä»¤ä¸ºå¼‚æ­¥å‘½ä»¤ã€‚</li>
<li>èŠ‚ç‚¹å»ºç«‹æ¡æ‰‹åï¼Œé›†ç¾¤æ­¤æ—¶å¤„äºä¸‹çº¿çŠ¶æ€ï¼Œæ‰€æœ‰çš„æ•°æ®è¯»å†™éƒ½è¢«ç¦æ­¢ã€‚å¯ä»¥é€šè¿‡<code>cluster info</code>æŸ¥çœ‹å½“å‰é›†ç¾¤çŠ¶æ€ã€‚</li>
</ul>
</li>
<li>åˆ†é…æ§½<ul>
<li>é€šè¿‡<code>cluster addslots</code>å‘½ä»¤ä¸ºèŠ‚ç‚¹åˆ†é…æ§½ã€‚ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„é›†ç¾¤ï¼Œæ¯ä¸ªè´Ÿè´£å¤„ç†æ§½çš„èŠ‚ç‚¹åº”è¯¥å…·æœ‰ä»èŠ‚ç‚¹ï¼Œä¿è¯å½“å®ƒå‡ºç°æ•…éšœæ—¶å¯ä»¥è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚é›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒReidsèŠ‚ç‚¹è§’è‰²åˆ†ä¸ºä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ã€‚é¦–æ¬¡å¯åŠ¨çš„èŠ‚ç‚¹å’Œè¢«åˆ†é…æ§½çš„èŠ‚ç‚¹éƒ½æ˜¯ä¸»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹è´Ÿè´£å¤åˆ¶ä¸»èŠ‚ç‚¹æ§½ä¿¡æ¯å’Œç›¸å…³çš„æ•°æ®ã€‚ä½¿ç”¨<code>cluster replicate{nodeId}</code>å‘½ä»¤è®©ä¸€ä¸ªèŠ‚ç‚¹æˆä¸ºä»èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9i5gd6qalj30n80nowkd.jpg" alt="é›†ç¾¤å®Œæ•´ç»“æ„"></p>
<p>ç”±äºæ‰‹åŠ¨åˆ›å»ºé›†ç¾¤è¿‡äºç¹çï¼Œä¸”éšç€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ä¼šåŠ å¤§å¤æ‚åº¦ä¸è¿ç»´æˆæœ¬ï¼Œå› æ­¤å¯ä»¥é€šè¿‡<code>redis-trib.rb</code>æ¥æ­å»ºé›†ç¾¤ï¼Œè¯¥å·¥å…·æ”¯æŒé›†ç¾¤åˆ›å»ºã€æ£€æŸ¥ã€ä¿®å¤ã€å‡è¡¡ç­‰å‘½ä»¤è¡Œå·¥å…·ã€‚</p>
<p>å½“é›†ç¾¤åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œå®Œæ•´æ€§æ£€æŸ¥ã€‚é›†ç¾¤å®Œæ•´æ€§æŒ‡æ‰€æœ‰çš„æ§½éƒ½åˆ†é…åˆ°å­˜æ´»çš„ä¸»èŠ‚ç‚¹ä¸Šï¼Œåªè¦16384ä¸ªæ§½ä¸­æœ‰ä¸€ä¸ªæ²¡æœ‰åˆ†é…ç»™èŠ‚ç‚¹åˆ™è¡¨ç¤ºé›†ç¾¤ä¸å®Œæ•´ã€‚å¯ä»¥ä½¿ç”¨<code>redis-trib.rb check</code>å‘½ä»¤æ£€æµ‹ä¹‹å‰åˆ›å»ºçš„ä¸¤ä¸ªé›†ç¾¤æ˜¯å¦æˆåŠŸï¼Œ<code>check</code>å‘½ä»¤åªéœ€è¦ç»™å‡ºé›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹åœ°å€å°±å¯ä»¥å®Œæˆæ•´ä¸ªé›†ç¾¤çš„æ£€æŸ¥å·¥ä½œã€‚å½“æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä»æ•…éšœå‘ç°åˆ°è‡ªåŠ¨å®Œæˆè½¬ç§»æœŸé—´æ•´ä¸ªé›†ç¾¤æ˜¯ä¸å¯ç”¨çŠ¶æ€ï¼Œå¯¹äºå¤§å¤šæ•°ä¸šåŠ¡æ— æ³•å®¹å¿è¿™ç§æƒ…å†µï¼Œå› æ­¤å»ºè®®å°†å‚æ•°<code>cluster-require-full-coverage</code>é…ç½®ä¸ºnoï¼Œå½“ä¸»èŠ‚ç‚¹æ•…éšœæ—¶åªå½±å“å®ƒè´Ÿè´£æ§½çš„ç›¸å…³å‘½ä»¤æ‰§è¡Œï¼Œä¸ä¼šå½±å“å…¶ä»–ä¸»èŠ‚ç‚¹çš„å¯ç”¨æ€§ã€‚</p>
<h2 id="èŠ‚ç‚¹é€šä¿¡"><a href="#èŠ‚ç‚¹é€šä¿¡" class="headerlink" title="èŠ‚ç‚¹é€šä¿¡"></a>èŠ‚ç‚¹é€šä¿¡</h2><p>å¸¸è§çš„å…ƒæ•°æ®ç»´æŠ¤æ–¹å¼åˆ†ä¸ºï¼šé›†ä¸­å¼å’ŒP2Pæ–¹å¼ã€‚Redisé›†ç¾¤é‡‡ç”¨P2Pçš„Gossipï¼ˆæµè¨€ï¼‰åè®®ï¼ŒGossipåè®®å·¥ä½œåŸç†å°±æ˜¯èŠ‚ç‚¹å½¼æ­¤ä¸æ–­é€šä¿¡äº¤æ¢ä¿¡æ¯ï¼Œä¸€æ®µæ—¶é—´åæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¼šçŸ¥é“é›†ç¾¤å®Œæ•´çš„ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼ç±»ä¼¼æµè¨€ä¼ æ’­ã€‚å…¶é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå•ç‹¬å¼€è¾Ÿä¸€ä¸ªTCPé€šé“ï¼Œç”¨äºèŠ‚ç‚¹ä¹‹é—´å½¼æ­¤é€šä¿¡ï¼Œé€šä¿¡ç«¯å£å·åœ¨åŸºç¡€ç«¯å£ä¸ŠåŠ 10000ã€‚</li>
<li>æ¯ä¸ªèŠ‚ç‚¹åœ¨å›ºå®šå‘¨æœŸå†…é€šè¿‡ç‰¹å®šè§„åˆ™é€‰æ‹©å‡ ä¸ªèŠ‚ç‚¹å‘é€pingæ¶ˆæ¯ã€‚</li>
<li>æ¥æ”¶åˆ°pingæ¶ˆæ¯çš„èŠ‚ç‚¹ç”¨pongæ¶ˆæ¯ä½œä¸ºå“åº”ã€‚</li>
</ol>
<blockquote>
<p>æˆ‘ä»¬ç»å¸¸åœ¨ç½‘ç»œä¸­ä½¿ç”¨ ping ä½œä¸ºæ¢æ´»å‘½ä»¤ï¼Œä½¿ç”¨ pong ä½œä¸ºå“åº”ï¼Œè¿™ä¸ªä¸¤ä¸ªè¯åœ¨ä¸€æ¬¡æ­£å¥½ä¸º ping-pong ä¹’ä¹“çƒï¼Œå¯ä»¥ç†è§£ä¸ºå‘é€æ–¹å‘å‡ºå»çš„çƒå¾—åˆ°å“åº”æ‰è®¤ä¸ºå¯¹æ–¹å­˜æ´»ã€‚ä¸çŸ¥é“åˆ›å»ºè¿™ä¸€å¯¹å‘½ä»¤çš„äººæ˜¯å¦ä¹Ÿæ˜¯åŸºäºè¿™ä¸ªç†å¿µåˆ›å»ºçš„ã€‚</p>
</blockquote>
<p>å¸¸ç”¨çš„Gossipæ¶ˆæ¯å¯åˆ†ä¸ºï¼špingæ¶ˆæ¯ã€pongæ¶ˆæ¯ã€meetæ¶ˆæ¯ã€failæ¶ˆæ¯ç­‰ã€‚</p>
<ul>
<li>meet æ¶ˆæ¯ï¼šç”¨äºé€šçŸ¥æ–°èŠ‚ç‚¹åŠ å…¥</li>
<li>ping æ¶ˆæ¯ï¼šç”¨äºæ£€æµ‹èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿å’Œäº¤æ¢å½¼æ­¤çŠ¶æ€ä¿¡æ¯ã€‚ping æ¶ˆæ¯å‘é€å°è£…äº†è‡ªèº«èŠ‚ç‚¹å’Œéƒ¨åˆ†å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€æ•°æ®ã€‚</li>
<li>pong æ¶ˆæ¯ï¼šä½œä¸ºå“åº”æ¶ˆæ¯å›å¤ç»™å‘é€æ–¹ç¡®è®¤æ¶ˆæ¯æ­£å¸¸é€šä¿¡ã€‚pongæ¶ˆæ¯å†…éƒ¨å°è£…äº†è‡ªèº«çŠ¶æ€æ•°æ®ã€‚èŠ‚ç‚¹ä¹Ÿå¯ä»¥å‘é›†ç¾¤å†…å¹¿æ’­è‡ªèº«çš„pongæ¶ˆæ¯æ¥é€šçŸ¥æ•´ä¸ªé›†ç¾¤å¯¹è‡ªèº«çŠ¶æ€è¿›è¡Œæ›´æ–°ã€‚</li>
<li>fail æ¶ˆæ¯ï¼šå½“èŠ‚ç‚¹åˆ¤å®šé›†ç¾¤å†…å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä¼šå‘é›†ç¾¤å†…å¹¿æ’­ä¸€ä¸ªfailæ¶ˆæ¯ï¼Œå…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°failæ¶ˆæ¯ä¹‹åæŠŠå¯¹åº”èŠ‚ç‚¹æ›´æ–°ä¸ºä¸‹çº¿çŠ¶æ€ã€‚</li>
</ul>
<p>æ‰€æœ‰æ¶ˆæ¯æ ¼å¼åˆ’åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ã€‚æ¶ˆæ¯å¤´åŒ…å«å‘é€èŠ‚ç‚¹è‡ªèº«çŠ¶æ€æ•°æ®ï¼ˆå¦‚èŠ‚ç‚¹idã€æ§½æ˜ å°„ã€èŠ‚ç‚¹æ ‡è¯†ï¼ˆä¸»ä»è§’è‰²ï¼Œæ˜¯å¦ä¸‹çº¿ï¼‰ç­‰ï¼‰ï¼Œæ¥æ”¶èŠ‚ç‚¹æ ¹æ®æ¶ˆæ¯å¤´å°±å¯ä»¥è·å–åˆ°å‘é€èŠ‚ç‚¹çš„ç›¸å…³æ•°æ®ï¼›æ¶ˆæ¯ä½“åˆ™åŒ…å«äº†å‘é€èŠ‚ç‚¹æ‰€äº†è§£çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯ã€‚æ¶ˆæ¯çš„ç±»å‹åˆ™æ ¹æ®æ¶ˆæ¯å¤´çš„ type å±æ€§åŒºåˆ†ã€‚</p>
<p>æ¶ˆæ¯å¤´ç»“æ„ clusterMsg å¦‚ä¸‹</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">    <span class="keyword">char</span> sig[<span class="number">4</span>]; <span class="comment">/* ä¿¡å·æ ‡ç¤º */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> totlen; <span class="comment">/* æ¶ˆæ¯æ€»é•¿åº¦ */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> ver; <span class="comment">/* åè®®ç‰ˆæœ¬*/</span></span><br><span class="line">    <span class="keyword">uint16_t</span> type; <span class="comment">/* æ¶ˆæ¯ç±»å‹,ç”¨äºåŒºåˆ†meet,ping,pongç­‰æ¶ˆæ¯ */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> count; <span class="comment">/* æ¶ˆæ¯ä½“åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼Œä»…ç”¨äºmeet,ping,pingæ¶ˆæ¯ç±»å‹*/</span></span><br><span class="line">    <span class="keyword">uint64_t</span> currentEpoch; <span class="comment">/* å½“å‰å‘é€èŠ‚ç‚¹çš„é…ç½®çºªå…ƒ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> configEpoch; <span class="comment">/* ä¸»èŠ‚ç‚¹/ä»èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹é…ç½®çºªå…ƒ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> offset; <span class="comment">/* å¤åˆ¶åç§»é‡ */</span></span><br><span class="line">    <span class="keyword">char</span> sender[CLUSTER_NAMELEN]; <span class="comment">/* å‘é€èŠ‚ç‚¹çš„nodeId */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> myslots[CLUSTER_SLOTS/<span class="number">8</span>]; <span class="comment">/* å‘é€èŠ‚ç‚¹è´Ÿè´£çš„æ§½ä¿¡æ¯ */</span></span><br><span class="line">    <span class="keyword">char</span> slaveof[CLUSTER_NAMELEN]; <span class="comment">/* å¦‚æœå‘é€èŠ‚ç‚¹æ˜¯ä»èŠ‚ç‚¹ï¼Œè®°å½•å¯¹åº”ä¸»èŠ‚ç‚¹çš„nodeId */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> port; <span class="comment">/* ç«¯å£å· */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> flags; <span class="comment">/* å‘é€èŠ‚ç‚¹æ ‡è¯†,åŒºåˆ†ä¸»ä»è§’è‰²ï¼Œæ˜¯å¦ä¸‹çº¿ç­‰ */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> state; <span class="comment">/* å‘é€èŠ‚ç‚¹æ‰€å¤„çš„é›†ç¾¤çŠ¶æ€ */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> mflags[<span class="number">3</span>]; <span class="comment">/* æ¶ˆæ¯æ ‡è¯† */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">clusterMsgData</span> <span class="title">data</span> /* æ¶ˆæ¯æ­£æ–‡ */;</span></span><br><span class="line">} clusterMsg;</span><br></pre></td></tr></tbody></table></figure>

<p>æ¶ˆæ¯ä½“ clusterMsgData ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">    <span class="keyword">char</span> nodename[CLUSTER_NAMELEN]; <span class="comment">/* èŠ‚ç‚¹çš„nodeId */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> ping_sent; <span class="comment">/* æœ€åä¸€æ¬¡å‘è¯¥èŠ‚ç‚¹å‘é€pingæ¶ˆæ¯æ—¶é—´ */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> pong_received; <span class="comment">/* æœ€åä¸€æ¬¡æ¥æ”¶è¯¥èŠ‚ç‚¹pongæ¶ˆæ¯æ—¶é—´ */</span></span><br><span class="line">    <span class="keyword">char</span> ip[NET_IP_STR_LEN]; <span class="comment">/* IP */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> port; <span class="comment">/* port*/</span></span><br><span class="line">    <span class="keyword">uint16_t</span> flags; <span class="comment">/* è¯¥èŠ‚ç‚¹æ ‡è¯†, */</span></span><br><span class="line">} clusterMsgDataGossip;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9ic768uakj30ho0m8jve.jpg"></p>
<p>å¦‚æœèŠ‚ç‚¹é—´é¢‘ç¹é€šä¿¡ï¼Œåˆ™ä¼šåŠ é‡å¸¦å®½å’Œè®¡ç®—çš„è´Ÿæ‹…ï¼Œè¿‡æ…¢åˆä¼šå¯¼è‡´ä¿¡æ¯æ›´æ–°ä¸åŠæ—¶ï¼Œå› æ­¤æ­¤Redisé›†ç¾¤çš„Gossipåè®®éœ€è¦å…¼é¡¾ä¿¡æ¯äº¤æ¢å®æ—¶æ€§å’Œæˆæœ¬å¼€é”€ã€‚<br><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9icdly6hpj30j30ebq5o.jpg"></p>
<p>ä»Gossipçš„é€šä¿¡æœºåˆ¶ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œå½±å“å¸¦å®½çš„ä¸»è¦å› ç´ åœ¨äºé€šä¿¡çš„èŠ‚ç‚¹æ•°ä¸å‘é€çš„æ¶ˆæ¯æ•°æ®é‡ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä»è¿™ä¸¤æ–¹é¢è¿›è¡Œä¼˜åŒ–ï¼š</p>
<ul>
<li>é€‰æ‹©å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹æ•°é‡ï¼šé›†ç¾¤å†…æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤å®šæ—¶ä»»åŠ¡é»˜è®¤æ¯ç§’æ‰§è¡Œ10æ¬¡ï¼Œæ¯ç§’ä¼šéšæœºé€‰å–5ä¸ªèŠ‚ç‚¹æ‰¾å‡ºæœ€ä¹…æ²¡æœ‰é€šä¿¡çš„èŠ‚ç‚¹å‘é€pingæ¶ˆæ¯ï¼Œç”¨äºä¿è¯Gossipä¿¡æ¯äº¤æ¢çš„éšæœºæ€§ã€‚æ¯100æ¯«ç§’éƒ½ä¼šæ‰«ææœ¬åœ°èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¦‚æœå‘ç°èŠ‚ç‚¹æœ€è¿‘ä¸€æ¬¡æ¥å—pongæ¶ˆæ¯çš„æ—¶é—´å¤§äº<code>cluster_node_timeout/2</code>ï¼Œåˆ™ç«‹åˆ»å‘é€pingæ¶ˆæ¯ï¼Œé˜²æ­¢è¯¥èŠ‚ç‚¹ä¿¡æ¯å¤ªé•¿æ—¶é—´æœªæ›´æ–°ã€‚æ ¹æ®ä»¥ä¸Šè§„åˆ™å¾—å‡ºæ¯ä¸ªèŠ‚ç‚¹æ¯ç§’éœ€è¦å‘é€pingæ¶ˆæ¯çš„æ•°é‡<code>=1+10*numï¼ˆnode.pong_received&gt;cluster_node_timeout/2</code>ï¼Œå› æ­¤<code>cluster_node_timeout</code>å‚æ•°å¯¹æ¶ˆæ¯å‘é€çš„èŠ‚ç‚¹æ•°é‡å½±å“éå¸¸å¤§ã€‚å½“æˆ‘ä»¬çš„å¸¦å®½èµ„æºç´§å¼ æ—¶ï¼Œå¯ä»¥é€‚å½“è°ƒå¤§è¿™ä¸ªå‚æ•°ã€‚</li>
<li>æ¶ˆæ¯æ•°æ®é‡ï¼šæ¶ˆæ¯å¤´ä¸»è¦å ç”¨ç©ºé—´çš„å­—æ®µæ˜¯<code>myslots[CLUSTER_SLOTS/8]</code>ï¼Œå ç”¨2KBï¼Œè¿™å—ç©ºé—´å ç”¨ç›¸å¯¹å›ºå®šã€‚æ¶ˆæ¯ä½“æºå¸¦æ•°æ®é‡è·Ÿé›†ç¾¤çš„èŠ‚ç‚¹æ•°æ¯æ¯ç›¸å…³ï¼Œæ›´å¤§çš„é›†ç¾¤æ¯æ¬¡æ¶ˆæ¯é€šä¿¡çš„æˆæœ¬ä¹Ÿå°±æ›´é«˜ï¼Œå› æ­¤å¯¹äºRedisé›†ç¾¤æ¥è¯´å¹¶ä¸æ˜¯å¤§è€Œå…¨çš„é›†ç¾¤æ›´å¥½ã€‚</li>
</ul>
<h2 id="é›†ç¾¤ä¼¸ç¼©"><a href="#é›†ç¾¤ä¼¸ç¼©" class="headerlink" title="é›†ç¾¤ä¼¸ç¼©"></a>é›†ç¾¤ä¼¸ç¼©</h2><p>é›†ç¾¤çš„æ°´å¹³ä¼¸ç¼©çš„ä¸Šå±‚åŸç†ï¼š<strong>é›†ç¾¤ä¼¸ç¼© = æ§½å’Œæ•°æ®åœ¨èŠ‚ç‚¹ä¹‹é—´çš„ç§»åŠ¨</strong>ã€‚<br><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9icgp2fv1j30ju0gwtcv.jpg"></p>
<h3 id="æ‰©å®¹é›†ç¾¤"><a href="#æ‰©å®¹é›†ç¾¤" class="headerlink" title="æ‰©å®¹é›†ç¾¤"></a>æ‰©å®¹é›†ç¾¤</h3><p>æ§½è¿ç§»æ•°æ®æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯¹ç›®æ ‡èŠ‚ç‚¹å‘é€<code>cluster setslot {slot} importing {sourceNodeId}</code>å‘½ä»¤ï¼Œè®©ç›®æ ‡èŠ‚ç‚¹å‡†å¤‡å¯¼å…¥æ§½çš„æ•°æ®ã€‚</li>
<li>å¯¹æºèŠ‚ç‚¹å‘é€<code>cluster setslot {slot} migrating {targetNodeId}</code>å‘½ä»¤ï¼Œè®©æºèŠ‚ç‚¹å‡†å¤‡è¿å‡ºæ§½çš„æ•°æ®ã€‚</li>
<li>æºèŠ‚ç‚¹å¾ªç¯æ‰§è¡Œ<code>cluster getkeysinslot {slot} {count}</code>å‘½ä»¤ï¼Œè·å–countä¸ªå±äºæ§½{slot}çš„é”®ã€‚</li>
<li>åœ¨æºèŠ‚ç‚¹ä¸Šæ‰§è¡Œ<code>migrate {targetIp} {targetPort} "" 0 {timeout} keys {keys...}</code>å‘½ä»¤ï¼ŒæŠŠè·å–çš„é”®é€šè¿‡æµæ°´çº¿æœºåˆ¶æ‰¹é‡è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚</li>
<li>é‡å¤æ‰§è¡Œæ­¥éª¤3å’Œæ­¥éª¤4ç›´åˆ°æ§½ä¸‹æ‰€æœ‰çš„é”®å€¼æ•°æ®è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚</li>
<li>å‘é›†ç¾¤å†…æ‰€æœ‰ä¸»èŠ‚ç‚¹å‘é€<code>cluster setslot {slot} node {targetNodeId}</code>å‘½ä»¤ï¼Œé€šçŸ¥æ§½åˆ†é…ç»™ç›®æ ‡èŠ‚ç‚¹ã€‚ä¸ºäº†ä¿è¯æ§½èŠ‚ç‚¹æ˜ å°„å˜æ›´åŠæ—¶ä¼ æ’­ï¼Œéœ€è¦éå†å‘é€ç»™æ‰€æœ‰ä¸»èŠ‚ç‚¹æ›´æ–°è¢«è¿ç§»çš„æ§½æŒ‡å‘æ–°èŠ‚ç‚¹ã€‚</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9jh857qqpj30ji0ehq6u.jpg"></p>
<p><code>redis-trib</code>æ§½é‡åˆ†ç‰‡åŠŸèƒ½å‘½ä»¤å¦‚ä¸‹ï¼š<code>redis-trib.rb reshard host:port --from &lt;arg&gt; --to &lt;arg&gt; --slots &lt;arg&gt; --yes --timeout &lt;arg&gt; --pipeline &lt;arg&gt;</code></p>
<ul>
<li><code>host:port</code>ï¼šå¿…ä¼ å‚æ•°ï¼Œé›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹åœ°å€ï¼Œç”¨æ¥è·å–æ•´ä¸ªé›†ç¾¤ä¿¡æ¯ã€‚</li>
<li><code>--from</code>ï¼šåˆ¶å®šæºèŠ‚ç‚¹çš„idï¼Œå¦‚æœæœ‰å¤šä¸ªæºèŠ‚ç‚¹ï¼Œä½¿ç”¨é€—å·åˆ†éš”ï¼Œå¦‚æœæ˜¯allæºèŠ‚ç‚¹å˜ä¸ºé›†ç¾¤å†…æ‰€æœ‰ä¸»èŠ‚ç‚¹ï¼Œåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚</li>
<li><code>--to</code>ï¼šéœ€è¦è¿ç§»çš„ç›®æ ‡èŠ‚ç‚¹çš„idï¼Œç›®æ ‡èŠ‚ç‚¹åªèƒ½å¡«å†™ä¸€ä¸ªï¼Œåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚</li>
<li><code>--slots</code>ï¼šéœ€è¦è¿ç§»æ§½çš„æ€»æ•°é‡ï¼Œåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚</li>
<li><code>--yes</code>ï¼šå½“æ‰“å°å‡ºreshardæ‰§è¡Œè®¡åˆ’æ—¶ï¼Œæ˜¯å¦éœ€è¦ç”¨æˆ·è¾“å…¥yesç¡®è®¤åå†æ‰§è¡Œ<code>reshard</code>ã€‚</li>
<li><code>--timeout</code>ï¼šæ§åˆ¶æ¯æ¬¡migrateæ“ä½œçš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60000æ¯«ç§’ã€‚</li>
<li><code>--pipeline</code>ï¼šæ§åˆ¶æ¯æ¬¡æ‰¹é‡è¿ç§»é”®çš„æ•°é‡ï¼Œé»˜è®¤ä¸º10ã€‚</li>
</ul>
<p>è¿ç§»ä¹‹åå»ºè®®ä½¿ç”¨<code>redis-trib.rb rebalance</code>å‘½ä»¤æ£€æŸ¥èŠ‚ç‚¹ä¹‹é—´æ§½çš„å‡è¡¡æ€§ã€‚</p>
<h3 id="æ”¶ç¼©é›†ç¾¤"><a href="#æ”¶ç¼©é›†ç¾¤" class="headerlink" title="æ”¶ç¼©é›†ç¾¤"></a>æ”¶ç¼©é›†ç¾¤</h3><p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9jhell5zkj30gy0hc417.jpg"></p>
<ol>
<li>é¦–å…ˆéœ€è¦ç¡®å®šä¸‹çº¿èŠ‚ç‚¹æ˜¯å¦æœ‰è´Ÿè´£çš„æ§½ï¼Œå¦‚æœæ˜¯ï¼Œéœ€è¦æŠŠæ§½è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œä¿è¯èŠ‚ç‚¹ä¸‹çº¿åæ•´ä¸ªé›†ç¾¤æ§½èŠ‚ç‚¹æ˜ å°„çš„å®Œæ•´æ€§ã€‚</li>
<li>å½“ä¸‹çº¿èŠ‚ç‚¹ä¸å†è´Ÿè´£æ§½æˆ–è€…æœ¬èº«æ˜¯ä»èŠ‚ç‚¹æ—¶ï¼Œå°±å¯ä»¥é€šçŸ¥é›†ç¾¤å†…å…¶ä»–èŠ‚ç‚¹å¿˜è®°ä¸‹çº¿èŠ‚ç‚¹ï¼Œå½“æ‰€æœ‰çš„èŠ‚ç‚¹å¿˜è®°è¯¥èŠ‚ç‚¹åå¯ä»¥æ­£å¸¸å…³é—­ã€‚</li>
</ol>
<p>ä¸‹çº¿èŠ‚ç‚¹éœ€è¦æŠŠè‡ªå·±è´Ÿè´£çš„æ§½è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼ŒåŸç†ä¸ä¹‹å‰èŠ‚ç‚¹æ‰©å®¹çš„è¿ç§»æ§½è¿‡ç¨‹ä¸€è‡´ã€‚åœ¨æ­¤ä¸åšèµ˜è¿°ã€‚</p>
<p>ç”±äºé›†ç¾¤å†…çš„èŠ‚ç‚¹ä¸åœåœ°é€šè¿‡Gossipæ¶ˆæ¯å½¼æ­¤äº¤æ¢èŠ‚ç‚¹çŠ¶æ€ï¼Œå› æ­¤éœ€è¦é€šè¿‡ä¸€ç§å¥å£®çš„æœºåˆ¶è®©é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹å¿˜è®°ä¸‹çº¿çš„èŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´è®©å…¶ä»–èŠ‚ç‚¹ä¸å†ä¸è¦ä¸‹çº¿èŠ‚ç‚¹è¿›è¡ŒGossipæ¶ˆæ¯äº¤æ¢ã€‚Redisæä¾›äº†<code>cluster forget{downNodeId}</code>å‘½ä»¤å®ç°è¯¥åŠŸèƒ½ï¼Œï¼ˆæ­¤å¤„çš„Gossipå¯¹å¿˜è®°èŠ‚ç‚¹é€ æˆäº†é˜»ç¢ï¼‰</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9jhkc00w3j30he0b3q5k.jpg"></p>
<p>å½“èŠ‚ç‚¹æ¥æ”¶åˆ°<code>cluster forget{down NodeId}</code>å‘½ä»¤åï¼Œä¼šæŠŠnodeIdæŒ‡å®šçš„èŠ‚ç‚¹åŠ å…¥åˆ°ç¦ç”¨åˆ—è¡¨ä¸­ï¼Œåœ¨ç¦ç”¨åˆ—è¡¨å†…çš„èŠ‚ç‚¹ä¸å†å‘é€Gossipæ¶ˆæ¯ã€‚ç¦ç”¨åˆ—è¡¨æœ‰æ•ˆæœŸæ˜¯60ç§’ï¼Œè¶…è¿‡60ç§’èŠ‚ç‚¹ä¼šå†æ¬¡å‚ä¸æ¶ˆæ¯äº¤æ¢ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç¬¬ä¸€æ¬¡forgetå‘½ä»¤å‘å‡ºåï¼Œæˆ‘ä»¬æœ‰60ç§’çš„æ—¶é—´è®©é›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹å¿˜è®°ä¸‹çº¿èŠ‚ç‚¹ã€‚çº¿ä¸Šæ“ä½œä¸å»ºè®®ç›´æ¥ä½¿ç”¨<code>cluster forget</code>å‘½ä»¤ä¸‹çº¿èŠ‚ç‚¹ï¼Œéœ€è¦è·Ÿå¤§é‡èŠ‚ç‚¹å‘½ä»¤äº¤äº’ï¼Œå®é™…æ“ä½œèµ·æ¥è¿‡äºç¹çå¹¶ä¸”å®¹æ˜“é—æ¼forgetèŠ‚ç‚¹ã€‚å»ºè®®ä½¿ç”¨<code>redistrib.rb del-node{host:port}{downNodeId}</code>å‘½ä»¤ï¼Œå†…éƒ¨å®ç°çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def delnode_cluster_cmd(downNode):</span><br><span class="line">    <span class="comment"># ä¸‹çº¿èŠ‚ç‚¹ä¸å…è®¸åŒ…å«slots</span></span><br><span class="line">    <span class="keyword">if</span> downNode.slots.length != <span class="number">0</span></span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line">    end</span><br><span class="line">    <span class="comment"># å‘é›†ç¾¤å†…èŠ‚ç‚¹å‘é€cluster forget</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> nodes:</span><br><span class="line">        <span class="keyword">if</span> n.id == downNode.id:</span><br><span class="line">            <span class="comment"># ä¸èƒ½å¯¹è‡ªå·±åšforgetæ“ä½œ</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment"># å¦‚æœä¸‹çº¿èŠ‚ç‚¹æœ‰ä»èŠ‚ç‚¹åˆ™æŠŠä»èŠ‚ç‚¹æŒ‡å‘å…¶ä»–ä¸»èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> n.replicate &amp;&amp; n.replicate.nodeId == downNode.id :</span><br><span class="line">            <span class="comment"># æŒ‡å‘æ‹¥æœ‰æœ€å°‘ä»èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹</span></span><br><span class="line">            master = get_master_with_least_replicas();</span><br><span class="line">            n.cluster(<span class="string">"replicate"</span>,master.nodeId);</span><br><span class="line">        <span class="comment">#å‘é€å¿˜è®°èŠ‚ç‚¹å‘½ä»¤</span></span><br><span class="line">        n.cluster(<span class="string">'forget'</span>,downNode.id)</span><br><span class="line"><span class="comment"># èŠ‚ç‚¹å…³é—­</span></span><br><span class="line">downNode.shutdown();</span><br></pre></td></tr></tbody></table></figure>

<p>å½“ä¸‹çº¿ä¸»èŠ‚ç‚¹å…·æœ‰ä»èŠ‚ç‚¹æ—¶éœ€è¦æŠŠè¯¥ä»èŠ‚ç‚¹æŒ‡å‘åˆ°å…¶ä»–ä¸»èŠ‚ç‚¹ï¼Œå› æ­¤å¯¹äºä¸»ä»èŠ‚ç‚¹éƒ½ä¸‹çº¿çš„æƒ…å†µï¼Œå»ºè®®å…ˆä¸‹çº¿ä»èŠ‚ç‚¹å†ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼Œé˜²æ­¢ä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ã€‚</p>
<h2 id="è¯·æ±‚è·¯ç”±"><a href="#è¯·æ±‚è·¯ç”±" class="headerlink" title="è¯·æ±‚è·¯ç”±"></a>è¯·æ±‚è·¯ç”±</h2><h3 id="è¯·æ±‚é‡å®šå‘"><a href="#è¯·æ±‚é‡å®šå‘" class="headerlink" title="è¯·æ±‚é‡å®šå‘"></a>è¯·æ±‚é‡å®šå‘</h3><p>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒRedisæ¥æ”¶ä»»ä½•é”®ç›¸å…³å‘½ä»¤æ—¶é¦–å…ˆè®¡ç®—é”®å¯¹åº”çš„æ§½ï¼Œå†æ ¹æ®æ§½æ‰¾å‡ºæ‰€å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹æ˜¯è‡ªèº«ï¼Œåˆ™å¤„ç†é”®å‘½ä»¤ï¼›å¦åˆ™å›å¤MOVEDé‡å®šå‘é”™è¯¯ï¼Œé€šçŸ¥å®¢æˆ·ç«¯è¯·æ±‚æ­£ç¡®çš„èŠ‚ç‚¹ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºMOVEDé‡å®šå‘ã€‚<br><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9jhv81y3pj30j00jrwhp.jpg"></p>
<p>å¯ä»¥é€šè¿‡<code>cluster keyslot{key}</code>å‘½ä»¤è¿”å›keyæ‰€å¯¹åº”çš„æ§½ï¼Œè¯¥å‘½ä»¤é‡‡ç”¨<code>key_hash_slot()</code>å‡½æ•°å®ç°ã€‚<br>ä½¿ç”¨<code>redis-cli</code>å‘½ä»¤æ—¶ï¼Œå¯ä»¥åŠ å…¥<code>-c</code>å‚æ•°æ”¯æŒè‡ªåŠ¨é‡å®šå‘ï¼Œç®€åŒ–æ‰‹åŠ¨å‘èµ·é‡å®šå‘æ“ä½œã€‚</p>
<p>é”®å‘½ä»¤æ‰§è¡Œæ­¥éª¤ä¸»è¦åˆ†ä¸¤æ­¥ï¼šè®¡ç®—æ§½ï¼ŒæŸ¥æ‰¾æ§½æ‰€å¯¹åº”çš„èŠ‚ç‚¹ã€‚</p>
<ol>
<li>Redisé¦–å…ˆéœ€è¦è®¡ç®—é”®æ‰€å¯¹åº”çš„æ§½ã€‚æ ¹æ®é”®çš„æœ‰æ•ˆéƒ¨åˆ†ä½¿ç”¨CRC16å‡½æ•°è®¡ç®—å‡ºæ•£åˆ—å€¼ï¼Œå†å–å¯¹16383çš„ä½™æ•°ï¼Œä½¿æ¯ä¸ªé”®éƒ½å¯ä»¥æ˜ å°„åˆ°0~16383æ§½èŒƒå›´å†…ã€‚</li>
<li>èŠ‚ç‚¹å¯¹äºåˆ¤å®šé”®å‘½ä»¤æ˜¯æ‰§è¡Œè¿˜æ˜¯MOVEDé‡å®šå‘ï¼Œéƒ½æ˜¯å€ŸåŠ©<code>slots [CLUSTER_SLOTS]</code>æ•°ç»„å®ç°ã€‚æ ¹æ®MOVEDé‡å®šå‘æœºåˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥éšæœºè¿æ¥é›†ç¾¤å†…ä»»ä¸€Redisè·å–é”®æ‰€åœ¨èŠ‚ç‚¹ï¼Œè¿™ç§å®¢æˆ·ç«¯åˆå«Dummyï¼ˆå‚€å„¡ï¼‰å®¢æˆ·ç«¯ï¼Œå®ƒä¼˜ç‚¹æ˜¯ä»£ç å®ç°ç®€å•ï¼Œå¯¹å®¢æˆ·ç«¯åè®®å½±å“è¾ƒå°ï¼Œåªéœ€è¦æ ¹æ®é‡å®šå‘ä¿¡æ¯å†æ¬¡å‘é€è¯·æ±‚å³å¯ã€‚ä½†æ˜¯å®ƒçš„å¼Šç«¯å¾ˆæ˜æ˜¾ï¼Œæ¯æ¬¡æ‰§è¡Œé”®å‘½ä»¤å‰éƒ½è¦åˆ°Redisä¸Šè¿›è¡Œé‡å®šå‘æ‰èƒ½æ‰¾åˆ°è¦æ‰§è¡Œå‘½ä»¤çš„èŠ‚ç‚¹ï¼Œé¢å¤–å¢åŠ äº†IOå¼€é”€ï¼Œè¿™ä¸æ˜¯Redisé›†ç¾¤é«˜æ•ˆçš„ä½¿ç”¨æ–¹å¼ã€‚æ­£å› ä¸ºå¦‚æ­¤é€šå¸¸é›†ç¾¤å®¢æˆ·ç«¯éƒ½é‡‡ç”¨å¦ä¸€ç§å®ç°ï¼šSmartï¼ˆæ™ºèƒ½ï¼‰å®¢æˆ·ç«¯ã€‚Smartå®¢æˆ·ç«¯é€šè¿‡åœ¨å†…éƒ¨ç»´æŠ¤slotâ†’nodeçš„æ˜ å°„å…³ç³»ï¼Œæœ¬åœ°å°±å¯å®ç°é”®åˆ°èŠ‚ç‚¹çš„æŸ¥æ‰¾ï¼Œä»è€Œä¿è¯IOæ•ˆç‡çš„æœ€å¤§åŒ–ï¼Œè€ŒMOVEDé‡å®šå‘è´Ÿè´£ååŠ©Smartå®¢æˆ·ç«¯æ›´æ–°slotâ†’nodeæ˜ å°„ã€‚</li>
</ol>
<h4 id="hash-tag"><a href="#hash-tag" class="headerlink" title="hash_tag"></a>hash_tag</h4><p>hash_tag å…è®¸ç”¨ key çš„éƒ¨åˆ†å­—ç¬¦ä¸²æ¥è®¡ç®— hashã€‚å½“ä¸€ä¸ª key åŒ…å« {} çš„æ—¶å€™ï¼Œå°±ä¸å¯¹æ•´ä¸ª key åš hashï¼Œè€Œä»…å¯¹ {} åŒ…æ‹¬çš„å­—ç¬¦ä¸²åš hashã€‚</p>
<p>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨mgetç­‰å‘½ä»¤ä¼˜åŒ–æ‰¹é‡è°ƒç”¨æ—¶ï¼Œé”®åˆ—è¡¨å¿…é¡»å…·æœ‰ç›¸åŒçš„slotï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚è¿™æ—¶å¯ä»¥åˆ©ç”¨hash_tagè®©ä¸åŒçš„é”®å…·æœ‰ç›¸åŒçš„slotè¾¾åˆ°ä¼˜åŒ–çš„ç›®çš„ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight accesslog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6385</span>&gt; mget user:<span class="number">10086</span>:frends user:<span class="number">10086</span>:videos</span><br><span class="line">(error) CROSSSLOT Keys in request don't hash to the same slot</span><br><span class="line"><span class="number">127.0.0.1:6385</span>&gt; mget user:{<span class="number">10086</span>}:friends user:{<span class="number">10086</span>}:videos</span><br><span class="line"><span class="number">1</span>) <span class="string">"friends"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"videos"</span></span><br></pre></td></tr></tbody></table></figure>
<p>PipelineåŒæ ·å¯ä»¥å—ç›Šäºhash_tagï¼Œç”±äºPipelineåªèƒ½å‘ä¸€ä¸ªèŠ‚ç‚¹æ‰¹é‡å‘é€æ‰§è¡Œå‘½ä»¤ï¼Œè€Œç›¸åŒslotå¿…ç„¶ä¼šå¯¹åº”åˆ°å”¯ä¸€çš„èŠ‚ç‚¹ï¼Œé™ä½äº†é›†ç¾¤ä½¿ç”¨Pipelineçš„é—¨æ§›ã€‚</p>
<h3 id="ASK-é‡å®šå‘"><a href="#ASK-é‡å®šå‘" class="headerlink" title="ASK é‡å®šå‘"></a>ASK é‡å®šå‘</h3><p>å½“slotå¯¹åº”çš„æ•°æ®ä»æºèŠ‚ç‚¹åˆ°ç›®æ ‡èŠ‚ç‚¹è¿ç§»è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯éœ€è¦åšåˆ°æ™ºèƒ½è¯†åˆ«ï¼Œä¿è¯é”®å‘½ä»¤å¯æ­£å¸¸æ‰§è¡Œã€‚ä¾‹å¦‚å½“ä¸€ä¸ªslotæ•°æ®ä»æºèŠ‚ç‚¹è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹æ—¶ï¼ŒæœŸé—´å¯èƒ½å‡ºç°ä¸€éƒ¨åˆ†æ•°æ®åœ¨æºèŠ‚ç‚¹ï¼Œè€Œå¦ä¸€éƒ¨åˆ†åœ¨ç›®æ ‡èŠ‚ç‚¹ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9qoovqnpwj30u00vlk0z.jpg"></p>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9qop67mnjj311m0ti0z1.jpg"></p>
<p>ASKä¸MOVEDè™½ç„¶éƒ½æ˜¯å¯¹å®¢æˆ·ç«¯çš„é‡å®šå‘æ§åˆ¶ï¼Œä½†æ˜¯æœ‰ç€æœ¬è´¨åŒºåˆ«ã€‚ASKé‡å®šå‘è¯´æ˜é›†ç¾¤æ­£åœ¨è¿›è¡Œslotæ•°æ®è¿ç§»ï¼Œå®¢æˆ·ç«¯æ— æ³•çŸ¥é“ä»€ä¹ˆæ—¶å€™è¿ç§»å®Œæˆï¼Œå› æ­¤åªèƒ½æ˜¯ä¸´æ—¶æ€§çš„é‡å®šå‘ï¼Œå®¢æˆ·ç«¯ä¸ä¼šæ›´æ–°slotsç¼“å­˜ã€‚ä½†æ˜¯MOVEDé‡å®šå‘è¯´æ˜é”®å¯¹åº”çš„æ§½å·²ç»æ˜ç¡®æŒ‡å®šåˆ°æ–°çš„èŠ‚ç‚¹ï¼Œå› æ­¤éœ€è¦æ›´æ–°slotsç¼“å­˜ã€‚</p>
<p>ä¸ºäº†æ”¯æŒASKé‡å®šå‘ï¼ŒæºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹åœ¨å†…éƒ¨çš„clusterStateç»“æ„ä¸­ç»´æŠ¤å½“å‰æ­£åœ¨è¿ç§»çš„æ§½ä¿¡æ¯ï¼Œç”¨äºè¯†åˆ«æ§½è¿ç§»æƒ…å†µã€‚</p>
<ul>
<li>å¦‚æœé”®æ‰€åœ¨çš„æ§½ç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£ï¼Œä½†é”®ä¸å­˜åœ¨åˆ™æŸ¥æ‰¾<code>migrating_slots_to</code>æ•°ç»„æŸ¥çœ‹æ§½æ˜¯å¦æ­£åœ¨è¿å‡ºï¼Œå¦‚æœæ˜¯è¿”å›ASKé‡å®šå‘ã€‚</li>
<li>å¦‚æœå®¢æˆ·ç«¯å‘é€<code>asking</code>å‘½ä»¤æ‰“å¼€äº†<code>CLIENT_ASKING</code>æ ‡è¯†ï¼Œåˆ™è¯¥å®¢æˆ·ç«¯ä¸‹æ¬¡å‘é€é”®å‘½ä»¤æ—¶æŸ¥æ‰¾<code>importing_slots_from</code>æ•°ç»„è·å–<code>clusterNode</code>ï¼Œå¦‚æœæŒ‡å‘è‡ªèº«åˆ™æ‰§è¡Œå‘½ä»¤ã€‚<ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œaskingå‘½ä»¤æ˜¯ä¸€æ¬¡æ€§å‘½ä»¤ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œåå®¢æˆ·ç«¯æ ‡è¯†éƒ½ä¼šä¿®æ”¹å›åŸçŠ¶æ€ï¼Œå› æ­¤æ¯æ¬¡å®¢æˆ·ç«¯æ¥æ”¶åˆ°ASKé‡å®šå‘åéƒ½éœ€è¦å‘é€askingå‘½ä»¤ã€‚</li>
</ul>
</li>
<li>ASKé‡å®šå‘å¯¹å•é”®å‘½ä»¤æ”¯æŒå¾—å¾ˆå®Œå–„ã€‚å½“æ§½å¤„äºè¿ç§»çŠ¶æ€æ—¶ï¼Œæ‰¹é‡æ“ä½œä¼šå—åˆ°å½±å“ã€‚</li>
</ul>
<p>ä½¿ç”¨smartå®¢æˆ·ç«¯æ‰¹é‡æ“ä½œé›†ç¾¤æ—¶ï¼Œéœ€è¦è¯„ä¼°<code>mget/mset</code>ã€Pipelineç­‰æ–¹å¼åœ¨slotè¿ç§»åœºæ™¯ä¸‹çš„å®¹é”™æ€§ï¼Œé˜²æ­¢é›†ç¾¤è¿ç§»é€ æˆå¤§é‡é”™è¯¯å’Œæ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚</p>
<p>é›†ç¾¤ç¯å¢ƒä¸‹å¯¹äºä½¿ç”¨æ‰¹é‡æ“ä½œçš„åœºæ™¯ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨Pipelineæ–¹å¼ï¼Œåœ¨å®¢æˆ·ç«¯å®ç°å¯¹ASKé‡å®šå‘çš„æ­£ç¡®å¤„ç†ï¼Œè¿™æ ·æ—¢å¯ä»¥å—ç›Šäºæ‰¹é‡æ“ä½œçš„IOä¼˜åŒ–ï¼Œåˆå¯ä»¥å…¼å®¹slotè¿ç§»åœºæ™¯ã€‚</p>
<h2 id="æ•…éšœè½¬ç§»-1"><a href="#æ•…éšœè½¬ç§»-1" class="headerlink" title="æ•…éšœè½¬ç§»"></a>æ•…éšœè½¬ç§»</h2><p>å½“æŸä¸ªèŠ‚ç‚¹è¢«ä¸»è§‚ä¸‹çº¿åï¼Œping/pongæ¶ˆæ¯çš„æ¶ˆæ¯ä½“ä¼šæºå¸¦é›†ç¾¤1/10çš„å…¶ä»–èŠ‚ç‚¹çŠ¶æ€æ•°æ®åœ¨é›†ç¾¤å†…ä¼ æ’­ã€‚å½“åŠæ•°ä»¥ä¸ŠæŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹éƒ½æ ‡è®°æŸä¸ªèŠ‚ç‚¹æ˜¯ä¸»è§‚ä¸‹çº¿æ—¶ï¼Œè§¦å‘å®¢è§‚ä¸‹çº¿æµç¨‹ã€‚</p>
<p>æ¯ä¸ªä¸‹çº¿æŠ¥å‘Šéƒ½å­˜åœ¨æœ‰æ•ˆæœŸ(<code>cluster-node-time*2</code>)ï¼Œæ¯æ¬¡åœ¨å°è¯•è§¦å‘å®¢è§‚ä¸‹çº¿æ—¶ï¼Œéƒ½ä¼šæ£€æµ‹ä¸‹çº¿æŠ¥å‘Šæ˜¯å¦è¿‡æœŸï¼Œå¯¹äºè¿‡æœŸçš„ä¸‹çº¿æŠ¥å‘Šå°†è¢«åˆ é™¤ã€‚</p>
<p>å¦‚æœåœ¨<code>cluster-node-time*2</code>æ—¶é—´å†…æ— æ³•æ”¶é›†åˆ°ä¸€åŠä»¥ä¸Šæ§½èŠ‚ç‚¹çš„ä¸‹çº¿æŠ¥å‘Šï¼Œé‚£ä¹ˆä¹‹å‰çš„ä¸‹çº¿æŠ¥å‘Šå°†ä¼šè¿‡æœŸï¼Œä¹Ÿå°±æ˜¯è¯´ä¸»è§‚ä¸‹çº¿ä¸ŠæŠ¥çš„é€Ÿåº¦è¿½èµ¶ä¸ä¸Šä¸‹çº¿æŠ¥å‘Šè¿‡æœŸçš„é€Ÿåº¦ï¼Œé‚£ä¹ˆæ•…éšœèŠ‚ç‚¹å°†æ°¸è¿œæ— æ³•è¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿ä»è€Œå¯¼è‡´æ•…éšœè½¬ç§»å¤±è´¥ã€‚å› æ­¤ä¸å»ºè®®å°†<code>cluster-node-time</code>è®¾ç½®å¾—è¿‡å°ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9qp56c761j30u010847e.jpg"></p>
<p>æ•…éšœæ¢å¤æµç¨‹ï¼š</p>
<ol>
<li>èµ„æ ¼æ£€æŸ¥</li>
<li>å‡†å¤‡é€‰ä¸¾æ—¶é—´</li>
<li>å‘èµ·é€‰ä¸¾</li>
<li>é€‰ä¸¾æŠ•ç¥¨</li>
<li>æ›¿æ¢ä¸»èŠ‚ç‚¹</li>
</ol>
<p>æŠ•ç¥¨ä½œåºŸï¼šæ¯ä¸ªé…ç½®çºªå…ƒä»£è¡¨äº†ä¸€æ¬¡é€‰ä¸¾å‘¨æœŸï¼Œå¦‚æœåœ¨å¼€å§‹æŠ•ç¥¨ä¹‹åçš„<code>cluster-node-timeout*2</code>æ—¶é—´å†…ä»èŠ‚ç‚¹æ²¡æœ‰è·å–è¶³å¤Ÿæ•°é‡çš„æŠ•ç¥¨ï¼Œåˆ™æœ¬æ¬¡é€‰ä¸¾ä½œåºŸã€‚ä»èŠ‚ç‚¹å¯¹é…ç½®çºªå…ƒè‡ªå¢å¹¶å‘èµ·ä¸‹ä¸€è½®æŠ•ç¥¨ï¼Œç›´åˆ°é€‰ä¸¾æˆåŠŸä¸ºæ­¢ã€‚</p>
<p>æ•…éšœè½¬ç§»æ—¶é—´ï¼š<code>failover-time(æ¯«ç§’) â‰¤ cluster-node-timeout + cluster-node-timeout/2 + 1000</code></p>
<h2 id="é›†ç¾¤è¿ç»´"><a href="#é›†ç¾¤è¿ç»´" class="headerlink" title="é›†ç¾¤è¿ç»´"></a>é›†ç¾¤è¿ç»´</h2><p>é›†ç¾¤å€¾æ–œ</p>
<ul>
<li>æ•°æ®å€¾æ–œ<ul>
<li>èŠ‚ç‚¹å’Œæ§½åˆ†é…ä¸¥é‡ä¸å‡ã€‚å¯ä»¥ä½¿ç”¨<code>redis-trib.rb info{host:ip}</code>è¿›è¡Œå®šä½</li>
<li>ä¸åŒæ§½å¯¹åº”é”®æ•°é‡å·®å¼‚è¿‡å¤§ã€‚é”®é€šè¿‡CRC16å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°æ§½ä¸Šï¼Œæ­£å¸¸æƒ…å†µä¸‹æ§½å†…é”®æ•°é‡ä¼šç›¸å¯¹å‡åŒ€ã€‚ä½†å½“å¤§é‡ä½¿ç”¨hash_tagæ—¶ï¼Œä¼šäº§ç”Ÿä¸åŒçš„é”®æ˜ å°„åˆ°åŒä¸€ä¸ªæ§½çš„æƒ…å†µã€‚ç‰¹åˆ«æ˜¯é€‰æ‹©ä½œä¸ºhash_tagçš„æ•°æ®ç¦»æ•£åº¦è¾ƒå·®æ—¶ï¼Œå°†åŠ é€Ÿæ§½å†…é”®æ•°é‡å€¾æ–œæƒ…å†µã€‚é€šè¿‡å‘½ä»¤<code>cluster countkeysinslot{slot}</code>å¯ä»¥è·å–æ§½å¯¹åº”çš„é”®æ•°é‡ï¼Œè¯†åˆ«å‡ºå“ªäº›æ§½æ˜ å°„äº†è¿‡å¤šçš„é”®ã€‚å†é€šè¿‡å‘½ä»¤<code>clustergetkeysinslot{slot}{count}</code>å¾ªç¯è¿­ä»£å‡ºæ§½ä¸‹æ‰€æœ‰çš„é”®ã€‚ä»è€Œå‘ç°è¿‡åº¦ä½¿ç”¨hash_tagçš„é”®ã€‚</li>
<li>é›†åˆå¯¹è±¡åŒ…å«å¤§é‡å…ƒç´ ã€‚</li>
<li>å†…å­˜ç›¸å…³é…ç½®ä¸ä¸€è‡´ã€‚</li>
</ul>
</li>
<li>è¯·æ±‚å€¾æ–œ<ul>
<li>åˆç†è®¾è®¡é”®ï¼Œçƒ­ç‚¹å¤§é›†åˆå¯¹è±¡åšæ‹†åˆ†æˆ–ä½¿ç”¨hmgetæ›¿ä»£hgetallé¿å…æ•´ä½“è¯»å–ã€‚</li>
<li>ä¸è¦ä½¿ç”¨çƒ­é”®ä½œä¸ºhash_tagï¼Œé¿å…æ˜ å°„åˆ°åŒä¸€æ§½ã€‚</li>
<li>å¯¹äºä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œå®¢æˆ·ç«¯å¯ä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡å°‘çƒ­é”®è°ƒç”¨ã€‚</li>
</ul>
</li>
</ul>
<p>é›†ç¾¤æ¨¡å¼ä¸‹ä»èŠ‚ç‚¹ä¸æ¥å—ä»»ä½•è¯»å†™è¯·æ±‚ï¼Œå‘é€è¿‡æ¥çš„é”®å‘½ä»¤ä¼šé‡å®šå‘åˆ°è´Ÿè´£æ§½çš„ä¸»èŠ‚ç‚¹ä¸Šã€‚å½“éœ€è¦ä½¿ç”¨ä»èŠ‚ç‚¹åˆ†æ‹…ä¸»èŠ‚ç‚¹è¯»å‹åŠ›æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>readonly</code>å‘½ä»¤æ‰“å¼€å®¢æˆ·ç«¯è¿æ¥åªè¯»çŠ¶æ€ã€‚<code>readonly</code>å‘½ä»¤æ˜¯è¿æ¥çº§åˆ«ç”Ÿæ•ˆï¼Œå› æ­¤æ¯æ¬¡æ–°å»ºè¿æ¥æ—¶éƒ½éœ€è¦æ‰§è¡Œ<code>readonly</code>å¼€å¯åªè¯»çŠ¶æ€ã€‚æ‰§è¡Œ<code>readwrite</code>å‘½ä»¤å¯ä»¥å…³é—­è¿æ¥åªè¯»çŠ¶æ€ã€‚</p>
<h1 id="ç¬¬-11-ç« -ç¼“å­˜è®¾è®¡"><a href="#ç¬¬-11-ç« -ç¼“å­˜è®¾è®¡" class="headerlink" title="ç¬¬ 11 ç«  ç¼“å­˜è®¾è®¡"></a>ç¬¬ 11 ç«  ç¼“å­˜è®¾è®¡</h1><h2 id="ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>ç¼“å­˜æ›´æ–°ç­–ç•¥</h2><h3 id="LRU-LFU-FIFO-ç®—æ³•å‰”é™¤"><a href="#LRU-LFU-FIFO-ç®—æ³•å‰”é™¤" class="headerlink" title="LRU/LFU/FIFO ç®—æ³•å‰”é™¤"></a>LRU/LFU/FIFO ç®—æ³•å‰”é™¤</h3><p>ä½¿ç”¨åœºæ™¯ï¼šå‰”é™¤ç®—æ³•é€šå¸¸ç”¨äºç¼“å­˜ä½¿ç”¨é‡è¶…è¿‡äº†é¢„è®¾çš„æœ€å¤§å€¼æ—¶å€™ï¼Œå¦‚ä½•å¯¹ç°æœ‰çš„æ•°æ®è¿›è¡Œå‰”é™¤ã€‚<br>ä¸€è‡´æ€§ï¼šè¦æ¸…ç†å“ªäº›æ•°æ®æ˜¯ç”±å…·ä½“ç®—æ³•å†³å®šï¼Œå¼€å‘äººå‘˜åªèƒ½å†³å®šä½¿ç”¨å“ªç§ç®—æ³•ï¼Œæ‰€ä»¥æ•°æ®çš„ä¸€è‡´æ€§æ˜¯æœ€å·®çš„ã€‚<br>ç»´æŠ¤æˆæœ¬ï¼šç®—æ³•ä¸éœ€è¦å¼€å‘äººå‘˜è‡ªå·±æ¥å®ç°ï¼Œé€šå¸¸åªéœ€è¦é…ç½®æœ€å¤§<code>maxmemory</code>å’Œå¯¹åº”çš„ç­–ç•¥å³å¯ã€‚å¼€å‘äººå‘˜åªéœ€è¦çŸ¥é“æ¯ç§ç®—æ³•çš„å«ä¹‰ï¼Œé€‰æ‹©é€‚åˆè‡ªå·±çš„ç®—æ³•å³å¯ã€‚</p>
<h3 id="è¶…æ—¶å‰”é™¤"><a href="#è¶…æ—¶å‰”é™¤" class="headerlink" title="è¶…æ—¶å‰”é™¤"></a>è¶…æ—¶å‰”é™¤</h3><p>ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸šåŠ¡å¯ä»¥å®¹å¿ä¸€æ®µæ—¶é—´å†…ï¼Œç¼“å­˜å±‚æ•°æ®å’Œå­˜å‚¨å±‚æ•°æ®ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå¯ä»¥ä¸ºå…¶è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚å¦‚ä¸€ä¸ªè§†é¢‘çš„æè¿°ä¿¡æ¯ï¼Œå¯ä»¥å®¹å¿å‡ åˆ†é’Ÿå†…æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æ˜¯æ¶‰åŠäº¤æ˜“æ–¹é¢çš„ä¸šåŠ¡åˆ™ä¸é€‚ç”¨ã€‚<br>ä¸€è‡´æ€§ï¼šä¸€æ®µæ—¶é—´çª—å£å†…å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ã€‚<br>ç»´æŠ¤æˆæœ¬ï¼šåªéœ€è®¾ç½®<code>expire</code>è¿‡æœŸæ—¶é—´å³å¯ï¼Œç»´æŠ¤æˆæœ¬è¾ƒä½ã€‚</p>
<h3 id="ä¸»åŠ¨æ›´æ–°"><a href="#ä¸»åŠ¨æ›´æ–°" class="headerlink" title="ä¸»åŠ¨æ›´æ–°"></a>ä¸»åŠ¨æ›´æ–°</h3><p>ä½¿ç”¨åœºæ™¯ï¼šåº”ç”¨æ–¹å¯¹äºæ•°æ®çš„ä¸€è‡´æ€§è¦æ±‚é«˜ï¼Œéœ€è¦åœ¨çœŸå®æ•°æ®æ›´æ–°åï¼Œç«‹å³æ›´æ–°ç¼“å­˜æ•°æ®ã€‚<br>ä¸€è‡´æ€§ï¼šä¸€è‡´æ€§æœ€é«˜ï¼Œä½†å¦‚æœä¸»åŠ¨æ›´æ–°å‘ç”Ÿäº†é—®é¢˜ï¼Œé‚£ä¹ˆè¿™æ¡æ•°æ®å¾ˆå¯èƒ½å¾ˆé•¿æ—¶é—´ä¸ä¼šæ›´æ–°ï¼Œæ‰€ä»¥<strong>å»ºè®®ç»“åˆè¶…æ—¶å‰”é™¤ä¸€èµ·ä½¿ç”¨æ•ˆæœä¼šæ›´å¥½</strong>ã€‚<br>ç»´æŠ¤æˆæœ¬ï¼šç»´æŠ¤æˆæœ¬è¾ƒé«˜ï¼Œå¼€å‘è€…éœ€è¦è‡ªå·±æ¥å®Œæˆæ›´æ–°ï¼Œå¹¶ä¿è¯æ›´æ–°æ“ä½œçš„æ­£ç¡®æ€§ã€‚</p>
<h3 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h3><ol>
<li>ä½ä¸€è‡´æ€§ä¸šåŠ¡å»ºè®®é…ç½®æœ€å¤§å†…å­˜å’Œæ·˜æ±°ç­–ç•¥çš„æ–¹å¼ä½¿ç”¨ã€‚</li>
<li>é«˜ä¸€è‡´æ€§ä¸šåŠ¡å¯ä»¥ç»“åˆä½¿ç”¨è¶…æ—¶å‰”é™¤å’Œä¸»åŠ¨æ›´æ–°ï¼Œè¿™æ ·å³ä½¿ä¸»åŠ¨æ›´æ–°å‡ºäº†é—®é¢˜ï¼Œä¹Ÿèƒ½ä¿è¯æ•°æ®è¿‡æœŸæ—¶é—´ååˆ é™¤è„æ•°æ®ã€‚</li>
</ol>
<h2 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h2><p>ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜å±‚å’Œå­˜å‚¨å±‚éƒ½ä¸ä¼šå‘½ä¸­ã€‚é€ æˆç¼“å­˜ç©¿é€çš„åŸºæœ¬åŸå› æœ‰ä¸¤ä¸ªã€‚ç¬¬ä¸€ï¼Œè‡ªèº«ä¸šåŠ¡ä»£ç æˆ–è€…æ•°æ®å‡ºç°é—®é¢˜ï¼Œç¬¬äºŒï¼Œä¸€äº›æ¶æ„æ”»å‡»ã€çˆ¬è™«ç­‰é€ æˆå¤§é‡ç©ºå‘½ä¸­ã€‚</p>
<h3 id="ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆ"><a href="#ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆ"></a>ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆ</h3><h4 id="1-ç¼“å­˜ç©ºå¯¹è±¡"><a href="#1-ç¼“å­˜ç©ºå¯¹è±¡" class="headerlink" title="1. ç¼“å­˜ç©ºå¯¹è±¡"></a>1. ç¼“å­˜ç©ºå¯¹è±¡</h4><p>ç¼“å­˜ç©ºå¯¹è±¡ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼šç¬¬ä¸€ï¼Œç©ºå€¼åšäº†ç¼“å­˜ï¼Œæ„å‘³ç€ç¼“å­˜å±‚ä¸­å­˜äº†æ›´å¤šçš„é”®ï¼Œéœ€è¦æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼ˆå¦‚æœæ˜¯æ”»å‡»ï¼Œé—®é¢˜æ›´ä¸¥é‡ï¼‰ï¼Œæ¯”è¾ƒæœ‰æ•ˆçš„æ–¹æ³•æ˜¯é’ˆå¯¹è¿™ç±»æ•°æ®è®¾ç½®ä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè®©å…¶è‡ªåŠ¨å‰”é™¤ã€‚ç¬¬äºŒï¼Œç¼“å­˜å±‚å’Œå­˜å‚¨å±‚çš„æ•°æ®ä¼šæœ‰ä¸€æ®µæ—¶é—´çª—å£çš„ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¹ä¸šåŠ¡æœ‰ä¸€å®šå½±å“ã€‚ä¾‹å¦‚è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º5åˆ†é’Ÿï¼Œå¦‚æœæ­¤æ—¶å­˜å‚¨å±‚æ·»åŠ äº†è¿™ä¸ªæ•°æ®ï¼Œé‚£æ­¤æ®µæ—¶é—´å°±ä¼šå‡ºç°ç¼“å­˜å±‚å’Œå­˜å‚¨å±‚æ•°æ®çš„ä¸ä¸€è‡´ï¼Œæ­¤æ—¶å¯ä»¥åˆ©ç”¨æ¶ˆæ¯ç³»ç»Ÿæˆ–è€…å…¶ä»–æ–¹å¼æ¸…é™¤æ‰ç¼“å­˜å±‚ä¸­çš„ç©ºå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">get</span><span class="params">(String key)</span> </span>{</span><br><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­è·å–æ•°æ®</span></span><br><span class="line">    String cacheValue = cache.get(key);</span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(cacheValue)) {</span><br><span class="line">        <span class="comment">// ä»å­˜å‚¨ä¸­è·å–</span></span><br><span class="line">        String storageValue = storage.get(key);</span><br><span class="line">        cache.set(key, storageValue);</span><br><span class="line">        <span class="comment">// å¦‚æœå­˜å‚¨æ•°æ®ä¸ºç©ºï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´(300ç§’)</span></span><br><span class="line">        <span class="keyword">if</span> (storageValue == <span class="keyword">null</span>) {</span><br><span class="line">            cache.expire(key, <span class="number">60</span> * <span class="number">5</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> storageValue;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// ç¼“å­˜éç©º</span></span><br><span class="line">        <span class="keyword">return</span> cacheValue;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enly0i2dj30g10i1ac8.jpg"></p>
<h4 id="2-å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª"><a href="#2-å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª" class="headerlink" title="2. å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª"></a>2. å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª</h4><p>å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨è®¿é—®ç¼“å­˜å±‚å’Œå­˜å‚¨å±‚ä¹‹å‰ï¼Œå°†å­˜åœ¨çš„keyç”¨å¸ƒéš†è¿‡æ»¤å™¨æå‰ä¿å­˜èµ·æ¥ï¼Œåšç¬¬ä¸€å±‚æ‹¦æˆªã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªæ¨èç³»ç»Ÿæœ‰4äº¿ä¸ªç”¨æˆ·idï¼Œæ¯ä¸ªå°æ—¶ç®—æ³•å·¥ç¨‹å¸ˆä¼šæ ¹æ®æ¯ä¸ªç”¨æˆ·ä¹‹å‰å†å²è¡Œä¸ºè®¡ç®—å‡ºæ¨èæ•°æ®æ”¾åˆ°å­˜å‚¨å±‚ä¸­ï¼Œä½†æ˜¯æœ€æ–°çš„ç”¨æˆ·ç”±äºæ²¡æœ‰å†å²è¡Œä¸ºï¼Œå°±ä¼šå‘ç”Ÿç¼“å­˜ç©¿é€çš„è¡Œä¸ºï¼Œä¸ºæ­¤å¯ä»¥å°†æ‰€æœ‰æ¨èæ•°æ®çš„ç”¨æˆ·åšæˆå¸ƒéš†è¿‡æ»¤å™¨ã€‚å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è®¤ä¸ºè¯¥ç”¨æˆ·idä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè®¿é—®å­˜å‚¨å±‚ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¿æŠ¤äº†å­˜å‚¨å±‚ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enotipdrj30in0hvq5t.jpg"></p>
<blockquote>
<p>å¯ä»¥åˆ©ç”¨ Redis çš„ Bitmaps å®ç°å¸ƒéš†è¿‡æ»¤å™¨ã€‚ç±»ä¼¼å¼€æºæ–¹æ¡ˆå¯æŸ¥çœ‹ <a target="_blank" rel="noopener" href="https://github.com/erikdubbelboer/redis-lua-scaling-bloom-filter">https://github.com/erikdubbelboer/redis-lua-scaling-bloom-filter</a></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9ens6v1czj30md068q4q.jpg"></p>
<h2 id="æ— åº•æ´ä¼˜åŒ–"><a href="#æ— åº•æ´ä¼˜åŒ–" class="headerlink" title="æ— åº•æ´ä¼˜åŒ–"></a>æ— åº•æ´ä¼˜åŒ–</h2><p>æ— åº•æ´æ˜¯æŒ‡ï¼Œé‡‡ç”¨åˆ†å¸ƒå¼æå‡ç¼“å­˜çš„èƒ½åŠ›ï¼Œä½†åˆ†å¸ƒå¼æ¶æ„åˆå¼•å‘äº†<code>mget</code>ç­‰æ‰¹é‡æ“ä½œå‘½ä»¤çš„å¤šæ¬¡ç½‘ç»œè¿æ¥é€ æˆçš„æ€§èƒ½ä¸‹é™ã€‚å› æ­¤ï¼Œæ›´å¤šçš„èŠ‚ç‚¹ä¸ä»£è¡¨æ›´é«˜çš„æ€§èƒ½ï¼Œæ‰€è°“â€œæ— åº•æ´â€å°±æ˜¯è¯´æŠ•å…¥è¶Šå¤šä¸ä¸€å®šäº§å‡ºè¶Šå¤šã€‚ä½†æ˜¯åˆ†å¸ƒå¼åˆæ˜¯ä¸å¯ä»¥é¿å…çš„ï¼Œå› ä¸ºè®¿é—®é‡å’Œæ•°æ®é‡è¶Šæ¥è¶Šå¤§ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ ¹æœ¬æŠ—ä¸ä½ï¼Œæ‰€ä»¥å¦‚ä½•é«˜æ•ˆåœ°åœ¨åˆ†å¸ƒå¼ç¼“å­˜ä¸­æ‰¹é‡æ“ä½œæ˜¯ä¸€ä¸ªéš¾ç‚¹ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enykatrkj30lu0m9tf4.jpg"><br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9enz0x9eaj30mh0jsgr7.jpg"></p>
<p>æ— åº•æ´é—®é¢˜çš„ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ul>
<li><p>å‘½ä»¤æœ¬èº«çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ä¼˜åŒ–SQLè¯­å¥ç­‰ã€‚</p>
</li>
<li><p>å‡å°‘ç½‘ç»œé€šä¿¡æ¬¡æ•°ã€‚</p>
<ul>
<li>å®¢æˆ·ç«¯næ¬¡get(ä¸²è¡Œæ‰§è¡Œ)ï¼šnæ¬¡ç½‘ç»œ+næ¬¡getå‘½ä»¤æœ¬èº«ã€‚<ul>
<li>å³é€æ¬¡æ‰§è¡Œnä¸ªgetå‘½ä»¤ï¼Œè¿™ç§æ“ä½œæ—¶é—´å¤æ‚åº¦è¾ƒé«˜ï¼Œä½†å®ç°ä¹Ÿæœ€ç®€å•ã€‚</li>
</ul>
</li>
<li>å®¢æˆ·ç«¯1æ¬¡pipeline get(ä¸²è¡ŒI/O)ï¼š1æ¬¡ç½‘ç»œ+næ¬¡getå‘½ä»¤æœ¬èº«ã€‚<ul>
<li>Redis Clusterä½¿ç”¨CRC16ç®—æ³•è®¡ç®—å‡ºæ•£åˆ—å€¼ï¼Œå†å–å¯¹16383çš„ä½™æ•°å°±å¯ä»¥ç®—å‡ºslotå€¼ï¼ŒåŒæ—¶Smartå®¢æˆ·ç«¯ä¼šä¿å­˜slotå’ŒèŠ‚ç‚¹çš„å¯¹åº”å…³ç³»ï¼Œæœ‰äº†è¿™ä¸¤ä¸ªæ•°æ®å°±å¯ä»¥å°†å±äºåŒä¸€ä¸ªèŠ‚ç‚¹çš„keyè¿›è¡Œå½’æ¡£ï¼Œå¾—åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„keyå­åˆ—è¡¨ï¼Œä¹‹åå¯¹æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œmgetæˆ–è€…Pipelineæ“ä½œï¼Œå®ƒçš„æ“ä½œæ—¶é—´=nodeæ¬¡ç½‘ç»œæ—¶é—´+næ¬¡å‘½ä»¤æ—¶é—´ï¼Œç½‘ç»œæ¬¡æ•°æ˜¯nodeçš„ä¸ªæ•°ï¼Œå¾ˆæ˜æ˜¾è¿™ç§æ–¹æ¡ˆæ¯”ç¬¬ä¸€ç§è¦å¥½å¾ˆå¤šï¼Œä½†æ˜¯å¦‚æœèŠ‚ç‚¹æ•°å¤ªå¤šï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„æ€§èƒ½é—®é¢˜ã€‚</li>
</ul>
</li>
<li>å®¢æˆ·ç«¯1æ¬¡mget(å¹¶è¡ŒI/O)ï¼š1æ¬¡ç½‘ç»œ+1æ¬¡mgetå‘½ä»¤æœ¬èº«ã€‚<ul>
<li>æ­¤æ–¹æ¡ˆæ˜¯å°†æ–¹æ¡ˆ2ä¸­çš„æœ€åä¸€æ­¥æ”¹ä¸ºå¤šçº¿ç¨‹æ‰§è¡Œï¼Œç½‘ç»œæ¬¡æ•°è™½ç„¶è¿˜æ˜¯èŠ‚ç‚¹ä¸ªæ•°ï¼Œä½†ç”±äºä½¿ç”¨å¤šçº¿ç¨‹ç½‘ç»œæ—¶é—´å˜ä¸º$O(1)$ï¼Œè¿™ç§æ–¹æ¡ˆä¼šå¢åŠ ç¼–ç¨‹çš„å¤æ‚åº¦ã€‚å…¶æ“ä½œæ—¶é—´ä¸ºï¼š<code>max_slow(nodeç½‘ç»œæ—¶é—´)+næ¬¡å‘½ä»¤æ—¶é—´</code></li>
</ul>
</li>
<li>Redis Clusterçš„<code>hash_tag</code>å¯ä»¥å°†å¤šä¸ªkeyå¼ºåˆ¶åˆ†é…åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®ƒçš„æ“ä½œæ—¶é—´=1æ¬¡ç½‘ç»œæ—¶é—´+næ¬¡å‘½ä»¤æ—¶é—´ã€‚</li>
</ul>
</li>
<li><p>é™ä½æ¥å…¥æˆæœ¬ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯ä½¿ç”¨é•¿è¿/è¿æ¥æ± ã€NIO(Non-blocking I/O)ç­‰ã€‚</p>
</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eoakg0wrj30md0g0jty.jpg"></p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eo4ku5pyj30mg095acq.jpg"></p>
<h2 id="é›ªå´©ä¼˜åŒ–"><a href="#é›ªå´©ä¼˜åŒ–" class="headerlink" title="é›ªå´©ä¼˜åŒ–"></a>é›ªå´©ä¼˜åŒ–</h2><p>ç¼“å­˜é›ªå´©ï¼šå¦‚æœç¼“å­˜å±‚ç”±äºæŸäº›åŸå› ä¸èƒ½æä¾›æœåŠ¡ï¼Œäºæ˜¯æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè¾¾åˆ°å­˜å‚¨å±‚ï¼Œå­˜å‚¨å±‚çš„è°ƒç”¨é‡ä¼šæš´å¢ï¼Œé€ æˆå­˜å‚¨å±‚ä¹Ÿä¼šçº§è”å®•æœºçš„æƒ…å†µã€‚<br><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eobx2323j30m20ed0vb.jpg"></p>
<p>ä¼˜åŒ–æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<ol>
<li>ä¿è¯ç¼“å­˜å±‚æœåŠ¡é«˜å¯ç”¨æ€§ã€‚Redis Sentinelå’ŒRedis Clusteréƒ½å®ç°äº†é«˜å¯ç”¨ã€‚</li>
<li>ä¾èµ–éš”ç¦»ç»„ä»¶ä¸ºåç«¯é™æµå¹¶é™çº§ã€‚ä½œä¸ºå¹¶å‘é‡è¾ƒå¤§çš„ç³»ç»Ÿï¼Œå‡å¦‚æœ‰ä¸€ä¸ªèµ„æºä¸å¯ç”¨ï¼Œå¯èƒ½ä¼šé€ æˆçº¿ç¨‹å…¨éƒ¨é˜»å¡åœ¨è¿™ä¸ªèµ„æºä¸Šï¼Œé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ã€‚é™çº§æœºåˆ¶åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­æ˜¯éå¸¸æ™®éçš„ï¼šæ¯”å¦‚æ¨èæœåŠ¡ä¸­ï¼Œå¦‚æœä¸ªæ€§åŒ–æ¨èæœåŠ¡ä¸å¯ç”¨ï¼Œå¯ä»¥é™çº§è¡¥å……çƒ­ç‚¹æ•°æ®ï¼Œä¸è‡³äºé€ æˆå‰ç«¯é¡µé¢æ˜¯å¼€å¤©çª—ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹é‡è¦çš„èµ„æºï¼ˆä¾‹å¦‚Redisã€MySQLã€HBaseã€å¤–éƒ¨æ¥å£ï¼‰éƒ½è¿›è¡Œéš”ç¦»ï¼Œè®©æ¯ç§èµ„æºéƒ½å•ç‹¬è¿è¡Œåœ¨è‡ªå·±çš„çº¿ç¨‹æ± ä¸­ï¼Œå³ä½¿ä¸ªåˆ«èµ„æºå‡ºç°äº†é—®é¢˜ï¼Œå¯¹å…¶ä»–æœåŠ¡æ²¡æœ‰å½±å“ã€‚</li>
<li>æå‰æ¼”ç»ƒã€‚åœ¨é¡¹ç›®ä¸Šçº¿å‰ï¼Œæ¼”ç»ƒç¼“å­˜å±‚å®•æ‰åï¼Œåº”ç”¨ä»¥åŠåç«¯çš„è´Ÿè½½æƒ…å†µä»¥åŠå¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšä¸€äº›é¢„æ¡ˆè®¾å®šã€‚</li>
</ol>
<h2 id="çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–"><a href="#çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–" class="headerlink" title="çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–"></a>çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–</h2><p>åœ¨ç¼“å­˜å¤±æ•ˆçš„ç¬é—´ï¼Œæœ‰å¤§é‡çº¿ç¨‹æ¥é‡å»ºç¼“å­˜ï¼Œé€ æˆåç«¯è´Ÿè½½åŠ å¤§ï¼Œç”šè‡³å¯èƒ½ä¼šè®©åº”ç”¨å´©æºƒã€‚</p>
<p>è§£å†³çƒ­ç‚¹ key é‡å»ºçš„æ€è·¯ï¼š</p>
<ul>
<li>å‡å°‘é‡å»ºç¼“å­˜çš„æ¬¡æ•°ã€‚</li>
<li>æ•°æ®å°½å¯èƒ½ä¸€è‡´ã€‚</li>
<li>è¾ƒå°‘çš„æ½œåœ¨å±é™©ã€‚</li>
</ul>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><h4 id="äº’æ–¥é”-mutex-key"><a href="#äº’æ–¥é”-mutex-key" class="headerlink" title="äº’æ–¥é”(mutex key)"></a>äº’æ–¥é”(mutex key)</h4><p>æ­¤æ–¹æ³•åªå…è®¸ä¸€ä¸ªçº¿ç¨‹é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…é‡å»ºç¼“å­˜çš„çº¿ç¨‹æ‰§è¡Œå®Œï¼Œé‡æ–°ä»ç¼“å­˜è·å–æ•°æ®å³å¯ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">get</span><span class="params">(String key)</span> </span>{</span><br><span class="line">    <span class="comment">// ä»Redisä¸­è·å–æ•°æ®</span></span><br><span class="line">    String value = redis.get(key);</span><br><span class="line">    <span class="comment">// å¦‚æœvalueä¸ºç©ºï¼Œåˆ™å¼€å§‹é‡æ„ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// åªå…è®¸ä¸€ä¸ªçº¿ç¨‹é‡æ„ç¼“å­˜ï¼Œä½¿ç”¨nxï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ex</span></span><br><span class="line">        String mutexKey = <span class="string">"mutext:key:"</span> + key;</span><br><span class="line">        <span class="keyword">if</span> (redis.set(mutexKey, <span class="string">"1"</span>, <span class="string">"ex 180"</span>, <span class="string">"nx"</span>)) {</span><br><span class="line">            <span class="comment">// ä»æ•°æ®æºè·å–æ•°æ®</span></span><br><span class="line">            value = db.get(key);</span><br><span class="line">            <span class="comment">// å›å†™Redisï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">            redis.setex(key, timeout, value);</span><br><span class="line">            <span class="comment">// åˆ é™¤key_mutex</span></span><br><span class="line">            redis.delete(mutexKey);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// å…¶ä»–çº¿ç¨‹ä¼‘æ¯50æ¯«ç§’åé‡è¯•</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            get(key);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="æ°¸ä¸è¿‡æœŸ"><a href="#æ°¸ä¸è¿‡æœŸ" class="headerlink" title="æ°¸ä¸è¿‡æœŸ"></a>æ°¸ä¸è¿‡æœŸ</h4><p>æ°¸ä¸è¿‡æœŸåŒ…å«ä¸¤å±‚å«ä¹‰ï¼š</p>
<ul>
<li>ä»ç¼“å­˜å±‚é¢æ¥çœ‹ï¼Œç¡®å®æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°çƒ­ç‚¹keyè¿‡æœŸåäº§ç”Ÿçš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯â€œç‰©ç†â€ä¸è¿‡æœŸã€‚</li>
<li>ä»åŠŸèƒ½å±‚é¢æ¥çœ‹ï¼Œä¸ºæ¯ä¸ªvalueè®¾ç½®ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œå½“å‘ç°è¶…è¿‡é€»è¾‘è¿‡æœŸæ—¶é—´åï¼Œä¼šä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹å»æ„å»ºç¼“å­˜ã€‚</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eomw75jpj30lp0lt43y.jpg"></p>
<p>ä½œä¸ºä¸€ä¸ªå¹¶å‘é‡è¾ƒå¤§çš„åº”ç”¨ï¼Œåœ¨ä½¿ç”¨ç¼“å­˜æ—¶æœ‰ä¸‰ä¸ªç›®æ ‡ï¼šç¬¬ä¸€ï¼ŒåŠ å¿«ç”¨æˆ·è®¿é—®é€Ÿåº¦ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚ç¬¬äºŒï¼Œé™ä½åç«¯è´Ÿè½½ï¼Œå‡å°‘æ½œåœ¨çš„é£é™©ï¼Œä¿è¯ç³»ç»Ÿå¹³ç¨³ã€‚ç¬¬ä¸‰ï¼Œä¿è¯æ•°æ®â€œå°½å¯èƒ½â€åŠæ—¶æ›´æ–°ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g9eol3rlkmj30mz07fq4l.jpg"></p>
<h1 id="ç¬¬-12-ç« -Devops-çš„é™·é˜±"><a href="#ç¬¬-12-ç« -Devops-çš„é™·é˜±" class="headerlink" title="ç¬¬ 12 ç«  Devops çš„é™·é˜±"></a>ç¬¬ 12 ç«  Devops çš„é™·é˜±</h1><h2 id="Redis-æ”»å‡»"><a href="#Redis-æ”»å‡»" class="headerlink" title="Redis æ”»å‡»"></a>Redis æ”»å‡»</h2><p>æ”»å‡»è€…å……åˆ†åˆ©ç”¨Redisçš„dirå’Œ<code>dbfilename</code>ä¸¤ä¸ªé…ç½®å¯ä»¥ä½¿ç”¨<code>config set</code>åŠ¨æ€è®¾ç½®ï¼Œä»¥åŠRDBæŒä¹…åŒ–çš„ç‰¹æ€§ï¼Œå°†è‡ªå·±çš„å…¬é’¥å†™å…¥åˆ°ç›®æ ‡æœºå™¨çš„<code>/root/.ssh/authotrized_keys</code>æ–‡ä»¶ä¸­ï¼Œä»è€Œå®ç°äº†å¯¹ç›®æ ‡æœºå™¨çš„æ”»é™·ã€‚æ”»å‡»è¿‡ç¨‹å¦‚å›¾ã€‚<br><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9qrmwcp5ij30il0black.jpg"></p>
<h2 id="å‘½ä»¤é‡å†™"><a href="#å‘½ä»¤é‡å†™" class="headerlink" title="å‘½ä»¤é‡å†™"></a>å‘½ä»¤é‡å†™</h2><p>Redis ä¸­æä¾›äº†<code>rename-command</code>å‘½ä»¤æ¥é‡å‘½åå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥å‘½ä»¤å°†ä¸€äº›å±é™©å‘½ä»¤æ”¹å†™ï¼Œå¦‚<code>keys</code>ã€<code>flushall/flushdb</code>ã€<code>save</code>ã€<code>debug</code>(<code>debug reload</code>ä¼šé‡å¯ Redis)ã€<code>config</code>ã€<code>shutdown</code>ã€‚åŒæ—¶ï¼Œ<code>rename-command</code>ä¸æ”¯æŒ<code>config set</code>ï¼Œå¦‚æœAOFå’ŒRDBæ–‡ä»¶åŒ…å«äº†rename-commandä¹‹å‰çš„å‘½ä»¤ï¼ŒRediså°†æ— æ³•å¯åŠ¨ã€‚</p>
<p><code>rename-command</code>çš„æœ€ä½³å®è·µï¼š</p>
<ul>
<li>å¯¹äºä¸€äº›å±é™©çš„å‘½ä»¤ï¼ˆä¾‹å¦‚flushallï¼‰ï¼Œä¸ç®¡æ˜¯å†…ç½‘è¿˜æ˜¯å¤–ç½‘ï¼Œä¸€å¾‹ä½¿ç”¨<code>rename-command</code>é…ç½®</li>
<li>å»ºè®®ç¬¬ä¸€æ¬¡é…ç½®Redisæ—¶ï¼Œå°±åº”è¯¥é…ç½®<code>rename-command</code>ï¼Œå› ä¸º<code>renamecommand</code>ä¸æ”¯æŒ<code>config set</code>ã€‚</li>
<li>å¦‚æœæ¶‰åŠä¸»ä»å…³ç³»ï¼Œä¸€å®šè¦ä¿æŒä¸»ä»èŠ‚ç‚¹é…ç½®çš„ä¸€è‡´æ€§ï¼Œå¦åˆ™å­˜åœ¨ä¸»ä»æ•°æ®ä¸ä¸€è‡´çš„å¯èƒ½æ€§ã€‚</li>
</ul>
<h2 id="é˜²ç«å¢™"><a href="#é˜²ç«å¢™" class="headerlink" title="é˜²ç«å¢™"></a>é˜²ç«å¢™</h2><p>å¯ä»¥ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è¾“å…¥å’Œè¾“å‡ºçš„IPæˆ–è€…IPèŒƒå›´ã€ç«¯å£æˆ–è€…ç«¯å£èŒƒå›´ã€‚</p>
<p>å¾ˆå¤šå¼€å‘è€…åœ¨ä¸€å¼€å§‹çœ‹åˆ°bindçš„è¿™ä¸ªé…ç½®æ—¶éƒ½æ˜¯è¿™ä¹ˆè®¤ä¸ºçš„ï¼šæŒ‡å®šRedisåªæ¥æ”¶æ¥è‡ªäºæŸä¸ªç½‘æ®µIPçš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä½†<strong>äº‹å®ä¸ŠbindæŒ‡å®šçš„æ˜¯Rediså’Œå“ªä¸ªç½‘å¡è¿›è¡Œç»‘å®š</strong>ï¼Œå’Œå®¢æˆ·ç«¯æ˜¯ä»€ä¹ˆç½‘æ®µæ²¡æœ‰å…³ç³»ã€‚</p>
<ul>
<li>å¦‚æœæœºå™¨æœ‰å¤–ç½‘IPï¼Œä½†éƒ¨ç½²çš„Redisæ˜¯ç»™å†…éƒ¨ä½¿ç”¨çš„ï¼Œå»ºè®®å»æ‰å¤–ç½‘ç½‘å¡æˆ–è€…ä½¿ç”¨bindé…ç½®é™åˆ¶æµé‡ä»å¤–ç½‘è¿›å…¥ã€‚</li>
<li>å¦‚æœå®¢æˆ·ç«¯å’ŒRediséƒ¨ç½²åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥ä½¿ç”¨å›ç¯åœ°å€ï¼ˆ127.0.0.1ï¼‰ã€‚</li>
<li>bindé…ç½®ä¸æ”¯æŒ<code>config set</code>ï¼Œæ‰€ä»¥å°½å¯èƒ½åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨å‰é…ç½®å¥½</li>
</ul>
<h2 id="bigkey"><a href="#bigkey" class="headerlink" title="bigkey"></a>bigkey</h2><p>å±å®³ï¼š</p>
<ul>
<li>å†…å­˜ç©ºé—´ä¸å‡åŒ€</li>
<li>è¶…æ—¶é˜»å¡</li>
<li>ç½‘ç»œæ‹¥å¡</li>
</ul>
<p>bigkeyçš„å­˜åœ¨å¹¶ä¸æ˜¯å®Œå…¨è‡´å‘½çš„ï¼Œå¦‚æœè¿™ä¸ªbigkeyå­˜åœ¨ä½†æ˜¯å‡ ä¹ä¸è¢«è®¿é—®ï¼Œé‚£ä¹ˆåªæœ‰å†…å­˜ç©ºé—´ä¸å‡åŒ€çš„é—®é¢˜å­˜åœ¨ï¼Œç›¸å¯¹äºå¦å¤–ä¸¤ä¸ªé—®é¢˜æ²¡æœ‰é‚£ä¹ˆé‡è¦ç´§æ€¥ï¼Œä½†æ˜¯å¦‚æœbigkeyæ˜¯ä¸€ä¸ªçƒ­ç‚¹keyï¼ˆé¢‘ç¹è®¿é—®ï¼‰ï¼Œé‚£ä¹ˆå…¶å¸¦æ¥çš„å±å®³ä¸å¯æƒ³è±¡ï¼Œæ‰€ä»¥åœ¨å®é™…å¼€å‘å’Œè¿ç»´æ—¶ä¸€å®šè¦å¯†åˆ‡å…³æ³¨bigkeyçš„å­˜åœ¨ã€‚</p>
<h2 id="æŸ¥æ‰¾çƒ­ç‚¹-Key"><a href="#æŸ¥æ‰¾çƒ­ç‚¹-Key" class="headerlink" title="æŸ¥æ‰¾çƒ­ç‚¹ Key"></a>æŸ¥æ‰¾çƒ­ç‚¹ Key</h2><table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>å®¢æˆ·ç«¯</td>
<td>å®ç°ç®€å•</td>
<td>Â· å†…å­˜æ³„éœ²éšæ‚£<br>Â· ç»´æŠ¤æˆæœ¬é«˜<br>Â· åªèƒ½ç»Ÿè®¡å•ä¸ªå®¢æˆ·ç«¯</td>
</tr>
<tr>
<td>ä»£ç†</td>
<td>ä»£ç†æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ¡¥æ¢ï¼Œå®ç°æœ€æ–¹ä¾¿æœ€ç³»ç»Ÿ</td>
<td>å¢åŠ ä»£ç†ç«¯çš„æˆæœ¬éƒ¨ç½²å¼€å‘</td>
</tr>
<tr>
<td>æœåŠ¡ç«¯</td>
<td>å®ç°ç®€å•</td>
<td>Â· monitor æœ¬èº«çš„ä½¿ç”¨æˆæœ¬å’Œå±å®³ï¼Œåªèƒ½çŸ­æ—¶é—´ä½¿ç”¨<br>Â· åªèƒ½ç»Ÿè®¡å•ä¸ª Redis èŠ‚ç‚¹</td>
</tr>
<tr>
<td>æœºå™¨</td>
<td>å¯¹äºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ— ä¾µå…¥å’Œå½±å“</td>
<td>éœ€è¦ä¸“ä¸šçš„è¿ç»´å›¢é˜Ÿå¼€å‘ï¼Œå¹¶ä¸”å¢åŠ äº†æœºå™¨çš„éƒ¨ç½²æˆæœ¬</td>
</tr>
</tbody></table>
<hr>
<blockquote>
<p>è¯»åæ„Ÿï¼šRedis æ˜¯ä¸€æ¬¾å¼ºæœ‰åŠ›çš„ç”Ÿäº§åŠ›å·¥å…·ï¼Œåƒä¸€æŠŠç‘å£«å†›åˆ€ï¼Œåªæœ‰ä½ ç†Ÿæ‚‰è‡ªå·±ä½¿ç”¨çš„å·¥å…·ï¼Œæ‰èƒ½æ„å»ºå‡ºä¸€åº§åšå›ºæ¼‚äº®çš„å¤§å¦ã€‚ä½¿ç”¨ä»€ä¹ˆå·¥å…·å†³å®šäº†ä½ çš„ä¸‹é™ï¼Œä½†æ€ä¹ˆä½¿ç”¨å·¥å…·å†³å®šäº†ä½ çš„ä¸Šé™ï¼Œä½ å¯ä»¥ç”¨ Redis æ¥åšç¼“å­˜ï¼Œä¹Ÿå¯ä»¥ç”¨äºæµé‡å‰Šå³°ï¼Œå¹´ä¼šæŠ½å¥–ï¼Œç¤¾äº¤æ¨èã€‚æ‰€æœ‰å·¥å…·çš„èƒŒåéƒ½å–å†³äºäººï¼Œåˆ›æ–°äº§ç”Ÿä»·å€¼ã€‚</p>
</blockquote>
<p>Redis ä¸­å€¼å¾—æˆ‘ä»¬å…³æ³¨çš„åœ°æ–¹ï¼š</p>
<ul>
<li>åŸºç¡€æ•°æ®ç±»å‹</li>
<li>ä¸»ä»å¤åˆ¶</li>
<li>å“¨å…µ</li>
<li>é›†ç¾¤</li>
<li>å¦‚ä½•åšåˆ°é«˜æ€§èƒ½ã€ä½å¤æ‚åº¦</li>
<li>å¦‚ä½•ä¿éšœä¸»ä»ã€å“¨å…µã€é›†ç¾¤çš„æ•°æ®ä¸€è‡´æ€§</li>
</ul>

    </div>

    
    
    
      
        <div class="reward-container">
  <div>å› ä¸ºçƒ­çˆ±ï¼Œæ‰€ä»¥æ‰§ç€ã€‚</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechat.png" alt="Palemoky WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="Palemoky Alipay">
        <p>Alipay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"><i class="fa fa-tag"></i> redis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-prev post-nav-item">
                <a href="/post/Wall-of-Shame/" rel="prev" title="æŒ‚å—å¢™">
                  <i class="fa fa-chevron-left"></i> æŒ‚å—å¢™
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-next post-nav-item">
                <a href="/post/get-bank-info-by-unionpay/" rel="next" title="é“¶è”æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯">
                  é“¶è”æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-1-%E7%AB%A0-%E5%88%9D%E8%AF%86-Redis"><span class="nav-text">ç¬¬ 1 ç«  åˆè¯† Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">Redis æ•°æ®ç±»å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E6%8F%90%E4%BE%9B%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-text">Redis æä¾›çš„åŠŸèƒ½</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">Redis ä½¿ç”¨åœºæ™¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-Redis-%E5%BE%88%E5%BF%AB%EF%BC%9F"><span class="nav-text">ä¸ºä»€ä¹ˆ Redis å¾ˆå¿«ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="nav-text">Redis å¯æ‰§è¡Œæ–‡ä»¶è¯´æ˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-Redis-%E7%9A%843%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-text">å¯åŠ¨ Redis çš„3ç§æ–¹å¼</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-2-%E7%AB%A0-API-%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="nav-text">ç¬¬ 2 ç«  API çš„ç†è§£å’Œä½¿ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E9%94%AE%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">åˆ¤æ–­é”®ä¸å­˜åœ¨çš„æ–¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E8%A1%A8%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%93%8D%E4%BD%9C%E7%B1%BB%E5%9E%8B"><span class="nav-text">åˆ—è¡¨çš„å››ç§æ“ä½œç±»å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E8%A1%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">åˆ—è¡¨çš„ä½¿ç”¨åœºæ™¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">é›†åˆçš„ä½¿ç”¨åœºæ™¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E8%A1%A8%E3%80%81%E9%9B%86%E5%90%88%E3%80%81%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E7%9A%84%E5%BC%82%E5%90%8C%E7%82%B9"><span class="nav-text">åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆçš„å¼‚åŒç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81"><span class="nav-text">Redis æ•°æ®ç»“æ„ä¸å†…éƒ¨ç¼–ç </span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-3-%E7%AB%A0-%E5%B0%8F%E5%8A%9F%E8%83%BD%E5%A4%A7%E7%94%A8%E5%A4%84"><span class="nav-text">ç¬¬ 3 ç«  å°åŠŸèƒ½å¤§ç”¨å¤„</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2"><span class="nav-text">æ…¢æŸ¥è¯¢</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E9%85%8D%E7%BD%AE"><span class="nav-text">æ…¢æŸ¥è¯¢é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E5%91%BD%E4%BB%A4"><span class="nav-text">æ…¢æŸ¥è¯¢å‘½ä»¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E7%BB%93%E6%9E%84"><span class="nav-text">æ…¢æŸ¥è¯¢æ—¥å¿—ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Shell"><span class="nav-text">Redis Shell</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redis-cli"><span class="nav-text">redis-cli</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redis-server"><span class="nav-text">redis-server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redis-benchmark"><span class="nav-text">redis-benchmark</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pipeline"><span class="nav-text">Pipeline</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E4%B8%8E-Lua"><span class="nav-text">äº‹åŠ¡ä¸ Lua</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-Redis-%E4%B8%AD%E6%89%A7%E8%A1%8C-Lua-%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">åœ¨ Redis ä¸­æ‰§è¡Œ Lua çš„æ–¹æ³•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bitmaps"><span class="nav-text">Bitmaps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HyperLogLog"><span class="nav-text">HyperLogLog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="nav-text">å‘å¸ƒè®¢é˜…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GEO"><span class="nav-text">GEO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-4-%E7%AB%A0-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">ç¬¬ 4 ç«  å®¢æˆ·ç«¯</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8"><span class="nav-text">å®¢æˆ·ç«¯å¸¸è§å¼‚å¸¸</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-text">å®¢æˆ·ç«¯æ¡ˆä¾‹åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis%E5%86%85%E5%AD%98%E9%99%A1%E5%A2%9E"><span class="nav-text">Rediså†…å­˜é™¡å¢</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%B0%E8%B1%A1"><span class="nav-text">ç°è±¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E5%8E%9F%E5%9B%A0"><span class="nav-text">åˆ†æåŸå› </span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%A8%E6%9C%9F%E6%80%A7%E7%9A%84%E8%B6%85%E6%97%B6"><span class="nav-text">å®¢æˆ·ç«¯å‘¨æœŸæ€§çš„è¶…æ—¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%B0%E8%B1%A1-1"><span class="nav-text">ç°è±¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">åˆ†æ</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-5-%E7%AB%A0-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">ç¬¬ 5 ç«  æŒä¹…åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RDB"><span class="nav-text">RDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB-%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">RDB çš„ä¼˜ç¼ºç‚¹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOF"><span class="nav-text">AOF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E5%8A%A0%E8%BD%BD"><span class="nav-text">é‡å¯åŠ è½½</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-text">é—®é¢˜å®šä½ä¸ä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fork-%E6%93%8D%E4%BD%9C"><span class="nav-text">fork æ“ä½œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%BC%80%E9%94%80%E7%9B%91%E6%8E%A7%E5%92%8C%E4%BC%98%E5%8C%96"><span class="nav-text">å­è¿›ç¨‹å¼€é”€ç›‘æ§å’Œä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CPU"><span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A1%AC%E7%9B%98%E5%BC%80%E9%94%80"><span class="nav-text">ç¡¬ç›˜å¼€é”€</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF-%E8%BF%BD%E5%8A%A0%E9%98%BB%E5%A1%9E"><span class="nav-text">AOF è¿½åŠ é˜»å¡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E6%80%BB%E7%BB%93"><span class="nav-text">æœ¬ç« æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-6-%E7%AB%A0-%E5%A4%8D%E5%88%B6"><span class="nav-text">ç¬¬ 6 ç«  å¤åˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%A4%8D%E5%88%B6"><span class="nav-text">å»ºç«‹å¤åˆ¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%AD%E5%BC%80%E5%A4%8D%E5%88%B6"><span class="nav-text">æ–­å¼€å¤åˆ¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%93%E6%89%91"><span class="nav-text">æ‹“æ‰‘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E"><span class="nav-text">ä¸€ä¸»ä¸€ä»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E"><span class="nav-text">ä¸€ä¸»å¤šä»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%91%E7%8A%B6%E4%B8%BB%E4%BB%8E%E7%BB%93%E6%9E%84"><span class="nav-text">æ ‘çŠ¶ä¸»ä»ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-text">åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="nav-text">æ•°æ®åŒæ­¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="nav-text">å¤åˆ¶åç§»é‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E7%A7%AF%E5%8E%8B%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="nav-text">å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E8%BF%90%E8%A1%8CID"><span class="nav-text">ä¸»èŠ‚ç‚¹è¿è¡ŒID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#psync-%E5%91%BD%E4%BB%A4"><span class="nav-text">psync å‘½ä»¤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="nav-text">å…¨é‡åŒæ­¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="nav-text">å¢é‡åŒæ­¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%83%E8%B7%B3"><span class="nav-text">å¿ƒè·³</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E4%B8%8E%E8%BF%90%E7%BB%B4%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">å¼€å‘ä¸è¿ç»´ä¸­çš„é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BB%B6%E6%97%B6"><span class="nav-text">æ•°æ®å»¶æ—¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%88%B0%E8%BF%87%E6%9C%9F%E6%95%B0%E6%8D%AE"><span class="nav-text">è¯»åˆ°è¿‡æœŸæ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="nav-text">ä»èŠ‚ç‚¹æ•…éšœ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E9%81%BF%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="nav-text">è§„é¿å…¨é‡å¤åˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E9%81%BF%E5%A4%8D%E5%88%B6%E9%A3%8E%E6%9A%B4"><span class="nav-text">è§„é¿å¤åˆ¶é£æš´</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E4%B8%BB%E8%8A%82%E7%82%B9%E5%A4%8D%E5%88%B6%E9%A3%8E%E6%9A%B4"><span class="nav-text">å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E5%99%A8%E5%A4%8D%E5%88%B6%E9%A3%8E%E6%9A%B4"><span class="nav-text">å•æœºå™¨å¤åˆ¶é£æš´</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-7-%E7%AB%A0-%E9%98%BB%E5%A1%9E"><span class="nav-text">ç¬¬ 7 ç«  é˜»å¡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%9B%A0"><span class="nav-text">å†…å› </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%8F%91%E7%8E%B0%E6%85%A2%E6%9F%A5%E8%AF%A2"><span class="nav-text">å¦‚ä½•å‘ç°æ…¢æŸ¥è¯¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%8F%91%E7%8E%B0%E5%A4%A7%E5%AF%B9%E8%B1%A1"><span class="nav-text">å¦‚ä½•å‘ç°å¤§å¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU%E9%A5%B1%E5%92%8C"><span class="nav-text">CPUé¥±å’Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E9%98%BB%E5%A1%9E"><span class="nav-text">æŒä¹…åŒ–é˜»å¡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%96%E5%9B%A0"><span class="nav-text">å¤–å› </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU-%E7%AB%9E%E4%BA%89"><span class="nav-text">CPU ç«äº‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%BA%A4%E6%8D%A2"><span class="nav-text">å†…å­˜äº¤æ¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98"><span class="nav-text">ç½‘ç»œé—®é¢˜</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-8-%E7%AB%A0-%E7%90%86%E8%A7%A3%E5%86%85%E5%AD%98"><span class="nav-text">ç¬¬ 8 ç«  ç†è§£å†…å­˜</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97"><span class="nav-text">å†…å­˜æ¶ˆè€—</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97%E7%BB%9F%E8%AE%A1"><span class="nav-text">å†…å­˜æ¶ˆè€—ç»Ÿè®¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97%E5%88%92%E5%88%86"><span class="nav-text">å†…å­˜æ¶ˆè€—åˆ’åˆ†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97"><span class="nav-text">å­è¿›ç¨‹å†…å­˜æ¶ˆè€—</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">å†…å­˜ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%86%85%E5%AD%98%E4%B8%8A%E9%99%90"><span class="nav-text">è®¾ç½®å†…å­˜ä¸Šé™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E6%95%B4%E5%86%85%E5%AD%98%E4%B8%8A%E9%99%90"><span class="nav-text">åŠ¨æ€è°ƒæ•´å†…å­˜ä¸Šé™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E7%AD%96%E7%95%A5"><span class="nav-text">å†…å­˜å›æ”¶ç­–ç•¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="nav-text">å†…å­˜ä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redisObject%E5%AF%B9%E8%B1%A1"><span class="nav-text">redisObjectå¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%A9%E5%87%8F%E9%94%AE%E5%80%BC%E5%AF%B9%E8%B1%A1"><span class="nav-text">ç¼©å‡é”®å€¼å¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BC%98%E5%8C%96"><span class="nav-text">å­—ç¬¦ä¸²ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E4%BC%98%E5%8C%96"><span class="nav-text">ç¼–ç ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E9%94%AE%E7%9A%84%E6%95%B0%E9%87%8F"><span class="nav-text">æ§åˆ¶é”®çš„æ•°é‡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93"><span class="nav-text">ä¼˜åŒ–æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-9-%E7%AB%A0-%E5%93%A8%E5%85%B5"><span class="nav-text">ç¬¬ 9 ç«  å“¨å…µ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">åŸºç¡€æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-text">éƒ¨ç½²</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E8%8A%82%E7%82%B9%E7%9A%84-API"><span class="nav-text">å“¨å…µèŠ‚ç‚¹çš„ API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Sentinel-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">Redis Sentinel çš„å®ç°åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E4%B8%AA%E5%AE%9A%E6%97%B6%E7%9B%91%E6%8E%A7%E4%BB%BB%E5%8A%A1"><span class="nav-text">ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E8%A7%82%E4%B8%8B%E7%BA%BF%E4%B8%8E%E5%AE%A2%E8%A7%82%E4%B8%8B%E7%BA%BF"><span class="nav-text">ä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%86%E5%AF%BC%E8%80%85-Sentinel-%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE"><span class="nav-text">é¢†å¯¼è€… Sentinel èŠ‚ç‚¹é€‰ä¸¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="nav-text">æ•…éšœè½¬ç§»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E4%B8%8E%E8%BF%90%E7%BB%B4%E9%97%AE%E9%A2%98"><span class="nav-text">å¼€å‘ä¸è¿ç»´é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-10-%E7%AB%A0-%E9%9B%86%E7%BE%A4"><span class="nav-text">ç¬¬ 10 ç«  é›†ç¾¤</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83"><span class="nav-text">æ•°æ®åˆ†å¸ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%93%88%E5%B8%8C%E5%88%86%E5%8C%BA%E8%A7%84%E5%88%99"><span class="nav-text">å¸¸è§çš„å“ˆå¸Œåˆ†åŒºè§„åˆ™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%8A%9F%E8%83%BD%E9%99%90%E5%88%B6"><span class="nav-text">é›†ç¾¤åŠŸèƒ½é™åˆ¶</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-text">é›†ç¾¤æ­å»º</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%80%9A%E4%BF%A1"><span class="nav-text">èŠ‚ç‚¹é€šä¿¡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E4%BC%B8%E7%BC%A9"><span class="nav-text">é›†ç¾¤ä¼¸ç¼©</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4"><span class="nav-text">æ‰©å®¹é›†ç¾¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B6%E7%BC%A9%E9%9B%86%E7%BE%A4"><span class="nav-text">æ”¶ç¼©é›†ç¾¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E8%B7%AF%E7%94%B1"><span class="nav-text">è¯·æ±‚è·¯ç”±</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-text">è¯·æ±‚é‡å®šå‘</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hash-tag"><span class="nav-text">hash_tag</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ASK-%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-text">ASK é‡å®šå‘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB-1"><span class="nav-text">æ•…éšœè½¬ç§»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4"><span class="nav-text">é›†ç¾¤è¿ç»´</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-11-%E7%AB%A0-%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1"><span class="nav-text">ç¬¬ 11 ç«  ç¼“å­˜è®¾è®¡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="nav-text">ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LRU-LFU-FIFO-%E7%AE%97%E6%B3%95%E5%89%94%E9%99%A4"><span class="nav-text">LRU/LFU/FIFO ç®—æ³•å‰”é™¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E5%89%94%E9%99%A4"><span class="nav-text">è¶…æ—¶å‰”é™¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="nav-text">ä¸»åŠ¨æ›´æ–°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">æœ€ä½³å®è·µ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="nav-text">ç¼“å­˜ç©¿é€</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%BC%93%E5%AD%98%E7%A9%BA%E5%AF%B9%E8%B1%A1"><span class="nav-text">1. ç¼“å­˜ç©ºå¯¹è±¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E6%8B%A6%E6%88%AA"><span class="nav-text">2. å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A0%E5%BA%95%E6%B4%9E%E4%BC%98%E5%8C%96"><span class="nav-text">æ— åº•æ´ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%AA%E5%B4%A9%E4%BC%98%E5%8C%96"><span class="nav-text">é›ªå´©ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%83%AD%E7%82%B9key%E9%87%8D%E5%BB%BA%E4%BC%98%E5%8C%96"><span class="nav-text">çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">è§£å†³æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%92%E6%96%A5%E9%94%81-mutex-key"><span class="nav-text">äº’æ–¥é”(mutex key)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B0%B8%E4%B8%8D%E8%BF%87%E6%9C%9F"><span class="nav-text">æ°¸ä¸è¿‡æœŸ</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-12-%E7%AB%A0-Devops-%E7%9A%84%E9%99%B7%E9%98%B1"><span class="nav-text">ç¬¬ 12 ç«  Devops çš„é™·é˜±</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E6%94%BB%E5%87%BB"><span class="nav-text">Redis æ”»å‡»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E9%87%8D%E5%86%99"><span class="nav-text">å‘½ä»¤é‡å†™</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">é˜²ç«å¢™</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bigkey"><span class="nav-text">bigkey</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E7%83%AD%E7%82%B9-Key"><span class="nav-text">æŸ¥æ‰¾çƒ­ç‚¹ Key</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Palemoky" src="https://tva1.sinaimg.cn/large/006tNbRwly1g9hf0u8313j305o05p3ye.jpg">
  <p class="site-author-name" itemprop="name">Palemoky</p>
  <div class="site-description" itemprop="description">Learn by doing !</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">101</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  Â© 2016 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xinyu Â© Copyright  |  <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en"> BY-NC-SA</a></span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v5.4.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.2
  </div>

        
<div class="busuanzi-count">
  <script pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  
  











  




  
  




  














    <div id="pjax">

  

  
      



    

  




    </div>


<script src="/bundle.js"></script><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.getAttribute('pjax') !== null) {
      element.setAttribute('pjax', '');
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
;

    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  ;

    MathJax.Ajax.config.path['mhchem'] = '//cdnjs.cloudflare.com/ajax/libs/mathjax-mhchem/3.3.0';

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        extensions: ['[mhchem]/mhchem.js'],
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
;

  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
;

NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: true,
    notify: false,
    appId: 'CEo3hR7qTLSO1hx0GRgh4VkR-gzGzoHsz',
    appKey: 'mOoWJCRObxe1hAfLmzmXWKSS',
    placeholder: "æ‹™ç¬”è‹¥åšå›ä¸€æ€ï¼Œå¹¸ç”šä¹‹è‡³",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script></body></html>