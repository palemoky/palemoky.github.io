<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon.png">
  <link rel="mask-icon" href="/images/icon.png" color="#222">
  <meta name="google-site-verification" content="HffpR8NKoAvdPtHw1WLz8yun_UKXOBTbuFVpUH6i77Q">







<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"flat"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: true,
    lazyload: false,
    pangu: true,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="article">
<meta property="og:title" content="使用 Certbot 获取 TLS 证书">
<meta property="og:url" content="https://blog.palemoky.com/post/play-certbot-with-tls/index.html">
<meta property="og:site_name" content="Xinyu's Space">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tva1.sinaimg.cn/middle/007S8ZIlly1gf82zknh92j30g70a0dgl.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82016ptej31980quagg.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8596nzraj30ib0jpq5q.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82h5x763j30ia08cwff.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82ikv3waj30im0oj41m.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82rfu35bj30ob0b0js6.jpg">
<meta property="article:published_time" content="2020-05-28T02:40:09.000Z">
<meta property="article:modified_time" content="2021-01-17T12:55:45.400Z">
<meta property="article:author" content="Palemoky">
<meta property="article:tag" content="tls">
<meta property="article:tag" content="ssl">
<meta property="article:tag" content="certbot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/middle/007S8ZIlly1gf82zknh92j30g70a0dgl.jpg">

<link rel="canonical" href="https://blog.palemoky.com/post/play-certbot-with-tls/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>
<meta name="google-site-verification" content="HffpR8NKoAvdPtHw1WLz8yun_UKXOBTbuFVpUH6i77Q">
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js"></script>
  <title>使用 Certbot 获取 TLS 证书 | Xinyu's Space</title>
  
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-88938102-1"></script>
    <script pjax="">
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-88938102-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <script type="text/javascript">
    var host = "blog.palemoky.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
</script>
<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');loadCss('//fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext');loadCss('//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css');loadCss('https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css');</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"></noscript></head>

<body itemscope="" itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xinyu's Space</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">七窍通了六窍</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-ascii">

    <a href="/ASCII/" rel="section"><i class="fa fa-fw fa-globe"></i>ASCII</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Searching..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/palemoky" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.palemoky.com/post/play-certbot-with-tls/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://tva1.sinaimg.cn/large/006tNbRwly1g9hf0u8313j305o05p3ye.jpg">
      <meta itemprop="name" content="Palemoky">
      <meta itemprop="description" content="Learn by doing !">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xinyu's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          使用 Certbot 获取 TLS 证书
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-28 10:40:09" itemprop="dateCreated datePublished" datetime="2020-05-28T10:40:09+08:00">2020-05-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-17 20:55:45" itemprop="dateModified" datetime="2021-01-17T20:55:45+08:00">2021-01-17</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/post/play-certbot-with-tls/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/play-certbot-with-tls/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://tva1.sinaimg.cn/middle/007S8ZIlly1gf82zknh92j30g70a0dgl.jpg"></p>
<span id="more"></span>

<h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1 简介"></a>1 简介</h1><p><a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a>是一个旨在提升互联网安全、免费、自动化的证书颁发机构（CA)，由互联网安全研究小组（ISRG）运营。它可以提供 90 天有效期的 TLS 证书，我们可以通过 Certbot 自动部署工具来实现自动化续期而达到免费长期使用，So, Let’s Encrypt!</p>
<p><a target="_blank" rel="noopener" href="https://certbot.eff.org/">Certbot</a>是由 EFF (电子前哨基金会) 运营的实现 ACME (自动证书管理环境)协议的 TLS 自动部署工具，在<a target="_blank" rel="noopener" href="https://certbot.eff.org/">这里</a>可以查看在不同系统和环境下的安装命令。在使用Certbot前，建议仔细阅读<a target="_blank" rel="noopener" href="https://certbot.eff.org/docs">Certbot文档</a> 和 <a target="_blank" rel="noopener" href="https://letsencrypt.org/zh-cn/docs/">Let’s Encrypt 文档</a>，其中对很多概念都有详细的讲解，也会解决很多你遇到的问题。以下简单记录常用的使用摘要。</p>
<h1 id="2-使用摘要"><a href="#2-使用摘要" class="headerlink" title="2 使用摘要"></a>2 使用摘要</h1><h2 id="2-1-申请证书"><a href="#2-1-申请证书" class="headerlink" title="2.1 申请证书"></a>2.1 申请证书</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/using.html#getting-certificates-and-choosing-plugins">https://certbot.eff.org/docs/using.html#getting-certificates-and-choosing-plugins</a></p>
</blockquote>
<p>申请证书时，Let’s Encrypt 需要验证你对网站的所有权，主要有通过访问指定文件和访问指定 dns 记录等方式，具体有以下 5 种：</p>
<ol>
<li>webroot：在网站指定目录下存放指定文件，以使 certbot 验证网站的所有权</li>
<li>standalone: 仅申请证书</li>
<li>nginx/apache: 申请证书并配置相应服务软件</li>
<li>plugin：根据不同的 DNS 服务提供商集成的一键申请模型</li>
<li>manual：可手动指定认证方式为 http 或 dns，http 即通过验证网站指定文件，dns 即通过验证 dns 的 txt 记录</li>
</ol>
<p>需要注意的是，Let’s Encrypt每周对重复证书申请<a target="_blank" rel="noopener" href="https://letsencrypt.org/zh-cn/docs/rate-limits/">限制为 5 张</a>，在学习证书申请时，可添加<code>--test-cert</code>参数申请测试证书，限制为每周 3万张。</p>
<h2 id="2-2-管理证书"><a href="#2-2-管理证书" class="headerlink" title="2.2 管理证书"></a>2.2 管理证书</h2><p>使用以下命令列出本机的所有通过 certbot 申请的证书：</p>
<figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>certbot certificates</span><br></pre></td></tr></tbody></table></figure>
<p><code>--cert-name</code>可用于 <code>run</code>, <code>certonly</code>, <code>certificates</code>, <code>renew</code>, <code>delete</code> 等子命令，指定操作某一域名，如<code>certbot certificates --cert-name example.com</code></p>
<h3 id="2-2-1-续签证书"><a href="#2-2-1-续签证书" class="headerlink" title="2.2.1 续签证书"></a>2.2.1 续签证书</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/using.html#re-creating-and-updating-existing-certificates">https://certbot.eff.org/docs/using.html#re-creating-and-updating-existing-certificates</a></p>
</blockquote>
<ol>
<li><code>certbot renew</code>可自动更新 30 天内到期的证书，否则跳过本次任务（可用<code>--dry-run</code>测试证书是否可正常更新）</li>
<li>续期前后可以使用钩子来完成一些动作，如<code>certbot renew --pre-hook "service nginx stop" --post-hook "service nginx start"</code></li>
<li>可以使用<code>--deploy-hook</code>来完成续期成功后的动作，如<code>certbot renew --deploy-hook /path/to/deploy-hook-script</code></li>
<li>钩子脚本位于 <code>/etc/letsencrypt/renewal-hooks/{pre,post,deploy}</code> 目录下，将脚本放置在对应位置，即可自动执行</li>
<li><code>-q</code>可关闭续期期间的日志输出</li>
<li><code>-n</code> 或 <code>--noninteractive</code>可用于防止阻塞用户输入，在cron 命令运行时很有用</li>
<li>证书签发后，certbot 会自动在 <code>/etc/letsencrypt/renewal/CERTNAME</code> 目录下创建一个更新配置文件，之后的更新便会依据该文件进行更新(修改<code>/etc/letsencrypt</code>中的任何文件都可能导致 certbot 无法正常工作！！！)</li>
</ol>
<h3 id="2-2-2-证书存放位置"><a href="#2-2-2-证书存放位置" class="headerlink" title="2.2.2 证书存放位置"></a>2.2.2 证书存放位置</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/using.html#where-are-my-certificates">https://certbot.eff.org/docs/using.html#where-are-my-certificates</a></p>
</blockquote>
<ol>
<li><code>/etc/letsencrypt/archive</code> 和 <code>/etc/letsencrypt/keys</code> 包含了所有以前的密钥和证书，而<code>/etc/letsencrypt/live</code>则是指向最新版的软链接</li>
<li>如果需要复制申请后的证书，可使用命令<code>\cp -rfL /path/to/{fullchain.pem,privkey.pem} dir</code> 复制</li>
</ol>
<h2 id="2-3-日志"><a href="#2-3-日志" class="headerlink" title="2.3 日志"></a>2.3 日志</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/using.html#id30">https://certbot.eff.org/docs/using.html#id30</a></p>
</blockquote>
<ol>
<li>存储于<code>/var/log/letsencrypt</code>，默认 1k 个日志文件，超过 1k 个后删除最旧的</li>
</ol>
<h1 id="3-Docker-安装"><a href="#3-Docker-安装" class="headerlink" title="3 Docker 安装"></a>3 Docker 安装</h1><p>Docker 方式支持多个 DNS 服务商，我们此处以 Cloudflare 为例，来实现 TLS 证书的申请、续期、撤销等操作，相关文档如下：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/install.html#running-with-docker">running-with-docker - Certbot</a> </li>
<li><a target="_blank" rel="noopener" href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/">certbot-dns-cloudflare</a></li>
<li><a target="_blank" rel="noopener" href="https://soulteary.com/2018/08/30/use-docker-certbot-to-obtain-ssl-certificates.html">使用 Docker CertBot 获取 SSL 证书</a></li>
</ol>
<h2 id="3-1-安装-certbot"><a href="#3-1-安装-certbot" class="headerlink" title="3.1 安装 certbot"></a>3.1 安装 certbot</h2><p>在<a target="_blank" rel="noopener" href="https://certbot.eff.org/">这里</a>根据自己的主机配置安装 certbot。</p>
<h2 id="3-2-安装-Docker"><a href="#3-2-安装-Docker" class="headerlink" title="3.2 安装 Docker"></a>3.2 安装 Docker</h2><p>按照<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/">文档</a>安装即可，不过墙内主机会由于网络原因下载特别慢。</p>
<h2 id="3-3-申请证书"><a href="#3-3-申请证书" class="headerlink" title="3.3 申请证书"></a>3.3 申请证书</h2><p>由于 Let’s Encrypt 只提供域名验证型（DV）证书，因此我们需要通过完成 certbot 对域名的指定动作才能证明我们对域名的拥有权。在 docker 方式中，我们通过 cloudflare.ini 文件来填写 cloudflare 的信息，先创建 cloudflare.ini 文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /home/xinyu/certbot</span><br><span class="line">$ touch cloudflare.ini</span><br></pre></td></tr></tbody></table></figure>

<p>在<a target="_blank" rel="noopener" href="https://dash.cloudflare.com/profile/api-tokens">这里</a>设置好 key 后，将以下信息写入 <code>cloudflare.ini</code> 文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cloudflare API credentials used by Certbot</span></span><br><span class="line">dns_cloudflare_email = cloudflare@example.com</span><br><span class="line">dns_cloudflare_api_key = 0123456789abcdef0123456789abcdef01234</span><br></pre></td></tr></tbody></table></figure>

<p>在这一步有个坑，就是我们使用 Cloudflare 的 Global API Key 可以正常申请证书，而使用 API Tokens 则会有以下错误提示：</p>
<figure class="highlight excel"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error determining zone_<span class="symbol">id:</span> <span class="number">6003</span> Invalid request headers. Please confirm that you have supplied valid Cloudflare API credentials. (Did you copy your entire API token/key? To use Cloudflare tokens, you'll need the python package cloudflare&gt;</span><br><span class="line">=<span class="number">2.3</span>.<span class="number">1</span>. This certbot is running cloudflare <span class="number">2.3</span>.<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>仔细阅读<a target="_blank" rel="noopener" href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/#credentials">相关文档</a>，发现其中有这样一段话</p>
<blockquote>
<p>Cloudflare’s newer API Tokens can be restricted to specific domains and operations, and are therefore now the recommended authentication option.</p>
<p>However, due to some shortcomings in Cloudflare’s implementation of Tokens, Tokens created for Certbot currently require Zone:Zone:Read and Zone:DNS:Edit permissions for all zones in your account. While this is not ideal, your Token will still have fewer permission than the Global key, so it’s still worth doing. Hopefully Cloudflare will improve this in the future.</p>
</blockquote>
<p>难道是因为我的 API Tokens 配置有问题？各种尝试下仍然是相同的错误提示，最后在 certbot 的源码中终于看到了这样一段代码：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82016ptej31980quagg.jpg"></p>
<p>大意是还有一种认证方式是<code>dns_cloudflare_api_token</code>，于是将<code>cloudflare.ini</code>内容修改为以下内容，结果果然可以了</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cloudflare API credentials used by Certbot</span></span><br><span class="line">dns_cloudflare_api_token = 0123456789abcdef0123456789abcdef01234</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --rm --name certbot \</span><br><span class="line">    -v <span class="string">"/etc/letsencrypt:/etc/letsencrypt"</span> \</span><br><span class="line">    -v <span class="string">"/var/lib/letsencrypt:/var/lib/letsencrypt"</span> \</span><br><span class="line">    -v <span class="string">"/home/xinyu/certbot:/.secrets"</span> \</span><br><span class="line">    certbot/dns-cloudflare certonly \</span><br><span class="line">    --dns-cloudflare-credentials /.secrets/cloudflare.ini \</span><br><span class="line">    --dns-cloudflare-propagation-seconds 30 \</span><br><span class="line">    --test-cert \</span><br><span class="line">    --server https://acme-v02.api.letsencrypt.org/directory \</span><br><span class="line">    -d example.com,*.example.com</span><br></pre></td></tr></tbody></table></figure>
<p>参数说明：</p>
<ul>
<li><code>--dns-cloudflare-propagation-seconds</code>可以根据自己的 DNS 解析时间调整；</li>
<li>Let’s Encrypt 每周对重复证书申请限制为 5 张，<code>--test-cert</code> 参数调用测试证书，限制为每周 3 万张；</li>
<li>如果不申请泛解析域名，可以去掉<code>--server https://acme-v02.api.letsencrypt.org/directory</code>。</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8596nzraj30ib0jpq5q.jpg"></p>
<h2 id="3-4-查看证书"><a href="#3-4-查看证书" class="headerlink" title="3.4 查看证书"></a>3.4 查看证书</h2><p>通过命令<code>certbot certificates</code>可以查看我们主机上所有通过 certbot 申请的证书<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82h5x763j30ia08cwff.jpg"></p>
<h2 id="3-5-续期证书"><a href="#3-5-续期证书" class="headerlink" title="3.5 续期证书"></a>3.5 续期证书</h2><h3 id="3-5-1-手动续期"><a href="#3-5-1-手动续期" class="headerlink" title="3.5.1 手动续期"></a>3.5.1 手动续期</h3><p>要续期证书，可以将申请证书的命令再执行一次，在交互中选择续期选项，但为了自动化续期，我们可以通过以下命令实现一键续期：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --rm --name certbot \</span><br><span class="line">    -v <span class="string">"/etc/letsencrypt:/etc/letsencrypt"</span> \</span><br><span class="line">    -v <span class="string">"/var/lib/letsencrypt:/var/lib/letsencrypt"</span> \</span><br><span class="line">    -v <span class="string">"/home/xinyu/certbot:/.secrets"</span> \</span><br><span class="line">    certbot/dns-cloudflare renew \</span><br><span class="line">    --dns-cloudflare-credentials /.secrets/cloudflare.ini \</span><br><span class="line">    --dns-cloudflare-propagation-seconds 30 \</span><br><span class="line">    --server https://acme-v02.api.letsencrypt.org/directory \</span><br><span class="line">    --dry-run \</span><br><span class="line">    --cert-name example.com</span><br></pre></td></tr></tbody></table></figure>
<p>参数说明：</p>
<ul>
<li><code>--dry-run</code> 是续期测试命令，certbot 只会对30天内过期的证书进行续期，该命令可以测试有效期大于30天的证书是否可以正常续期。</li>
<li><code>--cert-name</code>用于对指定证书续期，填写<code>certbot certificates</code>中的<code>Certificate Name</code>即可，无此参数默认对所有证书进行续期</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82ikv3waj30im0oj41m.jpg"></p>
<p>如果在创建或者续期证书期间遇到以下错误，请适当调整<code>--dns-cloudflare-propagation-seconds</code>参数，该错误的更多信息可以查看<a target="_blank" rel="noopener" href="https://community.letsencrypt.org/t/during-secondary-validation-incorrect-txt-record/113643">During secondary validation: Incorrect TXT record</a></p>
<figure class="highlight maxima"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">IMPORTANT NOTES:</span><br><span class="line"> - The following <span class="built_in">errors</span> were reported by the server:</span><br><span class="line"></span><br><span class="line">   Domain: <span class="built_in">example</span>.com</span><br><span class="line">   Type:   unauthorized</span><br><span class="line">   Detail: During secondary validation: Incorrect TXT record</span><br><span class="line">   <span class="string">"lLY******4x5WA"</span> (<span class="keyword">and</span> <span class="number">1</span> more) found <span class="built_in">at</span></span><br><span class="line">   _acme-challenge.<span class="built_in">example</span>.com</span><br><span class="line"></span><br><span class="line">   Domain: <span class="built_in">example</span>.com</span><br><span class="line">   Type:   unauthorized</span><br><span class="line">   Detail: Incorrect TXT record</span><br><span class="line">   <span class="string">"lLY******4x5WA"</span> (<span class="keyword">and</span> <span class="number">1</span> more) found <span class="built_in">at</span></span><br><span class="line">   _acme-challenge.<span class="built_in">example</span>.com</span><br><span class="line"></span><br><span class="line">   To <span class="built_in">fix</span> these <span class="built_in">errors</span>, please make sure that your <span class="built_in">domain</span> name was</span><br><span class="line">   entered correctly <span class="keyword">and</span> the DNS A/AAAA record(s) <span class="keyword">for</span> that <span class="built_in">domain</span></span><br><span class="line">   contain(s) the right IP address.</span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-5-2-自动续期"><a href="#3-5-2-自动续期" class="headerlink" title="3.5.2 自动续期"></a>3.5.2 自动续期</h3><p>手动操作太原始了，我们通过定时脚本的方式来自动完成该重复操作。</p>
<p>首先，我们创建一个用于续期的容器，我们每次需要续期的时候，只需要执行<code>docker start certbot-renewal</code>启动容器即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name certbot-renewal \</span><br><span class="line">    -v <span class="string">"/etc/letsencrypt:/etc/letsencrypt"</span> \</span><br><span class="line">    -v <span class="string">"/var/lib/letsencrypt:/var/lib/letsencrypt"</span> \</span><br><span class="line">    -v <span class="string">"/home/xinyu/certbot:/.secrets"</span> \</span><br><span class="line">    certbot/dns-cloudflare renew \</span><br><span class="line">    --dns-cloudflare-credentials /.secrets/cloudflare.ini \</span><br><span class="line">    --dns-cloudflare-propagation-seconds 20 \</span><br><span class="line">    --server https://acme-v02.api.letsencrypt.org/directory \</span><br><span class="line">    --cert-name example.com</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>如果要在容器中执行脚本，一定要查看容器 Linux 版本，Alpine 版本由于精简而经常用做制作容器，该版本中需要注意的是：</p>
<ol>
<li>shell 是 sh ，而不是 bash</li>
<li>有 wget，而没有 curl</li>
<li>不自持类似 <code>cp /path/to/{file1,file2} dir</code>的多文件复制命令</li>
</ol>
</blockquote>
<p>接下来，我们需要一个 shell 脚本来处理续期的操作和通知</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定时续签证书</span></span><br><span class="line"><span class="comment"># Author: Xinyu Shi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动证书续期容器</span></span><br><span class="line">docker start certbot-renewal 2&amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取容器退出码</span></span><br><span class="line">exitCode=$(docker inspect 117ea491188d --format=<span class="string">'{{.State.ExitCode}}'</span>)</span><br><span class="line"><span class="keyword">if</span> [ 0 -eq <span class="variable">$exitCode</span> ]; <span class="keyword">then</span></span><br><span class="line">    expireAt=$(cat /path/to/fullchain.pem | openssl x509 -noout -enddate)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># copy cert to trojan and nginx</span></span><br><span class="line">    \cp -rfL /path/to/{fullchain.pem,privkey.pem} /path/to/trojan &amp;&amp; \cp -rfL /path/to/{fullchain.pem,privkey.pem} /path/to/nginx/ssl</span><br><span class="line"></span><br><span class="line">    <span class="comment"># restart trojan and nginx</span></span><br><span class="line">    docker restart a767b9f9d9fa 833967a8990c 2&amp;&gt;/dev/null</span><br><span class="line">    trojanExitCode=$(docker inspect a767b9f9d9fa --format=<span class="string">'{{.State.ExitCode}}'</span>)</span><br><span class="line">    nginxExitCode=$(docker inspect 833967a8990c --format=<span class="string">'{{.State.ExitCode}}'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断 trojan 与 Nginx 是否重启成功</span></span><br><span class="line">    <span class="keyword">if</span> [ $((<span class="variable">$trojanExitCode</span> &amp; <span class="variable">$nginxExitCode</span>)) -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        errLog=<span class="string">"Error! Trojan or nginx restart failed!"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        errLog=<span class="string">"Congratulations! The certificate for example.com has been successfully renewed and expires on "</span><span class="variable">${expireAt#*=}</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    errLog=$(docker logs --since 1m 117ea491188d)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送通知</span></span><br><span class="line"><span class="function"><span class="title">sendNotification</span></span> () {</span><br><span class="line">    <span class="comment"># 发送微信通知</span></span><br><span class="line">    wget -q <span class="string">"https://sc.ftqq.com/"</span><span class="variable">$errLog</span></span><br><span class="line">    <span class="comment"># 发送 IFTTT 通知</span></span><br><span class="line">    <span class="comment"># 发送邮件通知</span></span><br><span class="line">    mail -s <span class="string">"证书续签结果"</span> user@example.com &lt;&lt;&lt; <span class="variable">$errLog</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">sendNotification</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>根据 Certbot 的<a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/using.html#re-creating-and-updating-existing-certificates">续签文档</a>，其中提供了基于续签前的<code>--pre-hook</code>，续签后的<code>--post-hook</code>，续签成功的<code>--deploy-hook</code>，可以充分利用钩子实现一些自动化的东西。</p>
</blockquote>
<p>有了执行脚本之后，我们就需要设置下定时器了，我们采用 systemd 的定时功能，而不是传统的 crond。关于 systemd 的定时功能，可以查看<a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2018/03/systemd-timer.html">Systemd 定时器教程</a> 和 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/operationhome/p/10720067.html">Linux 定时任务 crontab 和 Systemd Timer</a>。</p>
<p>我们简单学习一下，就明白了 systemd 的定时也是比较简单的，我们只需要在<code>/usr/lib/systemd/system</code>目录下创建<code>.service</code>和<code>.timer</code>文件即可，service 中包含了我们所需要执行的脚本， timer 中包含了我们的计划任务。</p>
<p><code>cert-renewal.service</code>文件内容为</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Cert Renewal</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/bin/bash /path/to/renewal.sh</span><br></pre></td></tr></tbody></table></figure>

<p><code>cert-renewal.timer</code>文件内容为</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Runs cert renewal every 85 days</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">OnUnitActiveSec=85d</span><br><span class="line">Persistent=<span class="literal">true</span></span><br><span class="line">Unit=cert-renewal.service</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure>

<p>现在万事俱备，只欠东风了。配置好定时器之后，我们依次执行以下命令：</p>
<p><code>systemctl daemon-reload</code> 重载配置文件，查看服务状态<code>systemctl status cert-renewal.timer</code> </p>
<figure class="highlight dts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">● cert-renewal.timer - cert-renewal</span><br><span class="line"><span class="symbol">   Loaded:</span> loaded (<span class="meta-keyword">/usr/</span>lib<span class="meta-keyword">/systemd/</span>system/cert-renewal.timer; disabled; vendor preset: disabled)</span><br><span class="line"><span class="symbol">   Active:</span> inactive (dead)</span><br><span class="line"><span class="symbol">  Trigger:</span> n/a</span><br></pre></td></tr></tbody></table></figure>

<p>此时，定时任务尚未激活，并且没有设置为开机自启，我们先执行<code>systemctl enable cert-renewal.timer</code>设置为开机自启</p>
<figure class="highlight dts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">● cert-renewal.timer - cert-renewal</span><br><span class="line"><span class="symbol">   Loaded:</span> loaded (<span class="meta-keyword">/usr/</span>lib<span class="meta-keyword">/systemd/</span>system/cert-renewal.timer; enabled; vendor preset: disabled)</span><br><span class="line"><span class="symbol">   Active:</span> inactive (dead)</span><br><span class="line"><span class="symbol">  Trigger:</span> n/a</span><br></pre></td></tr></tbody></table></figure>

<p>再激活任务<code>systemctl start cert-renewal.timer</code></p>
<figure class="highlight dts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">● cert-renewal.timer - cert-renewal</span><br><span class="line"><span class="symbol">   Loaded:</span> loaded (<span class="meta-keyword">/usr/</span>lib<span class="meta-keyword">/systemd/</span>system/cert-renewal.timer; enabled; vendor preset: disabled)</span><br><span class="line"><span class="symbol">   Active:</span> active (elapsed) since Mon <span class="number">2020</span><span class="number">-06</span><span class="number">-01</span> <span class="number">07</span>:<span class="number">29</span>:<span class="number">37</span> UTC; <span class="number">43</span>s ago</span><br><span class="line"><span class="symbol">  Trigger:</span> n/a</span><br></pre></td></tr></tbody></table></figure>

<p>虽然现在任务已经激活，但我们看到<code>Trigger: n/a</code>，这表明任务并不能按照预期来定时执行，这是因为我们的任务执行时间是相对时间，因此需要手动执行一次任务<code>systemctl start cert-renewal.service</code>，如果手动执行任务后仍没有出现下述状态，可以尝试<code>systemctl restart cert-renewal.timer</code></p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">●</span> <span class="string">cert-renewal.timer</span> <span class="bullet">-</span> <span class="string">cert-renewal</span></span><br><span class="line">   <span class="attr">Loaded:</span> <span class="string">loaded</span> <span class="string">(/usr/lib/systemd/system/cert-renewal.timer;</span> <span class="string">enabled;</span> <span class="attr">vendor preset:</span> <span class="string">disabled)</span></span><br><span class="line">   <span class="attr">Active:</span> <span class="string">active</span> <span class="string">(waiting)</span> <span class="string">since</span> <span class="string">Mon</span> <span class="number">2020-06-02 07:31:57 </span><span class="string">UTC;</span> <span class="string">59s</span> <span class="string">ago</span></span><br><span class="line">  <span class="attr">Trigger:</span> <span class="string">Mon</span> <span class="number">2020-08-25 17:32:46 </span><span class="string">UTC;</span> <span class="string">85d</span> <span class="string">left</span></span><br></pre></td></tr></tbody></table></figure>

<p>至此，我们我定时任务就设置完成了，用<code>systemctl list-timers --all</code>来查看下所有的 systemd 的定时任务，之后每次修改定时任务后，只需重载配置文件即可。</p>
<blockquote>
<p>如果设置定时任务后没有最近的执行时间以及下次执行时间，可以参照该<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Oup21KLlpD8">视频</a>处理</p>
</blockquote>
<p>如果需要移除定时任务，依次执行：</p>
<ol>
<li><code>systemctl disable test.timer</code></li>
<li><code>systemctl stop test.timer</code></li>
<li><code>sudo rm /usr/lib/systemd/system/example.*</code></li>
<li><code>systemctl daemon-reload</code></li>
<li><code>systemctl list-timers --all</code></li>
</ol>
<h2 id="3-6-吊销证书"><a href="#3-6-吊销证书" class="headerlink" title="3.6 吊销证书"></a>3.6 吊销证书</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo certbot revoke --test-cert --cert-path /etc/letsencrypt/live/example.com/cert.pem</span><br></pre></td></tr></tbody></table></figure>
<p>参数说明：</p>
<ul>
<li>由于我们申请的是测试证书，因此在吊销证书时同样需要用<code>--test-cert</code>指明吊销测试证书</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf82rfu35bj30ob0b0js6.jpg"></p>
<h2 id="3-7-更新证书域名"><a href="#3-7-更新证书域名" class="headerlink" title="3.7 更新证书域名"></a>3.7 更新证书域名</h2><p>如果想将<code>example.com</code>和<code>*.example.com</code>更新为<code>test.example.com</code>和<code>www.example.com</code>，执行以下命令即可：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ certbot certonly --cert-name example.com \</span><br><span class="line">  -d test.example.com \</span><br><span class="line">  -d www.example.com</span><br></pre></td></tr></tbody></table></figure>
    </div>

    
    
    
      
        <div class="reward-container">
  <div>因为热爱，所以执着。</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechat.png" alt="Palemoky WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="Palemoky Alipay">
        <p>Alipay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/tls/" rel="tag"><i class="fa fa-tag"></i> tls</a>
              <a href="/tags/ssl/" rel="tag"><i class="fa fa-tag"></i> ssl</a>
              <a href="/tags/certbot/" rel="tag"><i class="fa fa-tag"></i> certbot</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-prev post-nav-item">
                <a href="/post/auto-update-code-by-webhook/" rel="prev" title="使用 webhook 自动更新代码">
                  <i class="fa fa-chevron-left"></i> 使用 webhook 自动更新代码
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-next post-nav-item">
                <a href="/post/laradock-with-xDebug/" rel="next" title="xDebug 使用指南">
                  xDebug 使用指南 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="nav-text">1 简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E6%91%98%E8%A6%81"><span class="nav-text">2 使用摘要</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6"><span class="nav-text">2.1 申请证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E7%AE%A1%E7%90%86%E8%AF%81%E4%B9%A6"><span class="nav-text">2.2 管理证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E7%BB%AD%E7%AD%BE%E8%AF%81%E4%B9%A6"><span class="nav-text">2.2.1 续签证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E8%AF%81%E4%B9%A6%E5%AD%98%E6%94%BE%E4%BD%8D%E7%BD%AE"><span class="nav-text">2.2.2 证书存放位置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%97%A5%E5%BF%97"><span class="nav-text">2.3 日志</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Docker-%E5%AE%89%E8%A3%85"><span class="nav-text">3 Docker 安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%AE%89%E8%A3%85-certbot"><span class="nav-text">3.1 安装 certbot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%AE%89%E8%A3%85-Docker"><span class="nav-text">3.2 安装 Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6"><span class="nav-text">3.3 申请证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6"><span class="nav-text">3.4 查看证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E7%BB%AD%E6%9C%9F%E8%AF%81%E4%B9%A6"><span class="nav-text">3.5 续期证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-%E6%89%8B%E5%8A%A8%E7%BB%AD%E6%9C%9F"><span class="nav-text">3.5.1 手动续期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F"><span class="nav-text">3.5.2 自动续期</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E5%90%8A%E9%94%80%E8%AF%81%E4%B9%A6"><span class="nav-text">3.6 吊销证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E6%9B%B4%E6%96%B0%E8%AF%81%E4%B9%A6%E5%9F%9F%E5%90%8D"><span class="nav-text">3.7 更新证书域名</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Palemoky" src="https://tva1.sinaimg.cn/large/006tNbRwly1g9hf0u8313j305o05p3ye.jpg">
  <p class="site-author-name" itemprop="name">Palemoky</p>
  <div class="site-description" itemprop="description">Learn by doing !</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">101</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  © 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xinyu © Copyright  |  <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en"> BY-NC-SA</a></span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v5.4.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.2
  </div>

        
<div class="busuanzi-count">
  <script pjax="" async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  
  











  




  
  




  














    <div id="pjax">

  

  

  




    </div>


<script src="/bundle.js"></script><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.getAttribute('pjax') !== null) {
      element.setAttribute('pjax', '');
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
;

    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  ;

NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: true,
    notify: false,
    appId: 'CEo3hR7qTLSO1hx0GRgh4VkR-gzGzoHsz',
    appKey: 'mOoWJCRObxe1hAfLmzmXWKSS',
    placeholder: "拙笔若博君一思，幸甚之至",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script></body></html>